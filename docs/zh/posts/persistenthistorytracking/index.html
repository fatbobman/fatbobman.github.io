<!DOCTYPE html><html lang="zh"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="sitemap" href="/sitemap-index.xml"><!-- <link rel="shortcut icon" href={iconSVG.src} /> --><link rel="icon" type="image/png" sizes="16x16" href="/_astro/favicon-16x16.2312221518-2.4YWPtmqG.png"><link rel="icon" type="image/png" sizes="32x32" href="/_astro/favicon-32x32.2312221518-2.W1M1HUWf.png"><link rel="mask-icon" href="/_astro/faviconSVG-32x32.2312221518-2.JZf4E4CU.svg"><link rel="apple-touch-icon" sizes="180x180" href="/_astro/apple-touch-icon.2312227635.RNVrzb6f.png"><link rel="stylesheet" href="/style/global-new.css"><title>在 CoreData 中使用持久化历史跟踪 | 肘子的 Swift 记事本</title>
<meta name="description" content="本文详细介绍了 Core Data 的持久化历史跟踪功能，包括响应、提取、合并及清除的全过程处理，并提供示例代码。">
<meta name="robots" content="index,follow">
<link rel="canonical" href="https://fatbobman.com/zh/posts/persistenthistorytracking/">
<meta property="og:title" content="在 CoreData 中使用持久化历史跟踪 | 肘子的 Swift 记事本">
<meta property="og:description" content="本文详细介绍了 Core Data 的持久化历史跟踪功能，包括响应、提取、合并及清除的全过程处理，并提供示例代码。">
<meta property="og:url" content="https://fatbobman.com/zh/posts/persistenthistorytracking/">
<meta property="og:type" content="article">
<meta property="og:image" content="https://fatbobman.com/images/blog-card.png">

<meta property="og:locale" content="zh">
<meta property="og:site_name" content="fatbobman.com">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@fatbobman">
<meta name="twitter:creator" content="@fatbobman"><link rel="alternate" type="application/rss+xml" title="RSS Feed for My Website" href="https://fatbobman.com/zh/rss.xml"><link rel="sitemap" href="/sitemap-index.xml"><meta name="keywords" content="Swift 编程,Swift Programming,SwiftUI 教程,SwiftUI Tutorials,Core Data 实践,Core Data Practices,SwiftData 应用,SwiftData Applications,iOS 开发,iOS Development,Swift UI 设计,Swift UI Design,Swift 性能优化,Swift Performance Optimization,Swift 编码技巧,Swift Coding Techniques,iOS 应用开发,iOS App Development,Swift 数据管理,Swift Data Management,SwiftUI 布局,SwiftUI Layout,SwiftUI 动画,SwiftUI Animation"><meta name="apple-mobile-web-app-title" content="肘子的博客"><link rel="alternate" hreflang="zh" href="https://fatbobman.com/zh/posts/persistenthistorytracking/"><link rel="alternate" hreflang="en" href="https://fatbobman.com/en/posts/persistenthistorytracking/"><!-- <BasicScripts /> --><!-- <script is:inline>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?14e5d60a3ea6276655f9d14c58b1fcd0";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script> --><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5C7N4MF5');</script> <!-- End Google Tag Manager --><link rel="stylesheet" href="/_astro/about.j7QLSdOl.css" />
<link rel="stylesheet" href="/_astro/about.Yv8vAtam.css" />
<link rel="stylesheet" href="/_astro/_slug_.KE54EPLE.css" />
<style>.sticky[data-astro-cid-4wsjtibl]{position:fixed;top:0;left:50%;transform:translate(-50%);width:100%;max-width:100%}
</style><script type="module" src="/_astro/hoisted.i0Vwr4b0.js"></script></head> <body class="antialiased text-default tracking-tight bg-page">  <div class="flex flex-col min-h-screen justify-between "> <div> <header> <div class="bg-block" id="wholeHeader" data-astro-cid-4wsjtibl> <div id="blogTitle"> <a href="/zh/"> <div class="flex space-x-4 mx-auto text-center pt-16 sm:pt-12 font-black w-[240px] sm:w-[300px] pb-6 sm:pb-1"> <svg class="text-heading" width="337" height="63"> <use href="/images/title-fatbobman.svg#main"></use> </svg> <svg class="text-primary mt-[-6px] sm:mt-[-5px]" width="130" height="91"> <use href="/images/title-blog.svg#main"></use> </svg> </div> </a> </div> <div class="bg-block z-50 shadow-custom-light dark:shadow-custom-dark" id="stickyHeader" data-astro-cid-4wsjtibl> <div class="max-w-5xl flex flex-wrap items-center justify-between mx-auto p-2 sm:p-0" data-astro-cid-4wsjtibl> <div class="flex space-x-2" data-astro-cid-4wsjtibl> <div id="lang-data" data-lang="zh" style="display: none;"></div> <button id="language-dropdown-button" data-dropdown-toggle="language-dropdown-menu" type="button" class="p-2 w-10 h-10 font-medium text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg"> ZH </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-page divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="language-dropdown-menu"> <ul class="py-2 font-medium text-sm" role="none"> <li> <a href="/en/posts/persistenthistorytracking/" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
English
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="EN-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <a href="" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
中文
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="ZH-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <div class="border-t border-gray-200 dark:border-gray-800 w-4/5 mx-auto my-2"></div> <button class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem" id="set-default-lang"> <div class="inline-flex items-center"> 将中文设置为默认 </div> </button> </li> </ul> </div>  <button id="theme-dropdown-button" data-dropdown-toggle="theme-dropdown-menu" type="button" class="group p-2 w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <svg viewBox="0 0 24 24" id="theme_icon_system" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <svg viewBox="0 0 24 24" id="theme_icon_dark" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <svg viewBox="0 0 24 24" id="theme_icon_light" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="theme-dropdown-menu"> <ul class="py-2 font-medium" role="none"> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_light"> <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> <span class="ml-2 dark:hover:text-white">Light</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_dark"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <span class="ml-2 text-default dark:hover:text-white">Dark</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_system"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <span class="ml-2 dark:hover:text-white">System</span> </button> </li> </ul> </div> <script>
  (async () => {
    const { setTheme } = await import('/js/theme.js');
    // Use setTheme here
    // Change the icons inside the button based on previous settings
    // 如果 localStorage 里面有设置过 color-theme 的值, 则 themeToggleSystemIcon.classList.remove('hidden')
    function setThemeButton() {
      let theme = localStorage.getItem('color-theme');
      if (theme === 'dark') {
        themeToggleDarkIcon.classList.remove('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else if (theme === 'light') {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.remove('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.remove('hidden');
      }
    }

    // 监听暗黑模式的变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
      setThemeButton();
    });

    // 保证其他的页面也能够监听到 localStorage 的变化
    window.addEventListener('storage', function (event) {
      if (event.key === 'color-theme') {
        setThemeButton();
      }
    });

    function resetTheme() {
      setTheme();
      setThemeButton();
    }

    // 获取按钮
    var themeButtonLight = document.getElementById('theme_button_light');
    var themeButtonDark = document.getElementById('theme_button_dark');
    var themeButtonSystem = document.getElementById('theme_button_system');
    // 获取图标
    var themeToggleDarkIcon = document.getElementById('theme_icon_dark');
    var themeToggleLightIcon = document.getElementById('theme_icon_light');
    var themeToggleSystemIcon = document.getElementById('theme_icon_system');

    // Listen for clicks on the button themeToggleDarkIcon
    themeButtonDark.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'dark');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleLightIcon
    themeButtonLight.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'light');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleSystemIcon
    themeButtonSystem.addEventListener('click', function () {
      localStorage.removeItem('color-theme');
      resetTheme();
    });

    resetTheme();
  })();
</script> <link rel="stylesheet" href="/style/docsearch.css"><div id="docsearch" class="group w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"></div> </div> <button data-collapse-toggle="navbar-solid-bg" type="button" class="inline-flex items-center p-2 mx-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-solid-bg" aria-expanded="false" id="navbar-toggle-button"> <span class="sr-only">Open main menu</span> <svg class="w-5 h-5 text-default" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path> </svg> </button> <nav class="hidden w-full md:block md:w-auto px-4 z-40" id="navbar-solid-bg"> <ul class="flex flex-col font-bold mt-4 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent dark:bg-gray-800 md:dark:bg-transparent dark:border-gray-700"> <a href="/zh/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 首页 </a><a href="/zh/posts/" class="block py-2 px-3 md:p-0 rounded text-invert bg-secondary md:bg-transparent md:text-secondary md:dark:bg-transparent" aria-current="page"> 文章 </a><a href="/zh/weekly/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 周报 </a><a href="/zh/snippet/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 小贴士 </a><a href="/zh/about/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 关于 </a> </ul> </nav>  </div> </div> <div id="placeholder" class="hidden" data-astro-cid-4wsjtibl></div> </div> <script>(function(){const enableSticky = true;
const enableStickyInMobile = true;

  window.onload = function () {
    checkStickyHeader();
    stickySetup();
  };

  window.addEventListener('resize', stickySetup);

  function checkStickyHeader() {
    const title = document.getElementById('blogTitle');
    const stickyHeader = document.getElementById('stickyHeader');
    const placeholder = document.getElementById('placeholder');

    if (title && stickyHeader && placeholder) {
      const offset = title.offsetTop + title.offsetHeight;

      if (shouldStick() && window.scrollY >= offset) {
        stickyHeader.classList.add('sticky');
        placeholder.style.display = 'block';
        placeholder.style.height = `${stickyHeader.offsetHeight}px`;
      } else {
        stickyHeader.classList.remove('sticky');
        placeholder.style.display = 'none';
      }
    }
  }

  function shouldStick() {
    if (!enableSticky) return false;

    let isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (isMobile && !enableStickyInMobile) return false;

    return true;
  }

  function stickySetup() {
    window.onscroll = checkStickyHeader;
  }
})();</script>  </header> <main class="w-full mx-auto max-w-3xl p-4 md:p-6 "> <div class="container mx-auto space-y-6 sm:space-y-12">   <div class="mx-auto space-y-4 text-center py-10" style="width:80%"> <div class="flex mx-auto justify-center"> <div class="flex mx-auto justify-center"> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/zh/tags/Core Data/">
#Core Data </a> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/en/posts/persistenthistorytracking/" id="language-switcher-for-topic"> #English </a> </div> </div> <h1 class="text-2xl font-bold leadi md:text-3xl text-heading">在 CoreData 中使用持久化历史跟踪</h1> <p class="text-sm text-default"> <a itemprop="author" href="https://twitter.com/fatbobman" class="hover:text-secondary font-medium">东坡肘子</a> <!-- <time datetime={`${post.data.publishDate.toISOString()}`}>{date}</time> --> </p> <p class="text-xs text-muted"> 发表于 <time datetime="2021-07-27T04:00:00.000Z">2021 年 7 月 27 日</time>  </p> </div> <svg style="display: none;"> <symbol id="icon-clipboard" viewBox="0 0 1024 1024"> <path d="M426.666667 42.666667l170.666667 0q41.344 0 74.325333 23.850667t46.336 61.482667l50.005333 0q52.992 0 90.496 37.504t37.504 90.496l0 597.333333q0 52.992-37.504 90.496t-90.496 37.504l-512 0q-52.992 0-90.496-37.504t-37.504-90.496l0-597.333333q0-52.992 37.504-90.496t90.496-37.504l50.005333 0q13.312-37.674667 46.336-61.482667t74.325333-23.850667zM768 213.333333l-50.005333 0q-13.312 37.674667-46.336 61.482667t-74.325333 23.850667l-170.666667 0q-41.344 0-74.325333-23.850667t-46.336-61.482667l-50.005333 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333l0 597.333333q0 17.664 12.501333 30.165333t30.165333 12.501333l512 0q17.664 0 30.165333-12.501333t12.501333-30.165333l0-597.333333q0-17.664-12.501333-30.165333t-30.165333-12.501333zM597.333333 128l-170.666667 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333 12.501333 30.165333 30.165333 12.501333l170.666667 0q17.664 0 30.165333-12.501333t12.501333-30.165333-12.501333-30.165333-30.165333-12.501333z"></path> </symbol> <symbol id="icon-check" viewBox="0 0 1024 1024"> <path d="M421.858 683.366l401.796-448.518c18.66-20.828 50.668-22.586 71.498-3.928 20.828 18.66 22.586 50.67 3.928 71.498L463.638 788.494c-18.606 20.768-50.5 22.586-71.344 4.066l-263.29-233.924c-20.906-18.572-22.796-50.576-4.222-71.48 18.574-20.906 50.576-22.796 71.48-4.222L421.86 683.366z"></path> </symbol> </svg> <div class="relative" id="article-area"> <article class="prose dark:prose-invert mx-auto w-full"> <div> 
<div class="dynamic-ad-container pt-4"></div>
<h2 id="前言">前言</h2>
<blockquote>
<p><strong>2022 年 2 月更新</strong>：我已经重写了代码，并将其整理成库 <a href="https://github.com/fatbobman/PersistentHistoryTrackingKit?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">PersistentHistoryTrackingKit</a> 以方便大家使用。</p>
</blockquote>
<p>知道持久化历史跟踪功能已经有一段时间了，之前简单地浏览过文档但没有太当回事。一方面关于它的资料不多，学习起来并不容易；另一方面也没有使用它的特别动力。</p>
<p>在计划中的 <a href="/healthnotes/" target="_blank">【健康笔记 3】</a> 中，我考虑为 App 添加 Widget 或者其他的 Extentsion，另外我也打算将 WWDC 21 上介绍的 NSCoreDataCoreSpotlightDelegate 用到 App 的新版本中。为此就不得不认真地了解该如何使用持久化历史跟踪功能了。</p>
<h2 id="什么是持久化历史跟踪persistent-history-tracking">什么是持久化历史跟踪（Persistent History Tracking）</h2>
<blockquote>
<p>使用持久化历史跟踪（Persistent History Tracking）来确定自启用该项功能以来，存储（Store）中发生了哪些更改。 —— 苹果官方文档</p>
</blockquote>
<p>在 CoreData 中，如果你的数据保存形式是 Sqlite（绝大多数的开发者都采用此种方式）且启用了持久化历史跟踪功能，无论数据库中的数据有了何种变化（删除、添加、修改等），调用此数据库并注册了该通知的应用，都会收到一个数据库有变化的系统提醒。</p>
<h2 id="为什么要使用它">为什么要使用它</h2>
<p>持久化历史跟踪目前主要有以下几个应用的场景：</p>
<ul>
<li>
<p>在 App 中，将 App 的批处理（BatchInsert、BatchUpdate、BatchDelete）业务产生的数据变化合并到当前的视图上下文（ViewContext）中。</p>
<p>批处理是直接通过协调器（PersistentStoreCoordinator）来操作的，由于该操作并不经过上下文（ManagedObejctContext），因此如果不对其做特别的处理，App 并不会及时的将批处理导致的数据变化在当前的视图上下文中体现出来。在没有 Persistent History Tracking 之前，我们必须在每个批处理操作后，使用例如 <code>mergeChanegs</code> 将变化合并到上下文中。在使用了 Persistent History Tracking 之后，我们可以将所有的批处理变化统一到一个代码段中进行合并处理。</p>
</li>
<li>
<p>在一个 App Group 中，当 App 和 App Extension 共享一个数据库文件，将某个成员在数据库中做出的修改及时地体现在另一个成员的视图上下文中。</p>
<p>想象一个场景，你有一个汇总网页 Clips 的 App，并且提供了一个 Safari Extentsion 用来在浏览网页的时候，将合适的剪辑保存下来。在 Safari Extension 将一个 Clip 保存到数据库中后，将你的 App（Safari 保存数据时，该 App 已经启动且切换到了后台）切换到前台，如果正在显示 Clip 列表，最新的（由 Safari Extentsion 添加）Clip 并不会出现在列表中。一旦启用了 Persistent History Tracking，你的 App 将及时得到数据库发生变化的通知、并做出响应，用户便可以在第一时间在列表中看到新添加的 Clip。</p>
</li>
<li>
<p>当使用 PersistentCloudKitContainer 将你的 CoreData 数据库同 Cloudkit 进行数据同步时。</p>
<p>Persistent History Tracking 是实现 CoreData 同 CloudKit 数据同步的重要保证。无需开发者自行设定，当你使用 PersistentCloudKitContainer 作为容器后，CoreData 便已经为你的数据库启用了 Persistent History Tracking 功能。不过除非你在自己的代码中明确声明启用持久化历史跟踪，否则所有网络同步的数据变化都并不会通知到你的代码，CoreData 会在后台默默地处理好一切。</p>
</li>
<li>
<p>当使用 NSCoreDataCoreSpotlightDelegate 时。</p>
<p>在今年的 WWDC 2021 上，苹果推出了 NSCoreDataCoreSpotlightDelegate，可以非常便捷的将 CoreData 中的数据同 Spotlight 集成到一起。为了使用该功能，必须为你的数据库开启 Persistent History Tracking 功能。</p>
</li>
</ul>
<h2 id="persistent-history-tracking-的工作原理">Persistent History Tracking 的工作原理</h2>
<p>为持久化存储启用 Persistent History Tracking 后，你的应用程序将开始为 Core Data 的持久化存储中发生的任何更改创建事务记录（ Transaction ）。无论该事务是由何种方式（通过上下文还是不经过上下文）产生的，由那个 App 或 Extension 产生，都将事无巨细的记录下来。</p>
<p>所有的变化都会被保存在你的 Sqlite 数据库文件中，苹果在 Sqlite 中创建了几个表，用来记录了 Transaction 对应的各类信息。</p>
<p><picture>
                    <source media="(max-width: 479px)" srcset="https://cdn.fatbobman.com/image-20210727092416404-7349058.png?imageView2/0/w/500"/>
                    <source media="(max-width: 767px)" srcset="https://cdn.fatbobman.com/image-20210727092416404-7349058.png?imageView2/0/w/768"/>
                    <source media="(max-width: 1024px)" srcset="https://cdn.fatbobman.com/image-20210727092416404-7349058.png?imageView2/0/w/1024"/>
                    <img src="https://cdn.fatbobman.com/image-20210727092416404-7349058.png" alt="image-20210727092416404" loading="lazy" decoding="async"/>
                  </picture></p>
<p>苹果并没有公开这些表的具体结构，不过我们可以使用 Persistent History Tracking 提供的 API 来对其中的数据进行查询、清除等工作。</p>
<blockquote>
<p>如果有兴趣也可以自己看看这几个表的内容，苹果将数据组织的非常紧凑的。<code>ATRANSACTION</code> 中是尚未消除的 transaction，<code>ATRANSACTIONSTRING</code> 中是 author 和 contextName 的字符串标识，<code>ACHANGE</code> 是变化的数据，以上数据最终转换成对应的 ManagedObjectID。</p>
</blockquote>
<p>Transaction 将按照产生顺序被自动记录。我们可以检索特定时间后发生的所有更改。你可以通过多种表达方式来确定这个时间点：</p>
<ul>
<li>基于令牌（Token）</li>
<li>基于时间戳（Timestamp）</li>
<li>基于交易本身（Transaction）</li>
</ul>
<p>一个基本的 Persistent History Tracking 处理流程如下：</p>
<ol>
<li>响应 Persistent History Tracking 产生的 NSPersistentStoreRemoteChange 通知</li>
<li>检查从上次处理的时间戳后是否仍有需要处理的 Transaction</li>
<li>将需要处理的 Transaction 合并到当前的视图上下文中</li>
<li>记录最后处理的 Transaction 时间戳</li>
<li>择机删除已经被合并的 Transaction</li>
</ol>
<h2 id="app-groups">App Groups</h2>
<p>在继续聊 Persisten History Tracking 之前，我们先介绍一下 App Groups。</p>
<p>由于苹果对 App 采取了严格的沙盒机制，因此每个 App，Extension 都有其自己的存储空间。它们只能读取自己沙盒文件空间的内容。如果我们想让不同的 App，或者在 App 和 Extension 之间共享数据的话，在 App Groups 出现之前只能通过一些第三方库来进行简单的数据交换。</p>
<p>为了解决这个问题，苹果推出了自己的解决方案 App Groups。App Group 让不同的 App 或者 App&amp;App Extension 之间可以通过两种方式来共享资料（必须是同一个开发者账户）：</p>
<ul>
<li>UserDefauls</li>
<li>Group URL（Group 中每个成员都可以访问的存储空间）</li>
</ul>
<p>绝大多数的 Persistent History Tracking 应用场合，都是发生在启用了 App Group 的情况下。因此了解如何创建 App Grups、如何访问 Group 共享的 UserDefaults、如何读取 Group URL 中的文件非常有必要。</p>
<h3 id="让-app-加入-app-groups">让 App 加入 App Groups</h3>
<p>在项目导航栏中，选择需要加入 Group 的 Target，在 Signing&amp;Capabilities 中，点击 <code>+</code>，添加 App Group 功能。</p>
<p><picture>
                    <source media="(max-width: 479px)" srcset="https://cdn.fatbobman.com/image-20210726193034435-7299035.png?imageView2/0/w/500"/>
                    <source media="(max-width: 767px)" srcset="https://cdn.fatbobman.com/image-20210726193034435-7299035.png?imageView2/0/w/768"/>
                    <source media="(max-width: 1024px)" srcset="https://cdn.fatbobman.com/image-20210726193034435-7299035.png?imageView2/0/w/1024"/>
                    <img src="https://cdn.fatbobman.com/image-20210726193034435-7299035.png" alt="image-20210726193034435" loading="lazy" decoding="async"/>
                  </picture></p>
<p>在 App Groups 中选择或者创建 group</p>
<p><picture>
                    <source media="(max-width: 479px)" srcset="https://cdn.fatbobman.com/image-20210726193200091-7299122.png?imageView2/0/w/500"/>
                    <source media="(max-width: 767px)" srcset="https://cdn.fatbobman.com/image-20210726193200091-7299122.png?imageView2/0/w/768"/>
                    <source media="(max-width: 1024px)" srcset="https://cdn.fatbobman.com/image-20210726193200091-7299122.png?imageView2/0/w/1024"/>
                    <img src="https://cdn.fatbobman.com/image-20210726193200091-7299122.png" alt="image-20210726193200091" loading="lazy" decoding="async"/>
                  </picture></p>
<p><em>只有在 Team 设定的情况下，Group 才能被正确的添加。</em></p>
<p>App Group Container ID 必须以 <code>group.</code> 开始，后面通常会使用逆向域名的方式。</p>
<p>如果你有开发者账号，可以在 App ID 下加入 App Groups</p>
<p><picture>
                    <source media="(max-width: 479px)" srcset="https://cdn.fatbobman.com/image-20210726193614636-7299375.png?imageView2/0/w/500"/>
                    <source media="(max-width: 767px)" srcset="https://cdn.fatbobman.com/image-20210726193614636-7299375.png?imageView2/0/w/768"/>
                    <source media="(max-width: 1024px)" srcset="https://cdn.fatbobman.com/image-20210726193614636-7299375.png?imageView2/0/w/1024"/>
                    <img src="https://cdn.fatbobman.com/image-20210726193614636-7299375.png" alt="image-20210726193614636" loading="lazy" decoding="async"/>
                  </picture></p>
<p>其他的 App 或者 App Extension 也都按照同样的方式，指定到同一个 App Group 中。</p>
<h3 id="创建可在-group-中共享的-userdefaults">创建可在 Group 中共享的 UserDefaults</h3>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> extension</span><span style="color:#8BE9FD;font-style:italic"> UserDefaults</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">    /// 用于 app group 的 userDefaults, 在此处设定的内容可以被 app group 中的成员使用</span></span>
<span class="line"><span style="color:#FF79C6">    static</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> appGroup </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> UserDefaults</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">suiteName</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">group.com.fatbobman.healthnote</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span><span style="color:#FF79C6">!</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p><code>suitName</code> 是你在前面创建的 App Group Container ID</p>
<p>在 Group 中的 App 代码中，使用如下代码创建的 UserDefaults 数据，将被 Group 中所有的成员共享，每个成员都可以对其进行读写操作</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> userDefaults </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> UserDefaults.appGroup</span></span>
<span class="line"><span style="color:#F8F8F2">userDefaults.</span><span style="color:#BD93F9">set</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">hello world</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD">forKey</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">shareString</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span></code></pre></div>
<h3 id="获取-group-container-url">获取 Group Container URL</h3>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> groupURL </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> FileManager.default.</span><span style="color:#8BE9FD">containerURL</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">forSecurityApplicationGroupIdentifier</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">group.com.fatbobman.healthnote</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span><span style="color:#FF79C6">!</span></span></code></pre></div>
<p>对这个 URL 进行操作和对于 App 自己沙盒中的 URL 操作完全一样。Group 中的所有成员都可以在该文件夹中对文件进行读写。</p>
<blockquote>
<p>接下来的代码都假设 App 是在一个 App Group 中，并且通过 UserDefaults 和 Container URL 来进行数据共享。</p>
</blockquote>
<h2 id="启用持久化历史跟踪">启用持久化历史跟踪</h2>
<p>启用 Persistent History Tracking 功能非常简单，我们只需要对 NSPersistentStoreDescription `进行设置即可。</p>
<p>以下是在 Xcode 生成的 CoreData 模版 <code>Persistence.swift</code> 中启用的例子：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">   init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">inMemory</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> false</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">        container </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSPersistentContainer</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">name</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">PersistentTrackBlog</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> inMemory {</span></span>
<span class="line"><span style="color:#F8F8F2">            container.persistentStoreDescriptions.</span><span style="color:#BD93F9">first</span><span style="color:#FF79C6">!</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">url</span><span style="color:#FF79C6"> =</span><span style="color:#8BE9FD"> URL</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">fileURLWithPath</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">/dev/null</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">        // 添加如下代码：</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> desc </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> container.persistentStoreDescriptions.</span><span style="color:#BD93F9">first</span><span style="color:#FF79C6">!</span></span>
<span class="line"><span style="color:#6272A4">        // 如果不指定 desc.url 的话，默认的 URL 当前 App 的 Application Support 目录</span></span>
<span class="line"><span style="color:#6272A4">        // FileManager.default.urls(for: .applicationSupportDirectory, in: .userDomainMask).first!</span></span>
<span class="line"><span style="color:#6272A4">        // 在该 Description 上启用 Persistent History Tracking</span></span>
<span class="line"><span style="color:#F8F8F2">        desc.</span><span style="color:#8BE9FD">setOption</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">true</span><span style="color:#FF79C6"> as</span><span style="color:#F8F8F2"> NSNumber,</span></span>
<span class="line"><span style="color:#8BE9FD">                       forKey</span><span style="color:#F8F8F2">: NSPersistentHistoryTrackingKey)</span></span>
<span class="line"><span style="color:#6272A4">        // 在该 Description 上启用 Remote Change Notification</span></span>
<span class="line"><span style="color:#F8F8F2">        desc.</span><span style="color:#8BE9FD">setOption</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">true</span><span style="color:#FF79C6"> as</span><span style="color:#F8F8F2"> NSNumber,</span></span>
<span class="line"><span style="color:#8BE9FD">                       forKey</span><span style="color:#F8F8F2">: NSPersistentStoreRemoteChangeNotificationPostOptionKey)</span></span>
<span class="line"><span style="color:#6272A4">         // 对 description 的设置必须在 load 之前完成，否则不起作用</span></span>
<span class="line"><span style="color:#F8F8F2">        container.</span><span style="color:#8BE9FD">loadPersistentStores</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">completionHandler</span><span style="color:#F8F8F2">: { (storeDescription, error) </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">            if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> error </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> error </span><span style="color:#FF79C6">as</span><span style="color:#F8F8F2"> NSError</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">                fatalError</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Unresolved error </span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">error</span><span style="color:#FF79C6">)</span><span style="color:#F1FA8C">, </span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">error.</span><span style="color:#F8F8F2">userInfo</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">        })</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span></code></pre></div>
<p>如果创建自己的 Description，类似的代码如下：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> defaultDesc: NSPersistentStoreDescription</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> groupURL </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> FileManager.default.</span><span style="color:#8BE9FD">containerURL</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">forSecurityApplicationGroupIdentifier</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">group.com.fatbobman.healthnote</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span><span style="color:#FF79C6">!</span></span>
<span class="line"><span style="color:#6272A4">        // 数据库保存在 App Group Container 中，其他的 App 或者 App Extension 也可以读取</span></span>
<span class="line"><span style="color:#F8F8F2">        defaultDesc.</span><span style="color:#BD93F9">url</span><span style="color:#FF79C6"> =</span><span style="color:#F8F8F2"> groupURL</span></span>
<span class="line"><span style="color:#F8F8F2">        defaultDesc.configuration </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">Local</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2">        defaultDesc.</span><span style="color:#8BE9FD">setOption</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">true</span><span style="color:#FF79C6"> as</span><span style="color:#F8F8F2"> NSNumber, </span><span style="color:#8BE9FD">forKey</span><span style="color:#F8F8F2">: NSPersistentHistoryTrackingKey)</span></span>
<span class="line"><span style="color:#F8F8F2">        defaultDesc.</span><span style="color:#8BE9FD">setOption</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">true</span><span style="color:#FF79C6"> as</span><span style="color:#F8F8F2"> NSNumber, </span></span>
<span class="line"><span style="color:#8BE9FD">                              forKey</span><span style="color:#F8F8F2">: NSPersistentStoreRemoteChangeNotificationPostOptionKey)</span></span>
<span class="line"><span style="color:#F8F8F2">        container.persistentStoreDescriptions </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [defaultDesc]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        container.</span><span style="color:#8BE9FD">loadPersistentStores</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">completionHandler</span><span style="color:#F8F8F2">: { </span><span style="color:#BD93F9">_</span><span style="color:#F8F8F2">, error </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">            if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> error </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> error </span><span style="color:#FF79C6">as</span><span style="color:#F8F8F2"> NSError</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">        })</span></span></code></pre></div>
<p>Persistent History Tracking 功能是在 description 上设置的，因此如果你的 CoreData 使用了多个 <code>Configuration</code> 的话，可以只为有需要的 <code>configuration</code> 启用该功能。</p>
<h2 id="响应持久化存储跟踪远程通知">响应持久化存储跟踪远程通知</h2>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> PersistentHistoryTrackingManager</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">container</span><span style="color:#F8F8F2">: NSPersistentContainer, </span><span style="color:#50FA7B;font-style:italic">currentActor</span><span style="color:#F8F8F2">: AppActor) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.container </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> container</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.currentActor </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> currentActor</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">        // 注册 StoreRemoteChange 的响应</span></span>
<span class="line"><span style="color:#F8F8F2">        NotificationCenter.default.</span><span style="color:#8BE9FD">publisher</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#8BE9FD">            for</span><span style="color:#F8F8F2">: .NSPersistentStoreRemoteChange,</span></span>
<span class="line"><span style="color:#8BE9FD">            object</span><span style="color:#F8F8F2">: container.persistentStoreCoordinator</span></span>
<span class="line"><span style="color:#F8F8F2">        )</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#8BE9FD">subscribe</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">on</span><span style="color:#F8F8F2">: queue, </span><span style="color:#8BE9FD">options</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">nil</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        .sink { </span><span style="color:#BD93F9">_</span><span style="color:#FF79C6"> in</span></span>
<span class="line"><span style="color:#6272A4">            // notification 的内容没有意义，仅起到提示需要处理的作用</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">            self</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD">processor</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#8BE9FD">store</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">in</span><span style="color:#F8F8F2">: </span><span style="color:#FF79C6">&amp;</span><span style="color:#F8F8F2">cancellables)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> container: NSPersistentContainer</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> currentActor: AppActor</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> userDefaults </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> UserDefaults.appGroup</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    lazy</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> backgroundContext </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> { container.</span><span style="color:#8BE9FD">newBackgroundContext</span><span style="color:#F8F8F2">() }()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> cancellables: </span><span style="color:#8BE9FD;font-style:italic">Set</span><span style="color:#F8F8F2">&lt;AnyCancellable&gt; </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> []</span></span>
<span class="line"><span style="color:#FF79C6">    private</span><span style="color:#FF79C6"> lazy</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> queue </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">        DispatchQueue</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">label</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">com.fatbobman.</span><span style="color:#FF79C6">\(</span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F1FA8C">.</span><span style="color:#F8F8F2">currentActor</span><span style="color:#F1FA8C">.</span><span style="color:#BD93F9">rawValue</span><span style="color:#FF79C6">)</span><span style="color:#F1FA8C">.processPersistentHistory</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    }()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    /// 处理 persistent history</span></span>
<span class="line"><span style="color:#FF79C6">    private</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> processor</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#6272A4">        // 在正确的上下文中进行操作，避免影响主线程</span></span>
<span class="line"><span style="color:#F8F8F2">        backgroundContext.performAndWait {</span></span>
<span class="line"><span style="color:#6272A4">            // fetcher 用来获取需要处理的 transaction</span></span>
<span class="line"><span style="color:#FF79C6">            guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> transactions </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try?</span><span style="color:#8BE9FD"> fetcher</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">return</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#6272A4">            // merger 将 transaction 合并当当前的视图上下文中</span></span>
<span class="line"><span style="color:#8BE9FD">            merger</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">transaction</span><span style="color:#F8F8F2">: transactions)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>我简单的解释一下上面的代码。</p>
<p>我们注册 <code>processor</code> 来响应 <code>NSNotification.Name.NSPersistentStoreRemoteChange</code>。</p>
<p>每当你的数据库中启用 Persistent History Tracking 的 Entity 发生数据变动时，<code>processor</code> 都将会被调用。在上面的代码中，我们完全忽视了 <code>notification</code>，因为它本身的内容没有意义，只是告诉我们数据库发生了变化，需要 processor 来处理，具体发生了什么变化、是否有必要进行处理等都需要通过自己的代码来判断。</p>
<p>所有针对 Persistent History Tracking 的数据操作都放在 <code>backgroundContext</code> 中进行，避免影响主线程。</p>
<p><code>PersistentHistoryTrackingManager</code> 是我们处理 Persistent History Tracking 的核心。在 CoreDataStack 中（比如上面的 persistent. swift），通过在 init 中添加如下代码来处理 Persistent History Tracking 事件</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> persistentHistoryTrackingManager : PersistentHistoryTrackingManager</span></span>
<span class="line"><span style="color:#FF79C6">init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">inMemory</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> false</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">  ....</span></span>
<span class="line"><span style="color:#6272A4">  // 标记当前上下文的 author 名称</span></span>
<span class="line"><span style="color:#F8F8F2">    container.viewContext.transactionAuthor </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> AppActor.mainApp.</span><span style="color:#BD93F9">rawValue</span></span>
<span class="line"><span style="color:#F8F8F2">    persistentHistoryTrackingManager </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> PersistentHistoryTrackingManager</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#8BE9FD">                        container</span><span style="color:#F8F8F2">: container,</span></span>
<span class="line"><span style="color:#8BE9FD">                        currentActor</span><span style="color:#F8F8F2">: AppActor.mainApp </span><span style="color:#6272A4">//当前的成员</span></span>
<span class="line"><span style="color:#F8F8F2">   )</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>因为 App Group 中的成员都可以读写我们的数据库，为了在接下来的处理中更好的分辨到底是由那个成员产生的 Transaction，我们需要创建一个枚举类型来对每个成员进行标记。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">enum</span><span style="color:#8BE9FD;font-style:italic"> AppActor</span><span style="color:#F8F8F2">:String,CaseIterable{</span></span>
<span class="line"><span style="color:#FF79C6">    case</span><span style="color:#F8F8F2"> mainApp  </span><span style="color:#6272A4">// iOS App</span></span>
<span class="line"><span style="color:#FF79C6">    case</span><span style="color:#F8F8F2"> safariExtension </span><span style="color:#6272A4">//Safari Extension</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>按照自己的需求来创建成员的标记。</p>
<h2 id="获取需要处理的-transaction">获取需要处理的 Transaction</h2>
<p>在接收到 <code>NSPersistentStoreRemoteChange</code> 消息后，我们首先应该将需要处理的 Transaction 提取出来。就像在前面的工作原理中提到的一样，API 为我们提供了 3 种不同的方法：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">open</span><span style="color:#FF79C6"> class</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> fetchHistory</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">after</span><span style="color:#FFB86C;font-style:italic"> date</span><span style="color:#F8F8F2">: Date) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#BD93F9;font-style:italic"> Self</span></span>
<span class="line"><span style="color:#FF79C6">open</span><span style="color:#FF79C6"> class</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> fetchHistory</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">after</span><span style="color:#FFB86C;font-style:italic"> token</span><span style="color:#F8F8F2">: NSPersistentHistoryToken</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#BD93F9;font-style:italic"> Self</span></span>
<span class="line"><span style="color:#FF79C6">open</span><span style="color:#FF79C6"> class</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> fetchHistory</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">after</span><span style="color:#FFB86C;font-style:italic"> transaction</span><span style="color:#F8F8F2">: NSPersistentHistoryTransaction</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#BD93F9;font-style:italic"> Self</span></span></code></pre></div>
<p>获取指定<strong>时间点之后</strong>且满足条件的 Transaction</p>
<p>这里我更推荐使用 <code>Timestamp</code> 也就是 <code>Date</code> 来进行处理。主要有两个原因：</p>
<ul>
<li>当我们用 UserDefaults 来保存最后的记录时，<code>Date</code> 是 UserDefaults 直接支持的结构，无需进行转换</li>
<li><code>Timestamp</code> 已经被记录在 Transaction 中（表 <code>ATRANSACTION</code>），可以直接查找，无需转换，而 Token 是需要再度计算的</li>
</ul>
<p>通过使用下面的代码，我们可以获取当前 sqlite 数据库中，所有的 Transaction 信息：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">NSPersistentHistoryChangeRequest.</span><span style="color:#8BE9FD">fetchHistory</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">after</span><span style="color:#F8F8F2">: .distantPast)</span></span></code></pre></div>
<p>这些信息包括任意来源产生的 <code>Transaction</code>，无论这些 <code>Transaction</code> 是否是当前 App 所需要的，是否已经被当前 App 处理过了。</p>
<p>在上面的处理流程中，我们已经介绍过需要通过时间戳来过滤不必要的信息，并保存最后处理的 <code>Transaction</code> 时间戳。我们这些信息保存在 UserDefaults 中，方便 App Group 的成员来共同处理。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> UserDefaults</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">    /// 从全部的 app actor 的最后时间戳中获取最晚的时间戳</span></span>
<span class="line"><span style="color:#6272A4">    /// 只删除最晚的时间戳之前的 transaction，这样可以保证其他的 appActor</span></span>
<span class="line"><span style="color:#6272A4">    /// 都可以正常的获取未处理的 transaction</span></span>
<span class="line"><span style="color:#6272A4">    /// 设置了一个 7 天的界限。即使有的 appActor 没有使用（没有创建 userdefauls）</span></span>
<span class="line"><span style="color:#6272A4">    /// 也会至多只保留 7 天的 transaction</span></span>
<span class="line"><span style="color:#6272A4">    /// - Parameter appActors: app 角色，比如 healthnote ,widget</span></span>
<span class="line"><span style="color:#6272A4">    /// - Returns: 日期（时间戳）, 返回值为 nil 时会处理全部未处理的 transaction</span></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> lastCommonTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">in</span><span style="color:#FFB86C;font-style:italic"> appActors</span><span style="color:#F8F8F2">: [AppActor]) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> Date</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">        // 七天前</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> sevenDaysAgo </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Date</span><span style="color:#F8F8F2">().</span><span style="color:#8BE9FD">addingTimeInterval</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">-604800</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> lasttimestamps </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> appActors</span></span>
<span class="line"><span style="color:#F8F8F2">            .compactMap {</span></span>
<span class="line"><span style="color:#8BE9FD">                lastHistoryTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#6272A4">        // 全部 actor 都没有设定值</span></span>
<span class="line"><span style="color:#FF79C6">        guard</span><span style="color:#FF79C6"> !</span><span style="color:#F8F8F2">lasttimestamps.</span><span style="color:#BD93F9">isEmpty</span><span style="color:#FF79C6"> else</span><span style="color:#F8F8F2"> {</span><span style="color:#FF79C6">return</span><span style="color:#BD93F9"> nil</span><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> minTimestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> lasttimestamps.</span><span style="color:#8BE9FD">min</span><span style="color:#F8F8F2">()</span><span style="color:#FF79C6">!</span></span>
<span class="line"><span style="color:#6272A4">        // 检查是否全部的 actor 都设定了值</span></span>
<span class="line"><span style="color:#FF79C6">        guard</span><span style="color:#F8F8F2"> lasttimestamps.</span><span style="color:#BD93F9">count</span><span style="color:#FF79C6"> !=</span><span style="color:#F8F8F2"> appActors.</span><span style="color:#BD93F9">count</span><span style="color:#FF79C6"> else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">            //返回最晚的时间戳</span></span>
<span class="line"><span style="color:#FF79C6">            return</span><span style="color:#F8F8F2"> minTimestamp</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#6272A4">        // 如果超过 7 天还没有获得全部 actor 的值，则返回七天，防止有的 actor 永远不会被设定</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> minTimestamp </span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2"> sevenDaysAgo {</span></span>
<span class="line"><span style="color:#FF79C6">            return</span><span style="color:#F8F8F2"> sevenDaysAgo</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">            return</span><span style="color:#BD93F9"> nil</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    } </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    /// 获取指定的 appActor 最后处理的 transaction 的时间戳</span></span>
<span class="line"><span style="color:#6272A4">    /// - Parameter appActore: app 角色，比如 healthnote ,widget</span></span>
<span class="line"><span style="color:#6272A4">    /// - Returns: 日期（时间戳）, 返回值为 nil 时会处理全部未处理的 transaction</span></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> lastHistoryTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">for</span><span style="color:#FFB86C;font-style:italic"> appActor</span><span style="color:#F8F8F2">: AppActor) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> Date</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> key </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">PersistentHistoryTracker.lastToken.</span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">appActor.</span><span style="color:#BD93F9">rawValue</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#8BE9FD"> object</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">forKey</span><span style="color:#F8F8F2">: key) </span><span style="color:#FF79C6">as?</span><span style="color:#F8F8F2"> Date</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    /// 给指定的 appActor 设置最新的 transaction 时间戳</span></span>
<span class="line"><span style="color:#6272A4">    /// - Parameters:</span></span>
<span class="line"><span style="color:#6272A4">    ///   - appActor: app 角色，比如 healthnote ,widget</span></span>
<span class="line"><span style="color:#6272A4">    ///   - newDate: 日期（时间戳）</span></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> updateLastHistoryTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">for</span><span style="color:#FFB86C;font-style:italic"> appActor</span><span style="color:#F8F8F2">: AppActor, </span><span style="color:#50FA7B">to</span><span style="color:#FFB86C;font-style:italic"> newDate</span><span style="color:#F8F8F2">: Date</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> key </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">PersistentHistoryTracker.lastToken.</span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">appActor.</span><span style="color:#BD93F9">rawValue</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#FF79C6">        set</span><span style="color:#F8F8F2">(newDate, </span><span style="color:#8BE9FD">forKey</span><span style="color:#F8F8F2">: key)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>由于 App Group 的成员每个都会保存自己的 <code>lastHistoryTransactionTimestamp</code>，因此为了保证 <code>Transaction</code> 能够被所有成员都正确合并后，再被清除掉，<code>lastCommonTransactionTimestamp</code> 将返回所有成员最晚的时间戳。<code>lastCommonTransactionTimestamp</code> 在清除合并后的 <code>Transaction</code> 时，将被使用到。</p>
<p>有了这些基础，上面的代码变可以修改为：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> fromDate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> userDefaults.</span><span style="color:#8BE9FD">lastHistoryTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: currentActor) </span><span style="color:#FF79C6">??</span><span style="color:#F8F8F2"> Date.distantPast</span></span>
<span class="line"><span style="color:#F8F8F2">NSPersistentHistoryChangeRequest.</span><span style="color:#8BE9FD">fetchHistory</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">after</span><span style="color:#F8F8F2">: fromDate)</span></span></code></pre></div>
<p>通过时间戳，我们已经过滤了大量不必关心的 <code>Transaction</code> 了，但在剩下的 <code>Transaction</code> 中都是我们需要的吗？答案是否定的，至少有两种情况的 Transaction 我们是不需要关心的：</p>
<ul>
<li>
<p>由当前 App 本身上下文产生的 <code>Transaction</code></p>
<p>通常 App 会对自身通过上下文产生的数据变化做出即时的反馈，如果改变化已经体现在了视图上下文中（主线程 ManagedObjectContext），则我们可以无需理会这些 Transaction。但如果数据是通过批量操作完成的，或者是在 <code>backgroudContext</code> 操作，且并没有被合并到视图上下文中，我们还是要处理这些 Transaction 的。</p>
</li>
<li>
<p>由系统产生的 Transaction</p>
<p>比如当你使用了 PersistentCloudKitContainer 时，所有的网络同步数据都将会产生 <code>Transaction</code>，这些 <code>Transaction</code> 会由 CoreData 来处理，我们无需理会。</p>
</li>
</ul>
<p>基于以上两点，我们可以进一步缩小需要处理的 <code>Transaction</code> 范围。最终 fetcher 的代码如下：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> PersistentHistoryTrackerManager</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    enum</span><span style="color:#8BE9FD;font-style:italic"> Error</span><span style="color:#F8F8F2">: String, Swift.Error {</span></span>
<span class="line"><span style="color:#FF79C6">        case</span><span style="color:#F8F8F2"> historyTransactionConvertionFailed</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#6272A4">    // 获取过滤后的 Transaction</span></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> fetcher</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">throws</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> [NSPersistentHistoryTransaction] {</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> fromDate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> userDefaults.</span><span style="color:#8BE9FD">lastHistoryTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: currentActor) </span><span style="color:#FF79C6">??</span><span style="color:#F8F8F2"> Date.distantPast</span></span>
<span class="line"><span style="color:#F8F8F2">        NSPersistentHistoryChangeRequest.</span><span style="color:#8BE9FD">fetchHistory</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">after</span><span style="color:#F8F8F2">: fromDate)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> historyFetchRequest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> NSPersistentHistoryChangeRequest.</span><span style="color:#8BE9FD">fetchHistory</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">after</span><span style="color:#F8F8F2">: fromDate)</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> fetchRequest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> NSPersistentHistoryTransaction.fetchRequest {</span></span>
<span class="line"><span style="color:#FF79C6">            var</span><span style="color:#F8F8F2"> predicates: [NSPredicate] </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">            AppActor.allCases.</span><span style="color:#8BE9FD">forEach</span><span style="color:#F8F8F2"> { appActor </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">                if</span><span style="color:#F8F8F2"> appActor </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> currentActor {</span></span>
<span class="line"><span style="color:#6272A4">                    // 本代码假设在 App 中，即使通过 backgroud 进行的操作也已经被即时合并到了 ViewContext 中</span></span>
<span class="line"><span style="color:#6272A4">                    // 因此对于当前 appActor，只处理名称为 batchContext 上下文产生的 transaction</span></span>
<span class="line"><span style="color:#FF79C6">                    let</span><span style="color:#F8F8F2"> perdicate </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSPredicate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">format</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">%K = %@ AND %K = %@</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD">                                                #keyPath</span><span style="color:#F8F8F2">(NSPersistentHistoryTransaction.author),</span></span>
<span class="line"><span style="color:#F8F8F2">                                                appActor.</span><span style="color:#BD93F9">rawValue</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD">                                                #keyPath</span><span style="color:#F8F8F2">(NSPersistentHistoryTransaction.contextName),</span></span>
<span class="line"><span style="color:#E9F284">                                                &quot;</span><span style="color:#F1FA8C">batchContext</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">                    predicates.</span><span style="color:#8BE9FD">append</span><span style="color:#F8F8F2">(perdicate)</span></span>
<span class="line"><span style="color:#F8F8F2">                } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">                    // 其他的 appActor 产生的 transactions，全部都要进行处理</span></span>
<span class="line"><span style="color:#FF79C6">                    let</span><span style="color:#F8F8F2"> perdicate </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSPredicate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">format</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">%K = %@</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD">                                                #keyPath</span><span style="color:#F8F8F2">(NSPersistentHistoryTransaction.author),</span></span>
<span class="line"><span style="color:#F8F8F2">                                                appActor.</span><span style="color:#BD93F9">rawValue</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">                    predicates.</span><span style="color:#8BE9FD">append</span><span style="color:#F8F8F2">(perdicate)</span></span>
<span class="line"><span style="color:#F8F8F2">                }</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">            let</span><span style="color:#F8F8F2"> compoundPredicate </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSCompoundPredicate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">type</span><span style="color:#F8F8F2">: .or, </span><span style="color:#8BE9FD">subpredicates</span><span style="color:#F8F8F2">: predicates)</span></span>
<span class="line"><span style="color:#F8F8F2">            fetchRequest.predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> compoundPredicate</span></span>
<span class="line"><span style="color:#F8F8F2">            historyFetchRequest.fetchRequest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> fetchRequest</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> historyResult </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try</span><span style="color:#F8F8F2"> backgroundContext.</span><span style="color:#8BE9FD">execute</span><span style="color:#F8F8F2">(historyFetchRequest) </span><span style="color:#FF79C6">as?</span><span style="color:#F8F8F2"> NSPersistentHistoryResult,</span></span>
<span class="line"><span style="color:#FF79C6">              let</span><span style="color:#F8F8F2"> history </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> historyResult.result </span><span style="color:#FF79C6">as?</span><span style="color:#F8F8F2"> [NSPersistentHistoryTransaction]</span></span>
<span class="line"><span style="color:#FF79C6">        else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">            throw</span><span style="color:#8BE9FD;font-style:italic"> Error</span><span style="color:#F8F8F2">.historyTransactionConvertionFailed</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> history</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<blockquote>
<p>如果你的 App 比较单纯（比如没有使用 PersistentCloudKitContainer），可以不需要上面更精细的 <code>predicate</code> 处理过程。总的来说，即使获取的 <code>Transaction</code> 超出了需要的范围，CoreData 在合并时给系统造成的压力也并不大。</p>
</blockquote>
<p>由于 fetcher 是通过 <code>NSPersistentHistoryTransaction.author</code> 和 <code>NSPersistentHistoryTransaction.contextName</code> 来对 <code>Transaction</code> 进行进一步过滤的，因此请在你的代码中，明确的在 <code>NSManagedObjectContext</code> 中标记上身份：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#6272A4">// 标记代码中的上下文的 author，例如</span></span>
<span class="line"><span style="color:#F8F8F2">viewContext.transactionAuthor </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> AppActor.mainApp.</span><span style="color:#BD93F9">rawValue</span></span>
<span class="line"><span style="color:#6272A4">// 如果用于批处理的操作，请标记 name，例如</span></span>
<span class="line"><span style="color:#F8F8F2">backgroundContext.name </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">batchContext</span><span style="color:#E9F284">&quot;</span></span></code></pre></div>
<p><strong>清楚地标记 Transaction 信息，是使用 Persistent History Tracking 的基本要求</strong></p>
<h2 id="将-transaction-合并到视图上下文中">将 Transaction 合并到视图上下文中</h2>
<p>通过 fetcher 获取到了需要处理的 Transaction 后，我们需要将这些 Transaction 合并到视图上下文中。</p>
<p>合并的操作就很简单了，在合并后将最后的时间戳保存即可。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> PersistentHistoryTrackerManager</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> merger</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">transaction</span><span style="color:#F8F8F2">: [NSPersistentHistoryTransaction]) {</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> viewContext </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> container.viewContext</span></span>
<span class="line"><span style="color:#F8F8F2">        viewContext.perform {</span></span>
<span class="line"><span style="color:#F8F8F2">            transaction.</span><span style="color:#8BE9FD">forEach</span><span style="color:#F8F8F2"> { transaction </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">                let</span><span style="color:#F8F8F2"> userInfo </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> transaction.</span><span style="color:#8BE9FD">objectIDNotification</span><span style="color:#F8F8F2">().userInfo </span><span style="color:#FF79C6">??</span><span style="color:#F8F8F2"> [</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">                NSManagedObjectContext.</span><span style="color:#8BE9FD">mergeChanges</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">fromRemoteContextSave</span><span style="color:#F8F8F2">: userInfo, </span><span style="color:#8BE9FD">into</span><span style="color:#F8F8F2">: [viewContext])</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">        // 更新最后的 transaction 时间戳</span></span>
<span class="line"><span style="color:#FF79C6">        guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> lastTimestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> transaction.</span><span style="color:#BD93F9">last</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">.timestamp </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">return</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#F8F8F2">        userDefaults.</span><span style="color:#8BE9FD">updateLastHistoryTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: currentActor, </span><span style="color:#8BE9FD">to</span><span style="color:#F8F8F2">: lastTimestamp)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>可以根据自己的习惯选用合并代码，下面的代码和上面的 <code>NSManagedObjectContext.mergeChanges</code> 是等效的：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">viewContext.perform {</span></span>
<span class="line"><span style="color:#F8F8F2">   transaction.</span><span style="color:#8BE9FD">forEach</span><span style="color:#F8F8F2"> { transaction </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">      viewContext.</span><span style="color:#8BE9FD">mergeChanges</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">fromContextDidSave</span><span style="color:#F8F8F2">: transaction.</span><span style="color:#8BE9FD">objectIDNotification</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#F8F8F2">   }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>这些已经在数据库中发生但尚未反映在视图上下文中的 Transaction，会在合并后立即体现在你的 App UI 上。</p>
<h2 id="清理合并后的-transaction">清理合并后的 Transaction</h2>
<p>所有的 Transaction 都被保存在 Sqlite 文件中，不仅会占用空间，而且随着记录的增多也会影响 Sqlite 的访问速度。我们需要制定明确的清理策略来删除已经处理过的 Transaction。</p>
<p>同 <code>fetcher</code> 中使用 <code>open class func fetchHistory(after date: Date) -&gt; Self</code> 类似，Persistent History Tracking 同样为我们准备了三个方法用来做清理工作：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">open</span><span style="color:#FF79C6"> class</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> deleteHistory</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">before</span><span style="color:#FFB86C;font-style:italic"> date</span><span style="color:#F8F8F2">: Date) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#BD93F9;font-style:italic"> Self</span></span>
<span class="line"><span style="color:#FF79C6">open</span><span style="color:#FF79C6"> class</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> deleteHistory</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">before</span><span style="color:#FFB86C;font-style:italic"> token</span><span style="color:#F8F8F2">: NSPersistentHistoryToken</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#BD93F9;font-style:italic"> Self</span></span>
<span class="line"><span style="color:#FF79C6">open</span><span style="color:#FF79C6"> class</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> deleteHistory</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">before</span><span style="color:#FFB86C;font-style:italic"> transaction</span><span style="color:#F8F8F2">: NSPersistentHistoryTransaction</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#BD93F9;font-style:italic"> Self</span></span></code></pre></div>
<p>删除指定<strong>时间点之前</strong>且满足条件的 Transaction</p>
<p>清理策略可以粗旷的也可以很精细的，例如在苹果官方文档中便采取了一种比较粗旷的清理策略：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> sevenDaysAgo </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Date</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">timeIntervalSinceNow</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD">TimeInterval</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">exactly</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">-604_800</span><span style="color:#F8F8F2">)</span><span style="color:#FF79C6">!</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> purgeHistoryRequest </span><span style="color:#FF79C6">=</span></span>
<span class="line"><span style="color:#F8F8F2">    NSPersistentHistoryChangeRequest.</span><span style="color:#8BE9FD">deleteHistory</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#8BE9FD">        before</span><span style="color:#F8F8F2">: sevenDaysAgo)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">do</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#F8F8F2"> persistentContainer.backgroundContext.</span><span style="color:#8BE9FD">execute</span><span style="color:#F8F8F2">(purgeHistoryRequest)</span></span>
<span class="line"><span style="color:#F8F8F2">} </span><span style="color:#FF79C6">catch</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">    fatalError</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Could not purge history: </span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">error</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>删除一切 7 天前的 Transaction，无论其 author 是谁。事实上，这个看似粗旷的策略在实际使用中几乎没有任何问题。</p>
<p>在本文中，我们将同 fetcher 一样，对清除策略做更精细的处理。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">import</span><span style="color:#8BE9FD;font-style:italic"> CoreData</span></span>
<span class="line"><span style="color:#FF79C6">import</span><span style="color:#8BE9FD;font-style:italic"> Foundation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">/// 删除已经处理过的 transaction</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> struct</span><span style="color:#8BE9FD;font-style:italic"> PersistentHistoryCleaner</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">    /// NSPersistentCloudkitContainer</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> container: NSPersistentContainer</span></span>
<span class="line"><span style="color:#6272A4">    /// app group userDefaults</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> userDefault </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> UserDefaults.appGroup</span></span>
<span class="line"><span style="color:#6272A4">    /// 全部的 appActor</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> appActors </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> AppActor.allCases</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    /// 清除已经处理过的 persistent history transaction</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> clean</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">        guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> timestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> userDefault.</span><span style="color:#8BE9FD">lastCommonTransactionTimestamp</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">in</span><span style="color:#F8F8F2">: appActors) </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">            return</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">        // 获取可以删除的 transaction 的 request</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> deleteHistoryRequest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> NSPersistentHistoryChangeRequest.</span><span style="color:#8BE9FD">deleteHistory</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">before</span><span style="color:#F8F8F2">: timestamp)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">        // 只删除由 App Group 的成员产生的 Transaction</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> fetchRequest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> NSPersistentHistoryTransaction.fetchRequest {</span></span>
<span class="line"><span style="color:#FF79C6">            var</span><span style="color:#F8F8F2"> predicates: [NSPredicate] </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">            appActors.</span><span style="color:#8BE9FD">forEach</span><span style="color:#F8F8F2"> { appActor </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#6272A4">                // 清理 App Group 成员创建的 Transaction</span></span>
<span class="line"><span style="color:#FF79C6">                let</span><span style="color:#F8F8F2"> perdicate </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSPredicate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">format</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">%K = %@</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD">                                            #keyPath</span><span style="color:#F8F8F2">(NSPersistentHistoryTransaction.author),</span></span>
<span class="line"><span style="color:#F8F8F2">                                            appActor.</span><span style="color:#BD93F9">rawValue</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">                predicates.</span><span style="color:#8BE9FD">append</span><span style="color:#F8F8F2">(perdicate)</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">            let</span><span style="color:#F8F8F2"> compoundPredicate </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSCompoundPredicate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">type</span><span style="color:#F8F8F2">: .or, </span><span style="color:#8BE9FD">subpredicates</span><span style="color:#F8F8F2">: predicates)</span></span>
<span class="line"><span style="color:#F8F8F2">            fetchRequest.predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> compoundPredicate</span></span>
<span class="line"><span style="color:#F8F8F2">            deleteHistoryRequest.fetchRequest </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> fetchRequest</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">        container.performBackgroundTask { context </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">            do</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">                try</span><span style="color:#F8F8F2"> context.</span><span style="color:#8BE9FD">execute</span><span style="color:#F8F8F2">(deleteHistoryRequest)</span></span>
<span class="line"><span style="color:#6272A4">                // 重置全部 appActor 的时间戳</span></span>
<span class="line"><span style="color:#F8F8F2">                appActors.</span><span style="color:#8BE9FD">forEach</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">actor</span><span style="color:#8BE9FD;font-style:italic"> in</span></span>
<span class="line"><span style="color:#F8F8F2">                    userDefault.updateLastHistoryTransactionTimestamp(for: actor, to: nil)</span></span>
<span class="line"><span style="color:#F8F8F2">                }</span></span>
<span class="line"><span style="color:#F8F8F2">            } </span><span style="color:#FF79C6">catch</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">                print</span><span style="color:#F8F8F2">(error)</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>之所以在我在 fetcher 和 cleaner 中设置了如此详尽的 predicate，是因为我自己是在 <code>PersistentCloudKitContainer</code> 中使用 Persistent History Tracking 功能的。Cloudkit 同步会产生大量的 Transaction，因此需要更精准的对操作对象进行过滤。</p>
<p><strong>CoreData 会自动处理和清除 CloudKit 同步产生的 Transaction，但是如果我们不小心删除了尚没被 CoreData 处理的 CloudKit Transaction，可能会导致数据库同步错误，CoreData 会清空当前的全部数据，尝试从远程重新加载数据。</strong></p>
<p><strong>因此，如果你是在 <code>PersistentCloudKitContainer 上</code> 使用 Persistent History Tracking，请务必仅对 App Group 成员产生的 Transaction 做清除操作。</strong></p>
<p>如果仅是在 <code>PersistentContainer</code> 上使用 Persistent History Tracking，fetcher 和 cleaner 中都可以不用过滤的如此彻底。</p>
<p>在创建了 <code>PersistentHistoryCleaner</code> 后，我们可以根据自己的实际情况选择调用时机。</p>
<p>如果采用 <code>PersistentContainer</code>，可以尝试比较积极的清除策略。在 <code>PersistentHistoryTrackingManager</code> 中添加如下代码：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">    private</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> processor</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#F8F8F2">        backgroundContext.performAndWait {</span></span>
<span class="line"><span style="color:#FF79C6">            ...</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> cleaner </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> PersistentHistoryCleaner</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">container</span><span style="color:#F8F8F2">: container)</span></span>
<span class="line"><span style="color:#F8F8F2">        cleaner.</span><span style="color:#8BE9FD">clean</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span></code></pre></div>
<p>这样在每次响应 <code>NSPersistentStoreRemoteChange</code> 通知后，都会尝试清除已经合并过的 Transaction。</p>
<p>不过我个人更推荐使用不那么积极的清除策略。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@main</span></span>
<span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> PersistentTrackBlogApp</span><span style="color:#F8F8F2">: App {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> persistenceController </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> PersistenceController.shared</span></span>
<span class="line"><span style="color:#FF79C6">    @Environment</span><span style="color:#F8F8F2">(\.scenePhase) </span><span style="color:#FF79C6">var</span><span style="color:#F8F8F2"> scenePhase</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> body: </span><span style="color:#FF79C6">some</span><span style="color:#F8F8F2"> Scene {</span></span>
<span class="line"><span style="color:#F8F8F2">        WindowGroup {</span></span>
<span class="line"><span style="color:#8BE9FD">            ContentView</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">                .</span><span style="color:#8BE9FD">environment</span><span style="color:#F8F8F2">(\.managedObjectContext, persistenceController.container.viewContext)</span></span>
<span class="line"><span style="color:#F8F8F2">                .</span><span style="color:#8BE9FD">onChange</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">of</span><span style="color:#F8F8F2">: scenePhase) { scenePhase </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">                    switch</span><span style="color:#F8F8F2"> scenePhase {</span></span>
<span class="line"><span style="color:#FF79C6">                    case</span><span style="color:#F8F8F2"> .active</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">                        break</span></span>
<span class="line"><span style="color:#FF79C6">                    case</span><span style="color:#F8F8F2"> .background</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">                        let</span><span style="color:#F8F8F2"> clean </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> PersistentHistoryCleaner</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">container</span><span style="color:#F8F8F2">: persistenceController.container)</span></span>
<span class="line"><span style="color:#F8F8F2">                        clean.</span><span style="color:#8BE9FD">clean</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">                    case</span><span style="color:#F8F8F2"> .inactive</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">                        break</span></span>
<span class="line"><span style="color:#FF79C6">                    @unknown</span><span style="color:#FF79C6"> default:</span></span>
<span class="line"><span style="color:#FF79C6">                        break</span></span>
<span class="line"><span style="color:#F8F8F2">                    }</span></span>
<span class="line"><span style="color:#F8F8F2">                }</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>比如当 app 退到后台时，进行清除工作。</p>
<div class="dynamic-ad-container pt-4"></div>
<h2 id="总结">总结</h2>
<p>可以在 <a href="https://github.com/fatbobman/PersistentHistoryTrackingDemo?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">Github</a> 下载本文的全部代码。</p>
<p>以下资料对于本文有着至关重要的作用：</p>
<ul>
<li>
<p><a href="https://donnywals.gumroad.com/l/practical-core-data?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">Practical Core Data</a></p>
<p>Donny Wals 的这本书是我最近一段时间非常喜欢的一本 CoreData 的书籍。其中有关于 Persistent History Tracking 的章节。另外他的 <a href="https://www.donnywals.com/the-blog/?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">Blog</a> 也经常会有关于 CoreData 的文章</p>
</li>
<li>
<p><a href="https://www.avanderlee.com?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">SwiftLee</a></p>
<p>Avanderlee 的博客也有大量关于 CoreData 的精彩文章，<a href="https://www.avanderlee.com/swift/persistent-history-tracking-core-data/?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">Persistent History Tracking in Core Data</a> 这篇文章同样做了非常详细的说明。本文的代码结构也受其影响。</p>
</li>
</ul>
<p>苹果构建了 Persistent History Tracking，让多个成员可以共享单个数据库并保持 UI 的及时更新。无论你是构建一套应用程序，或者是想为你的 App 添加合适的 Extension，亦或仅为了统一的响应批处理操作的数据，持久化历史跟踪都能为你提供良好的帮助。</p>
<p>Persistent History Tracking 尽管可能会造成一点系统负担，不过和它带来的便利性相比是微不足道的。在实际使用中，我基本上感受不到因它而导致的性能损失。</p> </div> </article> <script src="/js/modalsubscribecontroller.js" defer></script> <!-- Modal toggle --><button data-modal-target="default-modal" data-modal-toggle="default-modal" class="hidden text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
Toggle modal
</button> <!-- Main modal --> <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"> <div id="default-modal" tabindex="-1" aria-hidden="true" class="hidden w-full h-full justify-center items-center"> <div class="relative p-4 w-full max-w-2xl"> <!-- Modal content --> <div class="relative bg-white rounded-lg shadow-2xl dark:bg-gray-800 border-gray-200 border dark:border-gray-600"> <!-- Modal header --> <div class="flex items-center justify-between px-4 md:px-5 pt-4 pb-0 rounded-t dark:border-gray-600"> <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="default-modal"> <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path> </svg> <span class="sr-only">Close modal</span> </button> </div> <!-- Modal body --> <div class="px-4 md:px-5 pb-4"> <div class="w-full mx-auto text-center px-6 pb-6"> <div class="text-lg font-semibold text-gray-900 dark:text-blue-100 pt-4 pb-8">每周一，与您分享精心筛选的 Swift 与 SwiftUI 开发精华</div> <div id="custom-substack-embed1"></div> <!-- <div class="text-gray-700 dark:text-blue-200 text-xs font-medium pt-4">{bottomTip}</div> --> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };

    // 创建一个新的 MutationObserver 实例
    const observer = new MutationObserver((mutationsList, observer) => {
      // 遍历所有的 mutations
      for (let mutation of mutationsList) {
        // 如果这个 mutation 是一个子节点的添加或删除
        if (mutation.type === 'childList') {
          // 查找订阅框
          const widget = document.querySelector('.custom-substack-widget1');
          if (widget) {
            // 查找 input 元素
            const input = widget.querySelector('input');
            const button = widget.querySelector('button');
            // 根据当前的颜色方案修改订阅框的样式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              // 暗黑模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            } else {
              // 正常模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            }

            if (window.matchMedia('(max-width: 640px)').matches) {
              // 屏幕尺寸小于 640px
              widget.style.maxWidth = '325px';
            } else {
              // 屏幕尺寸大于或等于 640px
              widget.style.maxWidth = '600px';
            }
            // 停止观察
            observer.disconnect();
          }
        }
      }
    });

    // 开始观察 #custom-substack-embed 元素的子节点的变化
    observer.observe(document.getElementById('custom-substack-embed1'), { childList: true });
  })();</script> <script src="/js/subscriber.js" async></script> </div> <div class="flex justify-center pb-6"> <button data-modal-hide="default-modal" type="button" class="text-gray-600 dark:text-gray-400 bg-transparent hover:text-gray-800 dark:hover:text-gray-200 font-medium rounded-lg text-sm px-8 py-2.5 text-center transition-colors">继续阅读</button> </div> </div> </div> </div> </div> </div> <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "author": {
    "@type": "Person",
    "name": "Fatbobman",
    "url": "https://twitter.com/fatbobman"
  },
  "dateModified": "2021-07-27T04:00:00.000Z",
  "datePublished": "2021-07-27T04:00:00.000Z",
  "description": "本文详细介绍了 Core Data 的持久化历史跟踪功能，包括响应、提取、合并及清除的全过程处理，并提供示例代码。",
  "headline": "在 CoreData 中使用持久化历史跟踪",
  "image": {
    "@type": "ImageObject"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fatbobman.com/zh/posts/persistenthistorytracking/"
  },
  "url": "https://fatbobman.com/zh/posts/persistenthistorytracking/",
  "publisher": {
    "@type": "Organization",
    "name": "Fatbobman's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fatbobman.com/images/blog-card.png"
    }
  }
}</script> <div class="w-full mx-auto text-center pb-0 sm:pb-6 pt-8"> <div id="custom-substack-embed"></div> <div class="text-xs font-medium text-heading p-4">为您每周带来有关 Swift 和 SwiftUI 的精选资讯！</div> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };
  
    const observer = new MutationObserver((mutationsList) => {
      const widget = document.querySelector('.custom-substack-widget');
      if (widget) {
        const input = widget.querySelector('input');
        const button = widget.querySelector('button');
  
        // 设置样式（合并暗黑模式与默认模式逻辑）
        const darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        widget.style.padding = '0.5rem';
        widget.style.borderRadius = '1.2rem';
        widget.style.border = '0.1px solid var(--aw-color-text-muted)';
        input.style.border = '0px solid #000';
        input.style.backgroundColor = 'var(--aw-background-color)';
        button.style.backgroundColor = 'var(--subscribe-button-background)';
        button.style.color = 'var(--subscribe-button-text)';
        button.style.borderRadius = '0.8rem';
        button.style.maxWidth = '100px';
        button.style.fontWeight = 'bold';
  
        // 响应式调整
        widget.style.maxWidth = window.matchMedia('(max-width: 640px)').matches
          ? '325px'
          : '400px';
  
        observer.disconnect(); // 停止观察
      }
    });
  
    // 开始观察
    observer.observe(document.getElementById('custom-substack-embed'), { childList: true });
  })();</script> <script src="https://substackapi.com/widget.js" defer></script> </div> <div class="pt-6 pb-6  dark:border-gray-700"> <!-- <p class="flex justify-center align-center text-sm font-medium text-heading">
    { lang === Lang.ZH && <SupportMeTextZH /> }
    { lang === Lang.EN && <SupportMeTextEN /> }
  </p> --> <div class="flex flex-col sm:flex-row justify-center items-center mx-auto sm:space-x-8 align-center pt-2"> <button type="button" class="text-gray-900 bg-yellow-200 hover:bg-yellow-300 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://www.buymeacoffee.com/fatbobman')"> <img src="/images/buymeacoffee.svg" alt="Buy me a coffee" class="w-5 h-5 me-2 -ms-1" decoding="async" loading="lazy"> <span class="text-black font-medium">Buy me a coffee</span> </button> <div class="pt-4 sm:pt-0"> <button type="button" class="text-red-500 bg-[#3270e1] hover:bg-blue-700 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://afdian.com/a/fatbobman')"> <img src="/images/aifadian.svg" alt="" width="18" height="18" loading="lazy" decoding="async" class="w-4 h-4 me-2 -ms-1" aria-hidden="true"> <span class="text-white font-medium">爱发电(微信/支付宝)</span> </button>  </div> </div> </div> <!-- <WeeklySubscribe1 lang={lang} top={0} bottom={4}/> --> <div id="copy-alert" class="hidden fixed bottom-28 right-5"> <div id="alert-1" class="flex items-center p-4 mb-4 text-blue-800 rounded-lg bg-blue-50/90 dark:bg-gray-800/90 dark:text-blue-400" role="alert"> <div class="text-sm font-medium">链接已复制</div> </div> </div> <style>
  .copy-icon {
    position: absolute;
    left: -30px; /* 根据您的布局调整位置 */
    top: 50%; /* 将图标定位到标题的中间高度 */
    transform: translateY(-50%); /* 垂直居中对齐图标 */
    cursor: pointer;
    transition: opacity 0.6s ease;
    pointer-events: all; /* 始终响应鼠标事件 */
  }

  article h2,
  article h3,
  article h4,
  article h5 {
    position: relative;
  }

  #copy-alert {
    position: fixed;
    bottom: -100px; /* 初始在视窗下方 */
    right: 20px;
    transition: bottom 0.5s ease-in-out;
  }

  /* 进入动画 */
  @keyframes slideIn {
    from {
      bottom: -100px;
    }
    to {
      bottom: 0px;
    }
  }

  /* 消失动画 */
  @keyframes slideOut {
    from {
      bottom: 20px;
    }
    to {
      bottom: -100px;
    }
  }
</style> <script>
  var hideTimeout; // 用于保存自动隐藏定时器的引用
  document.querySelectorAll('article h2, article h3, article h4, article h5').forEach(function (header) {
    var copyIcon = document.createElement('span');
    copyIcon.innerHTML =
      '<svg fill="currentColor" aria-hidden="true" stroke="currentColor" class="w-5 h-5 hidden md:block hover:text-secondary" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M861.866667 164.266667c-87.466667-87.466667-230.4-89.6-320-2.133334l-68.266667 68.266667c-12.8 12.8-12.8 32 0 44.8s32 12.8 44.8 0l68.266667-68.266667c64-61.866667 166.4-61.866667 230.4 2.133334 64 64 64 168.533333 2.133333 232.533333l-117.333333 119.466667c-34.133333 34.133333-81.066667 51.2-128 49.066666-46.933333-4.266667-91.733333-27.733333-119.466667-66.133333-10.666667-14.933333-29.866667-17.066667-44.8-6.4-14.933333 10.666667-17.066667 29.866667-6.4 44.8 40.533333 53.333333 100.266667 87.466667 166.4 91.733333h17.066667c59.733333 0 119.466667-23.466667 162.133333-68.266666l117.333333-119.466667c83.2-89.6 83.2-234.666667-4.266666-322.133333z"></path><path d="M505.6 750.933333l-66.133333 68.266667c-64 61.866667-166.4 61.866667-230.4-2.133333-64-64-64-168.533333-2.133334-232.533334l117.333334-119.466666c34.133333-34.133333 81.066667-51.2 128-49.066667 46.933333 4.266667 91.733333 27.733333 119.466666 66.133333 10.666667 14.933333 29.866667 17.066667 44.8 6.4 14.933333-10.666667 17.066667-29.866667 6.4-44.8-40.533333-53.333333-100.266667-87.466667-166.4-91.733333-66.133333-4.266667-130.133333 19.2-177.066666 66.133333l-117.333334 119.466667c-85.333333 89.6-85.333333 234.666667 2.133334 322.133333 44.8 44.8 102.4 66.133333 162.133333 66.133334 57.6 0 115.2-21.333333 160-64l66.133333-68.266667c12.8-12.8 12.8-32 0-44.8-14.933333-10.666667-34.133333-10.666667-46.933333 2.133333z"></path></svg>'; // 使用您选择的图标
    copyIcon.className = 'copy-icon';
    copyIcon.style.opacity = '0'; // 默认透明
    header.insertBefore(copyIcon, header.firstChild);

    header.addEventListener('mouseover', function () {
      copyIcon.style.opacity = '1';
    });
    header.addEventListener('mouseout', function () {
      copyIcon.style.opacity = '0';
    });

    copyIcon.addEventListener('click', function () {
        var url = window.location.href.split('#')[0] + '#' + header.id;
        navigator.clipboard.writeText(url).then(function () {
            var alertDiv = document.getElementById('copy-alert');
            if (alertDiv) {
                alertDiv.classList.remove('hidden'); // 确保提示框是可见的
                alertDiv.style.display = 'block'; // 显示提示框
                clearTimeout(hideTimeout); // 清除之前的定时器
                alertDiv.style.animation = 'none'; // 先清除之前的动画
                setTimeout(function () {
                    alertDiv.style.animation = 'slideIn 0.5s forwards'; // 应用新动画
                }, 10);

                // 设置自动隐藏定时器
                hideTimeout = setTimeout(function () {
                    alertDiv.style.animation = 'slideOut 0.5s forwards'; // 应用消失动画
                    setTimeout(function () {
                        alertDiv.style.display = 'none';
                    }, 500);
                }, 3000);
            }
        });
    });
  });
</script> <script>
function copyCode(button, event) {
  event.preventDefault();
  const codeBlock = button.parentNode.nextElementSibling.textContent; // 获取代码内容
  navigator.clipboard.writeText(codeBlock).then(() => {
    // 显示 "Copied"
    button.querySelector('.copy-text').style.display = 'none';
    button.querySelector('.copied-text').style.display = 'inline';

    // 3秒后恢复
    setTimeout(() => {
      button.querySelector('.copy-text').style.display = 'inline';
      button.querySelector('.copied-text').style.display = 'none';
    }, 3000);
  });
}
</script> <script>(function(){const url = "https://fatbobman.com/ads/zh";

  fetch(url)
    .then(response => response.text())
    .then(html => {
      // 获取所有的广告位元素
      const adSlots = document.querySelectorAll('.dynamic-ad-container');
      // 将广告内容填充到每一个广告位中
      adSlots.forEach(slot => {
        slot.innerHTML = html;
      });
    })
    .catch(error => console.error('Error loading the ad:', error));
})();</script>  <!-- <LeaveFeedback lang={lang} /> --> <section class="pt-10"><div class="max-w-5xl sm:px-4 py-2 mx-auto"><div class="grid gap-4 sm:gap-2 sm:mx-4 sm:grid-cols-12"><div class="col-span-12 sm:col-span-3 hidden sm:block"><div class="text-center sm:text-left mt-3 mb-14 before:block before:w-24 before:h-1 before:mb-3 before:rounded before:mx-auto sm:before:mx-0 before:bg-secondary"><h3 class="text-lg font-medium text-default">相关文章</h3></div></div><div class="sm:hidden text-lg font-medium text-heading col-span-12 text-left">相关文章</div><div class="relative col-span-12 sm:px-4 space-y-6 sm:col-span-9"><div class="col-span-12 space-y-2 relative sm:px-4 sm:col-span-8 sm:space-y-4 sm:before:absolute sm:before:top-2 sm:before:bottom-0 sm:before:w-0.5 sm:before:-left-3 before:bg-block"><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/persistent-history-tracking-in-swiftdata/" id="relatedPosts-如何通过 Persistent History Tracking 观察 SwiftData 的数据变化"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">如何通过 Persistent History Tracking 观察 SwiftData 的数据变化</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/masteringofcoredatastack/" id="relatedPosts-掌握 Core Data Stack"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">掌握 Core Data Stack</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/weekly/issue-062" id="relatedPosts-Weekly #62 - 让 Swift 更强，也更简单"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">Weekly #62 - 让 Swift 更强，也更简单</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/from-data-model-construction-to-managed-object-instances-in-core-data/" id="relatedPosts-CoreData 探秘 - 从数据模型构建到托管对象实例"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">CoreData 探秘 - 从数据模型构建到托管对象实例</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/real-time-switching-of-cloud-syncs-status/" id="relatedPosts-实时切换 Core Data 的云同步状态"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">实时切换 Core Data 的云同步状态</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/coredatawithcloudkit-2/" id="relatedPosts-Core Data with CloudKit（二） —— 同步本地数据库到 iCloud 私有数据库"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">Core Data with CloudKit（二） —— 同步本地数据库到 iCloud 私有数据库</h3></div></a></div></div></div></div></section> <!-- <BottomWeeklySubscribe lang={lang} /> --> <div><div id="gitalk-container" data-comment-id="在 CoreData 中使用持久化历史跟踪" data-lang="zh"></div><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script></div><script>
  document.addEventListener('DOMContentLoaded', async function () {
    console.log('fetching comment is enable');
    const response = await fetch('https://fatbobman.com/status/comment');
    const data = await response.text();
    console.log(data);
    if (data === '1') {
      var container = document.getElementById('gitalk-container');
      if (container) {
        var commentID = container.getAttribute('data-comment-id');
        var lang = container.getAttribute('data-lang');

        var gitalk = new Gitalk({
          clientID: 'fcf61195c7f73253dc8b',
          clientSecret: '0ac2907be08248a1fcb5312e27480ad535c682e5',
          repo: 'blogComments',
          owner: 'fatbobman',
          admin: ['fatbobman'],
          id: commentID.split('/').pop().substring(0, 49),
          distractionFreeMode: true,
          createIssueManually: true,
          language: lang,
        });

        gitalk.render('gitalk-container');
      }
    }
  });
</script> <div class="hidden xl:block w-44 lg:absolute" id="toc" style="left: -30px; top: 0px"> <div class="text-muted items-center justify-center overflow-x-clip"> <div class="w-full flex justify-start pb-2" id="toc-button"> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" id="toc-list-switcher"> <path d="M170.666667 277.333333a85.333333 85.333333 0 1 0 0-170.666666 85.333333 85.333333 0 0 0 0 170.666666zM405.333333 128a64 64 0 1 0 0 128h469.333334a64 64 0 0 0 0-128h-469.333334zM341.333333 490.666667A64 64 0 0 1 405.333333 426.666667h469.333334a64 64 0 0 1 0 128h-469.333334A64 64 0 0 1 341.333333 490.666667z m0 298.666666A64 64 0 0 1 405.333333 725.333333h469.333334a64 64 0 0 1 0 128h-469.333334A64 64 0 0 1 341.333333 789.333333z m-85.333333-298.666666a85.333333 85.333333 0 1 1-170.666667 0 85.333333 85.333333 0 0 1 170.666667 0z m-85.333333 384a85.333333 85.333333 0 1 0 0-170.666667 85.333333 85.333333 0 0 0 0 170.666667z"></path> </svg>  </div> </div> <div class="text-default text-xs hidden" id="toc-list"> <ul> <li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#前言" class=""> 前言 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#什么是持久化历史跟踪persistent-history-tracking" class=""> 什么是持久化历史跟踪（Persistent History Tracking） </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#为什么要使用它" class=""> 为什么要使用它 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#persistent-history-tracking-的工作原理" class=""> Persistent History Tracking 的工作原理 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#app-groups" class=""> App Groups </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#让-app-加入-app-groups" class=""> 让 App 加入 App Groups </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#创建可在-group-中共享的-userdefaults" class=""> 创建可在 Group 中共享的 UserDefaults </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#获取-group-container-url" class=""> 获取 Group Container URL </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#启用持久化历史跟踪" class=""> 启用持久化历史跟踪 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#响应持久化存储跟踪远程通知" class=""> 响应持久化存储跟踪远程通知 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#获取需要处理的-transaction" class=""> 获取需要处理的 Transaction </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#将-transaction-合并到视图上下文中" class=""> 将 Transaction 合并到视图上下文中 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#清理合并后的-transaction" class=""> 清理合并后的 Transaction </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#总结" class=""> 总结 </a> </div> </li> </ul> </div> </div> </div> <style>
  #toc-list {
    transition: all 0.9s ease-in-out;
  }

  #toc-button {
    transition: all 0.9s ease-in-out;
  }
</style> <script>
  function getOffsetTop(element) {
    var offsetTop = 0;
    while (element) {
      offsetTop += element.offsetTop;
      element = element.offsetParent;
    }
    return offsetTop;
  }

  var toc = document.querySelector('#toc');
  // 获取 sidebar 在浏览器中的初始 top 值
  var initialTop = getOffsetTop(toc);
  var positioningElement = document.querySelector('#article-area'); // 定位视图的选择器
  var stickyPoint = 150;
  var tocPadding = 30;
  var tocTopOffset = 4;
  var sidebarWidth = toc.offsetWidth;

  function adjustTocPosition() {
    var sidebarOffsetTop = toc.getBoundingClientRect().top;
    console.log(sidebarOffsetTop, window.scrollY, initialTop - stickyPoint);
    if (sidebarOffsetTop <= stickyPoint) {
      // 获取 positioningElement 的左侧侧与浏览器左侧之间的距离
      var positioningElementRight = (window.innerWidth - positioningElement.getBoundingClientRect().width) / 2;
      toc.style.position = 'fixed';
      toc.style.top = stickyPoint + 'px';
      toc.style.left = positioningElementRight - toc.getBoundingClientRect().width - tocPadding + 'px';
    }

    if (window.scrollY <= initialTop - stickyPoint) {
      toc.style.position = 'absolute';
      toc.style.top = tocTopOffset + 'px';
      toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';
    }
  }

  document.addEventListener('scroll', adjustTocPosition);
  window.addEventListener('resize', adjustTocPosition);
  // doc 加载完成后，调整 toc 的位置
  toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';

  document.addEventListener('DOMContentLoaded', function () {
    const tocList = document.getElementById('toc-list');
    const tocButton = document.getElementById('toc-button');

    // 更新toc-list和toc-button的显示状态
    function updateDisplay() {
      const showToc = localStorage.getItem('showToc') === 'true';
      if (showToc) {
        tocList.classList.remove('hidden');
        tocButton.classList.add('justify-start');
        tocButton.classList.remove('justify-end');
      } else {
        tocList.classList.add('hidden');
        tocButton.classList.remove('justify-start');
        tocButton.classList.add('justify-end');
      }
    }

    // 初始状态检查
    updateDisplay();

    // 点击事件监听器，用于切换toc-list的显示状态并更新按钮位置
    tocButton.addEventListener('click', function () {
      const isHidden = tocList.classList.contains('hidden');
      localStorage.setItem('showToc', isHidden);
      updateDisplay();
    });
  });
</script> <div class="hidden md:block md:absolute" id="sidebar" style="right: -50px; top: 0px"> <div class="flex flex-col space-y-4 text-muted items-center justify-center"> <!-- ---
import FloatButton from '../FloatButton.astro'
import type { CollectionEntry } from 'astro:content';
import {Lang} from '@src/enumType'
import { urlHelper } from '@src/utils/url';
import { dataOperator } from '@src/utils/dataOperator';
export interface Props {
  lang:Lang
  post:CollectionEntry<'blog'>
}

const { post, lang } = Astro.props
const nextSlug = dataOperator.getNextPostBySlugAndLang(post.slug, lang)
const nextURL = nextSlug && urlHelper.getPostPathBySlug(nextSlug)
const nextPost = nextSlug && dataOperator.getPostBySlugAndLang(nextSlug,lang)
const hidden = nextSlug === null
---
<FloatButton hidden = {hidden}>
  <a href={nextURL} 
  data-tooltip-target="tooltip-next-post" 
  data-tooltip-placement="left"
  id = "sidebar-next-post"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      stroke-width="2"
      stroke="currentColor"
      fill="currentColor"
      stroke-linecap="round"
      stroke-linejoin="round"
      ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
        d="M9.586 4l-6.586 6.586a2 2 0 0 0 0 2.828l6.586 6.586a2 2 0 0 0 2.18 .434l.145 -.068a2 2 0 0 0 1.089 -1.78v-2.586h7a2 2 0 0 0 2 -2v-4l-.005 -.15a2 2 0 0 0 -1.995 -1.85l-7 -.001v-2.585a2 2 0 0 0 -3.414 -1.414z"
        stroke-width="0"
        fill="currentColor"></path></svg
    >
</a>
</FloatButton>

<div id="tooltip-next-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90">
    { nextPost && nextPost.data.title}
    <div class="tooltip-arrow" data-popper-arrow></div>
</div> --><div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="/zh/posts/wwdc2021/" data-tooltip-target="tooltip-next-post" data-tooltip-placement="left" id="sidebar-next-post"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M9.586 4l-6.586 6.586a2 2 0 0 0 0 2.828l6.586 6.586a2 2 0 0 0 2.18 .434l.145 -.068a2 2 0 0 0 1.089 -1.78v-2.586h7a2 2 0 0 0 2 -2v-4l-.005 -.15a2 2 0 0 0 -1.995 -1.85l-7 -.001v-2.585a2 2 0 0 0 -3.414 -1.414z" stroke-width="0" fill="currentColor"></path> </svg> </a>  </div> <div id="tooltip-next-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> <div> <div>WWDC 2021 观后感</div> <div class="text-xs text-yellow-200 font-extrabold pt-2">⌥ + ←</div> </div> <div class="tooltip-arrow" data-popper-arrow></div> </div> <script>(function(){const url = "/zh/posts/wwdc2021/";
const isHidden = false;

  document.addEventListener('keydown', (e) => {
    // Check if Alt+RightArrow or just RightArrow was pressed
    if (e.altKey && e.key === 'ArrowLeft') {
      // Only navigate if there's a URL and the button isn't hidden
      if (url && !isHidden) {
        e.preventDefault(); // Prevent default browser behavior
        window.location.href = url;
      }
    }
  });
})();</script> <!-- ---
import FloatButton from '../FloatButton.astro'
import type { CollectionEntry } from 'astro:content';
import {Lang} from '@src/enumType'
import { urlHelper } from '@src/utils/url';
import { dataOperator } from '@src/utils/dataOperator';
export interface Props {
  lang:Lang
  post:CollectionEntry<'blog'>
}

const { post, lang } = Astro.props
const previousSlug = dataOperator.getPreviousPostBySlugAndLang(post.slug, lang)
const previousURL = previousSlug && urlHelper.getPostPathBySlug(previousSlug)
const previousPost = previousSlug && dataOperator.getPostBySlugAndLang(previousSlug,lang)
const hidden = previousSlug === null
---
<FloatButton hidden = {hidden}>
  <a
   href={previousURL}
   data-tooltip-target="tooltip-previous-post" data-tooltip-placement="left"
   id = "sidebar-previous-post"
  >
    <svg
  xmlns="http://www.w3.org/2000/svg"
  viewBox="0 0 24 24"
  stroke-width="2"
  stroke="currentColor"
  fill="currentColor"
  stroke-linecap="round"
  stroke-linejoin="round"
  ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
    d="M12.089 3.634a2 2 0 0 0 -1.089 1.78l-.001 2.586h-6.999a2 2 0 0 0 -2 2v4l.005 .15a2 2 0 0 0 1.995 1.85l6.999 -.001l.001 2.587a2 2 0 0 0 3.414 1.414l6.586 -6.586a2 2 0 0 0 0 -2.828l-6.586 -6.586a2 2 0 0 0 -2.18 -.434l-.145 .068z"
    stroke-width="0"
    fill="currentColor"></path></svg
>
  </a>
</FloatButton>

<div id="tooltip-previous-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90">
  { previousPost && previousPost.data.title}
  <div class="tooltip-arrow" data-popper-arrow></div>
</div> --><div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="/zh/posts/appstorage/" data-tooltip-target="tooltip-previous-post" data-tooltip-placement="left" id="sidebar-previous-post"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M12.089 3.634a2 2 0 0 0 -1.089 1.78l-.001 2.586h-6.999a2 2 0 0 0 -2 2v4l.005 .15a2 2 0 0 0 1.995 1.85l6.999 -.001l.001 2.587a2 2 0 0 0 3.414 1.414l6.586 -6.586a2 2 0 0 0 0 -2.828l-6.586 -6.586a2 2 0 0 0 -2.18 -.434l-.145 .068z" stroke-width="0" fill="currentColor"></path> </svg> </a>  </div> <div id="tooltip-previous-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> <div>@AppStorage 研究</div><div class="text-xs text-yellow-200 font-extrabold pt-2">⌥ + →</div> <div class="tooltip-arrow" data-popper-arrow></div> </div> <script>(function(){const url = "/zh/posts/appstorage/";
const isHidden = false;

  document.addEventListener('keydown', (e) => {
    // Check if Alt+RightArrow or just RightArrow was pressed
    if (e.altKey && e.key === 'ArrowRight') {
      // Only navigate if there's a URL and the button isn't hidden
      if (url && !isHidden) {
        e.preventDefault(); // Prevent default browser behavior
        window.location.href = url;
      }
    }
  });
})();</script> <!-- <DictButton lang={lang} post = {post}/> --> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://x.com/intent/tweet?text=%E5%9C%A8%20CoreData%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%8C%81%E4%B9%85%E5%8C%96%E5%8E%86%E5%8F%B2%E8%B7%9F%E8%B8%AA&#38;url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpersistenthistorytracking%2F&#38;hashtags=ios%2Cswiftlang&#38;via=fatbobman" target="_blank" id="sidebar-share-with-twitter"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 4l11.733 16h4.267l-11.733 -16z"></path> <path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"></path> </svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://bsky.app/intent/compose?text=%E5%9C%A8%20CoreData%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%8C%81%E4%B9%85%E5%8C%96%E5%8E%86%E5%8F%B2%E8%B7%9F%E8%B8%AA%0A by %40fatbobman.bsky.social %0Ahttps%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpersistenthistorytracking%2F%0A #ios #swift" target="_blank" id="sidebar-share-with-bluesky"> <svg xmlns="http://www.w3.org/2000/svg" class="text-default hover:text-secondary" width="20" height="20" viewBox="0 0 24 24" stroke-width="0.7" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <path d="M4.9 3.02725C5.6 3.12725 6.4 3.52725 7.5 4.22725C9.3 5.62725 10.8 7.32725 12 9.22726C13.2 7.42725 14.7 5.62725 16.5 4.32725C17.5 3.62725 18.4 3.22725 19.1 3.12725C19.9 3.02725 20.4 3.22725 20.7 3.32725C21.7 3.72725 22 4.92725 22 5.92725C22 6.12725 21.9 7.22725 21.8 8.32725C21.7 8.82725 21.7 9.42726 21.6 9.92726C21.5 10.3273 21.5 10.8273 21.4 11.0273C21.1 12.2273 20.3 13.0273 19.4 13.5273C20.3 14.2273 20.7 15.4273 20.3 16.5273C19.7 18.4273 17.6 20.9273 15.5 21.1273C13.7 21.3273 12.6 19.8273 11.9 18.3273C11.2 19.7273 10.1 21.2273 8.3 21.1273C6.2 20.9273 4.1 18.4273 3.5 16.5273C3.2 15.4273 3.5 14.2273 4.4 13.5273C3.5 13.0273 2.8 12.1273 2.4 11.0273C2.3 10.7273 2.3 10.3273 2.2 9.92726C2.1 9.42726 2.1 8.92725 2 8.32725C2.1 7.12725 2 6.02725 2 5.82725C2 4.82725 2.3 3.62725 3.3 3.22725C3.6 3.12725 4.1 2.92725 4.9 3.02725ZM4 6.52725C4.1 7.32725 4.2 8.62725 4.3 9.52725C4.3 9.82725 4.4 10.0273 4.4 10.3273C4.8 11.6273 6.3 12.4273 8.1 12.2273C8.6 12.1273 9.1 12.5273 9.2 13.1273C9.3 13.6273 8.9 14.1273 8.4 14.2273C7.6 14.3273 5.1 14.6273 5.5 15.8273C5.9 17.0273 7.3 18.9273 8.6 19.0273C9.5 19.1273 10.1 17.6273 10.4 17.0273C10.7 16.3273 10.9 15.6273 11.1 15.0273C11.2 14.6273 11.6 14.3273 12.1 14.3273C12.6 14.3273 12.9 14.6273 13.1 15.0273C13.3 15.6273 13.5 16.3273 13.8 17.0273C14.1 17.7273 14.6 19.1273 15.6 19.0273C16.9 18.9273 18.4 16.9273 18.7 15.8273C19.1 14.5273 16.5 14.3273 15.8 14.2273C15.3 14.1273 14.9 13.6273 15 13.1273C15.1 12.6273 15.6 12.2273 16.1 12.2273C17.9 12.4273 19.4 11.7273 19.8 10.3273C19.9 10.0273 19.9 9.82725 19.9 9.52725C20 8.62725 20.1 7.32725 20.2 6.52725C20.2 6.02725 20.4 4.92725 19.7 5.02725C19.4 5.02725 18.9 5.22725 18 5.92725C15.7 7.32725 14 9.42725 12.9 11.6273C12.7 11.9273 12.4 12.1273 12 12.1273C11.6 12.1273 11.3 11.9273 11.1 11.6273C10 9.42725 8.3 7.32725 6.3 5.92725C5.4 5.32725 4.9 5.12725 4.6 5.02725C3.8 4.92725 4 6.02725 4 6.52725Z" fill="currentColor"></path> </svg> </a>  </div> <!-- ---
import FloatButton from '../FloatButton.astro';
import type { CollectionEntry } from 'astro:content';
import { Lang } from '@src/enumType.ts';
import { urlHelper } from '@src/utils/url';
export interface Props {
  lang: Lang;
  post: CollectionEntry<'blog'>;
}

const { post, lang } = Astro.props;
const url = encodeURIComponent(urlHelper.getPostCanonicalPathBySlug(post.slug)); // 编码文章的 URL
const facebookShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
const hidden = lang === Lang.ZH
---

<FloatButton>
  <a href={facebookShareUrl} target="_blank" id = "sidebar-share-with-facebook">
  <svg 
  fill="currentColor"
  stroke="currentColor"
  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
    ><path
      d="M767.428571 6.857143v150.857143h-89.714285q-49.142857 0-66.285715 20.571428t-17.142857 61.714286v108h167.428572l-22.285715 169.142857h-145.142857v433.714286H419.428571V517.142857H273.714286V348h145.714285V223.428571q0-106.285714 59.428572-164.857142T637.142857 0q84 0 130.285714 6.857143z"
      p-id="4213"></path></svg
  >
  </a>
</FloatButton> --><div class="hidden opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://www.facebook.com/sharer/sharer.php?u=https%253A%252F%252Ffatbobman.com%252Fzh%252Fposts%252Fpersistenthistorytracking%252F" target="_blank" id="sidebar-share-with-facebook"> <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <path d="M767.428571 6.857143v150.857143h-89.714285q-49.142857 0-66.285715 20.571428t-17.142857 61.714286v108h167.428572l-22.285715 169.142857h-145.142857v433.714286H419.428571V517.142857H273.714286V348h145.714285V223.428571q0-106.285714 59.428572-164.857142T637.142857 0q84 0 130.285714 6.857143z" p-id="4213"></path> </svg> </a>  </div> <!-- ---
import FloatButton from '../FloatButton.astro';
import type { CollectionEntry } from 'astro:content';
import { Lang } from '@src/enumType';
import { urlHelper } from '@src/utils/url';
export interface Props {
  lang: Lang;
  post: CollectionEntry<'blog'>;
}

const { post, lang } = Astro.props;
const titel = post.data.title.replace(/@/g, '') ;
const url = urlHelper.getPostCanonicalPathBySlug(post.slug);
const title = encodeURIComponent(titel + '\n #ios #swift\n by @fatbobman\n'); // 将标题、标签和via组合
const urlEncoded = encodeURIComponent(url); // 编码文章的 URL
const weiboShareUrl = `https://service.weibo.com/share/share.php?url=${urlEncoded}&title=${title}`;
const hidden = lang === Lang.EN
---

<FloatButton hidden = {hidden}>
  <a href={weiboShareUrl} target="_blank" id = "sidebar-share-with-weibo">
    <svg 
    fill="currentColor"
    stroke="currentColor"
    viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" ><path d="M457.3 543c-68.1-17.7-145 16.2-174.6 76.2-30.1 61.2-1 129.1 67.8 151.3 71.2 23 155.2-12.2 184.4-78.3 28.7-64.6-7.2-131-77.6-149.2z m-52 156.2c-13.8 22.1-43.5 31.7-65.8 21.6-22-10-28.5-35.7-14.6-57.2 13.7-21.4 42.3-31 64.4-21.7 22.4 9.5 29.6 35 16 57.3z m45.5-58.5c-5 8.6-16.1 12.7-24.7 9.1-8.5-3.5-11.2-13.1-6.4-21.5 5-8.4 15.6-12.4 24.1-9.1 8.7 3.2 11.8 12.9 7 21.5zM785.3 443.5c15 4.8 31-3.4 35.9-18.3 11.8-36.6 4.4-78.4-23.2-109-27.6-30.6-68.4-42.3-106-34.3-15.4 3.3-25.2 18.4-21.9 33.8 3.3 15.3 18.4 25.2 33.8 21.8 18.4-3.9 38.3 1.8 51.9 16.7 13.5 15 17.2 35.4 11.3 53.3-4.9 15.1 3.2 31.1 18.2 36z"></path><path d="M885.1 237.5c-56.7-62.9-140.4-86.9-217.7-70.5-17.9 3.8-29.3 21.4-25.4 39.3 3.8 17.9 21.4 29.3 39.3 25.5 55-11.7 114.4 5.4 154.8 50.1 40.3 44.7 51.2 105.7 34 159.1-5.6 17.4 3.9 36 21.3 41.7 17.4 5.6 36-3.9 41.6-21.2v-0.1c24.1-75.4 8.9-161.1-47.9-223.9zM729 499c-12.2-3.6-20.5-6.1-14.1-22.1 13.8-34.7 15.2-64.7 0.3-86-28-40.1-104.8-37.9-192.8-1.1 0 0-27.6 12.1-20.6-9.8 13.5-43.5 11.5-79.9-9.6-101-47.7-47.8-174.6 1.8-283.5 110.6C127.3 471.1 80 557.5 80 632.2 80 775.1 263.2 862 442.5 862c235 0 391.3-136.5 391.3-245 0-65.5-55.2-102.6-104.8-118zM443 810.8c-143 14.1-266.5-50.5-275.8-144.5-9.3-93.9 99.2-181.5 242.2-195.6 143-14.2 266.5 50.5 275.8 144.4C694.4 709 586 796.6 443 810.8z"></path></svg>
  </a>
</FloatButton> --><div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpersistenthistorytracking%2F&#38;title=%E5%9C%A8%20CoreData%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%8C%81%E4%B9%85%E5%8C%96%E5%8E%86%E5%8F%B2%E8%B7%9F%E8%B8%AA%0A%20%23ios%20%23swift%0A%20by%20%40fatbobman%0A" target="_blank" id="sidebar-share-with-weibo"> <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <path d="M457.3 543c-68.1-17.7-145 16.2-174.6 76.2-30.1 61.2-1 129.1 67.8 151.3 71.2 23 155.2-12.2 184.4-78.3 28.7-64.6-7.2-131-77.6-149.2z m-52 156.2c-13.8 22.1-43.5 31.7-65.8 21.6-22-10-28.5-35.7-14.6-57.2 13.7-21.4 42.3-31 64.4-21.7 22.4 9.5 29.6 35 16 57.3z m45.5-58.5c-5 8.6-16.1 12.7-24.7 9.1-8.5-3.5-11.2-13.1-6.4-21.5 5-8.4 15.6-12.4 24.1-9.1 8.7 3.2 11.8 12.9 7 21.5zM785.3 443.5c15 4.8 31-3.4 35.9-18.3 11.8-36.6 4.4-78.4-23.2-109-27.6-30.6-68.4-42.3-106-34.3-15.4 3.3-25.2 18.4-21.9 33.8 3.3 15.3 18.4 25.2 33.8 21.8 18.4-3.9 38.3 1.8 51.9 16.7 13.5 15 17.2 35.4 11.3 53.3-4.9 15.1 3.2 31.1 18.2 36z"></path><path d="M885.1 237.5c-56.7-62.9-140.4-86.9-217.7-70.5-17.9 3.8-29.3 21.4-25.4 39.3 3.8 17.9 21.4 29.3 39.3 25.5 55-11.7 114.4 5.4 154.8 50.1 40.3 44.7 51.2 105.7 34 159.1-5.6 17.4 3.9 36 21.3 41.7 17.4 5.6 36-3.9 41.6-21.2v-0.1c24.1-75.4 8.9-161.1-47.9-223.9zM729 499c-12.2-3.6-20.5-6.1-14.1-22.1 13.8-34.7 15.2-64.7 0.3-86-28-40.1-104.8-37.9-192.8-1.1 0 0-27.6 12.1-20.6-9.8 13.5-43.5 11.5-79.9-9.6-101-47.7-47.8-174.6 1.8-283.5 110.6C127.3 471.1 80 557.5 80 632.2 80 775.1 263.2 862 442.5 862c235 0 391.3-136.5 391.3-245 0-65.5-55.2-102.6-104.8-118zM443 810.8c-143 14.1-266.5-50.5-275.8-144.5-9.3-93.9 99.2-181.5 242.2-195.6 143-14.2 266.5 50.5 275.8 144.4C694.4 709 586 796.6 443 810.8z"></path> </svg> </a>  </div> <div class="hidden opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:16px; height:16px;">  <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpersistenthistorytracking%2F" target="_blank" id="sidebar-share-with-linkedin"> <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 15 15"> <path fill-rule="evenodd" d="M7.979 5v1.586a3.5 3.5 0 0 1 3.082-1.574C14.3 5.012 15 7.03 15 9.655V15h-3v-4.738c0-1.13-.229-2.584-1.995-2.584-1.713 0-2.005 1.23-2.005 2.5V15H5.009V5h2.97ZM3 2.487a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" clip-rule="evenodd"></path> <path d="M3 5.012H0V15h3V5.012Z"></path> </svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="mailto:?subject=%E6%96%87%E7%AB%A0%3A%E3%80%90%E5%9C%A8%20CoreData%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%8C%81%E4%B9%85%E5%8C%96%E5%8E%86%E5%8F%B2%E8%B7%9F%E8%B8%AA%E3%80%91&#38;body=%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E7%BB%99%E4%BD%A0%EF%BC%9A%0A%0A%E5%9C%A8%20CoreData%20%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%8C%81%E4%B9%85%E5%8C%96%E5%8E%86%E5%8F%B2%E8%B7%9F%E8%B8%AA%0A%0A%E9%93%BE%E6%8E%A5%3A%20https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpersistenthistorytracking%2F" target="_blank" id="sidebar-share-with-email"> <svg fill="currentColor" stroke="currentColor" stroke-width="4" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <path d="M874.666667 181.333333H149.333333c-40.533333 0-74.666667 34.133333-74.666666 74.666667v512c0 40.533333 34.133333 74.666667 74.666666 74.666667h725.333334c40.533333 0 74.666667-34.133333 74.666666-74.666667V256c0-40.533333-34.133333-74.666667-74.666666-74.666667z m-725.333334 64h725.333334c6.4 0 10.666667 4.266667 10.666666 10.666667v25.6L512 516.266667l-373.333333-234.666667V256c0-6.4 4.266667-10.666667 10.666666-10.666667z m725.333334 533.333334H149.333333c-6.4 0-10.666667-4.266667-10.666666-10.666667V356.266667l356.266666 224c4.266667 4.266667 10.666667 4.266667 17.066667 4.266666s12.8-2.133333 17.066667-4.266666l356.266666-224V768c0 6.4-4.266667 10.666667-10.666666 10.666667z"></path> </svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" onclick="scrollToElement()" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M573 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40zM293 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40z" p-id="13138"></path><path d="M894 345c-48.1-66-115.3-110.1-189-130v0.1c-17.1-19-36.4-36.5-58-52.1-163.7-119-393.5-82.7-513 81-96.3 133-92.2 311.9 6 439l0.8 132.6c0 3.2 0.5 6.4 1.5 9.4 5.3 16.9 23.3 26.2 40.1 20.9L309 806c33.5 11.9 68.1 18.7 102.5 20.6l-0.5 0.4c89.1 64.9 205.9 84.4 313 49l127.1 41.4c3.2 1 6.5 1.6 9.9 1.6 17.7 0 32-14.3 32-32V753c88.1-119.6 90.4-284.9 1-408zM323 735l-12-5-99 31-1-104-8-9c-84.6-103.2-90.2-251.9-11-361 96.4-132.2 281.2-161.4 413-66 132.2 96.1 161.5 280.6 66 412-80.1 109.9-223.5 150.5-348 102z m505-17l-8 10 1 104-98-33-12 5c-56 20.8-115.7 22.5-171 7l-0.2-0.1C613.7 788.2 680.7 742.2 729 676c76.4-105.3 88.8-237.6 44.4-350.4l0.6 0.4c23 16.5 44.1 37.1 62 62 72.6 99.6 68.5 235.2-8 330z" p-id="13139"></path><path d="M433 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40z" p-id="13140"></path></svg>  </div> <script>
  var offset = 80
  function scrollToElement() {
    var gitalkContainer = document.getElementById('gitalk-container');
    if (gitalkContainer) {
      var topPosition = gitalkContainer.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: topPosition, behavior: 'smooth' });
    }
  }
</script> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" onclick="window.scrollTo({top:0,behavior:'smooth'})" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M862.464 161.536l-700.928 0c-30.976 0-56.096-25.12-56.096-56.096l0-28.064c0-30.944 25.12-56.064 56.096-56.064l700.896 0c30.976 0 56.096 25.12 56.096 56.064l0 28.032c0 31.008-25.12 56.096-56.096 56.096l0 0 0 0zM138.528 531.68c0 0 306.816-245.792 309.888-248.864 14.304-13.888 31.904-22.368 49.952-25.312 1.76-0.32 3.488-0.608 5.248-0.8 2.816-0.32 5.6-0.352 8.384-0.352 2.816-0.032 5.568 0.032 8.352 0.352 1.792 0.192 3.552 0.48 5.28 0.8 18.048 2.976 35.616 11.424 49.92 25.312 3.104 3.008 309.856 248.864 309.856 248.864 33.152 32.224 30.304 65.44-2.784 97.696s-77.376 3.04-110.496-29.216l-190.08-150.432 0 496.864c0 31.008-25.088 56.096-56.096 56.096l-28 0c-30.976 0-56.096-25.12-56.096-56.096l0-496.864-190.048 150.432c-33.088 32.288-77.408 61.536-110.496 29.216-33.056-32.256-35.872-65.44-2.816-97.696l0 0 0 0z"></path></svg>  </div> </div> </div>  </div>   </div> </main> </div> <footer> <footer class="bg-block"> <div class="mx-auto w-full max-w-3xl px-4 md:px-6"> <div class="container flex flex-col items-center pt-10"> <div class="flex flex-row justify-around w-full space-x-3"> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">网站</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://apps.apple.com/us/app/id1534513553" class="hover:text-secondary" target="_blank">健康笔记</a> <a href="https://discord.gg/zhou-zi-de-swiftji-shi-ben-967978112509935657" class="hover:text-secondary" target="_blank">Discord</a> <a href="/zh/posts/" class="hover:text-secondary">文章</a> <a href="/zh/tags/" class="hover:text-secondary">标签</a> <a href="/zh/collections/" class="hover:text-secondary">合集</a> <a href="/zh/snippet/" class="hover:text-secondary">小贴士</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">关注</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://weekly.fatbobman.com" class="hover:text-secondary">周报</a> <a href="https://x.com/fatbobman" class="hover:text-secondary" target="_blank">Twitter</a> <a href="https://mastodon.social/@fatbobman" class="hover:text-secondary" target="_blank">Mastodon</a> <a href="https://www.linkedin.com/in/fatbobman/" class="hover:text-secondary" target="_blank">Linkedin</a> <a href="https://bsky.app/profile/fatbobman.bsky.social" class="hover:text-secondary" target="_blank">Blue Sky</a> <a href="https://web.okjike.com/u/e32947ef-7751-4363-9456-b340eef2efd3" class="hover:text-secondary" target="_blank">
即刻
</a> <a href="https://github.com/fatbobman" class="hover:text-secondary" target="_blank">GitHub</a> <a href="/zh/rss.xml" class="hover:text-secondary hover:font-medium" target="_blank">RSS</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">信息</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="/zh/about/" class="hover:text-secondary">关于</a>  </div> </div> </div> <div class="pb-0"> <div class="flex items-center justify-center w-full px-6 pt-12 text-sm"> <span class="text-muted text-xs">Copyright © <span>2020-</span> 2025 <a href="https://x.com/fatbobman" class="border-b-secondary border-b-[1px]">Fatbobman Digital Limited</a>. All Rights
            Reserved.</span> </div> <div class="flex items-center justify-center w-full px-6 pt-2 text-sm pb-10"> <span> <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank" class="block text-xs text-muted">
辽ICP备20006550号-1
</a> </span> </div> </div> </div> </div> </footer> </footer> </div>   <!-- <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.js"></script> --><script type="module" src="/js/theme.js" defer></script> <script>(function(){const currentLang = "zh";

  function attachEvent(selector, event, fn) {
    const matches = typeof selector === 'string' ? document.querySelectorAll(selector) : selector;
    if (matches && matches.length) {
      matches.forEach((elem) => {
        elem.addEventListener(event, (e) => fn(e, elem), false);
      });
    }
  }

  // 为每个需要清除 focus 状态的按钮都添加一个 clear-focus 类, 下面的代码将在点击后自动移除 focus 状态
  document.addEventListener('DOMContentLoaded', (event) => {
    // 获取所有具有 'clear-focus' 类的按钮
    const buttons = document.querySelectorAll('.clear-focus');

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        setTimeout(() => {
          button.blur();
        }, 0);
      });
    });
  });

  window.onpageshow = function () {
    document.documentElement.classList.add('motion-safe:scroll-smooth');
  };
})();</script> <div id="docsearch-container-data" data-lang="zh" data-searchtext="搜索..."></div> <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script> <script src="/js/runsearch.js"></script> <!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5C7N4MF5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!-- End Google Tag Manager (noscript) --> </body></html>