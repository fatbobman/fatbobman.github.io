<!DOCTYPE html><html lang="zh"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="sitemap" href="/sitemap-index.xml"><!-- <link rel="shortcut icon" href={iconSVG.src} /> --><link rel="icon" type="image/png" sizes="16x16" href="/_astro/favicon-16x16.2312221518-2.4YWPtmqG.png"><link rel="icon" type="image/png" sizes="32x32" href="/_astro/favicon-32x32.2312221518-2.W1M1HUWf.png"><link rel="mask-icon" href="/_astro/faviconSVG-32x32.2312221518-2.JZf4E4CU.svg"><link rel="apple-touch-icon" sizes="180x180" href="/_astro/apple-touch-icon.2312227635.RNVrzb6f.png"><title>Swift Predicate - 用法、构成及注意事项 | 肘子的 Swift 记事本</title>
<meta name="description" content="深入剖析Swift Predicate用法、构成及注意事项，掌握使用技巧，解决SwiftData应用中的限制，高效进行数据筛选和逻辑判断。">
<meta name="robots" content="index,follow">
<link rel="canonical" href="https://fatbobman.com/zh/posts/swift-predicate-usage-composition-and-considerations/">
<meta property="og:title" content="Swift Predicate - 用法、构成及注意事项 | 肘子的 Swift 记事本">
<meta property="og:description" content="深入剖析Swift Predicate用法、构成及注意事项，掌握使用技巧，解决SwiftData应用中的限制，高效进行数据筛选和逻辑判断。">
<meta property="og:url" content="https://fatbobman.com/zh/posts/swift-predicate-usage-composition-and-considerations/">
<meta property="og:type" content="article">
<meta property="og:image" content="https://cdn.fatbobman.com/card/swift-predicate-usage-composition-and-considerations-zh.png">

<meta property="og:locale" content="zh">
<meta property="og:site_name" content="fatbobman.com">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@fatbobman">
<meta name="twitter:creator" content="@fatbobman"><link rel="alternate" type="application/rss+xml" title="RSS Feed for My Website" href="https://fatbobman.com/zh/rss.xml"><link rel="sitemap" href="/sitemap-index.xml"><meta name="keywords" content="Swift 编程,Swift Programming,SwiftUI 教程,SwiftUI Tutorials,Core Data 实践,Core Data Practices,SwiftData 应用,SwiftData Applications,iOS 开发,iOS Development,Swift UI 设计,Swift UI Design,Swift 性能优化,Swift Performance Optimization,Swift 编码技巧,Swift Coding Techniques,iOS 应用开发,iOS App Development,Swift 数据管理,Swift Data Management,SwiftUI 布局,SwiftUI Layout,SwiftUI 动画,SwiftUI Animation"><meta name="apple-mobile-web-app-title" content="肘子的博客"><link rel="alternate" hreflang="zh" href="https://fatbobman.com/zh/posts/swift-predicate-usage-composition-and-considerations/"><link rel="alternate" hreflang="en" href="https://fatbobman.com/en/posts/swift-predicate-usage-composition-and-considerations/"><!-- <BasicScripts /> --><!-- <script is:inline>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?14e5d60a3ea6276655f9d14c58b1fcd0";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script> --><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5C7N4MF5');</script> <!-- End Google Tag Manager --><script>
      // Immediately set theme before page renders
      if (
        localStorage.getItem('color-theme') === 'dark' ||
        (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
      }
    </script><link rel="stylesheet" href="/_astro/about.rOE2C0dG.css" />
<link rel="stylesheet" href="/_astro/about.h0meYZos.css" />
<link rel="stylesheet" href="/_astro/_slug_.EbA6AM4A.css" />
<style>.sticky[data-astro-cid-4wsjtibl]{position:fixed;top:0;left:50%;transform:translate(-50%);width:100%;max-width:100%}
</style><script type="module" src="/_astro/hoisted.aDTDKmSO.js"></script></head> <body class="antialiased text-default bg-page">  <div class="flex flex-col min-h-screen justify-between "> <div> <header> <div class="bg-block" id="wholeHeader" data-astro-cid-4wsjtibl> <div id="blogTitle"> <a href="/zh/"> <div class="flex space-x-4 mx-auto text-center pt-16 sm:pt-12 font-black w-[240px] sm:w-[300px] pb-6 sm:pb-1"> <svg class="text-heading" width="337" height="63"> <use href="/images/title-fatbobman.svg#main"></use> </svg> <svg class="text-primary mt-[-6px] sm:mt-[-5px]" width="130" height="91"> <use href="/images/title-blog.svg#main"></use> </svg> </div> </a> </div> <div class="bg-block z-50 shadow-custom-light dark:shadow-custom-dark" id="stickyHeader" data-astro-cid-4wsjtibl> <div class="max-w-5xl flex flex-wrap items-center justify-between mx-auto p-2 sm:p-0" data-astro-cid-4wsjtibl> <div class="flex space-x-2" data-astro-cid-4wsjtibl> <div id="lang-data" data-lang="zh" style="display: none;"></div> <button id="language-dropdown-button" data-dropdown-toggle="language-dropdown-menu" type="button" class="p-2 w-10 h-10 font-medium text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg"> ZH </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-page divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="language-dropdown-menu"> <ul class="py-2 font-medium text-sm" role="none"> <li> <a href="/en/posts/swift-predicate-usage-composition-and-considerations/" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
English
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="EN-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <a href="" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
中文
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="ZH-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <div class="border-t border-gray-200 dark:border-gray-800 w-4/5 mx-auto my-2"></div> <button class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem" id="set-default-lang"> <div class="inline-flex items-center"> 将中文设置为默认 </div> </button> </li> </ul> </div>  <button id="theme-dropdown-button" data-dropdown-toggle="theme-dropdown-menu" type="button" class="group p-2 w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <svg viewBox="0 0 24 24" id="theme_icon_system" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <svg viewBox="0 0 24 24" id="theme_icon_dark" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <svg viewBox="0 0 24 24" id="theme_icon_light" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="theme-dropdown-menu"> <ul class="py-2 font-medium" role="none"> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_light"> <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> <span class="ml-2 dark:hover:text-white">Light</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_dark"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <span class="ml-2 text-default dark:hover:text-white">Dark</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_system"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <span class="ml-2 dark:hover:text-white">System</span> </button> </li> </ul> </div> <script>
  (async () => {
    const { setTheme } = await import('/js/theme.js');
    // Use setTheme here
    // Change the icons inside the button based on previous settings
    // 如果 localStorage 里面有设置过 color-theme 的值, 则 themeToggleSystemIcon.classList.remove('hidden')
    function setThemeButton() {
      let theme = localStorage.getItem('color-theme');
      if (theme === 'dark') {
        themeToggleDarkIcon.classList.remove('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else if (theme === 'light') {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.remove('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.remove('hidden');
      }
    }

    // 监听暗黑模式的变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
      setThemeButton();
    });

    // 保证其他的页面也能够监听到 localStorage 的变化
    window.addEventListener('storage', function (event) {
      if (event.key === 'color-theme') {
        setThemeButton();
      }
    });

    function resetTheme() {
      setTheme();
      setThemeButton();
    }

    // 获取按钮
    var themeButtonLight = document.getElementById('theme_button_light');
    var themeButtonDark = document.getElementById('theme_button_dark');
    var themeButtonSystem = document.getElementById('theme_button_system');
    // 获取图标
    var themeToggleDarkIcon = document.getElementById('theme_icon_dark');
    var themeToggleLightIcon = document.getElementById('theme_icon_light');
    var themeToggleSystemIcon = document.getElementById('theme_icon_system');

    // Listen for clicks on the button themeToggleDarkIcon
    themeButtonDark.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'dark');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleLightIcon
    themeButtonLight.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'light');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleSystemIcon
    themeButtonSystem.addEventListener('click', function () {
      localStorage.removeItem('color-theme');
      resetTheme();
    });

    resetTheme();
  })();
</script> <div id="docsearch" class="group w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true" class="DocSearch-Search-Icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg> </div> </div> <button data-collapse-toggle="navbar-solid-bg" type="button" class="inline-flex items-center p-2 mx-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-solid-bg" aria-expanded="false" id="navbar-toggle-button"> <span class="sr-only">Open main menu</span> <svg class="w-5 h-5 text-default" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path> </svg> </button> <nav class="hidden w-full md:block md:w-auto px-4 z-40" id="navbar-solid-bg"> <ul class="flex flex-col font-bold mt-4 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent dark:bg-gray-800 md:dark:bg-transparent dark:border-gray-700"> <a href="/zh/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 首页 </a><a href="/zh/posts/" class="block py-2 px-3 md:p-0 rounded text-invert bg-secondary md:bg-transparent md:text-secondary md:dark:bg-transparent" aria-current="page"> 文章 </a><a href="/zh/weekly/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 周报 </a><a href="/zh/snippet/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 小贴士 </a><a href="/zh/about/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 关于 </a> </ul> </nav>  </div> </div> <div id="placeholder" class="hidden" data-astro-cid-4wsjtibl></div> </div> <script>(function(){const enableSticky = true;
const enableStickyInMobile = true;

  window.onload = function () {
    checkStickyHeader();
    stickySetup();
  };

  window.addEventListener('resize', stickySetup);

  function checkStickyHeader() {
    const title = document.getElementById('blogTitle');
    const stickyHeader = document.getElementById('stickyHeader');
    const placeholder = document.getElementById('placeholder');

    if (title && stickyHeader && placeholder) {
      const offset = title.offsetTop + title.offsetHeight;

      if (shouldStick() && window.scrollY >= offset) {
        stickyHeader.classList.add('sticky');
        placeholder.style.display = 'block';
        placeholder.style.height = `${stickyHeader.offsetHeight}px`;
      } else {
        stickyHeader.classList.remove('sticky');
        placeholder.style.display = 'none';
      }
    }
  }

  function shouldStick() {
    if (!enableSticky) return false;

    let isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (isMobile && !enableStickyInMobile) return false;

    return true;
  }

  function stickySetup() {
    window.onscroll = checkStickyHeader;
  }
})();</script>  </header> <main class="w-full mx-auto max-w-3xl p-4 md:p-6 "> <div class="container mx-auto space-y-6 sm:space-y-12">   <div class="mx-auto space-y-4 text-center py-10" style="width:80%"> <div class="flex mx-auto justify-center"> <div class="flex mx-auto justify-center"> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/zh/tags/SwiftData/">
#SwiftData </a><a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/zh/tags/Swift/">
#Swift </a> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/en/posts/swift-predicate-usage-composition-and-considerations/" id="language-switcher-for-topic"> #English </a> </div> </div> <h1 class="text-2xl font-bold leadi md:text-3xl text-heading">Swift Predicate: 用法、构成及注意事项</h1> <p class="text-sm text-default"> <a itemprop="author" href="https://x.com/intent/follow?screen_name=fatbobman" target="_blank" class="hover:text-secondary font-medium">东坡肘子</a> <!-- <time datetime={`${post.data.publishDate.toISOString()}`}>{date}</time> --> </p> <p class="text-xs text-muted"> 发表于 <time datetime="2024-02-29T00:12:00.000Z">2024 年 2 月 29 日</time>  </p> </div> <svg style="display: none;"> <symbol id="icon-clipboard" viewBox="0 0 1024 1024"> <path d="M426.666667 42.666667l170.666667 0q41.344 0 74.325333 23.850667t46.336 61.482667l50.005333 0q52.992 0 90.496 37.504t37.504 90.496l0 597.333333q0 52.992-37.504 90.496t-90.496 37.504l-512 0q-52.992 0-90.496-37.504t-37.504-90.496l0-597.333333q0-52.992 37.504-90.496t90.496-37.504l50.005333 0q13.312-37.674667 46.336-61.482667t74.325333-23.850667zM768 213.333333l-50.005333 0q-13.312 37.674667-46.336 61.482667t-74.325333 23.850667l-170.666667 0q-41.344 0-74.325333-23.850667t-46.336-61.482667l-50.005333 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333l0 597.333333q0 17.664 12.501333 30.165333t30.165333 12.501333l512 0q17.664 0 30.165333-12.501333t12.501333-30.165333l0-597.333333q0-17.664-12.501333-30.165333t-30.165333-12.501333zM597.333333 128l-170.666667 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333 12.501333 30.165333 30.165333 12.501333l170.666667 0q17.664 0 30.165333-12.501333t12.501333-30.165333-12.501333-30.165333-30.165333-12.501333z"></path> </symbol> <symbol id="icon-check" viewBox="0 0 1024 1024"> <path d="M421.858 683.366l401.796-448.518c18.66-20.828 50.668-22.586 71.498-3.928 20.828 18.66 22.586 50.67 3.928 71.498L463.638 788.494c-18.606 20.768-50.5 22.586-71.344 4.066l-263.29-233.924c-20.906-18.572-22.796-50.576-4.222-71.48 18.574-20.906 50.576-22.796 71.48-4.222L421.86 683.366z"></path> </symbol> </svg> <div class="relative" id="article-area"> <article class="prose dark:prose-invert mx-auto w-full"> <div> 
<p>NSPredicate 一直是 Apple 提供的一个强大工具，允许开发者通过定义复杂的逻辑条件以自然且高效的方式对数据集合进行筛选和评估。随着时间的推移，Swift 语言的不断成熟和发展，2023 年 Swift 社区着手使用纯 Swift 语言重构 Foundation 框架。在这一重大更新中，引入了基于 Swift 编码的新 Predicate 功能，标志着在数据处理和评估方面迈入了新的阶段。本文旨在探讨 Swift Predicate 的使用方法、构成以及在实际开发中应注意的关键事项。</p>
<div class="dynamic-ad-container pt-4"></div>
<h2 id="什么是谓词">什么是谓词</h2>
<p>在现代软件开发中，对数据进行高效且精确的筛选和评估是至关重要的。谓词（Predicate）作为一种强大的工具，允许开发者通过定义返回布尔值（true 或 false）的逻辑条件，来实现这一目标。这不仅在筛选集合或查找集合中的特定元素时发挥着核心作用，而且也是数据处理和业务逻辑实现的基石。</p>
<p>尽管苹果的 <code>NSPredicate</code> 提供了这种能力，但它依赖于 Objective-C 语法、存在容易出现运行时错误的风险以及面临平台限制等挑战，这些限制了其在不同环境下的应用范围和灵活性。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">class</span><span style="color:#8BE9FD"> MyObject</span><span style="color:#F8F8F2">: NSObject {</span></span>
<span class="line"><span style="color:#FF79C6">  @objc</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> name: </span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"><span style="color:#FF79C6">  init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">name</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    self</span><span style="color:#F8F8F2">.name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> name</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> object </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> MyObject</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">name</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// create NSPredicate</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSPredicate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">format</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">name = %@</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#8BE9FD">XCTAssertTrue</span><span style="color:#F8F8F2">(predicate.</span><span style="color:#8BE9FD">evaluate</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">with</span><span style="color:#F8F8F2">: object)) </span><span style="color:#6272A4">// true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> objs </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [object]</span></span>
<span class="line"><span style="color:#6272A4">// filter object by predicate</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> filteredObjs </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> (objs </span><span style="color:#FF79C6">as</span><span style="color:#F8F8F2"> NSArray).</span><span style="color:#8BE9FD">filtered</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">using</span><span style="color:#F8F8F2">: predicate) </span><span style="color:#FF79C6">as!</span><span style="color:#F8F8F2"> [MyObject]</span></span>
<span class="line"><span style="color:#8BE9FD">XCTAssertEqual</span><span style="color:#F8F8F2">(filteredObjs.</span><span style="color:#BD93F9">count</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span></span></code></pre></div>
<h3 id="swift-predicate-的引入与改进">Swift Predicate 的引入与改进</h3>
<p>为了克服这些限制并拓展谓词的应用范围，Swift 社区对 Foundation 框架进行了重构，引入了基于 Swift 语言的 Predicate 功能。这一新特性不仅摆脱了对 Objective-C 的依赖，还通过 Swift 的宏功能，简化了谓词的构建过程，如下所示：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">class</span><span style="color:#8BE9FD"> MyObject</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> name:</span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"><span style="color:#FF79C6">  init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">name</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    self</span><span style="color:#F8F8F2">.name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> name</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> object </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> MyObject</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">name</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">MyObject</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">.name </span><span style="color:#FF79C6">==</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#FF79C6">try</span><span style="color:#8BE9FD"> XCTAssertTrue</span><span style="color:#F8F8F2">(predicate.</span><span style="color:#8BE9FD">evaluate</span><span style="color:#F8F8F2">(object)) </span><span style="color:#6272A4">// true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> objs </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [object]</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> filteredObjs </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try</span><span style="color:#F8F8F2"> objs.</span><span style="color:#8BE9FD">filter</span><span style="color:#F8F8F2">(predicate)</span></span>
<span class="line"><span style="color:#8BE9FD">XCTAssertEqual</span><span style="color:#F8F8F2">(filteredObjs.</span><span style="color:#BD93F9">count</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">)</span></span></code></pre></div>
<p>在此示例中，我们通过 <code>#Predicate</code> 宏构建了一个逻辑条件。这种构建方式非常类似于撰写闭包代码，使得开发者能够以自然的方式构建出更加复杂的逻辑，例如：包含多个条件的谓词：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">MyObject</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ object </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">  object.name </span><span style="color:#FF79C6">==</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#FF79C6"> &amp;&amp;</span><span style="color:#F8F8F2"> object.name.</span><span style="color:#BD93F9">count</span><span style="color:#FF79C6"> &lt;</span><span style="color:#BD93F9"> 3</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">try</span><span style="color:#8BE9FD"> XCTAssertTrue</span><span style="color:#F8F8F2">(predicate.</span><span style="color:#8BE9FD">evaluate</span><span style="color:#F8F8F2">(object)) </span><span style="color:#6272A4">// false</span></span></code></pre></div>
<p>此外，现在的 <code>MyObject</code> 无需继承自 <code>NSObject</code> 或使用 <code>@objc</code> 标注其属性，以支持 KVC。当然，Swift Predicate 同样适用于仍继承自 <code>NSObject</code> 的类型。</p>
<h3 id="nspredicate-与-swift-predicate-的比较">NSPredicate 与 Swift Predicate 的比较</h3>
<p>相较于 NSPredicate，Swift Predicate 提供了诸多改进：</p>
<ul>
<li><strong>开源性与平台兼容性</strong>：支持跨平台使用，如 Linux 和 Windows。</li>
<li><strong>类型安全</strong>：利用 Swift 的类型检查减少运行时错误。</li>
<li><strong>开发效率</strong>：受益于 Xcode 支持，提高了代码编写的速度和准确性。</li>
<li><strong>语法自由度</strong>：提供更大的表达自由，不受 Objective-C 语法规则的限制。</li>
<li><strong>泛用性</strong>：可应用于所有 Swift 类型，不再限于继承自 NSObject 的类。</li>
<li><strong>现代 Swift 特性支持</strong>：支持 Sendable 和 Codable 等现代 Swift 特性，使其更适合当下的 Swift 编程范式。</li>
</ul>
<p>通过这些改进，Swift Predicate 不仅优化了开发者的工作流程，而且为 Swift 生态系统的扩展和成长开辟了新路径。</p>
<h2 id="swift-predicate-的主要构成">Swift Predicate 的主要构成</h2>
<p>在深入探讨 Swift Predicate 的使用方法和注意事项之前，首先需要对其结构进行一番了解。具体来说，我们应该明白 Predicate 是由哪些元素构成的，以及 Predicate 宏是如何发挥作用的。</p>
<h3 id="predicateexpression-协议">PredicateExpression 协议</h3>
<p><code>PredicateExpression</code> 协议（或者说是遵循该协议的具体类型）定义了表达式的条件逻辑。例如，它能够代表一个“小于”条件，该条件包含具体的逻辑判断，用以决定某个输入值是否小于给定的值。这一协议是构建 Swift Predicate 架构中最为关键的部分。<code>PredicateExpression</code> 协议的声明如下：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> protocol</span><span style="color:#8BE9FD;font-style:italic"> PredicateExpression</span><span style="color:#F8F8F2">&lt;Output&gt; {</span></span>
<span class="line"><span style="color:#FF79C6">    associatedtype</span><span style="color:#F8F8F2"> Output</span></span>
<span class="line"><span style="color:#F8F8F2">    </span></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> evaluate</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> bindings</span><span style="color:#F8F8F2">: PredicateBindings) </span><span style="color:#FF79C6">throws</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> Output</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>Foundation 提供了一系列<a href="https://developer.apple.com/documentation/foundation/predicateexpressions?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">预定义</a>的表达式类型，这些类型都遵循 <code>PredicateExpression</code> 协议，使得开发者能够直接利用 <code>PredicateExpressions</code> 下的类型或类型方法来构造谓词表达式。这为构建灵活而强大的条件评估逻辑铺平了道路。例如，若我们想构造一个代表数字 <code>4</code> 的表达式，相应的代码如下：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> express </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> PredicateExpressions.</span><span style="color:#8BE9FD;font-style:italic">Value</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">4</span><span style="color:#F8F8F2">)</span></span></code></pre></div>
<p><code>PredicateExpressions.Value</code> 的实现<a href="https://github.com/apple/swift-foundation/blob/b8ef4ce99ca7c5b8f39dbba7acb86721c916fb40/Sources/FoundationEssentials/Predicate/Expression.swift#L143?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">代码</a>如下所示：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> PredicateExpressions</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> struct</span><span style="color:#8BE9FD;font-style:italic"> Value</span><span style="color:#F8F8F2">&lt;</span><span style="color:#BD93F9;font-style:italic">Output</span><span style="color:#F8F8F2">&gt; : PredicateExpression {</span></span>
<span class="line"><span style="color:#FF79C6">        public</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> value: Output</span></span>
<span class="line"><span style="color:#F8F8F2">        </span></span>
<span class="line"><span style="color:#FF79C6">        public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> value</span><span style="color:#F8F8F2">: Output) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">            self</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">value</span><span style="color:#FF79C6"> =</span><span style="color:#F8F8F2"> value</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">        </span></span>
<span class="line"><span style="color:#FF79C6">        public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> evaluate</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> bindings</span><span style="color:#F8F8F2">: PredicateBindings) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> Output {</span></span>
<span class="line"><span style="color:#FF79C6">            return</span><span style="color:#BD93F9;font-style:italic"> self</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">value</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p><code>Value</code> 结构体直接封装了一个值，并在调用其 <code>evaluate</code> 方法时，简单地返回该被封装的值。这让 <code>Value</code> 成为了一种在谓词表达式中代表常量值的有效方式。</p>
<blockquote>
<p>需要特别指出的是，<code>PredicateExpression</code> 的 <code>evaluate</code> 方法可以返回任何类型的值，而不仅限于布尔类型。</p>
</blockquote>
<p>进一步，若我们需要定义一个表达 <code>3 &lt; 4</code> 条件的表达式，相应的代码示例如下：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> express </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> PredicateExpressions.</span><span style="color:#8BE9FD">build_Comparison</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#8BE9FD">  lhs</span><span style="color:#F8F8F2">: PredicateExpressions.</span><span style="color:#8BE9FD;font-style:italic">Value</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">3</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#8BE9FD">  rhs</span><span style="color:#F8F8F2">: PredicateExpressions.</span><span style="color:#8BE9FD;font-style:italic">Value</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">4</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#8BE9FD">  op</span><span style="color:#F8F8F2">: .lessThan</span></span>
<span class="line"><span style="color:#F8F8F2">)</span></span></code></pre></div>
<p>此代码片段将生成一个遵循 <code>PredicateExpression</code> 协议的类型实例：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">PredicateExpressions.Comparison</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">PredicateExpressions.</span><span style="color:#8BE9FD;font-style:italic">Value</span><span style="color:#FF79C6">&lt;</span><span style="color:#8BE9FD;font-style:italic">Int</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">, PredicateExpressions.</span><span style="color:#8BE9FD;font-style:italic">Value</span><span style="color:#FF79C6">&lt;</span><span style="color:#8BE9FD;font-style:italic">Int</span><span style="color:#FF79C6">&gt;&gt;</span></span></code></pre></div>
<p>调用此实例的 <code>evaluate</code> 方法时，将返回一个布尔值，即判断结果。</p>
<p>通过嵌套表达式的方式，开发者可以构建出极为复杂的逻辑判断。同时，所产生的类型表达式也相应地变得复杂。</p>
<blockquote>
<p>2024 年 6 月更新</p>
</blockquote>
<p>在 WWDC 2024 中，Foundation 的谓词系统引入了多项新功能，不仅增加了新的表达式方法，最为显著的改进是新增了 <code>#Expression</code> 宏，这大大简化了谓词表达式的构建过程。在之前的版本中，开发者仅在使用 <code>#Predicate</code> 宏时才能体验到构建的便捷性。现在，通过 <code>#Expression</code> 宏，即使是构建独立的表达式也能实现自然流畅的表达方式。</p>
<p><code>#Expression</code> 宏使得开发者可以通过多个独立的表达式来分别定义谓词，这不仅使构建复杂谓词更为清晰，还增强了表达式的可复用性。</p>
<p>与谓词只能返回布尔值不同，表达式可以返回任意类型。因此，在声明表达式时，开发者需要明确指定输入和输出类型。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> unplannedItemsExpression </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Expression</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">[BucketListItem], </span><span style="color:#8BE9FD;font-style:italic">Int</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> { items </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">    items.</span><span style="color:#8BE9FD">filter</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">        !</span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">.isInPlan</span></span>
<span class="line"><span style="color:#F8F8F2">    }.</span><span style="color:#BD93F9">count</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> today </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Date.now</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> tripsWithUnplannedItems </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Trip</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ trip</span></span>
<span class="line"><span style="color:#6272A4">    // The current date falls within the trip</span></span>
<span class="line"><span style="color:#F8F8F2">    (trip.startDate </span><span style="color:#FF79C6">..&lt;</span><span style="color:#F8F8F2"> trip.endDate).</span><span style="color:#8BE9FD">contains</span><span style="color:#F8F8F2">(today) </span><span style="color:#FF79C6">&amp;&amp;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // The trip has at least one BucketListItem</span></span>
<span class="line"><span style="color:#6272A4">    // where &#39;isInPlan&#39; is false</span></span>
<span class="line"><span style="color:#F8F8F2">    unplannedItemsExpression.</span><span style="color:#8BE9FD">evaluate</span><span style="color:#F8F8F2">(trip.bucketList) </span><span style="color:#FF79C6">&gt;</span><span style="color:#BD93F9"> 0</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<h3 id="predicate-结构体">Predicate 结构体</h3>
<p>Swift Predicate，即使通过宏定义，其核心依然是 <code>Predicate</code> 结构体。这个结构体负责将逻辑条件（由 <code>PredicateExpression</code> 实现）与具体的值相绑定。这种机制使得 <code>Predicate</code> 能够实例化具体的条件逻辑，并接受输入值以进行评估。</p>
<p>它的<a href="https://github.com/apple/swift-foundation/blob/b8ef4ce99ca7c5b8f39dbba7acb86721c916fb40/Sources/FoundationEssentials/Predicate/Predicate.swift#L14?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">定义</a>如下所示：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> struct</span><span style="color:#8BE9FD;font-style:italic"> Predicate</span><span style="color:#F8F8F2">&lt;</span><span style="color:#BD93F9;font-style:italic">each</span><span style="color:#BD93F9;font-style:italic"> Input</span><span style="color:#F8F8F2">&gt; : Sendable {</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> expression : </span><span style="color:#FF79C6">any</span><span style="color:#F8F8F2"> StandardPredicateExpression&lt;</span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#F8F8F2">&gt;</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> variable: (repeat PredicateExpressions.Variable&lt;each Input&gt;)</span></span>
<span class="line"><span style="color:#F8F8F2">    </span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> builder</span><span style="color:#F8F8F2">: (repeat PredicateExpressions.Variable&lt;each Input&gt;) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#FF79C6"> any</span><span style="color:#F8F8F2"> StandardPredicateExpression&lt;</span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#F8F8F2">&gt;) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.variable </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">repeat</span><span style="color:#F8F8F2"> PredicateExpressions.Variable</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">each Input</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.expression </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> builder</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">repeat</span><span style="color:#F8F8F2"> each variable)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">    </span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> evaluate</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> input</span><span style="color:#F8F8F2">: repeat each Input) </span><span style="color:#FF79C6">throws</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#8BE9FD;font-style:italic"> Bool</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">        try</span><span style="color:#F8F8F2"> expression.</span><span style="color:#8BE9FD">evaluate</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">            .</span><span style="color:#FF79C6">init</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">repeat</span><span style="color:#F8F8F2"> (each variable, each input))</span></span>
<span class="line"><span style="color:#F8F8F2">        )</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>主要特性包括：</p>
<ul>
<li><strong>布尔值返回限制</strong>：<code>Predicate</code> 专门处理返回布尔值的表达式。这意味着复杂的表达式树的最终结果必须是一个布尔值，以便于进行逻辑判断。</li>
<li><strong>构造过程</strong>：在构造 <code>Predicate</code> 时，必须提供一个闭包，该闭包接收 <code>PredicateExpressions.Variable</code> 类型参数，并返回一个遵循 <code>StandardPredicateExpression&lt;Bool&gt;</code> 协议的表达式。</li>
<li><strong><code>StandardPredicateExpression</code> 协议</strong>：这是对 <code>PredicateExpression</code> 协议的扩展，要求表达式同时遵循 <code>Codable</code> 和 <code>Sendable</code>。目前，官方只允许 Foundation 预置的表达式符合此协议。</li>
</ul>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> protocol</span><span style="color:#8BE9FD;font-style:italic"> StandardPredicateExpression</span><span style="color:#F8F8F2">&lt;Output&gt; : PredicateExpression, Codable, Sendable {}</span></span></code></pre></div>
<ul>
<li><strong>构造闭包和变量属性的高级特性</strong>：利用 Swift 的 <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0393-parameter-packs.md?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">Parameter Packs</a> 特性，<code>Predicate</code> 支持创建能同时处理多个泛型参数的谓词，这是 <code>NSPredicate</code> 所不具备的功能。</li>
</ul>
<p>比如，利用 <code>Predicate</code> 结构体和 <code>PredicateExpression</code> 协议，我们可以构造出一个用于比较两个整数 <code>n</code> 和 <code>m</code>（<code>n &lt; m</code>）的谓词示例：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#6272A4">// 定义闭包：比较两个整数值是否满足&quot;小于&quot;关系</span></span>
<span class="line"><span style="color:#6272A4">// 此闭包采用两个 PredicateExpressions.Variable&lt;Int&gt; 类型的参数，</span></span>
<span class="line"><span style="color:#6272A4">// 并构造一个表示&quot;小于&quot;比较逻辑的 PredicateExpression</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> express </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> { (</span><span style="color:#8BE9FD">value1</span><span style="color:#F8F8F2">: PredicateExpressions.Variable</span><span style="color:#FF79C6">&lt;</span><span style="color:#8BE9FD;font-style:italic">Int</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD">value2</span><span style="color:#F8F8F2">: PredicateExpressions.Variable</span><span style="color:#FF79C6">&lt;</span><span style="color:#8BE9FD;font-style:italic">Int</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">    PredicateExpressions.</span><span style="color:#8BE9FD">build_Comparison</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#8BE9FD">        lhs</span><span style="color:#F8F8F2">: value1,</span></span>
<span class="line"><span style="color:#8BE9FD">        rhs</span><span style="color:#F8F8F2">: value2,</span></span>
<span class="line"><span style="color:#8BE9FD">        op</span><span style="color:#F8F8F2">: .lessThan</span></span>
<span class="line"><span style="color:#F8F8F2">    )</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// 使用 express 闭包构造 Predicate 实例，</span></span>
<span class="line"><span style="color:#6272A4">// 其中 express 定义了评估逻辑，即判断第一个参数是否小于第二个参数</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Predicate {</span></span>
<span class="line"><span style="color:#8BE9FD">    express</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9;font-style:italic">$1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> n </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 3</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> m </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">// 评估 predicate：检查 n 是否小于 m，预期返回 true</span></span>
<span class="line"><span style="color:#FF79C6">try</span><span style="color:#8BE9FD"> XCTAssertTrue</span><span style="color:#F8F8F2">(predicate.</span><span style="color:#8BE9FD">evaluate</span><span style="color:#F8F8F2">(n, m))</span></span></code></pre></div>
<h3 id="predicate-宏">Predicate 宏</h3>
<p>与通过字符串构建的 <code>NSPredicate</code> 相比，虽然直接使用 <code>PredicateExpression</code> 和 <code>Predicate</code> 结构体构建谓词能够获得类型安全检查、代码自动完成等优势，但这种方式在效率上较低，编写和阅读的难度也相对较高，这无疑增加了开发者在创建谓词时的心智负担。</p>
<p>为了降低这种复杂性，Foundation 引入了 Predicate 宏（ <code>#Predicate</code>），旨在以更简洁、高效的方式帮助开发者构建 Swift Predicate。</p>
<p>仍以构建判断 <code>n &lt; m</code> 的谓词为例，通过使用宏可以大大地简化谓词的构建操作：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#8BE9FD;font-style:italic">Int</span><span style="color:#F8F8F2">,</span><span style="color:#8BE9FD;font-style:italic">Int</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#FF79C6"> &lt;</span><span style="color:#BD93F9;font-style:italic"> $1</span><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> n </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 3</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> m </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 4</span></span>
<span class="line"><span style="color:#FF79C6">try</span><span style="color:#8BE9FD"> XCTAssertTrue</span><span style="color:#F8F8F2">(predicate.</span><span style="color:#8BE9FD">evaluate</span><span style="color:#F8F8F2">(n,m)) </span><span style="color:#6272A4">// true</span></span></code></pre></div>
<p>在 Xcode 中，通过查看宏展开后生成的代码，我们可以清楚地看到宏如何简化了之前需要大量代码才能实现的逻辑。</p>
<p><picture>
                    <source media="(max-width: 479px)" srcset="https://cdn.fatbobman.com/image-20240225182917655-zipic.png?imageView2/0/w/500"/>
                    <source media="(max-width: 767px)" srcset="https://cdn.fatbobman.com/image-20240225182917655-zipic.png?imageView2/0/w/768"/>
                    <source media="(max-width: 1024px)" srcset="https://cdn.fatbobman.com/image-20240225182917655-zipic.png?imageView2/0/w/1024"/>
                    <img src="https://cdn.fatbobman.com/image-20240225182917655-zipic.png" alt="image-20240225182917655" loading="lazy" decoding="async"/>
                  </picture></p>
<p>Predicate 宏的<a href="https://github.com/apple/swift-foundation/blob/5b06c5d5ac15c6eb052ac1f91fc023d4299b5f66/Sources/FoundationMacros/PredicateMacro.swift?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">实现代码</a>大约有 1200 行，其只支持 Foundation 中预置的谓词表达式以及特定可用于谓词中的方法。在转换时，当遇到不支持的表达式类型、方法或找不到对应的表达式时会报错。</p>
<p>通过引入 Predicate 宏，Swift 提供了一种既简洁又强大的方式来构建复杂的谓词逻辑，它允许开发者以几乎原生 Swift 代码的形式直接构建出复杂的逻辑判断，显著提高了代码的可读性和可维护性。更重要的是，Predicate 宏的使用大幅减少了开发者构建复杂查询时的心智负担，使得开发工作流程更为流畅和高效。</p>
<h2 id="swift-predicate-构建的技巧与注意事项">Swift Predicate 构建的技巧与注意事项</h2>
<p>在了解了 Swift Predicate 的构成之后，我们可以更准确地掌握构建 Predicate 时的限制与技巧。</p>
<h3 id="全局函数的限制">全局函数的限制</h3>
<p>使用 Predicate 宏构建谓词时，需要注意宏的转换逻辑是将闭包代码转换为 Foundation 的预置 <code>PredicateExpress</code> 表达式。当前预置的 <code>PredicateExpress</code> 实现并不支持直接访问全局函数或类型方法或属性返回的数据。因此，在使用这类数据构建谓词时，应通过 <code>let</code> 关键字预先获取所需数据。例如：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">func</span><span style="color:#50FA7B"> now</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> Date {</span></span>
<span class="line"><span style="color:#F8F8F2">  .now</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Date</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#FF79C6"> &lt;</span><span style="color:#8BE9FD"> now</span><span style="color:#F8F8F2">()  } </span><span style="color:#6272A4">// Global functions are not supported in this predicate</span></span></code></pre></div>
<p>正确的方式是先获取函数或属性的值，再构建谓词：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> now </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> now</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Date</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#FF79C6"> &lt;</span><span style="color:#F8F8F2"> now  }</span></span></code></pre></div>
<p>同理，对于类型属性的直接访问也存在限制：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Date</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#FF79C6"> &lt;</span><span style="color:#F8F8F2"> Date.now  }</span></span>
<span class="line"><span style="color:#6272A4">// Key path cannot refer to static member &#39;now&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> now </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Date.now</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Date</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#FF79C6"> &lt;</span><span style="color:#F8F8F2"> now  }</span></span></code></pre></div>
<p>这是由于当前的谓词表达式仅支持实例属性的 KeyPath，并不支持类型属性。</p>
<h3 id="实例方法的限制">实例方法的限制</h3>
<p>与上一条相同，在谓词中直接调用实例方法（如 <code>.lowercased()</code>）也不受支持。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> A</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> name:</span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">A</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">.name.</span><span style="color:#8BE9FD">lowercased</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">==</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2"> } </span><span style="color:#6272A4">// The lowercased() function is not supported in this predicate</span></span></code></pre></div>
<p>在这种情况下，应使用 Swift Predicate 支持的内置方法，例如：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">A</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">.name.localizedLowercase </span><span style="color:#FF79C6">==</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2"> }</span></span></code></pre></div>
<p>目前可用的内置方法集合是相对有限的，这包括但不限于：<code>contains</code>、<code>allSatisfy</code>、<code>flatMap</code>、<code>filter</code>、<code>subscript</code>、<code>starts</code>、<code>min</code>、<code>max</code>、<code>localizedStandardContains</code>、<code>localizedCompare</code>、<code>caseInsensitiveCompare</code> 等。开发者应定期查阅苹果的 <a href="https://developer.apple.com/documentation/foundation/predicate?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">官方文档</a> 或直接参考 Predicate 宏的源代码，以获取对最新支持的方法的全面了解。</p>
<p>由于目前内置的方法并不全面，一些在 NSPredicate 中常见的谓词构建方式在 Swift Predicate 中可能尚未得到支持。这意味着，尽管 Swift Predicate 为构建类型安全且表达力强的谓词提供了强大的工具，但开发者可能仍需在某些场景下寻找替代方案或等待未来的扩展以覆盖更广泛的用例。</p>
<h3 id="支持创建多种泛型参数的谓词">支持创建多种泛型参数的谓词</h3>
<p>得益于 Parameter Packs 功能，Swift Predicate 为开发者提供了更高的灵活性，允许定义能够接收多种泛型参数的谓词。这种能力极大地扩展了谓词的适用场景，使得开发者能够轻松应对各种复杂的条件判断需求。</p>
<p>正如前文中构建的 <code>n &lt; m</code> 示例所展示的，这种方法不仅可以应用于单一类型的参数比较，还可以扩展到多个不同类型的参数，进一步增强了 Swift Predicate 相比传统 Swift 高阶函数的表达能力和灵活性。这一特性让 Swift Predicate 成为构建复杂逻辑判断的强大工具，同时保持代码的清晰性和类型安全。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> A</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> name:</span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> B</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> age: </span><span style="color:#8BE9FD;font-style:italic">Int</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">A,B</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ a,b </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">  !</span><span style="color:#F8F8F2">a.name.</span><span style="color:#BD93F9">isEmpty</span><span style="color:#FF79C6"> &amp;&amp;</span><span style="color:#F8F8F2"> b.age </span><span style="color:#FF79C6">&gt;</span><span style="color:#BD93F9"> 10</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<h3 id="通过嵌套机制创建复杂的判断逻辑">通过嵌套机制创建复杂的判断逻辑</h3>
<p>Swift Predicate 的设计允许开发者通过嵌套谓词表达式构建出结构复杂的谓词逻辑。这种能力使得在实现那些在 <code>NSPredicate</code> 中通常需要依赖子查询来完成的条件判断变得更加直观和简洁。如今，这些复杂的逻辑表达可以更加符合 Swift 语言的编程习惯，提高了代码的可读性和可维护性。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> Address</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> city:</span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> People</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> address:[Address]</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">People</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ people </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">  people.address.</span><span style="color:#8BE9FD">contains</span><span style="color:#F8F8F2"> { address </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">    address.city </span><span style="color:#FF79C6">==</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">Dalian</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<blockquote>
<p>当数据模型包含对多关系且为可选时，上述方法不起作用</p>
</blockquote>
<h3 id="支持构建包含可选值的谓词">支持构建包含可选值的谓词</h3>
<p>Swift Predicate 支持了可选值类型的使用，这是在处理数据模型中常见的可选属性时的一大优势。这种支持允许开发者直接在谓词逻辑中处理可选值，从而使得谓词表达式的书写更加直接和清晰。</p>
<p>例如，以下示例展示了如何在 Swift Predicate 中处理一个可选字符串属性，根据其是否以特定前缀开始来进行过滤：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Note</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> name </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9;font-style:italic"> $0</span><span style="color:#F8F8F2">.name {</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> name.</span><span style="color:#8BE9FD">starts</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">with</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">  } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#BD93F9"> false</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>对于希望深入了解如何在 Swift Predicate 中高效处理可选值的开发者，推荐阅读<a href="/zh/posts/how-to-handle-optional-values-in-swiftdata-predicates/" target="_blank">如何处理 SwiftData 谓词中的可选值</a>。</p>
<h3 id="swift-predicate-是线程安全的">Swift Predicate 是线程安全的</h3>
<p>Swift Predicate 的设计考虑到了并发编程的需求，确保了其线程安全性。通过遵循 <code>Sendable</code> 协议，Swift Predicate 支持在不同的执行上下文之间安全地传递。这一特性显著增强了 Swift Predicate 的实用性，使其能够适应现代 Swift 应用程序中对并发和异步编程的广泛需求。</p>
<h3 id="swift-predicate-支持序列化和反序列化">Swift Predicate 支持序列化和反序列化</h3>
<p>通过实现 <code>Codable</code> 协议，Swift Predicate 可以被转换成 JSON 或其他格式，从而实现数据的序列化与反序列化。这一特性对于需要将谓词条件保存至数据库或配置文件，或者需要在客户端与服务器之间共享谓词逻辑的应用场景尤为重要。</p>
<p>以下示例展示了如何将一个 <code>Predicate</code> 实例序列化为 JSON 数据，进而可以存储或传输：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> A</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> name:</span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">A</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">{ </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">.name </span><span style="color:#FF79C6">==</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">fatbobman</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#FF79C6">var</span><span style="color:#F8F8F2"> configuration </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">A</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">.EncodingConfiguration.standardConfiguration</span></span>
<span class="line"><span style="color:#F8F8F2">configuration.</span><span style="color:#8BE9FD">allowKeyPath</span><span style="color:#F8F8F2">(\A.name, </span><span style="color:#8BE9FD">identifier</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">name</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> data </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try</span><span style="color:#8BE9FD"> JSONEncoder</span><span style="color:#F8F8F2">().</span><span style="color:#8BE9FD">encode</span><span style="color:#F8F8F2">(predicate, </span><span style="color:#8BE9FD">configuration</span><span style="color:#F8F8F2">: configuration)</span></span></code></pre></div>
<h3 id="在构建复杂谓词时应注意其对编译时间的影响">在构建复杂谓词时，应注意其对编译时间的影响</h3>
<p>类似于在 SwiftUI 中构建界面时遇到的情况，在构建复杂的 Swift Predicate 表达式时，Swift 编译器需要处理并转换成一个庞大且复杂的类型。这个过程中，一旦表达式的复杂度超过了某个阈值，编译器在进行类型推断的时间将显著增加。</p>
<p>当发现编译时长受到影响时，开发者可以考虑将复杂的谓词声明放置在独立的 Swift 文件中。这样做不仅有助于组织和管理代码，还可以在一定程度上减少因频繁修改其他部分代码而触发的重新编译。</p>
<h3 id="尚不支持使用自定义谓词表达式构建谓词">尚不支持使用自定义谓词表达式构建谓词</h3>
<p>目前，尽管开发者可以创建符合 <code>PredicateExpress</code> 协议的自定义表达式类型，但官方并不允许自定义表达式符合 <code>StandardPredicateExpression</code> 协议。因此，虽然可以创建自定义表达式类型，但在构建谓词时无法直接使用这些自定义表达式。</p>
<p>即使开发者将自定义表达式标注为遵循 <code>StandardPredicateExpression</code> 协议，但是 Predicate 宏目前仅支持使用 Foundation 中预置的 <code>StandardPredicateExpression</code> 实现。这一限制使得开发者无法在 Predicate 宏中使用自定义表达式，从而导致无法利用自定义表达式构建谓词。</p>
<h3 id="尚不支持将多个谓词组合成更加复杂的谓词">尚不支持将多个谓词组合成更加复杂的谓词</h3>
<p>在构建 <code>NSPredicate</code> 时，开发者可以通过 <code>NSCompoundPredicate</code> 将多个简单逻辑的 <code>NSPredicate</code> 灵活组合成更复杂的谓词。然而，Swift Predicate 目前尚未提供类似的能力，这在一定程度上限制了开发者构建复杂谓词的灵活性。</p>
<p>在之后的文章中，我将介绍如何在当前阶段通过 <code>PredicateExpress</code> 动态构建复杂的谓词，以满足特定的需求。这样的方法可能会在某些情况下提供一种替代方案，以应对当前不支持将多个谓词合并的局限性。</p>
<h2 id="在-swiftdata-中应用-swift-predicate">在 SwiftData 中应用 Swift Predicate</h2>
<p>SwiftData 和 Core Data 中使用 Predicate 作为数据检索条件是许多开发者的常见场景。理解 SwiftData 对 Swift Predicate 的处理方式对于最大化其效用至关重要。</p>
<h3 id="swiftdata-与-swift-predicate-的交互机制">SwiftData 与 Swift Predicate 的交互机制</h3>
<p>当在 SwiftData 中设置 <code>FetchDescriptor</code> 的 Predicate 时，SwiftData 并不直接采用 Swift Predicate 的评估机制。相反，它通过解析 Predicate 的 <code>express</code> 属性所定义的表达式树，并将这些表达式转换成 SQL 语句，以便从 SQLite 数据库检索数据。这意味着，在 SwiftData 环境中，评估操作实际上是通过 SQL 指令从 SQLite 数据库获取数据的过程，是在数据库端进行的。</p>
<h3 id="swiftdata-对谓词参数的限制">SwiftData 对谓词参数的限制</h3>
<p>SwiftData 要求每个 FetchDescriptor 必须对应一个具体的数据实体。因此，构建谓词时，相应的实体类型成为谓词的唯一参数，这一点对于有效利用 SwiftData 构建谓词至关重要。</p>
<h3 id="swiftdata-谓词构建的表达能力限制">SwiftData 谓词构建的表达能力限制</h3>
<p>虽然 Swift Predicate 提供了一个强大的框架用于数据筛选，但其在 SwiftData 环境中的表达能力相比于结合使用 NSPredicate 的 Core Data 有所限制。面对特定筛选需求时，开发者可能需要采用间接方法，例如执行多次筛选或在实体中预先添加适配当前谓词能力的特定属性。例如，由于内置的 <code>starts</code> 方法对大小写敏感，若需实现忽略大小写的匹配，推荐为筛选属性创建一个预处理版本（如全部转为小写），以支持更灵活的数据检索。</p>
<h3 id="谓词出现运行时错误">谓词出现运行时错误</h3>
<p>即使 Swift Predicate 在编译时没有错误，使用 SwiftData 进行数据检索时也可能遇到无法成功转换为 SQL 语句的情况，从而导致出现运行时错误。考虑以下示例：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Note</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">.id </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> noteID }</span></span>
<span class="line"><span style="color:#6272A4">// Runtime error：Couldn&#39;t find \Note.id on Note with fields</span></span></code></pre></div>
<p>虽然 <code>Note</code> 类型遵循 PersistentModel 协议，并且其 <code>id</code> 属性的类型也为 PersistentIdentifier，但 SwiftData 在讲谓词转换为 SQL 指令时却无法识别 <code>id</code> 属性。在这种情况下，开发者应使用 <code>persistentModelID</code> 属性进行比较（ 在进行谓词转换时，除了底层数据模型对应的属性外，<code>persistentModelID</code> 是为数不多的特别支持的属性 ）：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Note</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9;font-style:italic">$0</span><span style="color:#F8F8F2">.persistentModelID </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> noteID }</span></span></code></pre></div>
<p>此外，尝试在 PersistentModel 的属性上应用内置方法集时也可能遇到问题：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Note</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">  $0</span><span style="color:#F8F8F2">.name.localizedLowercase.</span><span style="color:#8BE9FD">starts</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">with</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">abc</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">.localizedLowercase)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"><span style="color:#6272A4">// Runtime error: Couldn&#39;t find \Note.name.localizedLowercase on Note with fields</span></span></code></pre></div>
<p>当 SwiftData 转换这些表达式时，很多内置方法同样也不适用于 PersistentModel 的属性，SwiftData 会错误地将其视为一个 <code>KeyPath</code>。因此，在当前阶段，开发者可能需要创建额外的属性（例如，属性的小写版本）来适应这种场景。</p>
<h3 id="获取不到预期结果的情况">获取不到预期结果的情况</h3>
<p>在某些情况下， Swift Predicate 能够顺利编译并在 SwiftData 环境下运行而不报错，却可能因为 SwiftData 转换了错误的 SQL 指令，导致无法检索到预期的结果。以下示例说明了这一点：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Item</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">  $0</span><span style="color:#F8F8F2">.note</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">.parent</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">.persistentModelID </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> rootNoteID</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>此谓词在编译和运行时都不会出现问题，但最终无法正确检索数据。为了解决这个问题，我们需要用其他的方式构建相同逻辑的谓词，确保它能够正确处理可选值，详情请见 <a href="/zh/posts/how-to-handle-optional-values-in-swiftdata-predicates/" target="_blank">如何处理 SwiftData 谓词中的可选值</a> 一文：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> predicate </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> #Predicate</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Item</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> note </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9;font-style:italic"> $0</span><span style="color:#F8F8F2">.note {</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> note.parent</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">.persistentModelID </span><span style="color:#FF79C6">==</span><span style="color:#F8F8F2"> rootNoteID</span></span>
<span class="line"><span style="color:#F8F8F2">  } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#BD93F9"> false</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<blockquote>
<p>正因如此，进行全面而及时的单元测试在构建 SwiftData 谓词时显得尤为重要。通过测试，开发者可以验证谓词的行为与预期是否一致，确保数据检索的准确性和应用的稳定性。</p>
</blockquote>
<div class="dynamic-ad-container pt-4"></div>
<h2 id="总结">总结</h2>
<p>Swift Predicate 为 Swift 开发者带来了一种强大且灵活的工具，使得数据筛选和逻辑判断变得更加直观和高效。通过本文的探讨，我希望开发者不仅能够充分掌握 Swift Predicate 的强大功能和使用方法，而且能够在面对挑战和限制时，找到创造性的解决方案。</p> </div> </article>  <!-- Modal toggle --><button data-modal-target="default-modal" data-modal-toggle="default-modal" class="hidden text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
Toggle modal
</button> <!-- Modal backdrop with flex centering --> <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center"> <div id="default-modal" class="hidden relative p-4 w-full max-w-2xl"> <!-- Modal content --> <div class="relative bg-white rounded-lg shadow-2xl dark:bg-gray-800 border-gray-200 border dark:border-gray-600"> <!-- Modal header --> <div class="flex items-center justify-between px-4 md:px-5 pt-4 pb-0 rounded-t dark:border-gray-600"> <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="default-modal"> <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path> </svg> <span class="sr-only">Close modal</span> </button> </div> <!-- Modal body --> <div class="px-4 md:px-5 pb-4"> <div class="w-full mx-auto text-center px-6 pb-6"> <div class="text-lg font-semibold text-gray-900 dark:text-blue-100 pt-4 pb-8">每周一，与您分享精心筛选的 Swift 与 SwiftUI 开发精华</div> <div id="custom-substack-embed1"></div> <!-- <div class="text-gray-700 dark:text-blue-200 text-xs font-medium pt-4">{bottomTip}</div> --> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };

    // 创建一个新的 MutationObserver 实例
    const observer = new MutationObserver((mutationsList, observer) => {
      // 遍历所有的 mutations
      for (let mutation of mutationsList) {
        // 如果这个 mutation 是一个子节点的添加或删除
        if (mutation.type === 'childList') {
          // 查找订阅框
          const widget = document.querySelector('.custom-substack-widget1');
          if (widget) {
            // 查找 input 元素
            const input = widget.querySelector('input');
            const button = widget.querySelector('button');
            // 根据当前的颜色方案修改订阅框的样式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              // 暗黑模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            } else {
              // 正常模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            }

            if (window.matchMedia('(max-width: 640px)').matches) {
              // 屏幕尺寸小于 640px
              widget.style.maxWidth = '325px';
            } else {
              // 屏幕尺寸大于或等于 640px
              widget.style.maxWidth = '600px';
            }
            // 停止观察
            observer.disconnect();
          }
        }
      }
    });

    // 开始观察 #custom-substack-embed 元素的子节点的变化
    observer.observe(document.getElementById('custom-substack-embed1'), { childList: true });
  })();</script> <script src="/js/subscriber.js" async></script> </div> <div class="flex justify-center pb-6"> <button data-modal-hide="default-modal" type="button" class="text-gray-600 dark:text-gray-400 bg-transparent hover:text-gray-800 dark:hover:text-gray-200 font-medium rounded-lg text-sm px-8 py-2.5 text-center transition-colors">继续阅读</button> </div> </div> </div> </div> </div> <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "author": {
    "@type": "Person",
    "name": "Fatbobman",
    "url": "https://twitter.com/fatbobman"
  },
  "dateModified": "2024-02-29T00:12:00.000Z",
  "datePublished": "2024-02-29T00:12:00.000Z",
  "description": "深入剖析Swift Predicate用法、构成及注意事项，掌握使用技巧，解决SwiftData应用中的限制，高效进行数据筛选和逻辑判断。",
  "headline": "Swift Predicate: 用法、构成及注意事项",
  "image": {
    "@type": "ImageObject",
    "url": [
      {
        "url": "https://cdn.fatbobman.com/card/swift-predicate-usage-composition-and-considerations-zh.png"
      }
    ]
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fatbobman.com/zh/posts/swift-predicate-usage-composition-and-considerations/"
  },
  "url": "https://fatbobman.com/zh/posts/swift-predicate-usage-composition-and-considerations/",
  "publisher": {
    "@type": "Organization",
    "name": "Fatbobman's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fatbobman.com/images/blog-card.png"
    }
  }
}</script> <div class="w-full mx-auto text-center pb-0 sm:pb-6 pt-8"> <div id="custom-substack-embed"></div> <div class="text-xs font-medium text-heading p-4">为您每周带来有关 Swift 和 SwiftUI 的精选资讯！</div> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };
  
    const observer = new MutationObserver((mutationsList) => {
      const widget = document.querySelector('.custom-substack-widget');
      if (widget) {
        const input = widget.querySelector('input');
        const button = widget.querySelector('button');
  
        // 设置样式（合并暗黑模式与默认模式逻辑）
        const darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        widget.style.padding = '0.5rem';
        widget.style.borderRadius = '1.2rem';
        widget.style.border = '0.1px solid var(--aw-color-text-muted)';
        input.style.border = '0px solid #000';
        input.style.backgroundColor = 'var(--aw-background-color)';
        button.style.backgroundColor = 'var(--subscribe-button-background)';
        button.style.color = 'var(--subscribe-button-text)';
        button.style.borderRadius = '0.8rem';
        button.style.maxWidth = '100px';
        button.style.fontWeight = 'bold';
  
        // 响应式调整
        widget.style.maxWidth = window.matchMedia('(max-width: 640px)').matches
          ? '325px'
          : '400px';
  
        observer.disconnect(); // 停止观察
      }
    });
  
    // 开始观察
    observer.observe(document.getElementById('custom-substack-embed'), { childList: true });
  })();</script> <script src="https://substackapi.com/widget.js" defer></script> </div> <div class="pt-6 pb-6  dark:border-gray-700"> <!-- <p class="flex justify-center align-center text-sm font-medium text-heading">
    { lang === Lang.ZH && <SupportMeTextZH /> }
    { lang === Lang.EN && <SupportMeTextEN /> }
  </p> --> <div class="flex flex-col sm:flex-row justify-center items-center mx-auto sm:space-x-8 align-center pt-2"> <button type="button" class="text-gray-900 bg-yellow-200 hover:bg-yellow-300 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://www.buymeacoffee.com/fatbobman')"> <img src="/images/buymeacoffee.svg" alt="Buy me a coffee" class="w-5 h-5 me-2 -ms-1" decoding="async" loading="lazy"> <span class="text-black font-bold">Buy me a coffee</span> </button> <div class="pt-4 sm:pt-0"> <button type="button" class="text-red-500 bg-[#3b82f6] hover:bg-blue-700 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://afdian.com/a/fatbobman')"> <img src="/images/aifadian.svg" alt="" width="18" height="18" loading="lazy" decoding="async" class="w-4 h-4 me-2 -ms-1" aria-hidden="true"> <span class="text-white font-bold">爱发电(微信/支付宝)</span> </button>  </div> </div> </div> <!-- <WeeklySubscribe1 lang={lang} top={0} bottom={4}/> --> <div id="copy-alert" class="hidden fixed bottom-28 right-5"> <div id="alert-1" class="flex items-center p-4 mb-4 text-blue-800 rounded-lg bg-blue-50/90 dark:bg-gray-800/90 dark:text-blue-400" role="alert"> <div class="text-sm font-medium">链接已复制</div> </div> </div> <style>
  .copy-icon {
    position: absolute;
    left: -30px; /* 根据您的布局调整位置 */
    top: 50%; /* 将图标定位到标题的中间高度 */
    transform: translateY(-50%); /* 垂直居中对齐图标 */
    cursor: pointer;
    transition: opacity 0.6s ease;
    pointer-events: all; /* 始终响应鼠标事件 */
  }

  article h2,
  article h3,
  article h4,
  article h5 {
    position: relative;
  }

  #copy-alert {
    position: fixed;
    bottom: -100px; /* 初始在视窗下方 */
    right: 20px;
    transition: bottom 0.5s ease-in-out;
  }

  /* 进入动画 */
  @keyframes slideIn {
    from {
      bottom: -100px;
    }
    to {
      bottom: 0px;
    }
  }

  /* 消失动画 */
  @keyframes slideOut {
    from {
      bottom: 20px;
    }
    to {
      bottom: -100px;
    }
  }
</style> <script>
  var hideTimeout; // 用于保存自动隐藏定时器的引用
  document.querySelectorAll('article h2, article h3, article h4, article h5').forEach(function (header) {
    var copyIcon = document.createElement('span');
    copyIcon.innerHTML =
      '<svg fill="currentColor" aria-hidden="true" stroke="currentColor" class="w-5 h-5 hidden md:block hover:text-secondary" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M861.866667 164.266667c-87.466667-87.466667-230.4-89.6-320-2.133334l-68.266667 68.266667c-12.8 12.8-12.8 32 0 44.8s32 12.8 44.8 0l68.266667-68.266667c64-61.866667 166.4-61.866667 230.4 2.133334 64 64 64 168.533333 2.133333 232.533333l-117.333333 119.466667c-34.133333 34.133333-81.066667 51.2-128 49.066666-46.933333-4.266667-91.733333-27.733333-119.466667-66.133333-10.666667-14.933333-29.866667-17.066667-44.8-6.4-14.933333 10.666667-17.066667 29.866667-6.4 44.8 40.533333 53.333333 100.266667 87.466667 166.4 91.733333h17.066667c59.733333 0 119.466667-23.466667 162.133333-68.266666l117.333333-119.466667c83.2-89.6 83.2-234.666667-4.266666-322.133333z"></path><path d="M505.6 750.933333l-66.133333 68.266667c-64 61.866667-166.4 61.866667-230.4-2.133333-64-64-64-168.533333-2.133334-232.533334l117.333334-119.466666c34.133333-34.133333 81.066667-51.2 128-49.066667 46.933333 4.266667 91.733333 27.733333 119.466666 66.133333 10.666667 14.933333 29.866667 17.066667 44.8 6.4 14.933333-10.666667 17.066667-29.866667 6.4-44.8-40.533333-53.333333-100.266667-87.466667-166.4-91.733333-66.133333-4.266667-130.133333 19.2-177.066666 66.133333l-117.333334 119.466667c-85.333333 89.6-85.333333 234.666667 2.133334 322.133333 44.8 44.8 102.4 66.133333 162.133333 66.133334 57.6 0 115.2-21.333333 160-64l66.133333-68.266667c12.8-12.8 12.8-32 0-44.8-14.933333-10.666667-34.133333-10.666667-46.933333 2.133333z"></path></svg>'; // 使用您选择的图标
    copyIcon.className = 'copy-icon';
    copyIcon.style.opacity = '0'; // 默认透明
    header.insertBefore(copyIcon, header.firstChild);

    header.addEventListener('mouseover', function () {
      copyIcon.style.opacity = '1';
    });
    header.addEventListener('mouseout', function () {
      copyIcon.style.opacity = '0';
    });

    copyIcon.addEventListener('click', function () {
        var url = window.location.href.split('#')[0] + '#' + header.id;
        navigator.clipboard.writeText(url).then(function () {
            var alertDiv = document.getElementById('copy-alert');
            if (alertDiv) {
                alertDiv.classList.remove('hidden'); // 确保提示框是可见的
                alertDiv.style.display = 'block'; // 显示提示框
                clearTimeout(hideTimeout); // 清除之前的定时器
                alertDiv.style.animation = 'none'; // 先清除之前的动画
                setTimeout(function () {
                    alertDiv.style.animation = 'slideIn 0.5s forwards'; // 应用新动画
                }, 10);

                // 设置自动隐藏定时器
                hideTimeout = setTimeout(function () {
                    alertDiv.style.animation = 'slideOut 0.5s forwards'; // 应用消失动画
                    setTimeout(function () {
                        alertDiv.style.display = 'none';
                    }, 500);
                }, 3000);
            }
        });
    });
  });
</script> <script>
function copyCode(button, event) {
  event.preventDefault();
  const codeBlock = button.parentNode.nextElementSibling.textContent; // 获取代码内容
  navigator.clipboard.writeText(codeBlock).then(() => {
    // 显示 "Copied"
    button.querySelector('.copy-text').style.display = 'none';
    button.querySelector('.copied-text').style.display = 'inline';

    // 3秒后恢复
    setTimeout(() => {
      button.querySelector('.copy-text').style.display = 'inline';
      button.querySelector('.copied-text').style.display = 'none';
    }, 3000);
  });
}
</script> <script>(function(){const url = "https://fatbobman.com/ads/zh";

  const adCacheKey = 'dynamicAdCache';

  // 尝试从缓存中获取广告
  const cachedAd = JSON.parse(localStorage.getItem(adCacheKey));
  const now = Date.now();

  if (cachedAd && cachedAd.expiresAt > now) {
    console.log('Using cached ad');
    console.log(cachedAd.expiresAt - now);
    // 如果缓存有效，直接使用缓存的广告
    renderAd(cachedAd.content);
  } else {
    console.log('Fetching ad from the server');
    // 如果缓存无效，从服务器获取广告
    fetch(url, {
      headers: {
        'Accept': 'text/html',
      },
      cache: 'default'
    })
      .then(response => {
        const maxAgeMatch = response.headers.get('Cache-Control')?.match(/max-age=(\d+)/);
        const maxAge = maxAgeMatch ? parseInt(maxAgeMatch[1], 10) : 0;

        if (!response.ok || maxAge <= 0) {
          throw new Error('Invalid response or missing Cache-Control');
        }

        return response.text().then(adContent => {
          const expiresAt = now + maxAge * 1000; // 计算失效时间
          // 缓存广告内容
          localStorage.setItem(adCacheKey, JSON.stringify({ content: adContent, expiresAt }));
          // 渲染广告
          renderAd(adContent);
        });
      })
      .catch(error => console.error('Error loading the ad:', error));
  }

  // 渲染广告函数
  function renderAd(html) {
    const adSlots = document.querySelectorAll('.dynamic-ad-container');
    adSlots.forEach(slot => {
      slot.innerHTML = html;
    });
  }
})();</script>  <!-- <LeaveFeedback lang={lang} /> --> <section class="pt-10"><div class="max-w-5xl sm:px-4 py-2 mx-auto"><div class="grid gap-4 sm:gap-2 sm:mx-4 sm:grid-cols-12"><div class="col-span-12 sm:col-span-3 hidden sm:block"><div class="text-center sm:text-left mt-3 mb-14 before:block before:w-24 before:h-1 before:mb-3 before:rounded before:mx-auto sm:before:mx-0 before:bg-secondary"><h3 class="text-lg font-medium text-default">相关文章</h3></div></div><div class="sm:hidden text-lg font-medium text-heading col-span-12 text-left">相关文章</div><div class="relative col-span-12 sm:px-4 space-y-6 sm:col-span-9"><div class="col-span-12 space-y-2 relative sm:px-4 sm:col-span-8 sm:space-y-4 sm:before:absolute sm:before:top-2 sm:before:bottom-0 sm:before:w-0.5 sm:before:-left-3 before:bg-block"><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/how-to-handle-optional-values-in-swiftdata-predicates/" id="relatedPosts-如何处理 SwiftData 谓词中的可选值"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">如何处理 SwiftData 谓词中的可选值</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/weekly/issue-061" id="relatedPosts-Weekly #61 - 离开手机的两个小时"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">Weekly #61 - 离开手机的两个小时</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/how-to-dynamically-construct-complex-predicates-for-swiftdata/" id="relatedPosts-如何为 SwiftData 动态的构建复杂的谓词"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">如何为 SwiftData 动态的构建复杂的谓词</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/use-core-data-features-in-swiftdata-by-swiftdatakit/" id="relatedPosts-SwiftDataKit：让你在 SwiftData 中使用 Core Data 的高级功能"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftDataKit：让你在 SwiftData 中使用 Core Data 的高级功能</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/from-data-model-construction-to-managed-object-instances-in-core-data/" id="relatedPosts-CoreData 探秘 - 从数据模型构建到托管对象实例"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">CoreData 探秘 - 从数据模型构建到托管对象实例</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/persistent-history-tracking-in-swiftdata/" id="relatedPosts-如何通过 Persistent History Tracking 观察 SwiftData 的数据变化"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">如何通过 Persistent History Tracking 观察 SwiftData 的数据变化</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/relationships-in-swiftdata-changes-and-considerations/" id="relatedPosts-SwiftData 中的关系：变化与注意事项"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData 中的关系：变化与注意事项</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/concurret-programming-in-swiftdata/" id="relatedPosts-SwiftData 中的并发编程"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData 中的并发编程</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/what-s-new-in-core-data-in-wwdc23/" id="relatedPosts-WWDC 2023 Core Data 有哪些新变化"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">WWDC 2023 Core Data 有哪些新变化</h3></div></a></div></div></div></div></section> <!-- <BottomWeeklySubscribe lang={lang} /> --> <div><div id="gitalk-container" data-comment-id="Swift Predicate: 用法、构成及注意事项" data-lang="zh"></div><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" defer></script></div><script>
      document.addEventListener('DOMContentLoaded', async function () {
        const response = await fetch('https://fatbobman.com/status/comment');
        const data = await response.text();
        console.log(data);
        if (data === '1') {
          var container = document.getElementById('gitalk-container');
          if (container) {
            var commentID = container.getAttribute('data-comment-id');
            var lang = container.getAttribute('data-lang');

            var gitalk = new Gitalk({
              clientID: 'fcf61195c7f73253dc8b',
              clientSecret: '0ac2907be08248a1fcb5312e27480ad535c682e5',
              repo: 'blogComments',
              owner: 'fatbobman',
              admin: ['fatbobman'],
              id: commentID.split('/').pop().substring(0, 49),
              distractionFreeMode: true,
              createIssueManually: true,
              language: lang,
            });

            gitalk.render('gitalk-container');
          }
        }
      });
    </script> <div class="hidden xl:block w-44 lg:absolute" id="toc" style="left: -30px; top: 0px"> <div class="text-muted items-center justify-center overflow-x-clip"> <div class="w-full flex justify-end pb-2" id="toc-button"> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" id="toc-list-switcher"> <use href="/images/iconCollection.svg#icon-toc"></use> </svg>  </div> </div> <div class="text-default text-xs hidden" id="toc-list"> <ul> <li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#什么是谓词" class=""> 什么是谓词 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swift-predicate-的引入与改进" class=""> Swift Predicate 的引入与改进 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#nspredicate-与-swift-predicate-的比较" class=""> NSPredicate 与 Swift Predicate 的比较 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swift-predicate-的主要构成" class=""> Swift Predicate 的主要构成 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#predicateexpression-协议" class=""> PredicateExpression 协议 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#predicate-结构体" class=""> Predicate 结构体 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#predicate-宏" class=""> Predicate 宏 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swift-predicate-构建的技巧与注意事项" class=""> Swift Predicate 构建的技巧与注意事项 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#全局函数的限制" class=""> 全局函数的限制 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#实例方法的限制" class=""> 实例方法的限制 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#支持创建多种泛型参数的谓词" class=""> 支持创建多种泛型参数的谓词 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#通过嵌套机制创建复杂的判断逻辑" class=""> 通过嵌套机制创建复杂的判断逻辑 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#支持构建包含可选值的谓词" class=""> 支持构建包含可选值的谓词 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swift-predicate-是线程安全的" class=""> Swift Predicate 是线程安全的 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swift-predicate-支持序列化和反序列化" class=""> Swift Predicate 支持序列化和反序列化 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#在构建复杂谓词时应注意其对编译时间的影响" class=""> 在构建复杂谓词时，应注意其对编译时间的影响 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#尚不支持使用自定义谓词表达式构建谓词" class=""> 尚不支持使用自定义谓词表达式构建谓词 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#尚不支持将多个谓词组合成更加复杂的谓词" class=""> 尚不支持将多个谓词组合成更加复杂的谓词 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#在-swiftdata-中应用-swift-predicate" class=""> 在 SwiftData 中应用 Swift Predicate </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swiftdata-与-swift-predicate-的交互机制" class=""> SwiftData 与 Swift Predicate 的交互机制 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swiftdata-对谓词参数的限制" class=""> SwiftData 对谓词参数的限制 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swiftdata-谓词构建的表达能力限制" class=""> SwiftData 谓词构建的表达能力限制 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#谓词出现运行时错误" class=""> 谓词出现运行时错误 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#获取不到预期结果的情况" class=""> 获取不到预期结果的情况 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#总结" class=""> 总结 </a> </div> </li> </ul> </div> </div> </div> <style>
  #toc-list {
    transition: all 0.9s ease-in-out;
  }

  #toc-button {
    transition: all 0.9s ease-in-out;
  }
</style> <script>
  function getOffsetTop(element) {
    var offsetTop = 0;
    while (element) {
      offsetTop += element.offsetTop;
      element = element.offsetParent;
    }
    return offsetTop;
  }

  var toc = document.querySelector('#toc');
  // 获取 sidebar 在浏览器中的初始 top 值
  var initialTop = getOffsetTop(toc);
  var positioningElement = document.querySelector('#article-area'); // 定位视图的选择器
  var stickyPoint = 150;
  var tocPadding = 30;
  var tocTopOffset = 4;
  var sidebarWidth = toc.offsetWidth;

  function adjustTocPosition() {
    var sidebarOffsetTop = toc.getBoundingClientRect().top;
    if (sidebarOffsetTop <= stickyPoint) {
      // 获取 positioningElement 的左侧侧与浏览器左侧之间的距离
      var positioningElementRight = (window.innerWidth - positioningElement.getBoundingClientRect().width) / 2;
      toc.style.position = 'fixed';
      toc.style.top = stickyPoint + 'px';
      toc.style.left = positioningElementRight - toc.getBoundingClientRect().width - tocPadding + 'px';
    }

    if (window.scrollY <= initialTop - stickyPoint) {
      toc.style.position = 'absolute';
      toc.style.top = tocTopOffset + 'px';
      toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';
    }
  }

  document.addEventListener('scroll', adjustTocPosition);
  window.addEventListener('resize', adjustTocPosition);
  // doc 加载完成后，调整 toc 的位置
  toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';

  document.addEventListener('DOMContentLoaded', function () {
    const tocList = document.getElementById('toc-list');
    const tocButton = document.getElementById('toc-button');

    // 更新toc-list和toc-button的显示状态
    function updateDisplay() {
      const showToc = localStorage.getItem('showToc') === 'true';
      if (showToc) {
        tocList.classList.remove('hidden');
        tocButton.classList.add('justify-start');
        tocButton.classList.remove('justify-end');
      } else {
        tocList.classList.add('hidden');
        tocButton.classList.remove('justify-start');
        tocButton.classList.add('justify-end');
      }
    }

    // 初始状态检查
    updateDisplay();

    // 点击事件监听器，用于切换toc-list的显示状态并更新按钮位置
    tocButton.addEventListener('click', function () {
      const isHidden = tocList.classList.contains('hidden');
      localStorage.setItem('showToc', isHidden);
      updateDisplay();
    });
  });
</script> <div class="hidden md:block md:absolute" id="sidebar" style="right: -50px; top: 0px"> <div class="invisible flex flex-col space-y-4 text-muted items-center justify-center opacity-0 transition-all duration-1000 delay-300 ease-out" id="sidebar-content"> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <a href="/zh/posts/how-to-handle-optional-values-in-swiftdata-predicates/" data-tooltip-target="tooltip-next-post" data-tooltip-placement="left" id="sidebar-next-post" class=""> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <use href="/images/iconCollection.svg#icon-previous"></use> </svg> </a>  </div> <div id="tooltip-next-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> <div> <div>如何处理 SwiftData 谓词中的可选值</div> <div class="text-xs text-yellow-200 font-extrabold pt-2">⌥ + ←</div> </div> <div class="tooltip-arrow" data-popper-arrow></div> </div> <script>(function(){const url = "/zh/posts/how-to-handle-optional-values-in-swiftdata-predicates/";
const isHidden = false;

  document.addEventListener('keydown', (e) => {
    // Check if Alt+RightArrow or just RightArrow was pressed
    if (e.altKey && e.key === 'ArrowLeft') {
      // Only navigate if there's a URL and the button isn't hidden
      if (url && !isHidden) {
        e.preventDefault(); // Prevent default browser behavior
        window.location.href = url;
      }
    }
  });
})();</script> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <a href="/zh/posts/how-to-dynamically-construct-complex-predicates-for-swiftdata/" data-tooltip-target="tooltip-previous-post" data-tooltip-placement="left" id="sidebar-previous-post" class=""> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <use href="/images/iconCollection.svg#icon-next"></use> <symbol id="icon-next" viewBox="0 0 24 24" fill="currentColor"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M12.089 3.634a2 2 0 0 0 -1.089 1.78l-.001 2.586h-6.999a2 2 0 0 0 -2 2v4l.005 .15a2 2 0 0 0 1.995 1.85l6.999 -.001l.001 2.587a2 2 0 0 0 3.414 1.414l6.586 -6.586a2 2 0 0 0 0 -2.828l-6.586 -6.586a2 2 0 0 0 -2.18 -.434l-.145 .068z" stroke-width="0" fill="currentColor"></path> </symbol> </svg> </a>  </div> <div id="tooltip-previous-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> <div> <div>如何为 SwiftData 动态的构建复杂的谓词</div> <div class="text-xs text-yellow-200 font-extrabold pt-2">⌥ + →</div> </div> <div class="tooltip-arrow" data-popper-arrow></div> </div> <script>(function(){const url = "/zh/posts/how-to-dynamically-construct-complex-predicates-for-swiftdata/";
const isHidden = false;

  document.addEventListener('keydown', (e) => {
    // Check if Alt+RightArrow or just RightArrow was pressed
    if (e.altKey && e.key === 'ArrowRight') {
      // Only navigate if there's a URL and the button isn't hidden
      if (url && !isHidden) {
        e.preventDefault(); // Prevent default browser behavior
        window.location.href = url;
      }
    }
  });
})();</script> <!-- <DictButton lang={lang} post = {post}/> --> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <a href="https://x.com/intent/tweet?text=Swift%20Predicate%3A%20%E7%94%A8%E6%B3%95%E3%80%81%E6%9E%84%E6%88%90%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9&#38;url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fswift-predicate-usage-composition-and-considerations%2F&#38;hashtags=ios%2Cswiftlang&#38;via=fatbobman" target="_blank" id="sidebar-share-with-twitter"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/images/iconCollection.svg#icon-twitter"></use> </svg> </a>  </div> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <a href="https://bsky.app/intent/compose?text=Swift%20Predicate%3A%20%E7%94%A8%E6%B3%95%E3%80%81%E6%9E%84%E6%88%90%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%0A by %40fatbobman.bsky.social %0Ahttps%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fswift-predicate-usage-composition-and-considerations%2F%0A #ios #swift" target="_blank" id="sidebar-share-with-bluesky"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="0.4" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <use href="/images/iconCollection.svg#icon-bluesky"></use> </svg> </a>  </div> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <a href="https://www.facebook.com/sharer/sharer.php?u=https%253A%252F%252Ffatbobman.com%252Fzh%252Fposts%252Fswift-predicate-usage-composition-and-considerations%252F" target="_blank" id="sidebar-share-with-facebook"> <svg stroke="currentColor" fill="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <use href="/images/iconCollection.svg#icon-facebook"></use> </svg> </a>  </div> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fswift-predicate-usage-composition-and-considerations%2F&#38;title=Swift%20Predicate%3A%20%E7%94%A8%E6%B3%95%E3%80%81%E6%9E%84%E6%88%90%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%0A%20%23ios%20%23swift%0A%20by%20%40fatbobman%0A" target="_blank" id="sidebar-share-with-weibo"> <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <use href="/images/iconCollection.svg#icon-weibo"></use> </svg> </a>  </div> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:16px; height:16px;">  <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fswift-predicate-usage-composition-and-considerations%2F" target="_blank" id="sidebar-share-with-linkedin"> <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="0.1" viewBox="0 0 15 15"> <use href="/images/iconCollection.svg#icon-linkedin"></use> </svg> </a>  </div> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <a href="mailto:?subject=%E6%96%87%E7%AB%A0%3A%E3%80%90Swift%20Predicate%3A%20%E7%94%A8%E6%B3%95%E3%80%81%E6%9E%84%E6%88%90%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E3%80%91&#38;body=%E5%88%86%E4%BA%AB%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E7%BB%99%E4%BD%A0%EF%BC%9A%0A%0ASwift%20Predicate%3A%20%E7%94%A8%E6%B3%95%E3%80%81%E6%9E%84%E6%88%90%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%0A%0A%E9%93%BE%E6%8E%A5%3A%20https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fswift-predicate-usage-composition-and-considerations%2F" target="_blank" id="sidebar-share-with-email"> <svg fill="currentColor" stroke="currentColor" stroke-width="20" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <use href="/images/iconCollection.svg#icon-email"></use> </svg> </a>  </div> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" stroke-width="20" onclick="scrollToElement()" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <use href="/images/iconCollection.svg#icon-comment"></use> </svg>  </div> <script>
  var offset = 80
  function scrollToElement() {
    var gitalkContainer = document.getElementById('gitalk-container');
    if (gitalkContainer) {
      var topPosition = gitalkContainer.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: topPosition, behavior: 'smooth' });
    }
  }
</script> <div class="opacity-50 text-heading hover:opacity-100 hover:text-secondary " style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" onclick="window.scrollTo({top:0,behavior:'smooth'})" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <!-- <path d="M862.464 161.536l-700.928 0c-30.976 0-56.096-25.12-56.096-56.096l0-28.064c0-30.944 25.12-56.064 56.096-56.064l700.896 0c30.976 0 56.096 25.12 56.096 56.064l0 28.032c0 31.008-25.12 56.096-56.096 56.096l0 0 0 0zM138.528 531.68c0 0 306.816-245.792 309.888-248.864 14.304-13.888 31.904-22.368 49.952-25.312 1.76-0.32 3.488-0.608 5.248-0.8 2.816-0.32 5.6-0.352 8.384-0.352 2.816-0.032 5.568 0.032 8.352 0.352 1.792 0.192 3.552 0.48 5.28 0.8 18.048 2.976 35.616 11.424 49.92 25.312 3.104 3.008 309.856 248.864 309.856 248.864 33.152 32.224 30.304 65.44-2.784 97.696s-77.376 3.04-110.496-29.216l-190.08-150.432 0 496.864c0 31.008-25.088 56.096-56.096 56.096l-28 0c-30.976 0-56.096-25.12-56.096-56.096l0-496.864-190.048 150.432c-33.088 32.288-77.408 61.536-110.496 29.216-33.056-32.256-35.872-65.44-2.816-97.696l0 0 0 0z"></path> --> <use href="/images/iconCollection.svg#icon-top"></use> </svg>  </div> </div> </div>  </div>   </div> </main> </div> <footer> <footer class="bg-block"> <div class="mx-auto w-full max-w-3xl px-4 md:px-6"> <div class="container flex flex-col items-center pt-10"> <div class="flex flex-row justify-around w-full space-x-3"> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">网站</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://apps.apple.com/us/app/id1534513553" class="hover:text-secondary" target="_blank">健康笔记</a> <a href="https://discord.gg/zhou-zi-de-swiftji-shi-ben-967978112509935657" class="hover:text-secondary" target="_blank">Discord</a> <a href="/zh/posts/" class="hover:text-secondary">文章</a> <a href="/zh/tags/" class="hover:text-secondary">标签</a> <a href="/zh/collections/" class="hover:text-secondary">合集</a> <a href="/zh/snippet/" class="hover:text-secondary">小贴士</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">关注</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://weekly.fatbobman.com" class="hover:text-secondary">周报</a> <a href="https://x.com/intent/follow?screen_name=fatbobman" class="hover:text-secondary" target="_blank">Twitter</a> <a href="https://mastodon.social/@fatbobman" class="hover:text-secondary" target="_blank">Mastodon</a> <a href="https://www.linkedin.com/in/fatbobman/" class="hover:text-secondary" target="_blank">Linkedin</a> <a href="https://bsky.app/profile/fatbobman.bsky.social" class="hover:text-secondary" target="_blank">Blue Sky</a> <a href="https://web.okjike.com/u/e32947ef-7751-4363-9456-b340eef2efd3" class="hover:text-secondary" target="_blank">
即刻
</a> <a href="https://github.com/fatbobman" class="hover:text-secondary" target="_blank">GitHub</a> <a href="/zh/rss.xml" class="hover:text-secondary hover:font-medium" target="_blank">RSS</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">信息</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="/zh/about/" class="hover:text-secondary">关于</a>  </div> </div> </div> <div class="pb-0"> <div class="flex items-center justify-center w-full px-6 pt-12 text-sm"> <span class="text-muted text-xs">Copyright © <span>2020-</span> 2025 <a href="https://x.com/fatbobman" class="border-b-secondary border-b-[1px]">Fatbobman Digital Limited</a>. All Rights
            Reserved.</span> </div> <div class="flex items-center justify-center w-full px-6 pt-2 text-sm pb-10"> <span> <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank" class="block text-xs text-muted">
辽ICP备20006550号-1
</a> </span> </div> </div> </div> </div> </footer> </footer> </div>   <!-- <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.js"></script> --><!-- <script type="module" src="/js/theme.js" defer></script> --><script>(function(){const currentLang = "zh";

  function attachEvent(selector, event, fn) {
    const matches = typeof selector === 'string' ? document.querySelectorAll(selector) : selector;
    if (matches && matches.length) {
      matches.forEach((elem) => {
        elem.addEventListener(event, (e) => fn(e, elem), false);
      });
    }
  }

  // 为每个需要清除 focus 状态的按钮都添加一个 clear-focus 类, 下面的代码将在点击后自动移除 focus 状态
  document.addEventListener('DOMContentLoaded', (event) => {
    // 获取所有具有 'clear-focus' 类的按钮
    const buttons = document.querySelectorAll('.clear-focus');

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        setTimeout(() => {
          button.blur();
        }, 0);
      });
    });
  });

  window.onpageshow = function () {
    document.documentElement.classList.add('motion-safe:scroll-smooth');
  };
})();</script> <div id="docsearch-container-data" data-lang="zh" data-searchtext="搜索..."></div> <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" defer></script>  <!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5C7N4MF5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!-- End Google Tag Manager (noscript) --> </body></html>