<!DOCTYPE html><html lang="zh"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="sitemap" href="/sitemap-index.xml"><!-- <link rel="shortcut icon" href={iconSVG.src} /> --><link rel="icon" type="image/png" sizes="16x16" href="/_astro/favicon-16x16.2312221518-2.4YWPtmqG.png"><link rel="icon" type="image/png" sizes="32x32" href="/_astro/favicon-32x32.2312221518-2.W1M1HUWf.png"><link rel="mask-icon" href="/_astro/faviconSVG-32x32.2312221518-2.JZf4E4CU.svg"><link rel="apple-touch-icon" sizes="180x180" href="/_astro/apple-touch-icon.2312227635.RNVrzb6f.png"><link rel="stylesheet" href="/style/global-new.css"><title>以 SwiftData 之道，重塑 Core Data 开发 | 肘子的 Swift 记事本</title>
<meta name="description" content="探索如何将 SwiftData 的现代思维融入 Core Data，重点关注数据建模与并发编程。本文侧重设计思路，助你构建稳定高效的数据方案。">
<meta name="robots" content="index,follow">
<link rel="canonical" href="https://fatbobman.com/zh/posts/reinventing-core-data-development-with-swiftdata-principles/">
<meta property="og:title" content="以 SwiftData 之道，重塑 Core Data 开发 | 肘子的 Swift 记事本">
<meta property="og:description" content="探索如何将 SwiftData 的现代思维融入 Core Data，重点关注数据建模与并发编程。本文侧重设计思路，助你构建稳定高效的数据方案。">
<meta property="og:url" content="https://fatbobman.com/zh/posts/reinventing-core-data-development-with-swiftdata-principles/">
<meta property="og:type" content="article">
<meta property="og:image" content="https://cdn.fatbobman.com/card/reinventing-core-data-development-with-swiftdata-principles-zh.webp">

<meta property="og:locale" content="zh">
<meta property="og:site_name" content="fatbobman.com">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@fatbobman">
<meta name="twitter:creator" content="@fatbobman"><link rel="alternate" type="application/rss+xml" title="RSS Feed for My Website" href="https://fatbobman.com/zh/rss.xml"><link rel="sitemap" href="/sitemap-index.xml"><meta name="keywords" content="Swift 编程,Swift Programming,SwiftUI 教程,SwiftUI Tutorials,Core Data 实践,Core Data Practices,SwiftData 应用,SwiftData Applications,iOS 开发,iOS Development,Swift UI 设计,Swift UI Design,Swift 性能优化,Swift Performance Optimization,Swift 编码技巧,Swift Coding Techniques,iOS 应用开发,iOS App Development,Swift 数据管理,Swift Data Management,SwiftUI 布局,SwiftUI Layout,SwiftUI 动画,SwiftUI Animation"><meta name="apple-mobile-web-app-title" content="肘子的博客"><link rel="alternate" hreflang="zh" href="https://fatbobman.com/zh/posts/reinventing-core-data-development-with-swiftdata-principles/"><link rel="alternate" hreflang="en" href="https://fatbobman.com/en/posts/reinventing-core-data-development-with-swiftdata-principles/"><!-- <BasicScripts /> --><!-- <script is:inline>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?14e5d60a3ea6276655f9d14c58b1fcd0";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script> --><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5C7N4MF5');</script> <!-- End Google Tag Manager --><link rel="stylesheet" href="/_astro/about.W-24wY6J.css" />
<link rel="stylesheet" href="/_astro/about.g78UfH4M.css" />
<link rel="stylesheet" href="/_astro/_slug_.KE54EPLE.css" />
<style>.sticky[data-astro-cid-4wsjtibl]{position:fixed;top:0;left:50%;transform:translate(-50%);width:100%;max-width:100%}
@keyframes rotate360{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rotate[data-astro-cid-qwm5cfxr]{animation:rotate360 1s linear}
</style><script type="module" src="/_astro/hoisted.BZCfwh3i.js"></script></head> <body class="antialiased text-default tracking-tight bg-page">  <div class="flex flex-col min-h-screen justify-between "> <div> <header> <div class="bg-block" id="wholeHeader" data-astro-cid-4wsjtibl> <div id="blogTitle"> <a href="/zh/"> <div class="flex space-x-4 mx-auto text-center pt-16 sm:pt-12 font-black w-[240px] sm:w-[300px] pb-6 sm:pb-1"> <svg class="text-heading" width="337" height="63"> <use href="/images/title-fatbobman.svg#main"></use> </svg> <svg class="text-primary mt-[-6px] sm:mt-[-5px]" width="130" height="91"> <use href="/images/title-blog.svg#main"></use> </svg> </div> </a> </div> <div class="bg-block z-50 shadow-custom-light dark:shadow-custom-dark" id="stickyHeader" data-astro-cid-4wsjtibl> <div class="max-w-5xl flex flex-wrap items-center justify-between mx-auto p-2 sm:p-0" data-astro-cid-4wsjtibl> <div class="flex space-x-2" data-astro-cid-4wsjtibl> <div id="lang-data" data-lang="zh" style="display: none;"></div> <button id="language-dropdown-button" data-dropdown-toggle="language-dropdown-menu" type="button" class="p-2 w-10 h-10 font-medium text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg"> ZH </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-page divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="language-dropdown-menu"> <ul class="py-2 font-medium text-sm" role="none"> <li> <a href="/en/posts/reinventing-core-data-development-with-swiftdata-principles/" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
English
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="EN-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <a href="" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
中文
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="ZH-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <div class="border-t border-gray-200 dark:border-gray-800 w-4/5 mx-auto my-2"></div> <button class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem" id="set-default-lang"> <div class="inline-flex items-center"> 将中文设置为默认 </div> </button> </li> </ul> </div>  <button id="theme-dropdown-button" data-dropdown-toggle="theme-dropdown-menu" type="button" class="group p-2 w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <svg viewBox="0 0 24 24" id="theme_icon_system" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <svg viewBox="0 0 24 24" id="theme_icon_dark" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <svg viewBox="0 0 24 24" id="theme_icon_light" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="theme-dropdown-menu"> <ul class="py-2 font-medium" role="none"> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_light"> <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> <span class="ml-2 dark:hover:text-white">Light</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_dark"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <span class="ml-2 text-default dark:hover:text-white">Dark</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_system"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <span class="ml-2 dark:hover:text-white">System</span> </button> </li> </ul> </div> <script>
  (async () => {
    const { setTheme } = await import('/js/theme.js');
    // Use setTheme here
    // Change the icons inside the button based on previous settings
    // 如果 localStorage 里面有设置过 color-theme 的值, 则 themeToggleSystemIcon.classList.remove('hidden')
    function setThemeButton() {
      let theme = localStorage.getItem('color-theme');
      if (theme === 'dark') {
        themeToggleDarkIcon.classList.remove('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else if (theme === 'light') {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.remove('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.remove('hidden');
      }
    }

    // 监听暗黑模式的变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
      setThemeButton();
    });

    // 保证其他的页面也能够监听到 localStorage 的变化
    window.addEventListener('storage', function (event) {
      if (event.key === 'color-theme') {
        setThemeButton();
      }
    });

    function resetTheme() {
      setTheme();
      setThemeButton();
    }

    // 获取按钮
    var themeButtonLight = document.getElementById('theme_button_light');
    var themeButtonDark = document.getElementById('theme_button_dark');
    var themeButtonSystem = document.getElementById('theme_button_system');
    // 获取图标
    var themeToggleDarkIcon = document.getElementById('theme_icon_dark');
    var themeToggleLightIcon = document.getElementById('theme_icon_light');
    var themeToggleSystemIcon = document.getElementById('theme_icon_system');

    // Listen for clicks on the button themeToggleDarkIcon
    themeButtonDark.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'dark');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleLightIcon
    themeButtonLight.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'light');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleSystemIcon
    themeButtonSystem.addEventListener('click', function () {
      localStorage.removeItem('color-theme');
      resetTheme();
    });

    resetTheme();
  })();
</script> <link rel="stylesheet" href="/style/docsearch.css"><div id="docsearch" class="group w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"></div> </div> <button data-collapse-toggle="navbar-solid-bg" type="button" class="inline-flex items-center p-2 mx-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-solid-bg" aria-expanded="false" id="navbar-toggle-button"> <span class="sr-only">Open main menu</span> <svg class="w-5 h-5 text-default" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path> </svg> </button> <nav class="hidden w-full md:block md:w-auto px-4 z-40" id="navbar-solid-bg"> <ul class="flex flex-col font-bold mt-4 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent dark:bg-gray-800 md:dark:bg-transparent dark:border-gray-700"> <a href="/zh/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 首页 </a><a href="/zh/posts/" class="block py-2 px-3 md:p-0 rounded text-invert bg-secondary md:bg-transparent md:text-secondary md:dark:bg-transparent" aria-current="page"> 文章 </a><a href="/zh/weekly/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 周报 </a><a href="/zh/snippet/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 小贴士 </a><a href="/zh/about/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 关于 </a> </ul> </nav>  </div> </div> <div id="placeholder" class="hidden" data-astro-cid-4wsjtibl></div> </div> <script>(function(){const enableSticky = true;
const enableStickyInMobile = true;

  window.onload = function () {
    checkStickyHeader();
    stickySetup();
  };

  window.addEventListener('resize', stickySetup);

  function checkStickyHeader() {
    const title = document.getElementById('blogTitle');
    const stickyHeader = document.getElementById('stickyHeader');
    const placeholder = document.getElementById('placeholder');

    if (title && stickyHeader && placeholder) {
      const offset = title.offsetTop + title.offsetHeight;

      if (shouldStick() && window.scrollY >= offset) {
        stickyHeader.classList.add('sticky');
        placeholder.style.display = 'block';
        placeholder.style.height = `${stickyHeader.offsetHeight}px`;
      } else {
        stickyHeader.classList.remove('sticky');
        placeholder.style.display = 'none';
      }
    }
  }

  function shouldStick() {
    if (!enableSticky) return false;

    let isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (isMobile && !enableStickyInMobile) return false;

    return true;
  }

  function stickySetup() {
    window.onscroll = checkStickyHeader;
  }
})();</script>  </header> <main class="w-full mx-auto max-w-3xl p-4 md:p-6 "> <div class="container mx-auto space-y-6 sm:space-y-12">   <div class="mx-auto space-y-4 text-center py-10" style="width:80%"> <div class="flex mx-auto justify-center"> <div class="flex mx-auto justify-center"> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/zh/tags/SwiftData/">
#SwiftData </a><a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/zh/tags/Core Data/">
#Core Data </a> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/en/posts/reinventing-core-data-development-with-swiftdata-principles/" id="language-switcher-for-topic"> #English </a> </div> </div> <h1 class="text-2xl font-bold leadi md:text-3xl text-heading">以 SwiftData 之道，重塑 Core Data 开发</h1> <p class="text-sm text-default"> <a itemprop="author" href="https://twitter.com/fatbobman" class="hover:text-secondary font-medium">东坡肘子</a> <!-- <time datetime={`${post.data.publishDate.toISOString()}`}>{date}</time> --> </p> <p class="text-xs text-muted"> 发表于 <time datetime="2024-10-16T14:00:00.000Z">2024 年 10 月 16 日</time>  </p> </div> <div class="w-full mx-auto text-center pb-0 sm:pb-6 pt-0"> <div id="custom-substack-embed"></div> <div class="text-xs font-medium text-heading p-4">为您每周带来有关 Swift 和 SwiftUI 的精选资讯！</div> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };

    // 创建一个新的 MutationObserver 实例
    const observer = new MutationObserver((mutationsList, observer) => {
      // 遍历所有的 mutations
      for (let mutation of mutationsList) {
        // 如果这个 mutation 是一个子节点的添加或删除
        if (mutation.type === 'childList') {
          // 查找订阅框
          const widget = document.querySelector('.custom-substack-widget');
          if (widget) {
            // 查找 input 元素
            const input = widget.querySelector('input');
            const button = widget.querySelector('button');
            // 根据当前的颜色方案修改订阅框的样式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              // 暗黑模式
              widget.style.padding = '0.5rem';
              widget.style.borderRadius = '1.2rem 1.2rem 1.2rem 1.2rem';
              widget.style.border = '0.1px solid var(--aw-color-text-muted)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--aw-background-color)';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.borderRadius = '0.8rem 0.8rem 0.8rem 0.8rem';
              button.style.maxWidth = '100px';
              button.style.fontWeight = 'bold';
            } else {
              // 正常模式
              widget.style.padding = '0.5rem';
              widget.style.borderRadius = '1.2rem 1.2rem 1.2rem 1.2rem';
              widget.style.border = '0.1px solid var(--aw-color-text-muted)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--aw-background-color)';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.borderRadius = '0.8rem 0.8rem 0.8rem 0.8rem';
              button.style.maxWidth = '100px';
              button.style.fontWeight = 'bold';
            }

            if (window.matchMedia('(max-width: 640px)').matches) {
              // 屏幕尺寸小于 640px
              widget.style.maxWidth = '325px';
            } else {
              // 屏幕尺寸大于或等于 640px
              widget.style.maxWidth = '400px';
            }
            // 停止观察
            observer.disconnect();
          }
        }
      }
    });

    // 开始观察 #custom-substack-embed 元素的子节点的变化
    observer.observe(document.getElementById('custom-substack-embed'), { childList: true });
  })();</script> <script src="https://substackapi.com/widget.js" async></script> </div> <svg style="display: none;"> <symbol id="icon-clipboard" viewBox="0 0 1024 1024"> <path d="M426.666667 42.666667l170.666667 0q41.344 0 74.325333 23.850667t46.336 61.482667l50.005333 0q52.992 0 90.496 37.504t37.504 90.496l0 597.333333q0 52.992-37.504 90.496t-90.496 37.504l-512 0q-52.992 0-90.496-37.504t-37.504-90.496l0-597.333333q0-52.992 37.504-90.496t90.496-37.504l50.005333 0q13.312-37.674667 46.336-61.482667t74.325333-23.850667zM768 213.333333l-50.005333 0q-13.312 37.674667-46.336 61.482667t-74.325333 23.850667l-170.666667 0q-41.344 0-74.325333-23.850667t-46.336-61.482667l-50.005333 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333l0 597.333333q0 17.664 12.501333 30.165333t30.165333 12.501333l512 0q17.664 0 30.165333-12.501333t12.501333-30.165333l0-597.333333q0-17.664-12.501333-30.165333t-30.165333-12.501333zM597.333333 128l-170.666667 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333 12.501333 30.165333 30.165333 12.501333l170.666667 0q17.664 0 30.165333-12.501333t12.501333-30.165333-12.501333-30.165333-30.165333-12.501333z"></path> </symbol> <symbol id="icon-check" viewBox="0 0 1024 1024"> <path d="M421.858 683.366l401.796-448.518c18.66-20.828 50.668-22.586 71.498-3.928 20.828 18.66 22.586 50.67 3.928 71.498L463.638 788.494c-18.606 20.768-50.5 22.586-71.344 4.066l-263.29-233.924c-20.906-18.572-22.796-50.576-4.222-71.48 18.574-20.906 50.576-22.796 71.48-4.222L421.86 683.366z"></path> </symbol> </svg> <div class="relative" id="article-area"> <article class="prose dark:prose-invert mx-auto w-full"> <div> <!-- <AdsBannerTest /> --> 
<p>在现代应用开发中，高效的持久化框架至关重要。SwiftData 的出现，曾让众多 Core Data 开发者眼前一亮，大家期待着一个融合现代编程理念的新时代到来。本篇文章将探讨如何在 Core Data 中应用 SwiftData 的思维方式，重点关注数据建模和并发编程。</p>
<blockquote>
<p>本文将不深入讨论技术细节，而是侧重于探讨设计思路、策略和注意事项。</p>
</blockquote>
<div class="dynamic-ad-container pt-4"></div>
<h2 id="2024-年了swiftdata-准备好了吗">2024 年了，SwiftData 准备好了吗？</h2>
<p>SwiftData 在 WWDC 2023 上的突然亮相，为开发者带来了极大的惊喜。尽管首个版本（iOS 17）功能尚未完善、性能略显逊色，但它已经展现出了令人兴奋的潜力。随着小版本的迭代更新，SwiftData 的稳定性逐步提升，赢得了部分开发者的青睐。</p>
<p>一些喜欢尝鲜的开发者已将 SwiftData 应用于新项目中，他们惊喜地发现，这个框架不仅体现了现代编程思想，还显著提升了开发效率，简化了复杂操作。更令人欣喜的是，SwiftData 与 SwiftUI 的无缝协作，以及对 Swift 严格并发检查的完美契合，让开发者们看到了一个充满希望的未来。许多人坚信，SwiftData 终将成为苹果生态系统中最重要的数据管理框架。</p>
<p>然而，iOS 18 的发布给这美好的愿景蒙上了一层阴影。在首次亮相一年后，SwiftData 经历了一次重大的底层重构。这次调整虽然是为了从与 Core Data 的强耦合转向更加灵活的多持久化方案支持，方向无疑是正确的，但似乎由于转变过大，导致新版本的稳定性受到了相当大的冲击。</p>
<p>令人沮丧的是，大量在 iOS 17 上运行良好的 SwiftData 代码在新版本中出现了各种问题，这些问题对于一个肩负重任的数据持久化框架来说，无疑是致命的。更让人担忧的是，这些问题的复杂性意味着它们可能无法在短期内得到彻底解决。可以预见，在整个 iOS 18 周期中，选择使用 SwiftData 的开发者将不得不与这些挑战持续搏斗。</p>
<p>作为一个对 SwiftData 充满热情的开发者，我一直密切关注着它的发展。通过深入学习和实践，我不仅厘清了一些在 Core Data 中未能理解的概念，还大大提升了对现代编程范式、API 设计，尤其是 Swift 语言新特性的认知。去年，我满怀信心地开始用 SwiftData 重构一个应用。尽管过程中遇到了不少挑战，主要是因为某些功能的缺失，但整体开发体验依然令人愉悦。</p>
<p>然而，SwiftData 在 iOS 18 上的表现让我陷入了两难。对于一个以数据管理为核心的应用来说，稳定性和可靠性是不可妥协的。经过反复权衡，我不得不做出一个艰难的决定：放弃已经完成的数千行 SwiftData 代码，重新拥抱 Core Data。</p>
<p>这个决定并非轻易做出。我深知 SwiftData 的潜力和优势，但在当前阶段，项目的稳定性和可靠性必须放在首位。尽管如此，SwiftData 带给我的启发并未白费。在重新构建 Core Data 项目时，我决定将从 SwiftData 中学到的现代化思维融入其中，用更富有创新性的方式来驾驭这个历经考验的框架。</p>
<p>相较于 Core Data，SwiftData 在多个方面都展现出了革新性的突破。在接下来的内容中，我们将重点探讨两个关键领域：数据建模和并发编程。这两个方面是 SwiftData 相对于 Core Data 最具优势的部分。通过深入分析，我们将探索如何在 Core Data 中注入 SwiftData 的先进理念，从而打造出既稳定可靠，又富有现代感的数据管理方案。</p>
<h2 id="声明数据模型">声明数据模型</h2>
<h3 id="建模思路">建模思路</h3>
<p>在使用 Core Data 构建数据模型时，开发者通常会首先使用到 Xcode 提供的模型编辑器。尽管苹果试图在编辑器中淡化数据模型与底层数据库之间的关系（例如实体对应表、属性对应字段），但开发者难免会在编辑器模式下受到影响，往往会采用注重性能和空间效率的建模策略。另外随着模型的复杂性增加，逐个调整每个实体对应的声明代码变得困难，许多开发者会直接使用 Xcode 自动生成的模型代码，或仅进行少量调整。</p>
<p>SwiftData 从根本上反转了建模思路。开发者首先按照 Swift 标准类来声明实体类型，这使得开发者更关注模型在数据操作和视图代码中的易用性和语义表达。至于如何在持久化存储中保存，只要符合建模规范，SwiftData 会自动进行转换。</p>
<p>考虑到在目前的苹果生态下，开发者更多地将持久化框架用于移动端、桌面端的应用，因此，构建一个适合表现层面的模型声明代码更符合大多数需求，最终的实体对应的代码应当能够方便且无需调整地用于视图和其他代码中。</p>
<p>在实践中，我采用了以下步骤：</p>
<ul>
<li><strong>初步声明模型</strong>：首先不考虑与底层的对应关系，按照 Swift 标准类声明实体类型，确保语义清晰，类型明确，便于使用。</li>
<li><strong>优化底层模型</strong>：在模型编辑器中构建实体时，优先考虑性能和存储容量，不必刻意与用于表现层的声明代码对应，并且关闭模型代码的自动生成。</li>
<li><strong>调整声明代码</strong>：将初步声明的 Swift 类调整为符合托管对象的格式，对属性进行逐一检查，对于无法直接对应的属性和类型，在声明代码层面进行转换。</li>
<li><strong>构建安全的构造方法</strong>：确保模型实例在创建时就具备必要的数据，提高代码的安全性和可读性。</li>
</ul>
<p>在 SwiftData 中，我们只需完成第一步，剩余的部分由它自动完成。尽管在 Core Data 中这样做会增加一些工作量，但由于我们可以严格控制转换方式和底层类型，对模型的可控性相比 SwiftData 反到有所提高。</p>
<h3 id="可选值与默认值">可选值与默认值</h3>
<p>在 Core Data 中，模型编辑器中的可选值选项常常让开发者感到困惑，因为它并不等同于 Swift 语言中的可选类型，两者之间并非严格对应。例如，在模型编辑器中，一个设置了默认值且关闭了可选值选项的字符串属性，在自动生成的代码中对应的是 <code>String?</code>；而一个开启了可选值选项的浮点数属性，则对应非可选的 <code>Double</code>。</p>
<blockquote>
<p><strong>提示</strong>：模型编辑器中的可选值选项 <a href="/zh/posts/core-data-of-ask-apple-2022-2/#%E5%AE%9E%E4%BD%93%E5%B1%9E%E6%80%A7%E7%9A%84%E5%8F%AF%E9%80%89%E6%80%A7" target="_blank">早于 Swift 语言的出现</a>，表示属性在持久化存储中的字段是否可以为空（<code>NULL</code>）。</p>
</blockquote>
<p>SwiftData 通过纯代码声明的方式解决了这种不一致性。比如，我们要声明一个符合云同步规则的 <code>Item</code> 模型，可以直接使用如下代码：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@Model</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> name: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> &quot;&quot;</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> height: </span><span style="color:#8BE9FD;font-style:italic">Double</span><span style="color:#FF79C6">?</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">name</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">, </span><span style="color:#50FA7B;font-style:italic">height</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Double</span><span style="color:#FF79C6">?</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> nil</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> name</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.height </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> height</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>在这段代码中，<code>name</code> 是非可选的且具有默认值，便于在视图中使用。而 <code>height</code> 被声明为 Swift 的可选类型，明确表示该属性允许没有值。</p>
<p>按照上文中的建模思路，我们首先在 Core Data 中声明模型：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#6272A4">// 初步声明</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> name: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> &quot;&quot;</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> height: </span><span style="color:#8BE9FD;font-style:italic">Double</span><span style="color:#FF79C6">?</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre></div>
<p>但当尝试将上述代码转换为 Core Data 的托管对象时，会发现无法直接对应：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@objc</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">Item</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2">: NSManagedObject {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> name: </span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> height: </span><span style="color:#8BE9FD;font-style:italic">Double</span><span style="color:#FF79C6">?</span><span style="color:#6272A4"> // Property cannot be marked @NSManaged because its type cannot be represented in Objective-C</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p><picture>
                    <source media="(max-width: 479px)" srcset="https://cdn.fatbobman.com/image-20241012110005794.webp?imageView2/0/w/500"/>
                    <img src="https://cdn.fatbobman.com/image-20241012110005794.webp" alt="image-20241012110005794" loading="lazy"/>
                  </picture></p>
<p>这是因为 Core Data 本质上仍基于 Objective-C，要求属性类型必须能在 Objective-C 中表示。<code>Double?</code> 无法直接转换，因此我们需要在代码层面手动进行转换：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@objc</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">Note</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2">: NSManagedObject {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> name: </span><span style="color:#8BE9FD;font-style:italic">String</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> height: </span><span style="color:#8BE9FD;font-style:italic">Double</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">        get</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            heightValueNumber</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2">.doubleValue</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        set</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            heightValueNumber </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> newValue </span><span style="color:#FF79C6">as</span><span style="color:#F8F8F2"> NSNumber</span><span style="color:#FF79C6">?</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> heightValueNumber: NSNumber</span><span style="color:#FF79C6">?</span><span style="color:#6272A4"> // 没有添加 public 权限</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>为了保持公开的属性名称的一致性，我们在模型编辑器中将对应的存储属性命名为 <code>heightValueNumber</code>，并保留其 <code>NSNumber</code> 的原始类型，手动实现类型转换和映射。</p>
<h3 id="枚举与-codable">枚举与 Codable</h3>
<p>SwiftData 对枚举和符合 <code>Codable</code> 协议的属性类型也提供了自动转换能力。然而，正如我在 <a href="/zh/posts/considerations-for-using-codable-and-enums-in-swiftdata-models/" target="_blank">其他文章</a> 中提到的，转换后的底层格式可能与预期不符（通常基于 <a href="/zh/posts/what-s-new-in-core-data-in-wwdc23/" target="_blank">Composite attributes</a> 实现）。考虑到在 SwiftData 中当前的枚举类型仍无法直接用于谓词筛选，无论在 SwiftData 还是 Core Data 中，我都建议对枚举类型使用保存 <code>rawValue</code> 的方式，并在声明代码层面进行转换：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    ...</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> valueDisplayMode: DataDisplayMode {</span></span>
<span class="line"><span style="color:#FF79C6">        get</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">            DataDisplayMode</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">rawValue</span><span style="color:#F8F8F2">: valueDisplayModeRaw) </span><span style="color:#FF79C6">??</span><span style="color:#F8F8F2"> .average</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        set</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            valueDisplayModeRaw </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> newValue.</span><span style="color:#BD93F9">rawValue</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> enum</span><span style="color:#8BE9FD;font-style:italic"> DataDisplayMode</span><span style="color:#F8F8F2">: Int16, Sendable, Equatable {</span></span>
<span class="line"><span style="color:#FF79C6">    case</span><span style="color:#F8F8F2"> sum </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1</span></span>
<span class="line"><span style="color:#FF79C6">    case</span><span style="color:#F8F8F2"> average </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 2</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>对于复杂的属性类型，传统的 Core Data 解决方案通常基于 <code>NSSecureUnarchiveFromDataTransformer</code> 实现转换，但这种方式不符合 Swift 语言的特点。在新项目中，我们可以直接采用基于 <code>Codable</code> 的编码和解码方式进行保存：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">		...</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> options: [ItemOption]</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">        get</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">            guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> data </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> optionsData </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">return</span><span style="color:#BD93F9"> nil</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#FF79C6">            return</span><span style="color:#FF79C6"> try?</span><span style="color:#8BE9FD"> JSONDecoder</span><span style="color:#F8F8F2">().</span><span style="color:#8BE9FD">decode</span><span style="color:#F8F8F2">([ItemOption].</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD">from</span><span style="color:#F8F8F2">: data)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        set</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            optionsData </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try?</span><span style="color:#8BE9FD"> JSONEncoder</span><span style="color:#F8F8F2">().</span><span style="color:#8BE9FD">encode</span><span style="color:#F8F8F2">(newValue)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">    </span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> optionsData: Data</span><span style="color:#FF79C6">?</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>尽管 WWDC 2023 为 Core Data 引入了 Composite attributes 功能，但鉴于 SwiftData 对符合 <code>Codable</code> 协议类型的转换规则尚未完全明确，我仍会采用基于 <code>Codable</code> 的编解码方式来持久化数据。即使日后项目升级至 SwiftData，我们也可以通过计算属性来确保底层数据的一致性，从而降低潜在的迁移风险。</p>
<p>虽然这种处理方式与 SwiftData 的默认形式不同，但在现阶段，我也建议 SwiftData 的开发者采用这种方式，待 SwiftData 的稳定性和转换规则完全明确后，再考虑使用其默认模式。</p>
<h3 id="关系">关系</h3>
<p>在声明 Core Data 实体关系的代码，尤其是多对多关系时，我并没有做过多调整：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span><span style="color:#FF79C6"> public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> note: Note</span><span style="color:#FF79C6">?</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span><span style="color:#FF79C6"> public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> datas: </span><span style="color:#8BE9FD;font-style:italic">Set</span><span style="color:#F8F8F2">&lt;ItemData&gt;</span><span style="color:#FF79C6">?</span><span style="color:#6272A4"> // 用 Set 替换 NSSet</span></span>
<span class="line"><span style="color:#F8F8F2">  </span></span>
<span class="line"><span style="color:#FF79C6">    @objc</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">addDatasObject:</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span><span style="color:#FF79C6"> public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> addToDatas</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> value</span><span style="color:#F8F8F2">: ItemData)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    @objc</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">removeDatasObject:</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span><span style="color:#FF79C6"> public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> removeFromDatas</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> value</span><span style="color:#F8F8F2">: ItemData)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    @objc</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">addDatas:</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span><span style="color:#FF79C6"> public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> addToDatas</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> values</span><span style="color:#F8F8F2">: NSSet)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    @objc</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">removeDatas:</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    @NSManaged</span><span style="color:#FF79C6"> public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> removeFromDatas</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> values</span><span style="color:#F8F8F2">: NSSet)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>主要原因有：</p>
<ul>
<li>将多对多关系声明为数组并不会带来实质性好处，反而可能造成语义上的混淆：将一个无序集合表示为有序集合。</li>
<li>尝试转换为 SwiftData 基于数组的 <code>append</code> 方式操作对多关系，会导致性能下降，这一点我在 <a href="/zh/posts/relationships-in-swiftdata-changes-and-considerations/" target="_blank">SwiftData 中的关系：变化与注意事项</a> 一文中有详细阐述。</li>
</ul>
<p>值得注意的是，由于对多关系的添加和删除代码是手动编写的，因此要特别注意拼写问题，编译器并不会检查对应的 Objective-C 方法名称（例如 <code>@objc(removeDatas)</code>）。</p>
<h3 id="构造方法">构造方法</h3>
<p>SwiftData 的纯代码建模中，必须提供构造方法，这是一个关键特性。通过构造方法，开发者可以明确需要赋值的内容，确保模型实例在创建时就具备必要的数据。</p>
<p>然而，在 Core Data 中，开发者通常习惯于如下方式创建实例，这种方式在安全性和模型设计的意图表达上都不如 SwiftData：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> item </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">context</span><span style="color:#F8F8F2">:context)</span></span>
<span class="line"><span style="color:#F8F8F2">item.name </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">hello</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#FF79C6">...</span></span>
<span class="line"><span style="color:#6272A4">// 给其他属性赋值</span></span></code></pre></div>
<p>为了改进，我们需要为托管对象类型声明自定义的构造方法：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> convenience</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        name</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        height</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Double</span><span style="color:#FF79C6">?</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> nil</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        valueDisplayMode</span><span style="color:#F8F8F2">: DataDisplayMode </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> .sum,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        options</span><span style="color:#F8F8F2">: [ItemOption]</span><span style="color:#FF79C6">?</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> nil</span></span>
<span class="line"><span style="color:#F8F8F2">    ) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.</span><span style="color:#FF79C6">init</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">entity</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9;font-style:italic">Self</span><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD">entity</span><span style="color:#F8F8F2">(), </span><span style="color:#8BE9FD">insertInto</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">nil</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.name </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> name</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.height </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> height</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.valueDisplayMode </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> valueDisplayMode</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">        self</span><span style="color:#F8F8F2">.options </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> options</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>在构造方法中，我们通过 <code>self.init(entity: Self.entity(), insertInto: nil)</code> 避免在创建实例时提供上下文。这样一来，就需要像 SwiftData 一样，在创建实例后显式地插入上下文：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> item </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">name</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">context.</span><span style="color:#8BE9FD">insert</span><span style="color:#F8F8F2">(item) </span><span style="color:#6272A4">// 显式插入上下文</span></span></code></pre></div>
<p>对于部分 Core Data 开发者来说，显式插入上下文可能需要一些时间来适应，但这种方式有助于与 SwiftData 的开发模式统一。</p>
<blockquote>
<p>想了解托管对象的具体构造细节，请阅读 <a href="/zh/posts/from-data-model-construction-to-managed-object-instances-in-core-data/" target="_blank">CoreData 探秘 - 从数据模型构建到托管对象实例</a>。</p>
</blockquote>
<p>需要注意的是，我没有在构造方法中为关系数据提供参数。这是因为关系的创建是在上下文中进行的，尚未注册到上下文的托管对象实例无法正确处理构造方法中提供的关系数据。因此，所有的关系数据都需要在插入上下文后再设置：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> note </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Note</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">name</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">note1</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">context.</span><span style="color:#8BE9FD">insert</span><span style="color:#F8F8F2">(note)</span></span>
<span class="line"><span style="color:#FF79C6">let</span><span style="color:#F8F8F2"> item </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">name</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">fat</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">context.</span><span style="color:#8BE9FD">insert</span><span style="color:#F8F8F2">(item)</span></span>
<span class="line"><span style="color:#F8F8F2">item.note </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> note</span></span></code></pre></div>
<p>这个规则同样适用于 SwiftData。虽然有些开发者喜欢在构造方法中直接提供关系数据，但实践证明，这样的代码并不总是稳定的。为了确保代码的可靠性，最好在插入上下文后再设置关系数据。</p>
<h3 id="模型验证">模型验证</h3>
<p>传统上，无论在使用 Core Data（依赖模型编辑器自动生成代码）还是 SwiftData 时，开发者几乎不需要为模型声明代码编写单独的测试，因为模型代码与底层模型的对应关系会由框架自动处理。</p>
<p>但由于我们现在手动编写了模型声明代码，在声明模型后，立即为其编写验证模型有效性的测试是非常必要的，主要关注以下几点：</p>
<ul>
<li><strong>构造方法</strong>：确保涵盖了所有必要的属性。</li>
<li><strong>自定义转换</strong>：验证转换部分是否符合预期。</li>
<li><strong>多对多关系</strong>：检查关系设置部分是否能正确运行（是否存在拼写错误）。</li>
</ul>
<p>随着模型的变化和关系的调整，验证方法也需要不断更新。</p>
<h3 id="模块化">模块化</h3>
<p>模块化是现代编程的重要特征。在创建模型之初，就应将其封装到独立的库中，不仅减少了无关 API 的暴露（例如 <code>heightValueNumber</code> 并非 <code>public</code> 权限），也便于针对每个库进行单元测试。</p>
<p>在我的项目中，由于会为多个不同的数据操作逻辑分别创建库，因此就需要数据模型代码单独成库方便其他的库使用。这个数据模型库功能非常单一，主要提供类型声明。考虑到 Core Data 在构建 <code>container</code> 时的特殊性（一个托管对象模型文件只能在应用中被一个实例持有），除了公开必要的托管对象类型外，还要为整个项目提供唯一的 <code>NSManagedObjectModel</code> 实例。（由于 SwiftData 的模型完全基于代码，因此没有此类限制）</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@preconcurrency</span><span style="color:#FF79C6"> import</span><span style="color:#8BE9FD;font-style:italic"> CoreData</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> enum</span><span style="color:#8BE9FD;font-style:italic"> DBModelConfiguration</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#F8F8F2"> nonisolated </span><span style="color:#FF79C6">static</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> objectModel: NSManagedObjectModel </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">        guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> modelURL </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Bundle.module.</span><span style="color:#BD93F9">url</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">forResource</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">CareLog</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD">withExtension</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">momd</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">            fatalError</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Couldn&#39;t find the CareLog.momd file in the module bundle.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> model </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSManagedObjectModel</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">contentsOf</span><span style="color:#F8F8F2">: modelURL) </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">            fatalError</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Couldn&#39;t load the CareLog.momd file in the module bundle.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> model</span></span>
<span class="line"><span style="color:#F8F8F2">    }()</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>由于 <code>NSManagedObjectModel</code> 并非 <code>Sendable</code>，因此我们需要使用 <code>@preconcurrency</code> 来消除警告。在我当前的项目中（启用了 Swift 6 模式），所有的 Core Data 代码中，这是唯一需要手动干预才能避免并发安全警告的地方。</p>
<p>另外，如果将 SwiftData 的模型代码单独封装成库，可能需要在该库中包含相关的谓词设置。原因在于 SwiftData 中构建谓词时依赖 KeyPath，因此，若模型中的某些属性是非公开的（如枚举的 <code>rawValue</code> 等底层存储属性），这些属性只能在与模型处在同一库时才能作为筛选条件。相比之下，Core Data 的谓词基于字符串构建，无需在意属性的公开性，因此不受这一限制。</p>
<blockquote>
<p><a href="https://mastodon.social/@helge?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">Helge Heß</a> 开发了一款名为 <a href="https://github.com/Data-swift/ManagedModels?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">ManagedModels</a> 的第三方库，旨在提供与 SwiftData 中 <code>@Model</code> 类似的体验。</p>
</blockquote>
<h2 id="并发">并发</h2>
<p>如果说在 SwiftData 中，为了享受纯代码建模带来的优势，开发者需要放弃一些可控性，那么在并发方面，SwiftData 的改变对开发者来说则是纯粹的利好。</p>
<h3 id="用-actor-替换-perform">用 Actor 替换 <code>perform</code></h3>
<p>SwiftData 的 <code>@ModelActor</code> 为数据操作代码提供了一个运行线程可控的隔离环境（基于自定义 Actor 执行者，使用上下文线程）。在这个隔离环境中，开发者可以毫无顾虑地编写代码，不再受 <code>perform</code> 方法的限制。</p>
<p>幸运的是，自定义 Actor 执行者的功能包含在 Swift 5.9 版本中（需要 iOS 17+）。通过我编写的适用于 Core Data 的 <a href="https://github.com/fatbobman/CoreDataEvolution?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener"><code>@NSModelActor</code></a> 宏，Core Data 开发者也可以享受到与 SwiftData 完全一致的并发编程体验。</p>
<blockquote>
<p>想了解更多细节，请阅读 <a href="/zh/posts/core-data-reform-achieving-elegant-concurrency-operations-like-swiftdata/" target="_blank">Core Data 改革：实现 SwiftData 般的优雅并发操作</a>。</p>
</blockquote>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@NSModelActor</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> actor</span><span style="color:#8BE9FD;font-style:italic"> DataHandler</span><span style="color:#F8F8F2"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> DataHandler</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">    // 公开方法</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> deleteItemData</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B">        for</span><span style="color:#FFB86C;font-style:italic"> itemDataID</span><span style="color:#F8F8F2">: PersistentObjectID,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        saveImmediately</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span></span>
<span class="line"><span style="color:#F8F8F2">    ) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2">(DataHandlerError) { </span><span style="color:#FF79C6">...</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> deleteItemDatas</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B">        for</span><span style="color:#FFB86C;font-style:italic"> itemDataIDs</span><span style="color:#F8F8F2">: [PersistentObjectID],</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        saveImmediately</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span></span>
<span class="line"><span style="color:#F8F8F2">    ) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2">(DataHandlerError) { </span><span style="color:#FF79C6">...</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> createItemData</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B">        with</span><span style="color:#FFB86C;font-style:italic"> viewModel</span><span style="color:#F8F8F2">: ItemDataVM,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        saveImmediately</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> true</span></span>
<span class="line"><span style="color:#F8F8F2">    ) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2">(DataHandlerError) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> PersistentObjectID { </span><span style="color:#FF79C6">...</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#F8F8F2">  </span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> updateItemData</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B">        with</span><span style="color:#FFB86C;font-style:italic"> viewModel</span><span style="color:#F8F8F2">: ItemDataVM,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        saveImmediately</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> true</span></span>
<span class="line"><span style="color:#F8F8F2">    ) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2">(DataHandlerError) { </span><span style="color:#FF79C6">...</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // 内部方法</span></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> createItemDataObject</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B">        with</span><span style="color:#FFB86C;font-style:italic"> itemDataVM</span><span style="color:#F8F8F2">: ItemDataVM,</span></span>
<span class="line"><span style="color:#50FA7B">        in</span><span style="color:#FFB86C;font-style:italic"> item</span><span style="color:#F8F8F2">: Item,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        saveImmediately</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> true</span></span>
<span class="line"><span style="color:#F8F8F2">    ) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2">(DataHandlerError) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> ItemData { </span><span style="color:#FF79C6">...</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    func</span><span style="color:#50FA7B"> updateItemDataObject</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B">        for</span><span style="color:#FFB86C;font-style:italic"> itemData</span><span style="color:#F8F8F2">: ItemData,</span></span>
<span class="line"><span style="color:#50FA7B">        with</span><span style="color:#FFB86C;font-style:italic"> itemDataVM</span><span style="color:#F8F8F2">: ItemDataVM,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        saveImmediately</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> true</span></span>
<span class="line"><span style="color:#F8F8F2">    ) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2">(DataHandlerError) { </span><span style="color:#FF79C6">...</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre></div>
<p>可以注意到，Actor 中所有公开的 API 都只接受和返回 <code>Sendable</code> 的 <code>NSManagedObjectID</code>。而对于仅在 Actor 内部使用的方法，则可以安全地使用托管对象进行参数传递。这是进行安全并发编程的基本原则，无论对 Core Data 还是 SwiftData 都适用。</p>
<blockquote>
<p>从 Xcode 16 开始，官方已经为 Core Data 中的 <code>NSManagedObjectID</code> 和 <code>NSPersistentContainer</code> 标注了 <code>@unchecked Sendable</code>。这使得它们与 SwiftData 中对应类型的并发特性一致，开发者可以安全地在不同线程中传递这两个类型的实例。</p>
</blockquote>
<p>关于如何围绕 <code>@NSModelActor</code> 进行并发编程，本文不再赘述，因为其基本方式和思路与 <a href="/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/" target="_blank">SwiftData 实战：用现代方法构建 SwiftUI 应用</a> 一文中介绍的 SwiftData 使用方式一致。</p>
<h3 id="测试">测试</h3>
<p>将数据逻辑代码封装到 Actor 后，尤其是在启用了 Swift 6 模式后，会给单元测试带来一些新的变化。例如，以下是测试代码示例：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@Test</span></span>
<span class="line"><span style="color:#FF79C6">func</span><span style="color:#50FA7B"> createRootNoteTest</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> throws</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> PersistentController.</span><span style="color:#8BE9FD">createTestContainer</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">#function</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> handler </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DataHandler</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">container</span><span style="color:#F8F8F2">: container)</span></span>
<span class="line"><span style="color:#6272A4">    // 创建数据</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> handler.</span><span style="color:#8BE9FD">createRootNote</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">with</span><span style="color:#F8F8F2">: NoteVM.sample2)</span></span>
<span class="line"><span style="color:#6272A4">    // 验证结果</span></span>
<span class="line"><span style="color:#FF79C6">    ...</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>为了在不重新创建上下文的情况下（仍使用 Actor 中的上下文）验证数据是否创建成功，我们需要为 Actor 构建一个辅助方法：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> DataHandler</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> perform</span><span style="color:#F8F8F2">&lt;</span><span style="color:#BD93F9;font-style:italic">T</span><span style="color:#F8F8F2">&gt;(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> action</span><span style="color:#F8F8F2">: (NSManagedObjectContext) </span><span style="color:#FF79C6">throws</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> T) </span><span style="color:#FF79C6">throws</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> T </span><span style="color:#FF79C6">where</span><span style="color:#F8F8F2"> T: Sendable {</span></span>
<span class="line"><span style="color:#FF79C6">        try</span><span style="color:#8BE9FD"> action</span><span style="color:#F8F8F2">(modelContext)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>这样，我们就可以在测试代码中方便地为 Actor 插入需要验证的逻辑并检查结果：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@Test</span></span>
<span class="line"><span style="color:#FF79C6">func</span><span style="color:#50FA7B"> createRootNoteTest</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> throws</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> PersistentController.</span><span style="color:#8BE9FD">createTestContainer</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">#function</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> handler </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DataHandler</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">container</span><span style="color:#F8F8F2">: container)</span></span>
<span class="line"><span style="color:#6272A4">    // 创建数据</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> handler.</span><span style="color:#8BE9FD">createRootNote</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">with</span><span style="color:#F8F8F2">: NoteVM.sample2)</span></span>
<span class="line"><span style="color:#6272A4">    // 验证结果</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> query </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Note.</span><span style="color:#8BE9FD">query</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: .</span><span style="color:#8BE9FD">allRootNotes</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">sortBy</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">nil</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#6272A4">    // 在 Actor 中运行判断代码</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> handler.perform { context </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">        #</span><span style="color:#8BE9FD">expect</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">try</span><span style="color:#F8F8F2"> context.</span><span style="color:#BD93F9">count</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: query) </span><span style="color:#FF79C6">==</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>此外，为每个单元测试构建独立的数据库文件非常重要，这使我们可以充分利用 <a href="/zh/posts/mastering-the-swift-testing-framework/" target="_blank">Swift Testing</a> 提供的默认并行测试能力，大大提高测试效率：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> PersistentController</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">    /// 创建一个用来测试的 NSPersistentContainer( 只包含特定的 Configuration 中的实体 )</span></span>
<span class="line"><span style="color:#FF79C6">    static</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> createTestContainer</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#50FA7B">        _</span><span style="color:#FFB86C;font-style:italic"> name</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        enablePHT</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> false</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        configurationName</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#FF79C6"> =</span><span style="color:#F8F8F2"> DBModelConfiguration.privateConfigurationName,</span></span>
<span class="line"><span style="color:#50FA7B;font-style:italic">        subDirectory</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">DBCoreDataTestTemp</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2">    ) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#F8F8F2"> NSPersistentContainer {</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> tempURL </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> URL.temporaryDirectory</span></span>
<span class="line"><span style="color:#6272A4">        // 如果 tempURL 中没有 subDirectory 就创建</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#FF79C6"> !</span><span style="color:#F8F8F2">FileManager.default.</span><span style="color:#8BE9FD">fileExists</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">atPath</span><span style="color:#F8F8F2">: tempURL.</span><span style="color:#8BE9FD">appendingPathComponent</span><span style="color:#F8F8F2">(subDirectory).path) {</span></span>
<span class="line"><span style="color:#FF79C6">            try?</span><span style="color:#F8F8F2"> FileManager.default</span></span>
<span class="line"><span style="color:#F8F8F2">                .</span><span style="color:#8BE9FD">createDirectory</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">at</span><span style="color:#F8F8F2">: tempURL.</span><span style="color:#8BE9FD">appendingPathComponent</span><span style="color:#F8F8F2">(subDirectory), </span><span style="color:#8BE9FD">withIntermediateDirectories</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> url </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> tempURL.</span><span style="color:#8BE9FD">appendingPathComponent</span><span style="color:#F8F8F2">(subDirectory).</span><span style="color:#8BE9FD">appendingPathComponent</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#F8F8F2">            name </span><span style="color:#FF79C6">+</span><span style="color:#E9F284"> &quot;</span><span style="color:#F1FA8C">.sqlite</span><span style="color:#E9F284">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2">        )</span></span>
<span class="line"><span style="color:#6272A4">        // 删除原本的数据库文件，保证每次测试数据环境都是全新的</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> FileManager.default.</span><span style="color:#8BE9FD">fileExists</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">atPath</span><span style="color:#F8F8F2">: url.path) {</span></span>
<span class="line"><span style="color:#FF79C6">            try?</span><span style="color:#F8F8F2"> FileManager.default.</span><span style="color:#8BE9FD">removeItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">at</span><span style="color:#F8F8F2">: url)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSPersistentContainer</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">name</span><span style="color:#F8F8F2">: name, </span><span style="color:#8BE9FD">managedObjectModel</span><span style="color:#F8F8F2">: model)</span></span>
<span class="line"><span style="color:#FF79C6">        let</span><span style="color:#F8F8F2"> description </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> NSPersistentStoreDescription</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">url</span><span style="color:#F8F8F2">: url)</span></span>
<span class="line"><span style="color:#F8F8F2">        description.configuration </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> configurationName</span></span>
<span class="line"><span style="color:#F8F8F2">        description.shouldAddStoreAsynchronously </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> false</span></span>
<span class="line"><span style="color:#6272A4">        // 开启 Persistent History Tracking</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2"> enablePHT {</span></span>
<span class="line"><span style="color:#F8F8F2">            description.</span><span style="color:#8BE9FD">setOption</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">true</span><span style="color:#FF79C6"> as</span><span style="color:#F8F8F2"> NSNumber, </span><span style="color:#8BE9FD">forKey</span><span style="color:#F8F8F2">: NSPersistentHistoryTrackingKey)</span></span>
<span class="line"><span style="color:#F8F8F2">            description.</span><span style="color:#8BE9FD">setOption</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">true</span><span style="color:#FF79C6"> as</span><span style="color:#F8F8F2"> NSNumber, </span><span style="color:#8BE9FD">forKey</span><span style="color:#F8F8F2">: NSPersistentStoreRemoteChangeNotificationPostOptionKey)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">        container.persistentStoreDescriptions </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> [description]</span></span>
<span class="line"><span style="color:#F8F8F2">        container.loadPersistentStores { </span><span style="color:#BD93F9">_</span><span style="color:#F8F8F2">, error </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#FF79C6">            if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> error {</span></span>
<span class="line"><span style="color:#8BE9FD">                fatalError</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">加载 Persistent Store 失败: </span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">error</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">        return</span><span style="color:#F8F8F2"> container</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>相比使用内存数据库（<code>/dev/null</code>）的 <code>viewContext</code>，在单元测试中基于独立数据库和 Actor 的数据操作效率更高，而且完全避免了串行模式下，<code>viewContext</code> 因数据准备不足导致的测试不稳定情况。</p>
<p>关于 SwiftData 和 Core Data 单元测试的技巧，本身也是一个值得深入探讨的话题，后续会专门撰文进行探讨。</p>
<div class="dynamic-ad-container pt-4"></div>
<h2 id="最后">最后</h2>
<p>本文重点探讨了如何将 SwiftData 的新思维融入 Core Data 项目。可以看出，开发者为了实现类似 SwiftData 的体验，往往需要额外投入大量精力。这也反映了 SwiftData 在背后为实现自动转换所做的巨大工作量，毕竟它需要兼顾更多的场景并提高通用性。同时，由于引入了与 Core Data 的解耦层，SwiftData 在性能和稳定性方面面临着巨大的挑战。</p>
<p>那么，在付出更多工作量后，应用 SwiftData 思维的 Core Data 代码效果如何呢？至少对我而言，结果是十分令人满意的。除了在建模过程中需要投入更多精力外，在各个方面都获得了与 SwiftData 相似的体验，并且在现阶段具备了更好的性能和稳定度。</p>
<p>新架构未能带来预期的稳定性固然令人遗憾，但如果我们能从中学习并领悟新的知识，并将其应用于现有的框架和项目中，无疑会有所收获。</p> </div> </article>  <!-- Modal toggle --><button data-modal-target="default-modal" data-modal-toggle="default-modal" class="hidden text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
Toggle modal
</button> <!-- Main modal --> <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"> <div id="default-modal" tabindex="-1" aria-hidden="true" class="hidden w-full h-full justify-center items-center"> <div class="relative p-4 w-full max-w-2xl"> <!-- Modal content --> <div class="relative bg-white rounded-lg shadow-2xl dark:bg-gray-800 border-gray-200 border dark:border-gray-600"> <!-- Modal header --> <div class="flex items-center justify-between px-4 md:px-5 pt-4 pb-0 rounded-t dark:border-gray-600"> <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="default-modal"> <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path> </svg> <span class="sr-only">Close modal</span> </button> </div> <!-- Modal body --> <div class="px-4 md:px-5 pb-4"> <div class="w-full mx-auto text-center px-6 pb-6"> <div class="text-lg font-semibold text-gray-900 dark:text-blue-100 pt-4 pb-8">每周一，与您分享精心筛选的 Swift 与 SwiftUI 开发精华</div> <div id="custom-substack-embed1"></div> <!-- <div class="text-gray-700 dark:text-blue-200 text-xs font-medium pt-4">{bottomTip}</div> --> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };

    // 创建一个新的 MutationObserver 实例
    const observer = new MutationObserver((mutationsList, observer) => {
      // 遍历所有的 mutations
      for (let mutation of mutationsList) {
        // 如果这个 mutation 是一个子节点的添加或删除
        if (mutation.type === 'childList') {
          // 查找订阅框
          const widget = document.querySelector('.custom-substack-widget1');
          if (widget) {
            // 查找 input 元素
            const input = widget.querySelector('input');
            const button = widget.querySelector('button');
            // 根据当前的颜色方案修改订阅框的样式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              // 暗黑模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            } else {
              // 正常模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            }

            if (window.matchMedia('(max-width: 640px)').matches) {
              // 屏幕尺寸小于 640px
              widget.style.maxWidth = '325px';
            } else {
              // 屏幕尺寸大于或等于 640px
              widget.style.maxWidth = '600px';
            }
            // 停止观察
            observer.disconnect();
          }
        }
      }
    });

    // 开始观察 #custom-substack-embed 元素的子节点的变化
    observer.observe(document.getElementById('custom-substack-embed1'), { childList: true });
  })();</script> <script src="/js/subscriber.js" async></script> </div> <div class="flex justify-center pb-6"> <button data-modal-hide="default-modal" type="button" class="text-gray-600 dark:text-gray-400 bg-transparent hover:text-gray-800 dark:hover:text-gray-200 font-medium rounded-lg text-sm px-8 py-2.5 text-center transition-colors">继续阅读</button> </div> </div> </div> </div> </div> </div> <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "author": {
    "@type": "Person",
    "name": "Fatbobman",
    "url": "https://twitter.com/fatbobman"
  },
  "dateModified": "2024-10-16T14:00:00.000Z",
  "datePublished": "2024-10-16T14:00:00.000Z",
  "description": "探索如何将 SwiftData 的现代思维融入 Core Data，重点关注数据建模与并发编程。本文侧重设计思路，助你构建稳定高效的数据方案。",
  "headline": "以 SwiftData 之道，重塑 Core Data 开发",
  "image": {
    "@type": "ImageObject",
    "url": [
      {
        "url": "https://cdn.fatbobman.com/card/reinventing-core-data-development-with-swiftdata-principles-zh.webp"
      }
    ]
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fatbobman.com/zh/posts/reinventing-core-data-development-with-swiftdata-principles/"
  },
  "url": "https://fatbobman.com/zh/posts/reinventing-core-data-development-with-swiftdata-principles/",
  "publisher": {
    "@type": "Organization",
    "name": "Fatbobman's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fatbobman.com/images/blog-card.png"
    }
  }
}</script> <div class="pt-6 pb-6  dark:border-gray-700"> <!-- <p class="flex justify-center align-center text-sm font-medium text-heading">
    { lang === Lang.ZH && <SupportMeTextZH /> }
    { lang === Lang.EN && <SupportMeTextEN /> }
  </p> --> <div class="flex flex-col sm:flex-row justify-center items-center mx-auto sm:space-x-8 align-center pt-2"> <button type="button" class="text-gray-900 bg-yellow-200 hover:bg-yellow-300 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://www.buymeacoffee.com/fatbobman')"> <img src="/images/buymeacoffee.svg" alt="Buy me a coffee" class="w-5 h-5 me-2 -ms-1"> <span class="text-black font-medium">Buy me a coffee</span> </button> <div class="pt-4 sm:pt-0"> <button type="button" class="text-red-500 bg-[#3270e1] hover:bg-blue-700 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://afdian.com/a/fatbobman')"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="mr-2">  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path>  </svg> <span class="text-white font-medium">爱发电(微信/支付宝)</span> </button>  </div> </div> </div> <!-- <WeeklySubscribe1 lang={lang} top={0} bottom={4}/> --> <div id="copy-alert" class="hidden fixed bottom-28 right-5"> <div id="alert-1" class="flex items-center p-4 mb-4 text-blue-800 rounded-lg bg-blue-50/90 dark:bg-gray-800/90 dark:text-blue-400" role="alert"> <div class="text-sm font-medium">链接已复制</div> </div> </div> <style>
  .copy-icon {
    position: absolute;
    left: -30px; /* 根据您的布局调整位置 */
    top: 50%; /* 将图标定位到标题的中间高度 */
    transform: translateY(-50%); /* 垂直居中对齐图标 */
    cursor: pointer;
    transition: opacity 0.6s ease;
    pointer-events: all; /* 始终响应鼠标事件 */
  }

  article h2,
  article h3,
  article h4,
  article h5 {
    position: relative;
  }

  #copy-alert {
    position: fixed;
    bottom: -100px; /* 初始在视窗下方 */
    right: 20px;
    transition: bottom 0.5s ease-in-out;
  }

  /* 进入动画 */
  @keyframes slideIn {
    from {
      bottom: -100px;
    }
    to {
      bottom: 0px;
    }
  }

  /* 消失动画 */
  @keyframes slideOut {
    from {
      bottom: 20px;
    }
    to {
      bottom: -100px;
    }
  }
</style> <script>
  var hideTimeout; // 用于保存自动隐藏定时器的引用
  document.querySelectorAll('article h2, article h3, article h4, article h5').forEach(function (header) {
    var copyIcon = document.createElement('span');
    copyIcon.innerHTML =
      '<svg fill="currentColor" aria-hidden="true" stroke="currentColor" class="w-5 h-5 hidden md:block hover:text-secondary" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M861.866667 164.266667c-87.466667-87.466667-230.4-89.6-320-2.133334l-68.266667 68.266667c-12.8 12.8-12.8 32 0 44.8s32 12.8 44.8 0l68.266667-68.266667c64-61.866667 166.4-61.866667 230.4 2.133334 64 64 64 168.533333 2.133333 232.533333l-117.333333 119.466667c-34.133333 34.133333-81.066667 51.2-128 49.066666-46.933333-4.266667-91.733333-27.733333-119.466667-66.133333-10.666667-14.933333-29.866667-17.066667-44.8-6.4-14.933333 10.666667-17.066667 29.866667-6.4 44.8 40.533333 53.333333 100.266667 87.466667 166.4 91.733333h17.066667c59.733333 0 119.466667-23.466667 162.133333-68.266666l117.333333-119.466667c83.2-89.6 83.2-234.666667-4.266666-322.133333z"></path><path d="M505.6 750.933333l-66.133333 68.266667c-64 61.866667-166.4 61.866667-230.4-2.133333-64-64-64-168.533333-2.133334-232.533334l117.333334-119.466666c34.133333-34.133333 81.066667-51.2 128-49.066667 46.933333 4.266667 91.733333 27.733333 119.466666 66.133333 10.666667 14.933333 29.866667 17.066667 44.8 6.4 14.933333-10.666667 17.066667-29.866667 6.4-44.8-40.533333-53.333333-100.266667-87.466667-166.4-91.733333-66.133333-4.266667-130.133333 19.2-177.066666 66.133333l-117.333334 119.466667c-85.333333 89.6-85.333333 234.666667 2.133334 322.133333 44.8 44.8 102.4 66.133333 162.133333 66.133334 57.6 0 115.2-21.333333 160-64l66.133333-68.266667c12.8-12.8 12.8-32 0-44.8-14.933333-10.666667-34.133333-10.666667-46.933333 2.133333z"></path></svg>'; // 使用您选择的图标
    copyIcon.className = 'copy-icon';
    copyIcon.style.opacity = '0'; // 默认透明
    header.insertBefore(copyIcon, header.firstChild);

    header.addEventListener('mouseover', function () {
      copyIcon.style.opacity = '1';
    });
    header.addEventListener('mouseout', function () {
      copyIcon.style.opacity = '0';
    });

    copyIcon.addEventListener('click', function () {
        var url = window.location.href.split('#')[0] + '#' + header.id;
        navigator.clipboard.writeText(url).then(function () {
            var alertDiv = document.getElementById('copy-alert');
            if (alertDiv) {
                alertDiv.classList.remove('hidden'); // 确保提示框是可见的
                alertDiv.style.display = 'block'; // 显示提示框
                clearTimeout(hideTimeout); // 清除之前的定时器
                alertDiv.style.animation = 'none'; // 先清除之前的动画
                setTimeout(function () {
                    alertDiv.style.animation = 'slideIn 0.5s forwards'; // 应用新动画
                }, 10);

                // 设置自动隐藏定时器
                hideTimeout = setTimeout(function () {
                    alertDiv.style.animation = 'slideOut 0.5s forwards'; // 应用消失动画
                    setTimeout(function () {
                        alertDiv.style.display = 'none';
                    }, 500);
                }, 3000);
            }
        });
    });
  });
</script> <script>
function copyCode(button, event) {
  event.preventDefault();
  const codeBlock = button.parentNode.nextElementSibling.textContent; // 获取代码内容
  navigator.clipboard.writeText(codeBlock).then(() => {
    // 显示 "Copied"
    button.querySelector('.copy-text').style.display = 'none';
    button.querySelector('.copied-text').style.display = 'inline';

    // 3秒后恢复
    setTimeout(() => {
      button.querySelector('.copy-text').style.display = 'inline';
      button.querySelector('.copied-text').style.display = 'none';
    }, 3000);
  });
}
</script> <script>(function(){const url = "https://fatbobman.com/ads/zh";

  fetch(url)
    .then(response => response.text())
    .then(html => {
      // 获取所有的广告位元素
      const adSlots = document.querySelectorAll('.dynamic-ad-container');
      // 将广告内容填充到每一个广告位中
      adSlots.forEach(slot => {
        slot.innerHTML = html;
      });
    })
    .catch(error => console.error('Error loading the ad:', error));
})();</script>  <!-- <LeaveFeedback lang={lang} /> --> <section class="pt-10"><div class="max-w-5xl sm:px-4 py-2 mx-auto"><div class="grid gap-4 sm:gap-2 sm:mx-4 sm:grid-cols-12"><div class="col-span-12 sm:col-span-3 hidden sm:block"><div class="text-center sm:text-left mt-3 mb-14 before:block before:w-24 before:h-1 before:mb-3 before:rounded before:mx-auto sm:before:mx-0 before:bg-secondary"><h3 class="text-lg font-medium text-default">相关文章</h3></div></div><div class="sm:hidden text-lg font-medium text-heading col-span-12 text-left">相关文章</div><div class="relative col-span-12 sm:px-4 space-y-6 sm:col-span-9"><div class="col-span-12 space-y-2 relative sm:px-4 sm:col-span-8 sm:space-y-4 sm:before:absolute sm:before:top-2 sm:before:bottom-0 sm:before:w-0.5 sm:before:-left-3 before:bg-block"><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/" id="relatedPosts-SwiftData 实战：用现代方法构建 SwiftUI 应用"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData 实战：用现代方法构建 SwiftUI 应用</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/swiftdata-in-wwdc2024/" id="relatedPosts-SwiftData in WWDC 2024：革命仍在继续、稳定还需时日"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData in WWDC 2024：革命仍在继续、稳定还需时日</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/core-data-reform-achieving-elegant-concurrency-operations-like-swiftdata/" id="relatedPosts-Core Data 改革：实现 SwiftData 般的优雅并发操作"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">Core Data 改革：实现 SwiftData 般的优雅并发操作</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/before-wwdc-2024-swiftdata/" id="relatedPosts-写在 WWDC 2024 之前：SwiftData 的未来潜力与现实挑战"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">写在 WWDC 2024 之前：SwiftData 的未来潜力与现实挑战</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/concurrencyofcoredata/" id="relatedPosts-关于 Core Data 并发编程的几点提示"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">关于 Core Data 并发编程的几点提示</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/from-data-model-construction-to-managed-object-instances-in-core-data/" id="relatedPosts-CoreData 探秘 - 从数据模型构建到托管对象实例"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">CoreData 探秘 - 从数据模型构建到托管对象实例</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/spotlight/" id="relatedPosts-在 Spotlight 中展示应用中的 Core Data 数据"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">在 Spotlight 中展示应用中的 Core Data 数据</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/weekly/issue-052" id="relatedPosts-Weekly #52 - 回顾初心，写在周报创刊一周年"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">Weekly #52 - 回顾初心，写在周报创刊一周年</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/relationships-in-swiftdata-changes-and-considerations/" id="relatedPosts-SwiftData 中的关系：变化与注意事项"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData 中的关系：变化与注意事项</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/concurret-programming-in-swiftdata/" id="relatedPosts-SwiftData 中的并发编程"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData 中的并发编程</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/what-s-new-in-core-data-in-wwdc23/" id="relatedPosts-WWDC 2023 Core Data 有哪些新变化"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">WWDC 2023 Core Data 有哪些新变化</h3></div></a></div></div></div></div></section> <!-- <BottomWeeklySubscribe lang={lang} /> --> <div><div id="gitalk-container" data-comment-id="以 SwiftData 之道，重塑 Core Data 开发" data-lang="zh"></div><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script></div><script>
  document.addEventListener('DOMContentLoaded', async function () {
    console.log('fetching comment is enable');
    const response = await fetch('https://fatbobman.com/status/comment');
    const data = await response.text();
    console.log(data);
    if (data === '1') {
      var container = document.getElementById('gitalk-container');
      if (container) {
        var commentID = container.getAttribute('data-comment-id');
        var lang = container.getAttribute('data-lang');

        var gitalk = new Gitalk({
          clientID: 'fcf61195c7f73253dc8b',
          clientSecret: '0ac2907be08248a1fcb5312e27480ad535c682e5',
          repo: 'blogComments',
          owner: 'fatbobman',
          admin: ['fatbobman'],
          id: commentID.split('/').pop().substring(0, 49),
          distractionFreeMode: true,
          createIssueManually: true,
          language: lang,
        });

        gitalk.render('gitalk-container');
      }
    }
  });
</script> <div class="hidden xl:block w-44 lg:absolute" id="toc" style="left: -30px; top: 0px"> <div class="text-muted items-center justify-center overflow-x-clip"> <div class="w-full flex justify-start pb-2" id="toc-button"> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" id="toc-list-switcher"> <path d="M170.666667 277.333333a85.333333 85.333333 0 1 0 0-170.666666 85.333333 85.333333 0 0 0 0 170.666666zM405.333333 128a64 64 0 1 0 0 128h469.333334a64 64 0 0 0 0-128h-469.333334zM341.333333 490.666667A64 64 0 0 1 405.333333 426.666667h469.333334a64 64 0 0 1 0 128h-469.333334A64 64 0 0 1 341.333333 490.666667z m0 298.666666A64 64 0 0 1 405.333333 725.333333h469.333334a64 64 0 0 1 0 128h-469.333334A64 64 0 0 1 341.333333 789.333333z m-85.333333-298.666666a85.333333 85.333333 0 1 1-170.666667 0 85.333333 85.333333 0 0 1 170.666667 0z m-85.333333 384a85.333333 85.333333 0 1 0 0-170.666667 85.333333 85.333333 0 0 0 0 170.666667z"></path> </svg>  </div> </div> <div class="text-default text-xs hidden" id="toc-list"> <ul> <li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#2024-年了swiftdata-准备好了吗？" class=""> 2024 年了，SwiftData 准备好了吗？ </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#声明数据模型" class=""> 声明数据模型 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#建模思路" class=""> 建模思路 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#可选值与默认值" class=""> 可选值与默认值 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#枚举与-codable" class=""> 枚举与 Codable </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#关系" class=""> 关系 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#构造方法" class=""> 构造方法 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#模型验证" class=""> 模型验证 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#模块化" class=""> 模块化 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#并发" class=""> 并发 </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#用-actor-替换" class=""> 用 Actor 替换 perform </a> </div> </li><li class="pl-2 pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#测试" class=""> 测试 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#最后" class=""> 最后 </a> </div> </li> </ul> </div> </div> </div> <style>
  #toc-list {
    transition: all 0.9s ease-in-out;
  }

  #toc-button {
    transition: all 0.9s ease-in-out;
  }
</style> <script>
  function getOffsetTop(element) {
    var offsetTop = 0;
    while (element) {
      offsetTop += element.offsetTop;
      element = element.offsetParent;
    }
    return offsetTop;
  }

  var toc = document.querySelector('#toc');
  // 获取 sidebar 在浏览器中的初始 top 值
  var initialTop = getOffsetTop(toc);
  var positioningElement = document.querySelector('#article-area'); // 定位视图的选择器
  var stickyPoint = 150;
  var tocPadding = 30;
  var tocTopOffset = 4;
  var sidebarWidth = toc.offsetWidth;

  function adjustTocPosition() {
    var sidebarOffsetTop = toc.getBoundingClientRect().top;
    console.log(sidebarOffsetTop, window.scrollY, initialTop - stickyPoint);
    if (sidebarOffsetTop <= stickyPoint) {
      // 获取 positioningElement 的左侧侧与浏览器左侧之间的距离
      var positioningElementRight = (window.innerWidth - positioningElement.getBoundingClientRect().width) / 2;
      toc.style.position = 'fixed';
      toc.style.top = stickyPoint + 'px';
      toc.style.left = positioningElementRight - toc.getBoundingClientRect().width - tocPadding + 'px';
    }

    if (window.scrollY <= initialTop - stickyPoint) {
      toc.style.position = 'absolute';
      toc.style.top = tocTopOffset + 'px';
      toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';
    }
  }

  document.addEventListener('scroll', adjustTocPosition);
  window.addEventListener('resize', adjustTocPosition);
  // doc 加载完成后，调整 toc 的位置
  toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';

  document.addEventListener('DOMContentLoaded', function () {
    const tocList = document.getElementById('toc-list');
    const tocButton = document.getElementById('toc-button');

    // 更新toc-list和toc-button的显示状态
    function updateDisplay() {
      const showToc = localStorage.getItem('showToc') === 'true';
      if (showToc) {
        tocList.classList.remove('hidden');
        tocButton.classList.add('justify-start');
        tocButton.classList.remove('justify-end');
      } else {
        tocList.classList.add('hidden');
        tocButton.classList.remove('justify-start');
        tocButton.classList.add('justify-end');
      }
    }

    // 初始状态检查
    updateDisplay();

    // 点击事件监听器，用于切换toc-list的显示状态并更新按钮位置
    tocButton.addEventListener('click', function () {
      const isHidden = tocList.classList.contains('hidden');
      localStorage.setItem('showToc', isHidden);
      updateDisplay();
    });
  });
</script> <div class="hidden md:block md:absolute" id="sidebar" style="right: -50px; top: 0px"> <div class="flex flex-col space-y-4 text-muted items-center justify-center"> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="/zh/posts/comprehensive-guide-to-mastering-keypath-in-swift/" data-tooltip-target="tooltip-previous-post" data-tooltip-placement="left" id="sidebar-previous-post"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12.089 3.634a2 2 0 0 0 -1.089 1.78l-.001 2.586h-6.999a2 2 0 0 0 -2 2v4l.005 .15a2 2 0 0 0 1.995 1.85l6.999 -.001l.001 2.587a2 2 0 0 0 3.414 1.414l6.586 -6.586a2 2 0 0 0 0 -2.828l-6.586 -6.586a2 2 0 0 0 -2.18 -.434l-.145 .068z" stroke-width="0" fill="currentColor"></path></svg> </a>  </div> <div id="tooltip-previous-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> 从基础到进阶：Swift 中的 KeyPath 完全指南 <div class="tooltip-arrow" data-popper-arrow></div> </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="/zh/posts/userdefaults-and-observation/" data-tooltip-target="tooltip-next-post" data-tooltip-placement="left" id="sidebar-next-post"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9.586 4l-6.586 6.586a2 2 0 0 0 0 2.828l6.586 6.586a2 2 0 0 0 2.18 .434l.145 -.068a2 2 0 0 0 1.089 -1.78v-2.586h7a2 2 0 0 0 2 -2v-4l-.005 -.15a2 2 0 0 0 -1.995 -1.85l-7 -.001v-2.585a2 2 0 0 0 -3.414 -1.414z" stroke-width="0" fill="currentColor"></path></svg> </a>  </div> <div id="tooltip-next-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> SwiftUI 中的 UserDefaults 与 Observation：如何实现精准响应 <div class="tooltip-arrow" data-popper-arrow></div> </div> <div class="hidden" id="dict-randomURLS" data-randomurls="[&#34;/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/&#34;,&#34;/zh/posts/swiftdata-in-wwdc2024/&#34;,&#34;/zh/posts/core-data-reform-achieving-elegant-concurrency-operations-like-swiftdata/&#34;,&#34;/zh/posts/before-wwdc-2024-swiftdata/&#34;,&#34;/zh/posts/concurrencyofcoredata/&#34;,&#34;/zh/posts/from-data-model-construction-to-managed-object-instances-in-core-data/&#34;,&#34;/zh/posts/spotlight/&#34;,&#34;/zh/posts/relationships-in-swiftdata-changes-and-considerations/&#34;,&#34;/zh/posts/concurret-programming-in-swiftdata/&#34;,&#34;/zh/posts/what-s-new-in-core-data-in-wwdc23/&#34;]" data-astro-cid-qwm5cfxr></div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:18px; height:18px;">  <svg fill="currentColor" stroke="currentColor" onclick="openRandomUrl()" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" id="sidebar-random-post" data-astro-cid-qwm5cfxr> <path d="M956.222464 226.56a28.8256 28.8256 0 0 0 18.5344-17.5104 26.368 26.368 0 0 0-3.5328-24.4224 46.9504 46.9504 0 0 0-20.1216-14.08A18601.6256 18601.6256 0 0 0 712.152064 74.5472L524.555264 0h-25.6l-17.0496 7.0144C359.384064 55.3472 237.528064 103.0144 115.672064 152.6272l-46.7456 18.8928a29.3888 29.3888 0 0 0-21.1456 27.1872 28.6208 28.6208 0 0 0 20.48 27.8528c1.6896 0 5.12 1.8944 6.8096 2.8672C214.027264 288 353.240064 346.2144 492.145664 405.0944a44.8 44.8 0 0 0 40.6016 0L887.972864 256c23.8592-9.9328 45.7216-20.1728 68.2496-29.44zM341.976064 224a121.4464 121.4464 0 0 1-126.2592 0 31.6928 31.6928 0 0 1-16.9984-27.648c0-11.4688 6.4512-22.016 16.9984-27.6992a98.9696 98.9696 0 0 1 54.272-17.6128c25.3952-1.9456 50.7904 4.2496 71.9872 17.6128a31.6928 31.6928 0 0 1 16.9984 27.648 31.6928 31.6928 0 0 1-16.9984 27.648z m233.0624 0c-38.4 24.2176-88.576 24.2176-126.976 0a31.6416 31.6416 0 0 1-16.384-27.392c0-11.1616 6.2464-21.504 16.384-27.3408 19.968-12.9024 44.032-19.0976 68.3008-17.6128 19.9168 0.1024 39.3216 5.9392 55.6032 16.64 11.0592 5.12 18.2272 15.4624 18.8928 27.0336a31.488 31.488 0 0 1-15.8208 28.672z m234.4448 0a121.4464 121.4464 0 0 1-126.2592 0 31.6928 31.6928 0 0 1-16.9984-27.648c0-11.4688 6.4512-22.016 16.9984-27.6992 17.8688-12.8 39.936-19.3024 62.464-18.2784 22.3232-1.024 44.3392 5.2224 62.464 17.6128a31.8464 31.8464 0 0 1 18.2784 27.648 31.6416 31.6416 0 0 1-16.9472 28.3648zM468.235264 437.0944c-30.72-12.4928-61.44-25.2928-92.4672-39.0144-109.568-46.08-217.088-90.2656-325.2224-135.68a36.096 36.096 0 0 0-31.3856-1.9456 33.6896 33.6896 0 0 0-18.432 33.9456v495.9744c-2.048 27.0848 14.9504 52.2752 41.984 62.0544 133.12 55.3472 265.1136 110.7456 397.2096 167.0656 28.672 11.776 49.4592 0 49.4592-30.1056V475.4944c4.096-16.1792-5.6832-32.5632-22.528-37.7344l1.3824-0.6656z m-197.5808 243.2a34.4064 34.4064 0 0 1-28.16 16.64 34.9184 34.9184 0 0 1-29.8496-13.7728 91.8016 91.8016 0 0 1-22.528-75.2128c2.5088-15.0016 7.68-29.4912 15.36-42.8544a34.304 34.304 0 0 1 27.648-17.0496 35.072 35.072 0 0 1 30.0032 12.9024c15.3088 16.5376 23.7568 37.632 23.9104 59.4944 1.28 21.0432-4.4544 41.984-16.384 59.8528z m704.3072-417.8944l-416.256 175.0016a36.4544 36.4544 0 0 0-24.9344 36.5056v514.8672a28.416 28.416 0 0 0 13.4144 29.184 32.768 32.768 0 0 0 33.9968 0.256L983.512064 848.896c25.0368-8.8576 41.4208-31.5392 40.96-56.6272V293.7344c0-28.7744-21.8624-42.5472-49.5104-31.3344z m-257.6384 578.2016a34.8672 34.8672 0 0 1-30.208 14.2848 34.304 34.304 0 0 1-28.4672-17.152 103.5264 103.5264 0 0 1 7.5264-118.0672 34.9696 34.9696 0 0 1 30.6176-13.7216c12.032 0.8704 22.7328 7.68 28.0576 17.8688 10.24 16.8448 15.1552 35.9936 14.336 55.3472a92.16 92.16 0 0 1-21.8624 61.44z m181.9136-293.12a34.816 34.816 0 0 1-31.3344 15.4112 34.1504 34.1504 0 0 1-29.0816-18.944 104.0384 104.0384 0 0 1 5.7856-115.5072 34.6624 34.6624 0 0 1 32.9216-16.8448 33.792 33.792 0 0 1 29.5424 21.6576c9.216 14.592 13.824 31.3856 13.312 48.3328 0.6144 23.7568-7.4752 47.0016-22.8864 65.8944h1.7408z" p-id="9271" data-astro-cid-qwm5cfxr></path> </svg>  </div>  <script>
  function openRandomUrl() {
    const dataElement = document.getElementById('dict-randomURLS');
    const urls = JSON.parse(dataElement.getAttribute('data-randomurls'));

    if (urls && urls.length > 0) {
      const randomUrl = urls[Math.floor(Math.random() * urls.length)];
      window.open(randomUrl, '_self');
    }
  }

  const svgElement = document.getElementById('sidebar-random-post');

  setInterval(() => {
    svgElement.classList.add('rotate');

    // Remove the class after the animation completes (1 second)
    setTimeout(() => {
      svgElement.classList.remove('rotate');
    }, 1000);
  }, 15000); // 20 seconds interval
</script> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://x.com/intent/tweet?text=以 SwiftData 之道，重塑 Core Data 开发&#38;url=https://fatbobman.com/zh/posts/reinventing-core-data-development-with-swiftdata-principles/&#38;hashtags=ios,swiftlang&#38;via=fatbobman" target="_blank" id="sidebar-share-with-twitter"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 4l11.733 16h4.267l-11.733 -16z"></path><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"></path></svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://bsky.app/intent/compose?text=以 SwiftData 之道，重塑 Core Data 开发%0A by %40fatbobman.bsky.social %0Ahttps://fatbobman.com/zh/posts/reinventing-core-data-development-with-swiftdata-principles/%0A #ios #swift" target="_blank" id="sidebar-share-with-bluesky"> <svg xmlns="http://www.w3.org/2000/svg" class="text-default hover:text-secondary" width="20" height="20" viewBox="0 0 24 24" stroke-width="0.7" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <path d="M4.9 3.02725C5.6 3.12725 6.4 3.52725 7.5 4.22725C9.3 5.62725 10.8 7.32725 12 9.22726C13.2 7.42725 14.7 5.62725 16.5 4.32725C17.5 3.62725 18.4 3.22725 19.1 3.12725C19.9 3.02725 20.4 3.22725 20.7 3.32725C21.7 3.72725 22 4.92725 22 5.92725C22 6.12725 21.9 7.22725 21.8 8.32725C21.7 8.82725 21.7 9.42726 21.6 9.92726C21.5 10.3273 21.5 10.8273 21.4 11.0273C21.1 12.2273 20.3 13.0273 19.4 13.5273C20.3 14.2273 20.7 15.4273 20.3 16.5273C19.7 18.4273 17.6 20.9273 15.5 21.1273C13.7 21.3273 12.6 19.8273 11.9 18.3273C11.2 19.7273 10.1 21.2273 8.3 21.1273C6.2 20.9273 4.1 18.4273 3.5 16.5273C3.2 15.4273 3.5 14.2273 4.4 13.5273C3.5 13.0273 2.8 12.1273 2.4 11.0273C2.3 10.7273 2.3 10.3273 2.2 9.92726C2.1 9.42726 2.1 8.92725 2 8.32725C2.1 7.12725 2 6.02725 2 5.82725C2 4.82725 2.3 3.62725 3.3 3.22725C3.6 3.12725 4.1 2.92725 4.9 3.02725ZM4 6.52725C4.1 7.32725 4.2 8.62725 4.3 9.52725C4.3 9.82725 4.4 10.0273 4.4 10.3273C4.8 11.6273 6.3 12.4273 8.1 12.2273C8.6 12.1273 9.1 12.5273 9.2 13.1273C9.3 13.6273 8.9 14.1273 8.4 14.2273C7.6 14.3273 5.1 14.6273 5.5 15.8273C5.9 17.0273 7.3 18.9273 8.6 19.0273C9.5 19.1273 10.1 17.6273 10.4 17.0273C10.7 16.3273 10.9 15.6273 11.1 15.0273C11.2 14.6273 11.6 14.3273 12.1 14.3273C12.6 14.3273 12.9 14.6273 13.1 15.0273C13.3 15.6273 13.5 16.3273 13.8 17.0273C14.1 17.7273 14.6 19.1273 15.6 19.0273C16.9 18.9273 18.4 16.9273 18.7 15.8273C19.1 14.5273 16.5 14.3273 15.8 14.2273C15.3 14.1273 14.9 13.6273 15 13.1273C15.1 12.6273 15.6 12.2273 16.1 12.2273C17.9 12.4273 19.4 11.7273 19.8 10.3273C19.9 10.0273 19.9 9.82725 19.9 9.52725C20 8.62725 20.1 7.32725 20.2 6.52725C20.2 6.02725 20.4 4.92725 19.7 5.02725C19.4 5.02725 18.9 5.22725 18 5.92725C15.7 7.32725 14 9.42725 12.9 11.6273C12.7 11.9273 12.4 12.1273 12 12.1273C11.6 12.1273 11.3 11.9273 11.1 11.6273C10 9.42725 8.3 7.32725 6.3 5.92725C5.4 5.32725 4.9 5.12725 4.6 5.02725C3.8 4.92725 4 6.02725 4 6.52725Z" fill="currentColo"></path> </svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Freinventing-core-data-development-with-swiftdata-principles%2F" target="_blank" id="sidebar-share-with-facebook"> <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M767.428571 6.857143v150.857143h-89.714285q-49.142857 0-66.285715 20.571428t-17.142857 61.714286v108h167.428572l-22.285715 169.142857h-145.142857v433.714286H419.428571V517.142857H273.714286V348h145.714285V223.428571q0-106.285714 59.428572-164.857142T637.142857 0q84 0 130.285714 6.857143z" p-id="4213"></path></svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Freinventing-core-data-development-with-swiftdata-principles%2F&#38;title=%E4%BB%A5%20SwiftData%20%E4%B9%8B%E9%81%93%EF%BC%8C%E9%87%8D%E5%A1%91%20Core%20Data%20%E5%BC%80%E5%8F%91%0A%20%23ios%20%23swift%0A%20by%20%40fatbobman%0A" target="_blank" id="sidebar-share-with-weibo"> <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M457.3 543c-68.1-17.7-145 16.2-174.6 76.2-30.1 61.2-1 129.1 67.8 151.3 71.2 23 155.2-12.2 184.4-78.3 28.7-64.6-7.2-131-77.6-149.2z m-52 156.2c-13.8 22.1-43.5 31.7-65.8 21.6-22-10-28.5-35.7-14.6-57.2 13.7-21.4 42.3-31 64.4-21.7 22.4 9.5 29.6 35 16 57.3z m45.5-58.5c-5 8.6-16.1 12.7-24.7 9.1-8.5-3.5-11.2-13.1-6.4-21.5 5-8.4 15.6-12.4 24.1-9.1 8.7 3.2 11.8 12.9 7 21.5zM785.3 443.5c15 4.8 31-3.4 35.9-18.3 11.8-36.6 4.4-78.4-23.2-109-27.6-30.6-68.4-42.3-106-34.3-15.4 3.3-25.2 18.4-21.9 33.8 3.3 15.3 18.4 25.2 33.8 21.8 18.4-3.9 38.3 1.8 51.9 16.7 13.5 15 17.2 35.4 11.3 53.3-4.9 15.1 3.2 31.1 18.2 36z"></path><path d="M885.1 237.5c-56.7-62.9-140.4-86.9-217.7-70.5-17.9 3.8-29.3 21.4-25.4 39.3 3.8 17.9 21.4 29.3 39.3 25.5 55-11.7 114.4 5.4 154.8 50.1 40.3 44.7 51.2 105.7 34 159.1-5.6 17.4 3.9 36 21.3 41.7 17.4 5.6 36-3.9 41.6-21.2v-0.1c24.1-75.4 8.9-161.1-47.9-223.9zM729 499c-12.2-3.6-20.5-6.1-14.1-22.1 13.8-34.7 15.2-64.7 0.3-86-28-40.1-104.8-37.9-192.8-1.1 0 0-27.6 12.1-20.6-9.8 13.5-43.5 11.5-79.9-9.6-101-47.7-47.8-174.6 1.8-283.5 110.6C127.3 471.1 80 557.5 80 632.2 80 775.1 263.2 862 442.5 862c235 0 391.3-136.5 391.3-245 0-65.5-55.2-102.6-104.8-118zM443 810.8c-143 14.1-266.5-50.5-275.8-144.5-9.3-93.9 99.2-181.5 242.2-195.6 143-14.2 266.5 50.5 275.8 144.4C694.4 709 586 796.6 443 810.8z"></path></svg> </a>  </div> <div class="hidden opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:16px; height:16px;">  <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Freinventing-core-data-development-with-swiftdata-principles%2F" target="_blank" id="sidebar-share-with-linkedin"> <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 15 15"> <path fill-rule="evenodd" d="M7.979 5v1.586a3.5 3.5 0 0 1 3.082-1.574C14.3 5.012 15 7.03 15 9.655V15h-3v-4.738c0-1.13-.229-2.584-1.995-2.584-1.713 0-2.005 1.23-2.005 2.5V15H5.009V5h2.97ZM3 2.487a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" clip-rule="evenodd"></path> <path d="M3 5.012H0V15h3V5.012Z"></path> </svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="mailto:?subject=%E6%8E%A8%E8%8D%90%3A%20%E4%BB%A5%20SwiftData%20%E4%B9%8B%E9%81%93%EF%BC%8C%E9%87%8D%E5%A1%91%20Core%20Data%20%E5%BC%80%E5%8F%91&#38;body=%E6%88%91%E5%8F%91%E7%8E%B0%E4%BA%86%E8%BF%99%E7%AF%87%E6%9C%89%E8%B6%A3%E7%9A%84%E6%96%87%E7%AB%A0%EF%BC%8C%E6%83%B3%E5%88%86%E4%BA%AB%E7%BB%99%E4%BD%A0%EF%BC%9A%0A%0A%E4%BB%A5%20SwiftData%20%E4%B9%8B%E9%81%93%EF%BC%8C%E9%87%8D%E5%A1%91%20Core%20Data%20%E5%BC%80%E5%8F%91%0A%0A%E5%8E%9F%E6%96%87%E5%9C%B0%E5%9D%80%3A%20https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Freinventing-core-data-development-with-swiftdata-principles%2F" target="_blank" id="sidebar-share-with-email"> <svg fill="currentColor" stroke="currentColor" stroke-width="4" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M874.666667 181.333333H149.333333c-40.533333 0-74.666667 34.133333-74.666666 74.666667v512c0 40.533333 34.133333 74.666667 74.666666 74.666667h725.333334c40.533333 0 74.666667-34.133333 74.666666-74.666667V256c0-40.533333-34.133333-74.666667-74.666666-74.666667z m-725.333334 64h725.333334c6.4 0 10.666667 4.266667 10.666666 10.666667v25.6L512 516.266667l-373.333333-234.666667V256c0-6.4 4.266667-10.666667 10.666666-10.666667z m725.333334 533.333334H149.333333c-6.4 0-10.666667-4.266667-10.666666-10.666667V356.266667l356.266666 224c4.266667 4.266667 10.666667 4.266667 17.066667 4.266666s12.8-2.133333 17.066667-4.266666l356.266666-224V768c0 6.4-4.266667 10.666667-10.666666 10.666667z"></path></svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" onclick="scrollToElement()" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M573 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40zM293 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40z" p-id="13138"></path><path d="M894 345c-48.1-66-115.3-110.1-189-130v0.1c-17.1-19-36.4-36.5-58-52.1-163.7-119-393.5-82.7-513 81-96.3 133-92.2 311.9 6 439l0.8 132.6c0 3.2 0.5 6.4 1.5 9.4 5.3 16.9 23.3 26.2 40.1 20.9L309 806c33.5 11.9 68.1 18.7 102.5 20.6l-0.5 0.4c89.1 64.9 205.9 84.4 313 49l127.1 41.4c3.2 1 6.5 1.6 9.9 1.6 17.7 0 32-14.3 32-32V753c88.1-119.6 90.4-284.9 1-408zM323 735l-12-5-99 31-1-104-8-9c-84.6-103.2-90.2-251.9-11-361 96.4-132.2 281.2-161.4 413-66 132.2 96.1 161.5 280.6 66 412-80.1 109.9-223.5 150.5-348 102z m505-17l-8 10 1 104-98-33-12 5c-56 20.8-115.7 22.5-171 7l-0.2-0.1C613.7 788.2 680.7 742.2 729 676c76.4-105.3 88.8-237.6 44.4-350.4l0.6 0.4c23 16.5 44.1 37.1 62 62 72.6 99.6 68.5 235.2-8 330z" p-id="13139"></path><path d="M433 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40z" p-id="13140"></path></svg>  </div> <script>
  var offset = 80
  function scrollToElement() {
    var gitalkContainer = document.getElementById('gitalk-container');
    if (gitalkContainer) {
      var topPosition = gitalkContainer.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: topPosition, behavior: 'smooth' });
    }
  }
</script> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" onclick="window.scrollTo({top:0,behavior:'smooth'})" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M862.464 161.536l-700.928 0c-30.976 0-56.096-25.12-56.096-56.096l0-28.064c0-30.944 25.12-56.064 56.096-56.064l700.896 0c30.976 0 56.096 25.12 56.096 56.064l0 28.032c0 31.008-25.12 56.096-56.096 56.096l0 0 0 0zM138.528 531.68c0 0 306.816-245.792 309.888-248.864 14.304-13.888 31.904-22.368 49.952-25.312 1.76-0.32 3.488-0.608 5.248-0.8 2.816-0.32 5.6-0.352 8.384-0.352 2.816-0.032 5.568 0.032 8.352 0.352 1.792 0.192 3.552 0.48 5.28 0.8 18.048 2.976 35.616 11.424 49.92 25.312 3.104 3.008 309.856 248.864 309.856 248.864 33.152 32.224 30.304 65.44-2.784 97.696s-77.376 3.04-110.496-29.216l-190.08-150.432 0 496.864c0 31.008-25.088 56.096-56.096 56.096l-28 0c-30.976 0-56.096-25.12-56.096-56.096l0-496.864-190.048 150.432c-33.088 32.288-77.408 61.536-110.496 29.216-33.056-32.256-35.872-65.44-2.816-97.696l0 0 0 0z"></path></svg>  </div> </div> </div> <script>
  function getOffsetTop(element) {
    var offsetTop = 0;
    while (element) {
      offsetTop += element.offsetTop;
      element = element.offsetParent;
    }
    return offsetTop;
  }

  var sidebar = document.querySelector('#sidebar');
  // 获取 sidebar 在浏览器中的初始 top 值
  var initialTop = getOffsetTop(sidebar);
  var positioningElement = document.querySelector('#article-area'); // 定位视图的选择器
  var stickyPoint = 150;
  var padding = 50;
  var topOffset = 0;
  var sidebarWidth = sidebar.offsetWidth;

  function adjustSidebarPosition() {
    var sidebarOffsetTop = sidebar.getBoundingClientRect().top;
    if (sidebarOffsetTop <= stickyPoint) {
      // 获取 positioningElement 的右侧与浏览器右侧之间的距离
      var positioningElementRight = (window.innerWidth - positioningElement.getBoundingClientRect().width) / 2;
      sidebar.style.position = 'fixed';
      sidebar.style.top = stickyPoint + 'px';
      sidebar.style.right = positioningElementRight - padding + 'px';
    }

    if (window.scrollY <= initialTop - stickyPoint) {
      sidebar.style.position = 'absolute';
      sidebar.style.top =  topOffset + 'px';
      sidebar.style.right = '-' + padding + 'px';
    }
  }

  document.addEventListener('scroll', adjustSidebarPosition);
  window.addEventListener('resize', adjustSidebarPosition);
</script> </div>   </div> </main> </div> <footer> <footer class="bg-block"> <div class="mx-auto w-full max-w-3xl px-4 md:px-6"> <div class="container flex flex-col items-center pt-10"> <div class="flex flex-row justify-around w-full space-x-3"> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">网站</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://apps.apple.com/us/app/id1534513553" class="hover:text-secondary" target="_blank">健康笔记</a> <a href="https://discord.gg/zhou-zi-de-swiftji-shi-ben-967978112509935657" class="hover:text-secondary" target="_blank">Discord</a> <a href="/zh/posts/" class="hover:text-secondary">文章</a> <a href="/zh/tags/" class="hover:text-secondary">标签</a> <a href="/zh/collections/" class="hover:text-secondary">合集</a> <a href="/zh/snippet/" class="hover:text-secondary">小贴士</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">关注</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://weekly.fatbobman.com" class="hover:text-secondary">周报</a> <a href="https://x.com/fatbobman" class="hover:text-secondary" target="_blank">Twitter</a> <a href="https://mastodon.social/@fatbobman" class="hover:text-secondary" target="_blank">Mastodon</a> <a href="https://www.linkedin.com/in/fatbobman/" class="hover:text-secondary" target="_blank">Linkedin</a> <a href="https://bsky.app/profile/fatbobman.bsky.social" class="hover:text-secondary" target="_blank">Blue Sky</a> <a href="https://web.okjike.com/u/e32947ef-7751-4363-9456-b340eef2efd3" class="hover:text-secondary" target="_blank">
即刻
</a> <a href="https://github.com/fatbobman" class="hover:text-secondary" target="_blank">GitHub</a> <a href="/zh/rss.xml" class="hover:text-secondary hover:font-medium" target="_blank">RSS</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">信息</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="/zh/about/" class="hover:text-secondary">关于</a>  </div> </div> </div> <div class="pb-0"> <div class="flex items-center justify-center w-full px-6 pt-12 text-sm"> <span class="text-muted text-xs">Copyright © <span>2020-</span> 2025 <a href="https://x.com/fatbobman" class="border-b-secondary border-b-[1px]">Fatbobman Digital Limited</a>. All Rights
            Reserved.</span> </div> <div class="flex items-center justify-center w-full px-6 pt-2 text-sm pb-10"> <span> <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank" class="block text-xs text-muted">
辽ICP备20006550号-1
</a> </span> </div> </div> </div> </div> </footer> </footer> </div>   <!-- <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.js"></script> --><script type="module" src="/js/theme.js" defer></script> <script>(function(){const currentLang = "zh";

  function attachEvent(selector, event, fn) {
    const matches = typeof selector === 'string' ? document.querySelectorAll(selector) : selector;
    if (matches && matches.length) {
      matches.forEach((elem) => {
        elem.addEventListener(event, (e) => fn(e, elem), false);
      });
    }
  }

  // 为每个需要清除 focus 状态的按钮都添加一个 clear-focus 类, 下面的代码将在点击后自动移除 focus 状态
  document.addEventListener('DOMContentLoaded', (event) => {
    // 获取所有具有 'clear-focus' 类的按钮
    const buttons = document.querySelectorAll('.clear-focus');

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        setTimeout(() => {
          button.blur();
        }, 0);
      });
    });
  });

  window.onpageshow = function () {
    document.documentElement.classList.add('motion-safe:scroll-smooth');
  };
})();</script> <div id="docsearch-container-data" data-lang="zh" data-searchtext="搜索..."></div> <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script> <script src="/js/runsearch.js"></script> <!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5C7N4MF5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!-- End Google Tag Manager (noscript) --> </body></html>