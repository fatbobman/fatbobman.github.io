const A=document.getElementById("loadingAuth"),k=document.getElementById("mainContent"),m=document.getElementById("kvStatus"),D=document.getElementById("totalAds"),w=document.getElementById("logoutButton"),h=document.getElementById("adsList"),L=document.getElementById("createAdButton"),y=document.getElementById("adModal"),$=document.getElementById("closeModal"),S=document.getElementById("cancelButton"),I=document.getElementById("modalTitle"),x=document.getElementById("adForm"),N=document.getElementById("editDefaultButton"),p=document.getElementById("defaultAdModal"),C=document.getElementById("closeDefaultModal"),J=document.getElementById("cancelDefaultButton"),M=document.getElementById("defaultAdForm"),T=document.getElementById("validateDefaultButton"),v=document.getElementById("defaultZhTitle"),E=document.getElementById("defaultEnTitle");let i=null,f=null;async function O(){try{(await fetch("/api/admin/test-auth")).ok?(A.classList.add("hidden"),k.classList.remove("hidden"),j(),g()):window.location.href="/admin/login"}catch(s){console.error("Auth check failed:",s),window.location.href="/admin/login"}}async function j(){try{const s=await fetch("/test-kv?action=status"),e=await s.json();s.ok?(m.textContent=e.mode.includes("Mock")?"âš ï¸ Mock":"âœ“ Connected",m.className=e.mode.includes("Mock")?"text-2xl font-bold text-yellow-600 dark:text-yellow-400":"text-2xl font-bold text-green-600 dark:text-green-400"):(m.textContent="âœ— Error",m.className="text-2xl font-bold text-red-600 dark:text-red-400")}catch{m.textContent="âœ— Failed",m.className="text-2xl font-bold text-red-600 dark:text-red-400"}}async function g(){try{const s=Date.now(),e=await fetch(`/api/admin/ads?_t=${s}`,{cache:"no-cache",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}}),n=await e.json();if(e.ok&&n.success){if(i=n.data,D.textContent=n.count.toString(),F(n.data.schedules),n.data.default){const t=n.data.default.zh;Array.isArray(t)?v.innerHTML=t.map(o=>`<div class="mb-1"><strong>v${o.version}</strong> (style ${o.style||1}): ${o.title||"Untitled"}</div>`).join(""):t?v.textContent=t.title||"Not configured":v.textContent="Not configured";const d=n.data.default.en;Array.isArray(d)?E.innerHTML=d.map(o=>`<div class="mb-1"><strong>v${o.version}</strong> (style ${o.style||1}): ${o.title||"Untitled"}</div>`).join(""):d?E.textContent=d.title||"Not configured":E.textContent="Not configured"}}else h.innerHTML=`
            <div class="text-center py-8 text-red-600 dark:text-red-400">
              Failed to load advertisements: ${n.error||"Unknown error"}
            </div>
          `}catch(s){h.innerHTML=`
          <div class="text-center py-8 text-red-600 dark:text-red-400">
            Error: ${s.message}
          </div>
        `}}function F(s){if(s.length===0){h.innerHTML=`
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            No advertisements yet. Click "Create New Ad" to get started.
          </div>
        `;return}h.innerHTML=s.map(e=>{const n=new Date(e.startDate)<=new Date&&new Date<=new Date(e.endDate),t=e.enabled?n?"green":"blue":"gray",d=e.enabled?n?"ğŸŸ¢ Active":"ğŸ”µ Scheduled":"âšª Disabled";return`
          <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">
                    ${e.sponsorId}
                  </h3>
                  <span class="px-2 py-1 text-xs font-semibold rounded-full bg-${t}-100 dark:bg-${t}-900/30 text-${t}-700 dark:text-${t}-300">
                    ${d}
                  </span>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                  <div>ğŸ“… ${e.startDate} â†’ ${e.endDate}</div>
                  <div>ğŸŒ Variants: ${e.variants.zh?.length||0} Chinese, ${e.variants.en?.length||0} English</div>
                  ${e.notes?`<div>ğŸ“ ${e.notes}</div>`:""}
                </div>
              </div>
              <div class="flex items-center gap-2 ml-4">
                <button
                  class="edit-ad px-3 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                  data-id="${e.id}"
                >
                  âœï¸ Edit
                </button>
                <button
                  class="delete-ad px-3 py-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
                  data-id="${e.id}"
                >
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
            </div>
          </div>
        `}).join(""),document.querySelectorAll(".edit-ad").forEach(e=>{e.addEventListener("click",n=>{const t=n.target.closest("button")?.dataset.id;t&&z(t)})}),document.querySelectorAll(".delete-ad").forEach(e=>{e.addEventListener("click",n=>{const t=n.target.closest("button")?.dataset.id;t&&q(t)})})}L.addEventListener("click",()=>{f=null,I.textContent="Create Advertisement",x.reset(),document.getElementById("adId").value="",document.getElementById("variants").value=JSON.stringify({zh:[{version:1,style:1,title:"ç¤ºä¾‹æ ‡é¢˜",description:"ç¤ºä¾‹æè¿°",cta:"äº†è§£æ›´å¤š",link:"https://example.com",logo:"https://example.com/logo.png",features:["ç‰¹æ€§ 1","ç‰¹æ€§ 2"],badge:"èµåŠ©å•†"},{version:2,style:2,title:"ç®€æ´æ ‡é¢˜",description:"åƒæ–‡ç« å†…å®¹ä¸€æ ·çš„æè¿°æ–‡å­—",cta:"ä¼˜æƒ ä¿¡æ¯ â†’",link:"https://example.com",logo:"https://example.com/icon.png",badge:"æœ¬æœŸèµåŠ©"}],en:[{version:1,style:1,title:"Example Title",description:"Example description",cta:"Learn More",link:"https://example.com",logo:"https://example.com/logo.png",features:["Feature 1","Feature 2"],badge:"Sponsor"}]},null,2),y.classList.remove("hidden")});function z(s){const e=i.schedules.find(n=>n.id===s);e&&(f=s,I.textContent="Edit Advertisement",document.getElementById("adId").value=e.id,document.getElementById("sponsorId").value=e.sponsorId,document.getElementById("startDate").value=e.startDate,document.getElementById("endDate").value=e.endDate,document.getElementById("enabled").value=e.enabled.toString(),document.getElementById("notes").value=e.notes||"",document.getElementById("variants").value=JSON.stringify(e.variants,null,2),y.classList.remove("hidden"))}$.addEventListener("click",()=>y.classList.add("hidden"));S.addEventListener("click",()=>y.classList.add("hidden"));x.addEventListener("submit",async s=>{s.preventDefault();const e=new FormData(x);let n;try{n=JSON.parse(document.getElementById("variants").value)}catch{alert("Invalid JSON in variants field. Please check your syntax.");return}const t={id:f,sponsorId:e.get("sponsorId"),startDate:e.get("startDate"),endDate:e.get("endDate"),enabled:e.get("enabled")==="true",notes:e.get("notes"),variants:n};try{const r=await fetch("/api/admin/ads",{method:f?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),u=await r.json();r.ok&&u.success?(y.classList.add("hidden"),g()):alert(`Failed to save: ${u.error||"Unknown error"}`)}catch(d){alert(`Error: ${d.message}`)}});async function q(s){const e=i.schedules.find(n=>n.id===s);if(e&&confirm(`Are you sure you want to delete the advertisement for "${e.sponsorId}"?`))try{const n=await fetch(`/api/admin/ads?id=${s}`,{method:"DELETE"}),t=await n.json();n.ok&&t.success?g():alert(`Failed to delete: ${t.error||"Unknown error"}`)}catch(n){alert(`Error: ${n.message}`)}}N.addEventListener("click",()=>{!i||!i.default||(console.log("[Default Ad Editor] Current default data:",i.default),console.log("[Default Ad Editor] ZH data type:",Array.isArray(i.default.zh)?"array":"object"),console.log("[Default Ad Editor] EN data type:",Array.isArray(i.default.en)?"array":"object"),document.getElementById("defaultZhJson").value=JSON.stringify(i.default.zh,null,2),document.getElementById("defaultEnJson").value=JSON.stringify(i.default.en,null,2),document.getElementById("zhValidationErrors")?.classList.add("hidden"),document.getElementById("enValidationErrors")?.classList.add("hidden"),p.classList.remove("hidden"))});C.addEventListener("click",()=>p.classList.add("hidden"));J.addEventListener("click",()=>p.classList.add("hidden"));T.addEventListener("click",()=>{const s=document.getElementById("defaultZhJson").value,e=document.getElementById("defaultEnJson").value,n=[],t=[];let d,o;try{d=JSON.parse(s)}catch{n.push("Invalid JSON format")}try{o=JSON.parse(e)}catch{t.push("Invalid JSON format")}d&&(Array.isArray(d)?d.forEach((a,l)=>{["version","style","title","description","cta","link","logo","badge"].forEach(c=>{(a[c]===void 0||a[c]===null||a[c]==="")&&n.push(`[${l}] Missing field: ${c}`)}),a.version!==void 0&&(!Number.isInteger(a.version)||a.version<=0)&&n.push(`[${l}] Field 'version' must be a positive integer`),a.style!==void 0&&a.style!==1&&a.style!==2&&n.push(`[${l}] Field 'style' must be 1 or 2`),a.features!==void 0&&!Array.isArray(a.features)&&n.push(`[${l}] Field 'features' must be an array (or omit it)`)}):(["id","title","description","cta","link","logo","badge"].forEach(l=>{d[l]||n.push(`Missing field: ${l}`)}),d.features!==void 0&&!Array.isArray(d.features)&&n.push("features must be an array (or omit it)"))),o&&(Array.isArray(o)?o.forEach((a,l)=>{["version","style","title","description","cta","link","logo","badge"].forEach(c=>{(a[c]===void 0||a[c]===null||a[c]==="")&&t.push(`[${l}] Missing field: ${c}`)}),a.version!==void 0&&(!Number.isInteger(a.version)||a.version<=0)&&t.push(`[${l}] Field 'version' must be a positive integer`),a.style!==void 0&&a.style!==1&&a.style!==2&&t.push(`[${l}] Field 'style' must be 1 or 2`),a.features!==void 0&&!Array.isArray(a.features)&&t.push(`[${l}] Field 'features' must be an array (or omit it)`)}):(["id","title","description","cta","link","logo","badge"].forEach(l=>{o[l]||t.push(`Missing field: ${l}`)}),o.features!==void 0&&!Array.isArray(o.features)&&t.push("features must be an array (or omit it)")));const r=document.getElementById("zhValidationErrors"),u=document.getElementById("enValidationErrors");n.length>0?(r.classList.remove("hidden"),r.querySelector("ul").innerHTML=n.map(a=>`<li>${a}</li>`).join("")):r.classList.add("hidden"),t.length>0?(u.classList.remove("hidden"),u.querySelector("ul").innerHTML=t.map(a=>`<li>${a}</li>`).join("")):u.classList.add("hidden"),n.length===0&&t.length===0&&alert("âœ… Validation passed! All fields are valid.")});M.addEventListener("submit",async s=>{s.preventDefault();const e=document.getElementById("defaultZhJson").value,n=document.getElementById("defaultEnJson").value;let t,d;try{t=JSON.parse(e),d=JSON.parse(n)}catch{alert("Invalid JSON format. Please check your data.");return}console.log("[Default Ad Save] Saving data...",{zh:t,en:d});try{const o=await fetch("/api/admin/ads?action=update-default",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({zh:t,en:d})}),r=await o.json();if(console.log("[Default Ad Save] Response:",r),o.ok&&r.success)p.classList.add("hidden"),console.log("[Default Ad Save] Reloading ads data..."),await g(),console.log("[Default Ad Save] Ads reloaded, new adsData:",i),alert("âœ… Default advertisement updated successfully!");else{const u=r.error||"Unknown error",a=r.details?`

Details:
`+(Array.isArray(r.details)?r.details.join(`
`):r.details):"";alert(`Failed to save: ${u}${a}`)}}catch(o){alert(`Error: ${o.message}`)}});w.addEventListener("click",()=>{document.cookie="admin_session=; Path=/; Max-Age=0",window.location.href="/admin/login"});const U=document.getElementById("exportDataButton"),P=document.getElementById("importDataButton"),b=document.getElementById("importFileInput");U.addEventListener("click",()=>{if(!i){alert("No data to export. Please load ads first.");return}const s=JSON.stringify(i,null,2),e=new Blob([s],{type:"application/json"}),n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download=`ads-backup-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n),alert("âœ… Data exported successfully!")});P.addEventListener("click",()=>{b.click()});b.addEventListener("change",async s=>{const e=s.target.files?.[0];if(e)try{const n=await e.text(),t=JSON.parse(n);if(!t.schedules||!Array.isArray(t.schedules))throw new Error("Invalid data structure: missing schedules array");if(!t.default||!t.default.zh||!t.default.en)throw new Error("Invalid data structure: missing default ads");if(!confirm(`Import ${t.schedules.length} schedules and default ads?

âš ï¸  This will REPLACE all existing data!`))return;const o=await fetch("/api/admin/ads?action=import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(o.ok)alert("âœ… Data imported successfully!"),g();else{const r=await o.json();throw new Error(r.error||"Import failed")}}catch(n){alert(`âŒ Import failed: ${n.message}`)}finally{b.value=""}});O();
