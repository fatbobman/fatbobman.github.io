import{_ as u}from"./preload-helper.CLcXU_4U.js";const d=Object.freeze({ARTICLE:"article",WEEKLY:"weekly"}),h={[d.ARTICLE]:{depths:[2,3]},[d.WEEKLY]:{depths:[3]}},g={articleSelector:"article",tocListId:"toc-list",sourceType:d.ARTICLE,onHeadingsReady:null};class E{constructor(t={}){if(this.options=Object.assign({},g,t),this.sourceType=Object.values(d).includes(this.options.sourceType)?this.options.sourceType:d.ARTICLE,this.rules=h[this.sourceType]||h[d.ARTICLE],this.articleRoot=this.resolveRoot(),this.tocList=document.getElementById(this.options.tocListId),!this.articleRoot||!this.tocList){console.warn("[ClientToc] Required DOM nodes not found.");return}console.debug("[ClientToc] starting with source type:",this.sourceType),this.headings=[],this.intersectionObserver=null,this.currentActiveId=null,this.tooltipInstances=[],this.init()}init(){this.headings=this.collectHeadings(),console.debug("[ClientToc] collected headings:",this.headings.length),this.initializeExpansionState(),console.debug("[TOC] Initial expansion state set. Expanded H2s:",this.headings.filter(t=>t.depth===2&&t.isExpanded).map(t=>t.value)),typeof this.options.onHeadingsReady=="function"&&this.options.onHeadingsReady(this.headings),this.render()}initializeExpansionState(){const t=this.findVisibleHeading();if(t)this.setActiveHeadingExpansion(t);else if(this.headings.length>0){const e=this.headings.find(i=>i.depth===2);e&&(e.isExpanded=!0)}}findVisibleHeading(){for(const t of this.headings)if(t.element){const e=t.element.getBoundingClientRect();if(e.top>=-e.height*.1&&e.top<=window.innerHeight*.9)return t}return null}setActiveHeadingExpansion(t){if(t.depth===2)t.isExpanded=!0;else if(t.parentId){const e=this.headings.find(i=>i.id===t.parentId);e&&(e.isExpanded=!0)}}resolveRoot(){return this.options.articleElement instanceof HTMLElement?this.options.articleElement:document.querySelector(this.options.articleSelector)}collectHeadings(){const t=this.rules.depths.map(s=>`h${s}`).join(",");if(!t)return console.debug("[ClientToc] no selectors for current rules"),[];const i=Array.from(this.articleRoot.querySelectorAll(t)).map(s=>this.normalizeHeading(s)).filter(Boolean);let n=null;return i.forEach(s=>{s.depth===2?(n=s,s.parentId=null):s.depth>2&&n&&(s.parentId=n.id,s.isExpanded=!1)}),i}normalizeHeading(t){const e=Number(t.tagName.replace("H",""));if(!this.rules.depths.includes(e))return null;const i=t.textContent?t.textContent.trim():"";if(!i)return null;const n=this.ensureId(t,i);return{depth:e,value:i,id:n,element:t,isExpanded:!1,parentId:null}}ensureId(t,e){if(t.id)return t.id;const i=this.slugify(e);return t.id=i,i}slugify(t){let e=t.toLowerCase().replace(/\s+/g,"-");return e=e.replace(/[()&'`""、｜/?:：（）？！，@$!.+=————、，。；;,–—…’“”\\%^#‘ ≥~½*」「]/g,""),e=e.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{2B50}\u{1F004}\u{1F0CF}\u{1F1E6}-\u{1F1FF}]/gu,""),e.replace(/-+$/,"")}render(){if(!this.tocList)return;this.destroyTooltips(),this.tocList.innerHTML="";const t=this.buildTocTree(),e=document.createElement("ul");e.className="toc-tree space-y-1",t.forEach(i=>{e.appendChild(this.createTreeItem(i))}),this.tocList.appendChild(e),this.tocList.classList.add("toc-loaded"),this.bindEvents(),this.initIntersectionObserver(),this.setupTooltips(),console.debug("[ClientToc] rendered toc tree")}setupTooltips(){const i=[".toc-link"].flatMap(n=>Array.from(this.tocList.querySelectorAll(n))).filter(n=>this.isElementTruncated(n));i.length&&u(async()=>{const{Tooltip:n}=await import("./index.X8V1lpj1.js");return{Tooltip:n}},[]).then(({Tooltip:n})=>{i.forEach((s,r)=>{const a=`toc-tooltip-${s.getAttribute("data-heading-id")||`toc-link-${r}`}`,o=this.createTooltipElement(a,s.textContent||"");document.body.appendChild(o);const c=new n(o,s,{placement:"right",triggerType:"hover"});this.tooltipInstances.push({instance:c,element:o})})}).catch(n=>{console.error("[ClientToc] Failed to load tooltip module:",n)})}destroyTooltips(){this.tooltipInstances.length&&(this.tooltipInstances.forEach(({instance:t,element:e})=>{t&&typeof t.destroyAndRemoveInstance=="function"?t.destroyAndRemoveInstance():t&&typeof t.destroy=="function"&&t.destroy(),e&&e.parentNode&&e.parentNode.removeChild(e)}),this.tooltipInstances=[])}isElementTruncated(t){if(!t)return!1;const e=1;return t.scrollHeight-t.clientHeight>e||t.scrollWidth-t.clientWidth>e}createTooltipElement(t,e){const i=document.createElement("div");i.id=t,i.setAttribute("role","tooltip"),i.className="absolute z-50 invisible inline-block px-3 py-2 text-xs font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700 max-w-xs break-words",i.textContent=e;const n=document.createElement("div");return n.className="tooltip-arrow",n.setAttribute("data-popper-arrow",""),i.appendChild(n),i}bindEvents(){this.tocList.addEventListener("click",t=>{const e=t.target.closest(".toc-toggle");e&&(t.preventDefault(),this.toggleExpansion(e.getAttribute("data-heading-id")));const i=t.target.closest(".toc-link");if(i&&!t.target.closest(".toc-toggle")){t.preventDefault();const n=i.getAttribute("data-heading-id");this.scrollToHeading(n)}})}toggleExpansion(t){const e=this.headings.find(s=>s.id===t);if(!e)return;e.isExpanded=!e.isExpanded;const i=this.tocList.querySelector(`[data-heading-id="${t}"]`),n=this.tocList.querySelector(`[data-parent-id="${t}"]`);if(i&&n){i.setAttribute("aria-expanded",e.isExpanded.toString());const s=i.querySelector("svg");e.isExpanded?(n.classList.remove("max-h-0","opacity-0"),n.classList.add("max-h-[1000px]","opacity-100"),s&&(s.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>')):(n.classList.remove("max-h-[1000px]","opacity-100"),n.classList.add("max-h-0","opacity-0"),s&&(s.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>'))}}buildTocTree(){const t=[];return this.headings.filter(n=>n.depth===2).forEach(n=>{const s=this.headings.filter(r=>r.parentId===n.id);t.push({heading:n,children:s,isExpanded:n.isExpanded})}),this.headings.filter(n=>n.depth===3&&!n.parentId).forEach(n=>{t.push({heading:n,children:[],isExpanded:!0})}),t}createTreeItem(t){const{heading:e,children:i,isExpanded:n}=t,s=document.createElement("li");s.className="toc-item";const r=document.createElement("div");if(r.className="toc-header flex items-center gap-2 py-1 px-1 rounded transition-colors duration-200 hover:bg-muted/20 group",i.length>0){const o=document.createElement("button");o.className="toc-toggle w-4 h-4 flex items-center justify-center text-muted hover:text-heading transition-colors duration-200 flex-shrink-0",o.innerHTML=n?'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>':'<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>',o.setAttribute("aria-expanded",n.toString()),o.setAttribute("data-heading-id",e.id),r.appendChild(o)}else{const o=document.createElement("div");o.className="w-4 flex-shrink-0",r.appendChild(o)}const l=document.createElement("div");l.className="flex-1 min-w-0";const a=document.createElement("a");if(a.href=`#${e.id}`,a.textContent=e.value,a.className="toc-link toc-h2-link text-default font-medium transition-colors duration-200 text-left",a.setAttribute("data-heading-id",e.id),l.appendChild(a),r.appendChild(l),s.appendChild(r),i.length>0){const o=document.createElement("ul");o.className=`toc-children ml-4 space-y-0.5 overflow-hidden transition-all duration-300 ${n?"max-h-[1000px] opacity-100":"max-h-0 opacity-0"}`,o.setAttribute("data-parent-id",e.id),i.forEach(c=>{const p=this.createChildItem(c);o.appendChild(p)}),s.appendChild(o)}return s}createChildItem(t){const e=document.createElement("li");e.className="toc-child-item";const i=document.createElement("a");return i.href=`#${t.id}`,i.textContent=t.value,i.className="toc-link toc-h3-link py-1 px-2 pl-2 text-muted text-sm font-normal transition-colors duration-200 rounded text-left",i.setAttribute("data-heading-id",t.id),e.appendChild(i),e}initIntersectionObserver(){this.intersectionObserver&&this.intersectionObserver.disconnect();const t={root:null,rootMargin:"-20% 0px -60% 0px",threshold:0};this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(i=>{const n=this.headings.find(s=>s.element===i.target);i.isIntersecting?(console.debug("[TOC] Heading entered viewport:",n?.value,"(depth:",n?.depth+")"),this.updateActiveHeading(i.target.id)):console.debug("[TOC] Heading left viewport:",n?.value)})},t),this.headings.forEach(e=>{e.element&&this.intersectionObserver.observe(e.element)})}updateActiveHeading(t){if(this.currentActiveId===t)return;const e=this.headings.find(s=>s.id===t);if(!e)return;const i=this.currentActiveId?this.headings.find(s=>s.id===this.currentActiveId):null;if(this.currentActiveId){const s=this.tocList.querySelector(`[data-heading-id="${this.currentActiveId}"]`);s&&s.classList.remove("toc-active")}this.currentActiveId=t;const n=this.tocList.querySelector(`[data-heading-id="${t}"]`);n&&(n.classList.add("toc-active"),this.manageExpansionState(e,i),this.scrollTocToActive(n))}manageExpansionState(t,e){if(console.debug("[TOC] Managing expansion for:",t.value,"(depth:",t.depth+")"),t.depth===2)this.headings.filter(i=>i.depth===2).forEach(i=>{i.id!==t.id&&i.isExpanded&&(console.debug("[TOC] Collapsing H2:",i.value),this.toggleExpansion(i.id))}),t.isExpanded||(console.debug("[TOC] Expanding H2:",t.value),this.toggleExpansion(t.id));else if(t.parentId){const i=this.headings.find(n=>n.id===t.parentId);i&&!i.isExpanded&&(console.debug("[TOC] Expanding parent H2:",i.value,"for child:",t.value),this.headings.filter(n=>n.depth===2&&n.id!==t.parentId).forEach(n=>{n.isExpanded&&(console.debug("[TOC] Collapsing other H2:",n.value),this.toggleExpansion(n.id))}),this.toggleExpansion(t.parentId))}}scrollTocToActive(t){const e=this.tocList,i=t.getBoundingClientRect(),n=e.getBoundingClientRect();if(!(i.top>=n.top&&i.bottom<=n.bottom)){const r=e.scrollTop+i.top-n.top-n.height/2+i.height/2;e.scrollTo({top:r,behavior:"smooth"})}}scrollToHeading(t){const e=document.getElementById(t);if(e){const s=e.getBoundingClientRect().top+window.pageYOffset-80;window.scrollTo({top:s,behavior:"smooth"})}}destroy(){this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),this.destroyTooltips()}}export{d as SOURCE_TYPES,E as default};
