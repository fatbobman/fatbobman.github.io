<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="sitemap" href="/sitemap-index.xml"><!-- <link rel="shortcut icon" href={iconSVG.src} /> --><link rel="icon" type="image/png" sizes="16x16" href="/_astro/favicon-16x16.2312221518-2.DhhY-2ao.png"><link rel="icon" type="image/png" sizes="32x32" href="/_astro/favicon-32x32.2312221518-2.BbUzUdRZ.png"><link rel="mask-icon" href="/_astro/faviconSVG-32x32.2312221518-2.ll_gTgJS.svg"><link rel="apple-touch-icon" sizes="180x180" href="/_astro/apple-touch-icon.2312227635.BE1WvNvp.png"><title>In-Depth into Persistence Frameworks | Fatbobman&#39;s Blog</title>
<meta name="description" content="Some articles about Core Data and SwiftData">
<meta name="robots" content="index,follow">
<link rel="canonical" href="https://fatbobman.com/en/collections/persistent-framework/">
<meta property="og:title" content="In-Depth into Persistence Frameworks | Fatbobman&#39;s Blog">
<meta property="og:description" content="Some articles about Core Data and SwiftData">
<meta property="og:url" content="https://fatbobman.com/en/collections/persistent-framework/">
<meta property="og:type" content="article">
<meta property="og:image" content="https://cdn.fatbobman.com/card/collection-persistent-framework-en.png">

<meta property="og:locale" content="en">
<meta property="og:site_name" content="fatbobman.com">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@fatbobman">
<meta name="twitter:creator" content="@fatbobman"><link rel="alternate" type="application/rss+xml" title="RSS Feed for My Website" href="https://fatbobman.com/en/rss.xml"><link rel="sitemap" href="/sitemap-index.xml"><!-- 其他路径的 hreflang -->
  <link rel="alternate" hreflang="en" href="https://fatbobman.com/en/collections/persistent-framework/">
  <link rel="alternate" hreflang="zh-CN" href="https://fatbobman.com/zh/collections/persistent-framework/">
  <link rel="alternate" hreflang="x-default" href="https://fatbobman.com/en/collections/persistent-framework/"><script type="text/partytown" src="https://analytics.ahrefs.com/analytics.js" data-key="KF0NNRpbcfyJPzijzZEiOw"></script><script data-partytown-skip="true">
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.async = true; // Add async attribute
        hm.src = "https://hm.baidu.com/hm.js?14e5d60a3ea6276655f9d14c58b1fcd0";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script><script type="text/partytown">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5C7N4MF5');</script><script>
      // Immediately set theme before page renders
      if (
        localStorage.getItem('color-theme') === 'dark' ||
        (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
      }
    </script><script type='application/ld+json'>{
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": "#author",
  "name": "东坡肘子 (徐杨)",
  "alternateName": "Fatbobman (Xu Yang)",
  "jobTitle": "Apple Developer",
  "description": "苹果生态开发者，专注 Swift 和 SwiftUI 开发。Fatbobman's Blog 作者。",
  "url": "https://fatbobman.com",
  "image": {
    "@type": "ImageObject",
    "url": "https://cdn.fatbobman.com/FatWithBoys.png"
  },
  "sameAs": [
    "https://github.com/fatbobman",
    "https://x.com/fatbobman",
    "https://www.linkedin.com/in/fatbobman/",
    "https://bsky.app/profile/fatbobman.com",
    "https://mastodon.social/@fatbobman",
    "https://web.okjike.com/u/e32947ef-7751-4363-9456-b340eef2efd3",
    "https://fatbobman.com/zh/about/",
    "https://fatbobman.com/en/about/"
  ],
  "worksFor": {
    "@type": "Organization",
    "name": "Fatbobman's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fatbobman.com/images/blog-card.png"
    }
  }
}</script><link rel="stylesheet" href="/_astro/about.scnmE3He.css">
<style>.sticky[data-astro-cid-4wsjtibl]{position:fixed;top:0;left:50%;transform:translate(-50%);width:100%;max-width:100%;-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);background-color:#ffffffe6}.dark .sticky[data-astro-cid-4wsjtibl]{background-color:#171717e6}.sticky[data-astro-cid-4wsjtibl] .sticky-logo[data-astro-cid-4wsjtibl]{width:2rem;opacity:1;margin-right:.75rem}
</style><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push","gtag"])})(window,'partytown','forward');/* Partytown 0.11.2 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="antialiased text-default bg-page">  <div class="flex flex-col min-h-screen justify-between "> <div> <header> <div class="bg-block" id="wholeHeader" data-astro-cid-4wsjtibl> <!-- 
    修改点 1: px-4 sm:px-6
    给大标题区域增加左右边距，防止在屏幕变窄时贴边。
  --> <div class="max-w-5xl mx-auto px-4 sm:px-6 pt-6 pb-4 sm:pb-6" data-astro-cid-4wsjtibl> <div id="blogTitle" class="w-full"> <!-- 
    修改点 1: class="group block w-full"
    让链接容器变成块级元素并占满整行，确保内部内容可以基于整个页面宽度居中
  --> <a href="/en/" class="group block w-full"> <!-- 
      修改点 2: justify-center
      确保 Flex 容器的内容在水平方向上绝对居中
    --> <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-5 mx-auto pt-6 sm:pt-8 pb-2 sm:pb-0"> <!-- 吉祥物图标 --> <img src="/_astro/fat-blog-slug-icon.Cw1pK0wd.webp" class="w-20 h-20 sm:w-14 sm:h-14 rounded-full shadow-sm transition-transform duration-300 group-hover:rotate-12 group-hover:scale-105" alt="Fatbobman Logo"> <!-- SVG 文字容器 --> <div class="font-black w-[240px] sm:w-[300px] text-heading transition-opacity duration-300 group-hover:opacity-80 mt-2 sm:mt-0 sm:-mb-1"> <svg fill="currentColor" width="100%" viewBox="0 0 500 100"> <use href="/_astro/blogTitle.Ca1NZNqJ.svg#blog-title"></use> </svg> </div> </div> </a> </div> </div> <div class="bg-block z-50 shadow-custom-light dark:shadow-custom-dark" id="stickyHeader" data-astro-cid-4wsjtibl> <!-- 
      修改点 2: px-4 sm:px-6 py-3
      1. 删除了原来的 p-2 sm:p-0
      2. 增加了统一的 px-4 sm:px-6，让 Sticky 导航栏左右两端留有空白，不再紧贴屏幕边缘。
      3. 增加了 py-3，让导航栏高度稍微高一点点，看起来更从容。
    --> <div class="max-w-5xl flex flex-wrap items-center justify-between mx-auto px-4 sm:px-6 py-3" data-astro-cid-4wsjtibl> <div class="flex items-center space-x-2" data-astro-cid-4wsjtibl> <!-- Sticky Logo --> <a href="/" class="sticky-logo overflow-hidden transition-all duration-500 w-0 opacity-0 flex items-center justify-center" aria-label="Fatbobman Blog" data-astro-cid-4wsjtibl> <!-- 这里使用修改后的小尺寸 Logo (h-6 或 h-7) --> <img src="/_astro/fat-blog-slug-icon.Cw1pK0wd.webp" class="h-6 w-6 rounded-full" alt="Logo" data-astro-cid-4wsjtibl> </a> <div id="lang-data" data-lang="en" style="display: none;"></div> <button id="language-dropdown-button" data-dropdown-toggle="language-dropdown-menu" type="button" aria-label="Change Language" class="group p-2 w-10 h-10 text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <!-- 替换文字为 SVG 图标 --> <!-- 
    这里使用 w-5 h-5 (20px) 配合 stroke-width="2" 
    以匹配 SearchButton 和 ThemeSwitcher 的视觉分量
  --> <svg class="w-5 h-5 fill-none stroke-current" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <!-- 一个简单的地球图标 --> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-language"></use> </svg> <!-- 可选：如果非要保留文字，可以把文字做小一点放在图标旁边，或者只在 Hover 时显示 --> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-page divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="language-dropdown-menu"> <ul class="py-2 font-medium text-sm" role="none"> <li> <button type="button" onclick="
            try {
                if ('#' !== '#') {
                    window.location.href = '#';
                }
            } catch (e) {
                console.log('Navigation failed:', e);
            }
        " class="w-full text-left px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
English
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="EN-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-language"></use> </svg> </div> </button> </li><li> <button type="button" onclick="
              try {
                  if ('/zh/collections/persistent-framework/' !== '#') {
                      window.location.href = '/zh/collections/persistent-framework/';
                  }
              } catch (e) {
                  console.log('Navigation failed:', e);
              }
          " class="w-full text-left px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
中文
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="ZH-check" width="24" height="24" viewBox="0 0 24 24"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-check"></use> </svg> </div> </button> </li> <li> <div class="border-t border-gray-200 dark:border-gray-800 w-4/5 mx-auto my-2"></div> <button class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem" id="set-default-lang"> <div class="inline-flex items-center"> Set English as Default </div> </button> </li> </ul> <script type="module">function a(){const t=localStorage.getItem("lang"),e=document.getElementById("EN-check"),n=document.getElementById("ZH-check");e!==null&&n!==null&&(t==="en"?(e.classList.remove("hidden"),n.classList.add("hidden")):t==="zh"&&(n.classList.remove("hidden"),e.classList.add("hidden")))}document.addEventListener("DOMContentLoaded",()=>{a()});const l=document.getElementById("set-default-lang");l?.addEventListener("click",()=>{const t=document.getElementById("lang-data");if(t!=null){const e=t.dataset.lang;e!=null&&(localStorage.setItem("lang",e),a())}});</script> </div> <button id="theme-dropdown-button" data-dropdown-toggle="theme-dropdown-menu" type="button" aria-label="Theme Switcher" class="group p-2 w-10 h-10 text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <!-- 
    已更新为统一的 24px 线性图标 
    注意：移除了 fill-current，改为 fill="none" stroke="currentColor"
  --> <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none" class="w-5 h-5 hidden" id="theme_icon_system"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-computer"></use> </svg> <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none" class="w-5 h-5 hidden" id="theme_icon_dark"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-moon"></use> </svg> <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none" class="w-5 h-5 hidden" id="theme_icon_light"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-sun"></use> </svg> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="theme-dropdown-menu"> <ul class="py-2 font-medium" role="none"> <li class="hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white text-default"> <button class="flex w-full px-4 py-2 text-sm align-text-center hover:text-secondary" id="theme_button_light"> <svg class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-sun"></use> </svg> <span class="ml-2">Light</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white text-default"> <button class="flex w-full px-4 py-2 text-sm align-text-center hover:text-secondary" id="theme_button_dark"> <svg class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-moon"></use> </svg> <span class="ml-2">Dark</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white text-default"> <button class="flex w-full px-4 py-2 text-sm align-text-center hover:text-secondary" id="theme_button_system"> <svg class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-computer"></use> </svg> <span class="ml-2">System</span> </button> </li> </ul> </div> <script>
  // 获取按钮
  var themeDropdownButton = document.getElementById('theme-dropdown-button'); // 新增：获取主开关按钮
  var themeButtonLight = document.getElementById('theme_button_light');
  var themeButtonDark = document.getElementById('theme_button_dark');
  var themeButtonSystem = document.getElementById('theme_button_system');

  // 获取图标
  var themeToggleDarkIcon = document.getElementById('theme_icon_dark');
  var themeToggleLightIcon = document.getElementById('theme_icon_light');
  var themeToggleSystemIcon = document.getElementById('theme_icon_system');

  function setTheme() {
    if (
      localStorage.getItem('color-theme') === 'dark' ||
      (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }

  function setThemeButton() {
    let theme = localStorage.getItem('color-theme');
    // 先隐藏所有，再显示对应的
    themeToggleDarkIcon.classList.add('hidden');
    themeToggleLightIcon.classList.add('hidden');
    themeToggleSystemIcon.classList.add('hidden');

    if (theme === 'dark') {
      themeToggleDarkIcon.classList.remove('hidden');
    } else if (theme === 'light') {
      themeToggleLightIcon.classList.remove('hidden');
    } else {
      themeToggleSystemIcon.classList.remove('hidden');
    }
  }

  function resetTheme() {
    setTheme();
    setThemeButton();
  }

  // 初始化
  resetTheme();

  // 监听系统暗黑模式的变化
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    resetTheme();
  });

  // 监听 Storage 变化 (多标签页同步)
  window.addEventListener('storage', function (event) {
    if (event.key === 'color-theme') {
      resetTheme();
    }
  });

  // --- 核心修复：点击选项后，同时关闭下拉菜单 ---

  // Dark 模式
  themeButtonDark.addEventListener('click', function () {
    localStorage.setItem('color-theme', 'dark');
    resetTheme();
    themeDropdownButton.click(); // 模拟点击主按钮以关闭菜单
  });

  // Light 模式
  themeButtonLight.addEventListener('click', function () {
    localStorage.setItem('color-theme', 'light');
    resetTheme();
    themeDropdownButton.click(); // 模拟点击主按钮以关闭菜单
  });

  // System 模式
  themeButtonSystem.addEventListener('click', function () {
    localStorage.removeItem('color-theme');
    resetTheme();
    themeDropdownButton.click(); // 模拟点击主按钮以关闭菜单
  });
</script> <div id="docsearch" class="group w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center cursor-pointer"> <svg class="w-5 h-5 fill-none stroke-current" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-search"></use> </svg> </div> </div> <button data-collapse-toggle="navbar-solid-bg" type="button" class="inline-flex items-center p-2 mx-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-solid-bg" aria-expanded="false" id="navbar-toggle-button"> <span class="sr-only">Open main menu</span> <svg class="w-5 h-5 text-default" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path> </svg> </button> <nav class="hidden w-full md:block md:w-auto px-4 z-40" id="navbar-solid-bg"> <ul class="flex flex-col font-bold mt-4 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent dark:bg-gray-800 md:dark:bg-transparent dark:border-gray-700"> <a href="/en/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Home </a><a href="/en/posts/" class="block py-2 px-3 md:p-0 rounded text-invert bg-secondary md:bg-transparent md:text-secondary md:dark:bg-transparent " aria-current="page"> Articles </a><a href="/en/weekly/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Weekly </a><a href="/en/snippet/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Tips </a><a href="/en/sponsorship/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Sponsorship </a><a href="/en/about/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> About </a> </ul> </nav> </div> </div> <div id="placeholder" class="hidden" data-astro-cid-4wsjtibl></div> </div> <script>(function(){const enableSticky = true;
const enableStickyInMobile = true;

  window.onload = function () {
    checkStickyHeader();
    stickySetup();
  };

  window.addEventListener('resize', stickySetup);

  function checkStickyHeader() {
    const title = document.getElementById('blogTitle');
    const stickyHeader = document.getElementById('stickyHeader');
    const placeholder = document.getElementById('placeholder');

    if (title && stickyHeader && placeholder) {
      const offset = title.offsetTop + title.offsetHeight;

      if (shouldStick() && window.scrollY >= offset) {
        stickyHeader.classList.add('sticky');
        placeholder.style.display = 'block';
        placeholder.style.height = `${stickyHeader.offsetHeight}px`;
      } else {
        stickyHeader.classList.remove('sticky');
        placeholder.style.display = 'none';
      }
    }
  }

  function shouldStick() {
    if (!enableSticky) return false;

    let isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (isMobile && !enableStickyInMobile) return false;

    return true;
  }

  function stickySetup() {
    window.onscroll = checkStickyHeader;
  }
})();</script>  </header>  <main class="w-full mx-auto max-w-3xl p-4 md:p-6 "> <div class="container mx-auto">   <header class="max-w-3xl mx-auto px-4 sm:px-6 pt-8 text-center sm:text-left">  <div class="h-1.5 w-20 mb-8 rounded-full bg-gradient-to-r from-blue-500 to-cyan-400 mx-auto sm:mx-0"></div>  <div class="mb-4"> <span class="text-xs font-bold tracking-[0.2em] uppercase text-primary/80"> SwiftData &amp; Core Data </span> </div>  <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-heading leading-tight mb-6 tracking-tight"> In-Depth into Persistence Frameworks </h1>  <div class="text-lg sm:text-xl text-default/80 leading-relaxed border-l-0 sm:border-l-4 sm:border-gray-200 dark:sm:border-slate-700 sm:pl-6 "> Core Data and SwiftData are crucial persistence frameworks within the Apple ecosystem, establishing a solid foundation for application data. For developers, merely understanding how to use them is insufficient. Gaining a deeper comprehension of the operational mechanisms and internal principles of these frameworks can provide developers with a significant advantage. </div>  <hr class="mt-12 border-gray-100 dark:border-slate-800"> </header> <article class="prose prose-lg dark:prose-invert mx-auto w-full max-w-3xl px-4 sm:px-6 "> <aside aria-label="advertisement" role="complementary"><div class="dynamic-ad-inline"></div></aside>  <div class="mt-8">  </div>  <div class="mb-12">  <div class="mb-4"> <h2 id="core-data" class="text-2xl font-bold text-heading scroll-mt-24 mb-2 "> Core Data </h2>   </div>  <div class="flex flex-col"> <div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/model-inheritance-in-core-data/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Model Inheritance in Core Data </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> One of Core Data&#39;s outstanding features is its ability to allow developers to declare data models in a manner closer to object-oriented programming without worrying about the underlying storage implementation details. Within this framework, model inheritance is a particularly important mechanism. This article delves into the core concepts of model inheritance, including Parent Entity, Sub Entity, and Abstract Entity. We will analyze their advantages and disadvantages and explore how to achieve similar effects without directly using these features. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/mastering-data-tracking-and-notifications-in-core-data-and-swiftdata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Mastering Data Tracking and Notifications in Core Data and SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> Core Data and SwiftData, as powerful persistence frameworks in the Apple ecosystem, not only provide declarative data listening tools like @FetchRequest and @Query, but also have a complete set of data tracking and notification mechanisms built-in. Understanding and mastering these mechanisms is crucial for building robust data-driven applications. This article will take you through multi-layered solutions—from simple custom notifications to the powerful Persistent History Tracking and SwiftData History—to help you handle various complex data synchronization scenarios. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/reinventing-core-data-development-with-swiftdata-principles/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Reinventing Core Data Development with SwiftData Principles </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> In modern application development, an efficient persistence framework is crucial. The emergence of SwiftData once caught the eyes of many Core Data developers, who anticipated the advent of a new era integrating modern programming concepts. This article will explore how to apply SwiftData&#39;s way of thinking within Core Data, focusing on data modeling and concurrent programming. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/from-data-model-construction-to-managed-object-instances-in-core-data/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Exploring CoreData - From Data Model Creation to Managed Object Instances </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article will delve into the inner workings of Core Data in constructing managed object instances from a data model. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/mastering-relationships-in-core-data-fundamentals/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Mastering Relationships in Core Data: Fundamentals </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> In the numerous discussions about Core Data, &quot;object graph management&quot; undoubtedly appears as a core concept. As a renowned framework for object graph management, Core Data&#39;s key task is how it precisely describes and effectively manages the complex relationships between different data instances. Indeed, the ability to manage relationships not only constitutes the core characteristic of Core Data but also represents a significant advantage over other data persistence frameworks. In this article, we will delve into the basic concepts of relationships in Core Data, while providing important guidance and suggestions for implementing these relationships. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/batchprocessingincoredata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Batch Operations in Core Data </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article will introduce Core Data&#39;s batch operations, including their principles, usage methods, advanced techniques, and important considerations. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/concurrencyofcoredata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Several Tips on Core Data Concurrency Programming </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article offers tips for Core Data concurrency programming, including debug params, reducing blocking , using perform, NSManagedObjectID and more. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/masteringofcoredatastack/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Mastering Core Data Stack </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article will explain how to design a Core Data Stack. It will cover the functions, components, and configurations. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/persistenthistorytracking/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Using Persistent History Tracking in CoreData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article provides an in-depth explanation of CoreData&#39;s Persistent History Tracking feature. It covers the complete process from responding, fetching, merging, to purging, and includes demonstration code for readers to utilize. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/modern-core-data-problem/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> SwiftUI and Core Data: The Challenges </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> Currently, my main challenge and research direction is how to integrate Core Data into popular application architectures, and make it work more smoothly in environments such as SwiftUI, TCA, Unit Tests, and Preview. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/core-data-reform-achieving-elegant-concurrency-operations-like-swiftdata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Core Data Reform: Achieving Elegant Concurrency Operations like SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> SwiftData, as the successor to Core Data, has introduced a multitude of innovative and modern design ideas. Despite its availability for some time now, many developers have yet to adopt it in their projects. This situation is partly due to SwiftData&#39;s higher requirements for the operating system version. Additionally, because SwiftData is not yet mature enough in some functionalities, developers might choose to continue using Core Data even if their operating system version meets SwiftData’s requirements. Can we integrate some of SwiftData&#39;s excellent design philosophies and ingenious implementations into the practical use of Core Data? This article aims to explore how to introduce elegant and safe concurrency operations similar to those of SwiftData into Core Data, implementing a Core Data version of @ModelActor. </p>  </div> </div> </div><div class="mb-12">  <div class="mb-4"> <h2 id="swiftdata" class="text-2xl font-bold text-heading scroll-mt-24 mb-2 "> SwiftData </h2>   </div>  <div class="flex flex-col"> <div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/key-considerations-before-using-swiftdata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Key Considerations Before Using SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article aims to serve as a guide for developers interested in SwiftData, helping you understand its strengths and limitations so you can make informed decisions based on your project needs. Whether you’re considering adopting SwiftData in a new project or planning a migration from another persistence solution, the following content will provide valuable insights to support your decision-making process. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/using-transactions-instead-of-save-in-swiftdata-and-core-data/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Using Transactions Instead of Save in SwiftData and Core Data </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> Ensuring data consistency and integrity is crucial in data persistence operations. The SwiftData framework introduces the `transaction` method in `ModelContext`, providing developers with a more elegant way to organize and manage data operations. This article explores how to use the concept of transactions to build more reliable and efficient persistence operations. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/nsmanagedobjectid-and-persistentidentifier/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> NSManagedObjectID and PersistentIdentifier: Mastering Data Identifiers in Core Data and SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> Core Data and SwiftData are powerful data management frameworks designed by Apple for developers, capable of efficiently handling complex object relationships, hence known as object graph management frameworks. In these two frameworks, NSManagedObjectID and PersistentIdentifier serve similar functions and are both extremely important. This article will delve into their features, usage methods, and important considerations. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/considerations-for-using-codable-and-enums-in-swiftdata-models/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Considerations for Using Codable and Enums in SwiftData Models </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> Compared to Core Data, SwiftData has fundamentally revolutionized the way data models are constructed. It not only supports a purely code-based declaration method but also allows the direct use of types conforming to the Codable protocol and enum types within models, which are its significant new features. Many developers are inclined to leverage these new capabilities because they seem to fit very well with the Swift language&#39;s declaration style. However, a lack of understanding of the implementation details and potential limitations of these new features may lead to various issues in the future. This article aims to discuss several key points to consider when using Codable and enums in SwiftData models, helping developers avoid common pitfalls. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Practical SwiftData: Building SwiftUI Applications with Modern Approaches </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> In the previous article &quot;Concurrent Programming in SwiftData&quot;, we delved into the innovative concurrent programming model proposed by SwiftData, including its principles, core operations, and related considerations. This elegant programming solution has earned considerable praise. However, as more developers attempt to use SwiftData in actual SwiftUI applications, they have encountered some challenges, especially after enabling Swift&#39;s strict concurrency checks. They found that SwiftData&#39;s actor-based concurrency model is difficult to integrate with traditional application construction methods. This article will explain, in a tutorial-like manner, how to integrate SwiftData with modern programming concepts smoothly into SwiftUI applications and provide strategies to address the current challenges faced by developers. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/unveiling-the-data-modeling-principles-of-swiftdata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Unveiling the Data Modeling Principles of SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article will explore how SwiftData creates data models using code, the new language features it uses, and show how to create PersistentModel by declaring code. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/concurret-programming-in-swiftdata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Concurrent Programming in SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> As the successor to Core Data, SwiftData provides a more elegant and secure mechanism for concurrent programming. This article will introduce how SwiftData addresses these issues and offers developers a better experience with concurrent programming. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/use-core-data-features-in-swiftdata-by-swiftdatakit/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> SwiftDataKit: Unleashing Advanced Core Data Features in SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article will discuss how developers can call the advanced features provided by Core Data in SwiftData without using the Core Data stack, in order to extend the current capabilities of SwiftData. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/persistent-history-tracking-in-swiftdata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> How to Observe Data Changes in SwiftData using Persistent History Tracking </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> This article will explain how to observe specific data changes through Persistent History Tracking in SwiftData. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/relationships-in-swiftdata-changes-and-considerations/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Relationships in SwiftData: Changes and Considerations </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> In previous two articles, &quot;Mastering Relationships in Core Data - Fundamentals&quot; and &quot;Mastering Relationships in Core Data - Practical Application&quot;, we explored in detail the concepts and techniques of relationships in Core Data. While much of this knowledge is also applicable to SwiftData, Core Data&#39;s successor, SwiftData introduces several significant changes in handling relationships. This article focuses on the changes that have occurred in the aspect of relationships within SwiftData, as well as the potential challenges and noteworthy details arising from these changes. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/how-to-handle-optional-values-in-swiftdata-predicates/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> How to Handle Optional Values in SwiftData Predicates </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> SwiftData has revamped the mechanism for creating data models, incorporating a type-safe mode for predicate creation based on model code. As a result, developers encounter numerous operations involving optional values when constructing predicates for SwiftData. This article will explore some techniques and considerations for handling optional values while building predicates. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            border-b border-gray-100 dark:border-slate-800
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/swift-predicate-usage-composition-and-considerations/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> Swift Predicate: Usage, Composition, and Considerations </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> NSPredicate has always been a powerful tool provided by Apple, allowing developers to filter and evaluate data collections in a natural and efficient way by defining complex logical conditions. Over time, with the continuous maturation and development of the Swift language, in 2023, the Swift community undertook the task of reconstructing the Foundation framework using pure Swift language. In this significant update, a new Predicate feature based on Swift coding was introduced, marking a new stage in data processing and evaluation. This article aims to explore the usage, structure, and key considerations of Swift Predicate in practical development. </p>  </div><div class="
            group relative flex flex-col gap-1 py-5 
            /* 极简分割线，与首页保持一致 */
            
            transition-colors duration-200
          ">  <h3 class="text-lg sm:text-xl font-bold text-heading transition-colors duration-200 group-hover:text-primary leading-tight "> <a href="/en/posts/how-to-dynamically-construct-complex-predicates-for-swiftdata/" class="focus:outline-none">  <span class="absolute inset-0" aria-hidden="true"></span> How to Dynamically Construct Complex Predicates for SwiftData </a> </h3>  <p class="text-sm text-gray-500 dark:text-slate-400 leading-relaxed line-clamp-2 mt-1"> NSCompoundPredicate allows developers to combine multiple NSPredicate objects into a single compound predicate. This mechanism is particularly suited for scenarios that require data filtering based on multiple criteria. However, in the new Foundation framework restructured with Swift, the direct functionality corresponding to NSCompoundPredicate is missing. This change poses a significant challenge for developers who wish to build applications using SwiftData. This article aims to explore how to dynamically construct complex predicates that meet the requirements of SwiftData, utilizing PredicateExpression, under the current technical conditions. </p>  </div> </div> </div>  <div class="my-10"> <aside aria-label="advertisement" role="complementary" id="card-advertisement"><div class="dynamic-ad-card"></div></aside> </div>  <div class="mt-16"> <!-- 整合底座容器 --><div class="mt-16 mb-28 bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700/60 rounded-2xl p-6 sm:p-8"> <div class="flex flex-col lg:flex-row items-center justify-between gap-8 lg:gap-12"> <!-- 左侧：订阅区域 --> <!-- 适配逻辑：移动端/平板居中(text-center)，桌面端居左(lg:text-left) --> <div class="flex-1 w-full text-center lg:text-left flex flex-col items-center lg:items-start"> <h3 class="font-bold text-xl text-gray-900 dark:text-gray-100 mb-2"> Subscribe to Fatbobman </h3> <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 max-w-md"> Weekly Swift &amp; SwiftUI highlights. Join developers. </p> <!-- 订阅按钮：使用锚点链接触发 Modal --> <a href="#subscript" id="subscribe-bottom-btn" class="
          bg-black dark:bg-white text-white dark:text-black
          font-bold text-sm px-8 py-3 rounded-xl
          hover:opacity-80 hover:scale-105 active:scale-95
          transition-all duration-200 shadow-sm
          w-full sm:w-auto inline-block text-center
        "> Subscribe Now </a> </div> <!-- 右侧：功能按钮组 --> <!-- 适配逻辑：移动端堆叠(grid-cols-1)，平板以上并排(sm:grid-cols-2) --> <!-- w-full lg:w-auto 保证移动端撑满，桌面端紧凑 --> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full lg:w-auto min-w-[320px]"> <!-- 咖啡按钮 --> <a href="https://www.buymeacoffee.com/fatbobman" target="_blank" rel="noopener" class="group flex items-center justify-center lg:justify-start gap-3 px-5 py-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-sm hover:shadow-md hover:border-orange-200 dark:hover:border-orange-900 transition-all"> <span class="text-2xl group-hover:scale-110 transition-transform">☕️</span> <div class="text-left"> <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Support</div> <div class="text-sm font-bold text-gray-800 dark:text-gray-100">Buy me a Coffee</div> </div> </a> <!-- Discord 按钮 --> <a href="https://x.com/intent/follow?screen_name=fatbobman" target="_blank" rel="noopener" class="group flex items-center justify-center lg:justify-start gap-3 px-5 py-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-sm hover:shadow-md hover:border-blue-200 dark:hover:border-blue-900 transition-all"> <span class="text-2xl group-hover:scale-110 transition-transform">💬</span> <div class="text-left"> <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">CONNECT</div> <div class="text-sm font-bold text-gray-800 dark:text-gray-100">Follow on X</div> </div> </a> </div> </div> </div> <script>(function(){const lang = "en";

  // Track newsletter subscription button click via GTM dataLayer
  document.addEventListener('DOMContentLoaded', () => {
    const subscribeBtn = document.getElementById('subscribe-bottom-btn');
    if (!subscribeBtn) return;

    subscribeBtn.addEventListener('click', () => {
      // Initialize dataLayer if not exists
      window.dataLayer = window.dataLayer || [];

      // Push event to dataLayer for GTM
      window.dataLayer.push({
        event: 'subscribe_click',
        content_type: 'newsletter_subscribe',
        click_location: 'bottom',
        lang: lang
      });

      console.log('[Subscribe Tracking] Bottom subscribe button clicked (dataLayer)');
    }, { capture: true });  // 使用捕获阶段，确保在其他监听器之前执行
  });
})();</script> </div> </article> <script>(function(){const baseUrl = "https://fatbobman.com/ads/";
const langSuffix = "en";
const utmTerm = undefined;

  // ========================================
  // Configuration & Constants
  // ========================================

  const CACHE_DURATION = 20 * 60 * 1000; // 20 minutes
  const STALE_THRESHOLD = 24 * 60 * 60 * 1000; // 24 hours - when to force UI refresh

  // 读取 URL 参数用于测试和预览
  const urlParams = new URLSearchParams(window.location.search);
  const adIdParam = urlParams.get('adid') || urlParams.get('adId');
  const sponsorIdParam = urlParams.get('sponsorId');
  const scheduleIdParam = urlParams.get('scheduleId');
  const forceUpdateParam = urlParams.get('adForceUpdate') === 'true';

  const isPreviewMode = !!(adIdParam || sponsorIdParam || scheduleIdParam);
  const effectiveCacheDuration = isPreviewMode ? 60 * 1000 : CACHE_DURATION;

  // Store current ad metadata for click tracking
  const currentAdMetadata = {
    version1: null,  // .dynamic-ad-card metadata
    version2: null   // .dynamic-ad-inline metadata
  };

  // ========================================
  // Cache Management Functions
  // ========================================

  /**
   * Load ad from cache with SWR metadata
   * @param {string} cacheKey - Cache key
   * @returns {Object|null} - Cached ad data with metadata or null
   */
  function loadFromCache(cacheKey) {
    try {
      const cachedData = localStorage.getItem(cacheKey);
      if (!cachedData) return null;

      const cached = JSON.parse(cachedData);

      // Backward compatibility: handle old cache format
      if (cached.content && !cached.metadata) {
        console.log(`[AdsLoader SWR] Old cache format detected for ${cacheKey}, will update`);
        return null; // Force refresh to get new format
      }

      return cached;
    } catch (e) {
      console.warn(`[AdsLoader SWR] Failed to parse cached ad: ${cacheKey}`, e);
      localStorage.removeItem(cacheKey);
      return null;
    }
  }

  /**
   * Save ad to cache with metadata
   * @param {string} cacheKey - Cache key
   * @param {string} content - Ad HTML content
   * @param {Object} metadata - Ad metadata from response headers
   */
  function saveToCache(cacheKey, content, metadata) {
    try {
      const cacheData = {
        content: content,
        metadata: {
          ...metadata,
          fetchedAt: Date.now()
        }
      };

      localStorage.setItem(cacheKey, JSON.stringify(cacheData));
      const cacheMinutes = Math.round(effectiveCacheDuration / 60000);
      console.log(`[AdsLoader SWR] Saved to cache: ${cacheKey} (${cacheMinutes} min)`, metadata);
    } catch (e) {
      console.warn(`[AdsLoader SWR] Failed to save cache: ${cacheKey}`, e);
    }
  }

  /**
   * Extract metadata from response headers
   * @param {Response} response - Fetch response object
   * @returns {Object} - Metadata object
   */
  function extractMetadata(response) {
    return {
      sponsorId: response.headers.get('X-Sponsor-Id') || 'unknown',
      adId: response.headers.get('X-Ad-Id') || 'unknown',
      version: parseInt(response.headers.get('X-Ad-Version') || '1'),
      lang: response.headers.get('X-Ad-Lang') || langSuffix,
      lastUpdated: response.headers.get('Last-Modified') || new Date().toISOString(),
      forceUpdate: response.headers.get('X-Force-Update') === 'true',
      campaign: response.headers.get('X-UTM-Campaign') || null // Optional UTM campaign
    };
  }

  // ========================================
  // Smart Refresh Logic
  // ========================================

  /**
   * Check if two timestamps are on the same UTC calendar day
   * @param {number} timestamp1 - First timestamp (milliseconds)
   * @param {number} timestamp2 - Second timestamp (milliseconds)
   * @returns {boolean} - True if same UTC day
   */
  function isSameUTCDay(timestamp1, timestamp2) {
    const d1 = new Date(timestamp1);
    const d2 = new Date(timestamp2);
    return d1.getUTCFullYear() === d2.getUTCFullYear() &&
           d1.getUTCMonth() === d2.getUTCMonth() &&
           d1.getUTCDate() === d2.getUTCDate();
  }

  /**
   * Decide if UI should be refreshed based on cache age and ad changes
   * @param {Object|null} cached - Cached ad data with metadata
   * @param {Object} newMetadata - New ad metadata from server
   * @returns {boolean} - True if UI should be refreshed
   */
  function shouldRefreshUI(cached, newMetadata) {
    // Rule 1: No cache -> always render (first load)
    if (!cached || !cached.metadata) {
      console.log('[AdsLoader SWR] No cache, will render immediately');
      return true;
    }

    // Rule 2: Force update parameter -> always refresh
    if (forceUpdateParam || newMetadata.forceUpdate) {
      console.log('[AdsLoader SWR] Force update detected, will refresh UI');
      return true;
    }

    const cachedMeta = cached.metadata;
    const cacheAge = Date.now() - cachedMeta.fetchedAt;

    // Rule 3: Sponsor changed -> always refresh (different advertiser)
    if (cachedMeta.sponsorId !== newMetadata.sponsorId) {
      console.log(`[AdsLoader SWR] Sponsor changed: ${cachedMeta.sponsorId} → ${newMetadata.sponsorId}, will refresh UI`);
      return true;
    }

    // Rule 4: UTC date changed -> always refresh (ad schedule switches by calendar day)
    if (!isSameUTCDay(cachedMeta.fetchedAt, Date.now())) {
      const cachedDate = new Date(cachedMeta.fetchedAt).toISOString().split('T')[0];
      const currentDate = new Date().toISOString().split('T')[0];
      console.log(`[AdsLoader SWR] UTC date changed: ${cachedDate} → ${currentDate}, will refresh UI`);
      return true;
    }

    // Rule 5: Cache older than 24 hours -> always refresh
    if (cacheAge > STALE_THRESHOLD) {
      console.log(`[AdsLoader SWR] Cache very old (${Math.round(cacheAge / 3600000)}h), will refresh UI`);
      return true;
    }

    // Rule 6: Ad ID changed (same sponsor, different version) -> refresh if old, else silent update
    if (cachedMeta.adId !== newMetadata.adId) {
      console.log(`[AdsLoader SWR] Ad changed but cache fresh (${Math.round(cacheAge / 60000)}min), will update silently`);
      return false; // Silent update
    }

    // Rule 7: Default - silent update
    console.log(`[AdsLoader SWR] Cache fresh (${Math.round(cacheAge / 60000)}min old), will update silently`);
    return false;
  }

  // ========================================
  // UTM Parameters Injection
  // ========================================

  /**
   * Inject UTM parameters to all links in ad HTML
   * Only applies to non-default ads (sponsored ads)
   * @param {string} html - Ad HTML content
   * @param {Object} metadata - Ad metadata (sponsorId, campaign, version, etc.)
   * @returns {string} - Modified HTML with UTM parameters
   */
  function injectUTMParameters(html, metadata) {
    // Skip UTM injection for default ads
    if (metadata.sponsorId === 'default') {
      return html;
    }

    // Create temporary container to parse HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    // Find all links
    const links = tempDiv.querySelectorAll('a[href]');

    if (links.length === 0) {
      return html; // No links found, return original HTML
    }

    // Build UTM parameters
    const utmParams = {
      utm_source: 'fatbobman',
      utm_medium: 'blog',
      utm_content: metadata.version === 2 ? 'post-header' : 'post-footer'
    };

    // Add campaign if available
    if (metadata.campaign) {
      utmParams.utm_campaign = metadata.campaign;
    }

    // Add term if available
    if (utmTerm) {
      utmParams.utm_term = utmTerm;
    }

    // Inject UTM parameters to each link
    links.forEach(link => {
      try {
        const url = new URL(link.href);

        // Add each UTM parameter
        Object.entries(utmParams).forEach(([key, value]) => {
          url.searchParams.set(key, value);
        });

        link.href = url.toString();
      } catch (e) {
        // Invalid URL, skip
        console.warn('[AdsLoader SWR] Skipping invalid URL:', link.href, e);
      }
    });

    console.log('[AdsLoader SWR] Injected UTM parameters:', utmParams, `(${links.length} link(s))`);
    return tempDiv.innerHTML;
  }

  // ========================================
  // GA4 Click Tracking
  // ========================================

  /**
   * Track ad click in Google Analytics 4 via GTM dataLayer
   * @param {string} destinationUrl - Click destination URL
   * @param {Object} metadata - Ad metadata
   */
  function trackAdClick(destinationUrl, metadata) {
    // Initialize dataLayer if not exists (works with both regular GTM and Partytown)
    window.dataLayer = window.dataLayer || [];

    // Build event data based on ad type
    const eventData = {
      event: 'ad_click',
      destination_url: destinationUrl
    };

    if (metadata.sponsorId === 'default') {
      // Default ad: simple tracking with position only
      eventData.content_type = 'default_ad';
      eventData.ad_position = metadata.version === 2 ? 'post-header' : 'post-footer';
    } else {
      // Sponsored ad: detailed tracking
      eventData.content_type = 'sponsored_ad';
      eventData.ad_position = metadata.version === 2 ? 'post-header' : 'post-footer';
      eventData.sponsor_id = metadata.sponsorId;
      eventData.ad_id = metadata.adId;
      eventData.ad_version = metadata.version;
      eventData.ad_lang = metadata.lang;
    }

    // Push event to dataLayer for GTM
    window.dataLayer.push(eventData);
    console.log('[AdsLoader SWR] Ad click tracked (dataLayer):', eventData);
  }

  /**
   * Attach click tracking to ad links (reads metadata dynamically from currentAdMetadata)
   * @param {string} containerSelector - Container selector
   * @param {string} version - 'version1' or 'version2' key in currentAdMetadata
   */
  function attachClickTracking(containerSelector, version) {
    const containers = document.querySelectorAll(containerSelector);
    if (containers.length === 0) return;

    containers.forEach(container => {
      // Use event delegation to handle dynamically loaded ads
      container.addEventListener('click', (event) => {
        // Find the clicked link (or parent link)
        const link = event.target.closest('a[href]');
        if (!link) return;

        // Get current metadata dynamically (always up-to-date)
        const metadata = currentAdMetadata[version];
        if (!metadata) {
          console.warn(`[AdsLoader SWR] No metadata available for ${version}, skipping tracking`);
          return;
        }

        // Track the click
        trackAdClick(link.href, metadata);
      }, { capture: false, passive: true });
    });

    console.log(`[AdsLoader SWR] Click tracking attached to ${containers.length} container(s): ${containerSelector}`);
  }

  // ========================================
  // Ad Loading & Rendering
  // ========================================

  /**
   * Render ad to containers
   * @param {string} html - Ad HTML content
   * @param {string} containerSelector - Container selector
   * @param {Object} metadata - Ad metadata for tracking
   * @param {string} reason - Reason for rendering (for logging)
   */
  function renderAd(html, containerSelector, metadata, reason = 'unknown') {
    const containers = document.querySelectorAll(containerSelector);
    if (containers.length === 0) {
      console.warn(`[AdsLoader SWR] No containers found: ${containerSelector}`);
      return;
    }

    containers.forEach(container => {
      container.innerHTML = html;
    });

    // Store metadata for this version
    if (containerSelector === '.dynamic-ad-card') {
      currentAdMetadata.version1 = metadata;
    } else if (containerSelector === '.dynamic-ad-inline') {
      currentAdMetadata.version2 = metadata;
    }

    console.log(`[AdsLoader SWR] Rendered ad to ${containers.length} container(s): ${containerSelector} (${reason})`);
  }

  /**
   * Fetch ad from server
   * @param {number} version - Ad version (1 or 2)
   * @param {string} cacheKey - Cache key
   * @param {string} containerSelector - Container selector
   * @param {Object|null} cached - Cached ad data (if any)
   */
  async function fetchAd(version, cacheKey, containerSelector, cached) {
    // Build URL with parameters
    const params = new URLSearchParams({
      lang: langSuffix,
      version: version.toString()
    });

    // Add test/preview parameters
    if (adIdParam) params.append('adId', adIdParam);
    if (sponsorIdParam) params.append('sponsorId', sponsorIdParam);
    if (scheduleIdParam) params.append('scheduleId', scheduleIdParam);
    if (forceUpdateParam) params.append('adForceUpdate', 'true');

    const url = `${baseUrl}?${params.toString()}`;
    const previewTag = isPreviewMode ? ' [PREVIEW MODE]' : '';
    console.log(`[AdsLoader SWR] Fetching ad: ${url}${previewTag}`);

    try {
      const response = await fetch(url, {
        headers: { 'Accept': 'text/html' },
        cache: 'no-cache'
      });

      // Validate HTTP status
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      // Validate required metadata headers
      const sponsorId = response.headers.get('X-Sponsor-Id');
      const adId = response.headers.get('X-Ad-Id');

      if (!sponsorId || !adId || sponsorId === 'null' || adId === 'null') {
        console.warn('[AdsLoader SWR] Invalid response: missing or null metadata headers');
        throw new Error('Invalid ad response: missing metadata headers');
      }

      const content = await response.text();
      const metadata = extractMetadata(response);

      // Inject UTM parameters for sponsored ads
      const processedContent = injectUTMParameters(content, metadata);

      console.log('[AdsLoader SWR] Server response metadata:', metadata);

      // Decide if UI should be refreshed
      const shouldRefresh = shouldRefreshUI(cached, metadata);

      // Always update cache (with UTM-enhanced content)
      saveToCache(cacheKey, processedContent, metadata);

      // Conditionally refresh UI (with UTM-enhanced content)
      if (shouldRefresh) {
        renderAd(processedContent, containerSelector, metadata, shouldRefresh === true && !cached ? 'initial load' : 'smart refresh');
      } else {
        console.log(`[AdsLoader SWR] UI kept as-is, updated cache for next visit`);
      }

    } catch (error) {
      console.error(`[AdsLoader SWR] Error loading ad (version ${version}):`, error);

      // Smart fallback strategy based on cached ad type
      if (cached && cached.metadata) {
        if (cached.metadata.sponsorId === 'default') {
          // Default ad: keep displaying cached content (own content, safe to show when stale)
          console.log('[AdsLoader SWR] Fetch failed, keeping default ad cache');
          // UI already shows cached content, no action needed
        } else {
          // Sponsored ad: clear display (avoid showing expired paid ads)
          console.log('[AdsLoader SWR] Fetch failed, clearing sponsored ad to avoid showing stale content');
          const emptyMetadata = { sponsorId: 'error', version: version };
          renderAd('', containerSelector, emptyMetadata, 'error-clear');
        }
      } else {
        // No cache: leave blank
        console.log('[AdsLoader SWR] Fetch failed with no cache, leaving blank');
      }
    }
  }

  /**
   * Load ad with SWR strategy
   * @param {number} version - Ad version
   * @param {string} cacheKey - Cache key
   * @param {string} containerSelector - Container selector
   */
  function loadAd(version, cacheKey, containerSelector) {
    // Check if containers exist
    const containers = document.querySelectorAll(containerSelector);
    if (containers.length === 0) {
      console.log(`[AdsLoader SWR] No containers found for ${containerSelector}, skipping version ${version}`);
      return;
    }

    // Step 1: Load from cache if available
    const cached = loadFromCache(cacheKey);
    if (cached && cached.content) {
      console.log(`[AdsLoader SWR] Displaying cached ad: ${cacheKey}`, cached.metadata);
      // Inject UTM parameters to cached content (in case it's from old cache without UTM)
      const processedCachedContent = injectUTMParameters(cached.content, cached.metadata);
      renderAd(processedCachedContent, containerSelector, cached.metadata, 'from cache');
    } else {
      console.log(`[AdsLoader SWR] No cache available for ${cacheKey}, will show blank until loaded`);
    }

    // Step 2: Fetch from server in background
    fetchAd(version, cacheKey, containerSelector, cached);
  }

  // ========================================
  // Initialization
  // ========================================

  function initAds() {
    console.log('[AdsLoader SWR] Initializing ad loading with Stale-While-Revalidate strategy...');
    console.log(`[AdsLoader SWR] Config: cacheDuration=${effectiveCacheDuration/60000}min, staleThreshold=${STALE_THRESHOLD/3600000}h`);

    if (isPreviewMode) {
      const params = [];
      if (adIdParam) params.push(`adId=${adIdParam}`);
      if (sponsorIdParam) params.push(`sponsorId=${sponsorIdParam}`);
      if (scheduleIdParam) params.push(`scheduleId=${scheduleIdParam}`);
      console.log(`[AdsLoader SWR] 🔍 PREVIEW MODE: ${params.join(', ')}`);
    }

    if (forceUpdateParam) {
      console.log('[AdsLoader SWR] 🔄 FORCE UPDATE MODE: UI will always refresh');
    }

    // Generate cache keys (include test params to avoid conflicts)
    const cacheKeySuffix = langSuffix + (adIdParam || sponsorIdParam || scheduleIdParam || '');
    const cacheKeyCard = 'dynamicAdCardSWR-' + cacheKeySuffix;
    const cacheKeyInline = 'dynamicAdInlineSWR-' + cacheKeySuffix;

    // Load both ad versions
    loadAd(1, cacheKeyCard, '.dynamic-ad-card');
    loadAd(2, cacheKeyInline, '.dynamic-ad-inline');

    // Attach click tracking event listeners (after ads are loaded)
    // These will dynamically read metadata from currentAdMetadata
    attachClickTracking('.dynamic-ad-card', 'version1');
    attachClickTracking('.dynamic-ad-inline', 'version2');
  }

  // Start loading when page is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAds);
  } else {
    initAds();
  }
})();</script> <div id="weekly-subscribe-anchor" class="pb-16"></div>    </div> </main> </div> <footer> <footer class="bg-block border-t border-gray-100 dark:border-slate-800 mt-20" id="page-footer"> <div class="mx-auto w-full max-w-5xl px-6 py-12 md:py-16"> <div class="grid grid-cols-1 md:grid-cols-12 gap-8 lg:gap-12">  <div class="md:col-span-4 lg:col-span-5 space-y-4"> <div class="flex items-center space-x-2">  <span class="text-xl font-black tracking-tight text-heading">
Fatbobman's <span class="text-primary">Blog</span> </span> </div> <p class="text-sm text-muted leading-relaxed max-w-xs"> Exploring the infinite possibilities of Swift and Apple development ecosystem. </p> </div>  <div class="md:col-span-8 lg:col-span-7 grid grid-cols-2 sm:grid-cols-3 gap-8">  <div> <h3 class="text-sm font-bold text-heading uppercase tracking-wider mb-4 "> Explore </h3> <ul class="space-y-3 text-sm text-muted"> <li><a href="/en/snippet/" class="hover:text-primary transition-colors">Quick Tips</a></li> <li><a href="/en/posts/" class="hover:text-primary transition-colors">Posts</a></li> <li><a href="/en/tags/" class="hover:text-primary transition-colors">Tags</a></li> <li><a href="/en/collections/" class="hover:text-primary transition-colors">Collections</a></li> </ul> </div>  <div> <h3 class="text-sm font-bold text-heading uppercase tracking-wider mb-4 "> Subscribe </h3> <ul class="space-y-3 text-sm text-muted"> <li><a href="https://weekly.fatbobman.com/welcome" class="hover:text-primary transition-colors" target="_blank">Newsletter</a></li> <li><a href="/rss.xml" class="hover:text-primary transition-colors" target="_blank">RSS</a></li> </ul> </div>  <div> <h3 class="text-sm font-bold text-heading uppercase tracking-wider mb-4 "> Connect &amp; Support </h3> <ul class="space-y-3 text-sm text-muted"> <li><a href="/en/sponsorship/" class="hover:text-primary transition-colors" rel="sponsored">Promote on Blog</a></li> <li><a href="/en/about/#contact" class="hover:text-primary transition-colors">Contact Me</a></li> <li> <a href="https://www.buymeacoffee.com/fatbobman" class="hover:text-primary transition-colors group flex items-center" target="_blank"> <span>Buy Me a Coffee</span> <span class="ml-1 group-hover:scale-110 transition-transform inline-block">☕️</span> </a> </li> </ul> </div> </div> </div>  <div class="mt-12 pt-8 border-t border-gray-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center text-xs text-muted/60 gap-4"> <div class="text-center md:text-left"> <span>&copy; 2025 Fatbobman Digital Limited. All Rights Reserved.</span> </div> <div class="flex items-center gap-4">  <div class="opacity-70 hover:opacity-100 transition-opacity"> <div class="flex items-center justify-center w-full px-6 pt-2 text-sm pb-10"> <button type="button" onclick="
        try {
          window.open('https://beian.miit.gov.cn/#/Integrated/index', '_blank');
        } catch (e) {
          console.log('Failed to open ICP link:', e);
        }
      " class="text-xxs hover:underline text-muted tracking-wide" aria-label="ICP Registration Information">
辽ICP备20006550号-1
</button> </div> </div> </div> </div> </div> </footer> </footer> </div> <section> <div id="weekly-modal" data-subscribeText="Join Now" data-placeholder="Subscribe with your email" data-embed-url="https://weekly.fatbobman.com/embed" data-iframe-class="mx-auto sm:w-[320px] md:w-[480px] sm:h-[200px] md:h-[320px] dark:opacity-80 dark:rounded-lg dark:shadow-2xl dark:border-gray-600" data-iframe-style="border:0px solid #EEE; background:white; width: 100%; max-width: 480px;"> <div id="popup-modal" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full"> <!-- Modal content --> <div class="relative bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-lg shadow-2xl border-gray-200 border dark:border-gray-600"> <!-- Modal header --> <div class="flex items-center justify-between px-4 md:px-5 pt-4 pb-0 rounded-t dark:border-gray-600"> <button id="popup-modal-close-button" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"> <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path> </svg> <span class="sr-only">Close modal</span> </button> </div> <!-- Modal body --> <div class="px-4 md:px-5 pb-4 md:w-[480px] sm:w-80 mx-auto"> <div class="sm:hidden md:block text-base text-center font-bold text-gray-900 dark:text-blue-100 pt-4 pb-2 ">Weekly Swift &amp; SwiftUI Highlights - Every Monday</div> <div id="weekly-modal-embed" class="flex flex-col items-center justify-center gap-4" data-iframe-loaded="false"> <div class="relative flex items-center justify-center"> <div class="w-8 h-8 border-2 border-gray-200 dark:border-gray-700 border-t-secondary rounded-full animate-spin" aria-hidden="true"></div> </div> <div class="text-sm text-gray-400 dark:text-gray-500 text-center" data-weekly-loader data-error-text="Failed to load subscription form. Please retry later." aria-live="polite"> Preparing subscription form... </div> </div> </div> </div> </div> </div> </section> <script type="module" src="/_astro/WeeklyModalLoader.astro_astro_type_script_index_0_lang.DMZWLG_2.js"></script>  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js" async></script> <script>
  // 为每个需要清除 focus 状态的按钮都添加一个 clear-focus 类, 下面的代码将在点击后自动移除 focus 状态
  document.addEventListener('DOMContentLoaded', () => {
    // 获取所有具有 'clear-focus' 类的按钮
    const buttons = document.querySelectorAll('.clear-focus');

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        setTimeout(() => {
          button.blur();
        }, 0);
      });
    });
  });

  window.onpageshow = function () {
    document.documentElement.classList.add('motion-safe:scroll-smooth');
  };

  if (typeof window !== 'undefined') {
    const videos = Array.from(document.querySelectorAll('video.lazy-video[data-autoplay="lazy"]'));

    const disableTooltipsOnTouch = () => {
      const isTouch =
        'ontouchstart' in window ||
        (navigator && navigator.maxTouchPoints > 0) ||
        (window.matchMedia && window.matchMedia('(pointer: coarse)').matches);
      if (!isTouch) {
        return;
      }
      const triggers = document.querySelectorAll('[data-tooltip-target]');
      triggers.forEach((trigger) => {
        const tooltipId = trigger.getAttribute('data-tooltip-target');
        trigger.removeAttribute('data-tooltip-target');
        trigger.removeAttribute('data-tooltip-placement');
        if (tooltipId) {
          const tooltipEl = document.getElementById(tooltipId);
          if (tooltipEl && tooltipEl.parentNode) {
            tooltipEl.parentNode.removeChild(tooltipEl);
          }
        }
      });
    };

    document.addEventListener('DOMContentLoaded', disableTooltipsOnTouch);

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const video = entry.target;

            if (entry.isIntersecting) {
              // 进入视窗 -> 尝试播放（浏览器会根据策略决定是否允许）
              video.play().catch(() => {
                // 某些情况下（浏览器策略）可能会失败，静默即可
              });
            } else {
              // 离开视窗 -> 暂停，节省 CPU & 带宽
              video.pause();
            }
          });
        },
        {
          threshold: 0.1, // 至少有 10% 出现在视窗里时触发
        }
      );

      videos.forEach((video) => observer.observe(video));

      // 清理逻辑：页面卸载时取消所有观察
      window.addEventListener('beforeunload', () => {
        videos.forEach((video) => observer.unobserve(video));
        observer.disconnect();
      });

      // 处理 bfcache 情况
      window.addEventListener('pageshow', (event) => {
        // 如果是从 bfcache 恢复，重新初始化
        if (event.persisted) {
          const newVideos = Array.from(document.querySelectorAll('video.lazy-video[data-autoplay="lazy"]'));
          newVideos.forEach((video) => {
            if (!videos.includes(video)) {
              observer.observe(video);
            }
          });
        }
      });
    } else {
      // 老浏览器的降级策略：什么都不做，用户手动播放
    }
  }
</script> <script>(function(){const lang = "en";
const searchText = "Search...";
const runSearchModuleUrl = "/_astro/runsearch.Cf7wkMmH.js";

  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('docsearch');
    if (!button) {
      return;
    }

    let docsearchScriptPromise = null;
    let initialized = false;

    const loadDocsearchLibrary = () => {
      if (typeof window !== 'undefined' && typeof window.docsearch === 'function') {
        return Promise.resolve();
      }
      if (!docsearchScriptPromise) {
        docsearchScriptPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@docsearch/js@3.8.3';
          script.defer = true;
          script.onload = () => resolve();
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      return docsearchScriptPromise;
    };

    const handleFirstClick = async (event) => {
      event.preventDefault();
      event.stopPropagation();

      try {
        // Load DocSearch library
        await loadDocsearchLibrary();

        // Import and execute search module
        const module = await import(runSearchModuleUrl);

        // openSearch will call initSearch internally, so we don't need to call both
        await module.openSearch(lang, searchText);

        // Remove the first-click listener after successful initialization
        button.removeEventListener('click', handleFirstClick, true);
        initialized = true;
      } catch (error) {
        console.error('Failed to initialize DocSearch:', error);
      }
    };

    button.addEventListener('click', handleFirstClick, true);
  });
})();</script> <!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5C7N4MF5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!-- End Google Tag Manager (noscript) --> <!--Magic Fix 解决在 Safari 下搜索框取消后会滚动到页面底部--> <div class="fixed"> <input type="text"> </div> </body></html>