<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="sitemap" href="/sitemap-index.xml"><!-- <link rel="shortcut icon" href={iconSVG.src} /> --><link rel="icon" type="image/png" sizes="16x16" href="/_astro/favicon-16x16.2312221518-2.DhhY-2ao.png"><link rel="icon" type="image/png" sizes="32x32" href="/_astro/favicon-32x32.2312221518-2.BbUzUdRZ.png"><link rel="mask-icon" href="/_astro/faviconSVG-32x32.2312221518-2.ll_gTgJS.svg"><link rel="apple-touch-icon" sizes="180x180" href="/_astro/apple-touch-icon.2312227635.BE1WvNvp.png"><title>Solving SwiftUI Pain Points and Performance Bottlenecks - Zipic Development Technical Retrospective</title>
<meta name="description" content="What other technical challenges exist in image compression software? This article is packed with hardcore, practical macOS development experience. From SwiftUI component adaptation to low-level Core Graphics applications, and from Raycast extension integration to PDF compression implementation, it not only solves performance bottlenecks but also pushes the native experience to the limit.">
<meta name="robots" content="index,follow">
<link rel="canonical" href="https://fatbobman.com/en/posts/zipic-3-technical-details/">
<meta property="og:title" content="Solving SwiftUI Pain Points and Performance Bottlenecks - Zipic Development Technical Retrospective">
<meta property="og:description" content="What other technical challenges exist in image compression software? This article is packed with hardcore, practical macOS development experience. From SwiftUI component adaptation to low-level Core Graphics applications, and from Raycast extension integration to PDF compression implementation, it not only solves performance bottlenecks but also pushes the native experience to the limit.">
<meta property="og:url" content="https://fatbobman.com/en/posts/zipic-3-technical-details/">
<meta property="og:type" content="article">
<meta property="og:image" content="https://storage.5km.host/zipic-share-banner.jpeg">

<meta property="og:locale" content="en">
<meta property="og:site_name" content="fatbobman.com">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@fatbobman">
<meta name="twitter:creator" content="@fatbobman"><link rel="alternate" type="application/rss+xml" title="RSS Feed for My Website" href="https://fatbobman.com/en/rss.xml"><link rel="sitemap" href="/sitemap-index.xml"><!-- ÂÖ∂‰ªñË∑ØÂæÑÁöÑ hreflang -->
  <link rel="alternate" hreflang="en" href="https://fatbobman.com/en/posts/zipic-3-technical-details/">
  <link rel="alternate" hreflang="zh-CN" href="https://fatbobman.com/zh/posts/zipic-3-technical-details/">
  <link rel="alternate" hreflang="x-default" href="https://fatbobman.com/en/posts/zipic-3-technical-details/"><script type="text/partytown" src="https://analytics.ahrefs.com/analytics.js" data-key="KF0NNRpbcfyJPzijzZEiOw"></script><script data-partytown-skip="true">
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.async = true; // Add async attribute
        hm.src = "https://hm.baidu.com/hm.js?14e5d60a3ea6276655f9d14c58b1fcd0";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script><script type="text/partytown">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5C7N4MF5');</script><script>
      // Immediately set theme before page renders
      if (
        localStorage.getItem('color-theme') === 'dark' ||
        (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
      ) {
        document.documentElement.classList.add('dark');
      }
    </script><script type='application/ld+json'>{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "author": {
    "@id": "#author"
  },
  "dateModified": "2025-12-24T14:10:00.000Z",
  "datePublished": "2025-12-22T14:10:00.000Z",
  "description": "What other technical challenges exist in image compression software? This article is packed with hardcore, practical macOS development experience. From SwiftUI component adaptation to low-level Core Graphics applications, and from Raycast extension integration to PDF compression implementation, it not only solves performance bottlenecks but also pushes the native experience to the limit.",
  "headline": "Solving SwiftUI Pain Points and Performance Bottlenecks - Zipic Development Technical Retrospective",
  "image": {
    "@type": "ImageObject",
    "url": "https://storage.5km.host/zipic-share-banner.jpeg"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fatbobman.com/en/posts/zipic-3-technical-details/"
  },
  "url": "https://fatbobman.com/en/posts/zipic-3-technical-details/",
  "publisher": {
    "@type": "Organization",
    "name": "Fatbobman's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fatbobman.com/images/blog-card.png"
    }
  },
  "articleSection": [
    "Dev Diary",
    "Guest Post",
    "SwiftUI"
  ],
  "inLanguage": "en"
}</script><script type='application/ld+json'>{
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": "#author",
  "name": "‰∏úÂù°ËÇòÂ≠ê (ÂæêÊù®)",
  "alternateName": "Fatbobman (Xu Yang)",
  "jobTitle": "Apple Developer",
  "description": "ËãπÊûúÁîüÊÄÅÂºÄÂèëËÄÖÔºå‰∏ìÊ≥® Swift Âíå SwiftUI ÂºÄÂèë„ÄÇFatbobman's Blog ‰ΩúËÄÖ„ÄÇ",
  "url": "https://fatbobman.com",
  "image": {
    "@type": "ImageObject",
    "url": "https://cdn.fatbobman.com/FatWithBoys.png"
  },
  "sameAs": [
    "https://github.com/fatbobman",
    "https://x.com/fatbobman",
    "https://www.linkedin.com/in/fatbobman/",
    "https://bsky.app/profile/fatbobman.com",
    "https://mastodon.social/@fatbobman",
    "https://web.okjike.com/u/e32947ef-7751-4363-9456-b340eef2efd3",
    "https://fatbobman.com/zh/about/",
    "https://fatbobman.com/en/about/"
  ],
  "worksFor": {
    "@type": "Organization",
    "name": "Fatbobman's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fatbobman.com/images/blog-card.png"
    }
  }
}</script><link rel="stylesheet" href="/_astro/about.4LkOSyze.css">
<link rel="stylesheet" href="/_astro/_slug_.C4bWZTUX.css">
<style>.sticky[data-astro-cid-4wsjtibl]{position:fixed;top:0;left:50%;transform:translate(-50%);width:100%;max-width:100%;-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);background-color:#ffffffe6}.dark .sticky[data-astro-cid-4wsjtibl]{background-color:#171717e6}.sticky[data-astro-cid-4wsjtibl] .sticky-logo[data-astro-cid-4wsjtibl]{width:2rem;opacity:1;margin-right:.75rem}
</style><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push","gtag"])})(window,'partytown','forward');/* Partytown 0.11.2 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body class="antialiased text-default bg-page">  <div class="flex flex-col min-h-screen justify-between "> <div> <header> <div class="bg-block" id="wholeHeader" data-astro-cid-4wsjtibl> <!-- 
    ‰øÆÊîπÁÇπ 1: px-4 sm:px-6
    ÁªôÂ§ßÊ†áÈ¢òÂå∫ÂüüÂ¢ûÂä†Â∑¶Âè≥ËæπË∑ùÔºåÈò≤Ê≠¢Âú®Â±èÂπïÂèòÁ™ÑÊó∂Ë¥¥Ëæπ„ÄÇ
  --> <div class="max-w-5xl mx-auto px-4 sm:px-6 pt-6 pb-4 sm:pb-6" data-astro-cid-4wsjtibl> <div id="blogTitle" class="w-full"> <!-- 
    ‰øÆÊîπÁÇπ 1: class="group block w-full"
    ËÆ©ÈìæÊé•ÂÆπÂô®ÂèòÊàêÂùóÁ∫ßÂÖÉÁ¥†Âπ∂Âç†Êª°Êï¥Ë°åÔºåÁ°Æ‰øùÂÜÖÈÉ®ÂÜÖÂÆπÂèØ‰ª•Âü∫‰∫éÊï¥‰∏™È°µÈù¢ÂÆΩÂ∫¶Â±Ö‰∏≠
  --> <a href="/en/" class="group block w-full"> <!-- 
      ‰øÆÊîπÁÇπ 2: justify-center
      Á°Æ‰øù Flex ÂÆπÂô®ÁöÑÂÜÖÂÆπÂú®Ê∞¥Âπ≥ÊñπÂêë‰∏äÁªùÂØπÂ±Ö‰∏≠
    --> <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-5 mx-auto pt-6 sm:pt-8 pb-2 sm:pb-0"> <!-- ÂêâÁ••Áâ©ÂõæÊ†á --> <img src="/_astro/fat-blog-slug-icon.Cw1pK0wd.webp" class="w-20 h-20 sm:w-14 sm:h-14 rounded-full shadow-sm transition-transform duration-300 group-hover:rotate-12 group-hover:scale-105" alt="Fatbobman Logo"> <!-- SVG ÊñáÂ≠óÂÆπÂô® --> <div class="font-black w-[240px] sm:w-[300px] text-heading transition-opacity duration-300 group-hover:opacity-80 mt-2 sm:mt-0 sm:-mb-1"> <svg fill="currentColor" width="100%" viewBox="0 0 500 100"> <use href="/_astro/blogTitle.Ca1NZNqJ.svg#blog-title"></use> </svg> </div> </div> </a> </div> </div> <div class="bg-block z-50 shadow-custom-light dark:shadow-custom-dark" id="stickyHeader" data-astro-cid-4wsjtibl> <!-- 
      ‰øÆÊîπÁÇπ 2: px-4 sm:px-6 py-3
      1. Âà†Èô§‰∫ÜÂéüÊù•ÁöÑ p-2 sm:p-0
      2. Â¢ûÂä†‰∫ÜÁªü‰∏ÄÁöÑ px-4 sm:px-6ÔºåËÆ© Sticky ÂØºËà™Ê†èÂ∑¶Âè≥‰∏§Á´ØÁïôÊúâÁ©∫ÁôΩÔºå‰∏çÂÜçÁ¥ßË¥¥Â±èÂπïËæπÁºò„ÄÇ
      3. Â¢ûÂä†‰∫Ü py-3ÔºåËÆ©ÂØºËà™Ê†èÈ´òÂ∫¶Á®çÂæÆÈ´ò‰∏ÄÁÇπÁÇπÔºåÁúãËµ∑Êù•Êõ¥‰ªéÂÆπ„ÄÇ
    --> <div class="max-w-5xl flex flex-wrap items-center justify-between mx-auto px-4 sm:px-6 py-3" data-astro-cid-4wsjtibl> <div class="flex items-center space-x-2" data-astro-cid-4wsjtibl> <!-- Sticky Logo --> <a href="/" class="sticky-logo overflow-hidden transition-all duration-500 w-0 opacity-0 flex items-center justify-center" aria-label="Fatbobman Blog" data-astro-cid-4wsjtibl> <!-- ËøôÈáå‰ΩøÁî®‰øÆÊîπÂêéÁöÑÂ∞èÂ∞∫ÂØ∏ Logo (h-6 Êàñ h-7) --> <img src="/_astro/fat-blog-slug-icon.Cw1pK0wd.webp" class="h-6 w-6 rounded-full" alt="Logo" data-astro-cid-4wsjtibl> </a> <div id="lang-data" data-lang="en" style="display: none;"></div> <button id="language-dropdown-button" data-dropdown-toggle="language-dropdown-menu" type="button" aria-label="Change Language" class="group p-2 w-10 h-10 text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <!-- ÊõøÊç¢ÊñáÂ≠ó‰∏∫ SVG ÂõæÊ†á --> <!-- 
    ËøôÈáå‰ΩøÁî® w-5 h-5 (20px) ÈÖçÂêà stroke-width="2" 
    ‰ª•ÂåπÈÖç SearchButton Âíå ThemeSwitcher ÁöÑËßÜËßâÂàÜÈáè
  --> <svg class="w-5 h-5 fill-none stroke-current" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <!-- ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂú∞ÁêÉÂõæÊ†á --> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-language"></use> </svg> <!-- ÂèØÈÄâÔºöÂ¶ÇÊûúÈùûË¶Å‰øùÁïôÊñáÂ≠óÔºåÂèØ‰ª•ÊääÊñáÂ≠óÂÅöÂ∞è‰∏ÄÁÇπÊîæÂú®ÂõæÊ†áÊóÅËæπÔºåÊàñËÄÖÂè™Âú® Hover Êó∂ÊòæÁ§∫ --> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-page divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="language-dropdown-menu"> <ul class="py-2 font-medium text-sm" role="none"> <li> <button type="button" onclick="
            try {
                if ('#' !== '#') {
                    window.location.href = '#';
                }
            } catch (e) {
                console.log('Navigation failed:', e);
            }
        " class="w-full text-left px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
English
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="EN-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-language"></use> </svg> </div> </button> </li><li> <button type="button" onclick="
              try {
                  if ('/zh/posts/zipic-3-technical-details/' !== '#') {
                      window.location.href = '/zh/posts/zipic-3-technical-details/';
                  }
              } catch (e) {
                  console.log('Navigation failed:', e);
              }
          " class="w-full text-left px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
‰∏≠Êñá
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="ZH-check" width="24" height="24" viewBox="0 0 24 24"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-check"></use> </svg> </div> </button> </li> <li> <div class="border-t border-gray-200 dark:border-gray-800 w-4/5 mx-auto my-2"></div> <button class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem" id="set-default-lang"> <div class="inline-flex items-center"> Set English as Default </div> </button> </li> </ul> <script type="module">function a(){const t=localStorage.getItem("lang"),e=document.getElementById("EN-check"),n=document.getElementById("ZH-check");e!==null&&n!==null&&(t==="en"?(e.classList.remove("hidden"),n.classList.add("hidden")):t==="zh"&&(n.classList.remove("hidden"),e.classList.add("hidden")))}document.addEventListener("DOMContentLoaded",()=>{a()});const l=document.getElementById("set-default-lang");l?.addEventListener("click",()=>{const t=document.getElementById("lang-data");if(t!=null){const e=t.dataset.lang;e!=null&&(localStorage.setItem("lang",e),a())}});</script> </div> <button id="theme-dropdown-button" data-dropdown-toggle="theme-dropdown-menu" type="button" aria-label="Theme Switcher" class="group p-2 w-10 h-10 text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <!-- 
    Â∑≤Êõ¥Êñ∞‰∏∫Áªü‰∏ÄÁöÑ 24px Á∫øÊÄßÂõæÊ†á 
    Ê≥®ÊÑèÔºöÁßªÈô§‰∫Ü fill-currentÔºåÊîπ‰∏∫ fill="none" stroke="currentColor"
  --> <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none" class="w-5 h-5 hidden" id="theme_icon_system"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-computer"></use> </svg> <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none" class="w-5 h-5 hidden" id="theme_icon_dark"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-moon"></use> </svg> <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" fill="none" class="w-5 h-5 hidden" id="theme_icon_light"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-sun"></use> </svg> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="theme-dropdown-menu"> <ul class="py-2 font-medium" role="none"> <li class="hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white text-default"> <button class="flex w-full px-4 py-2 text-sm align-text-center hover:text-secondary" id="theme_button_light"> <svg class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-sun"></use> </svg> <span class="ml-2">Light</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white text-default"> <button class="flex w-full px-4 py-2 text-sm align-text-center hover:text-secondary" id="theme_button_dark"> <svg class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-moon"></use> </svg> <span class="ml-2">Dark</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white text-default"> <button class="flex w-full px-4 py-2 text-sm align-text-center hover:text-secondary" id="theme_button_system"> <svg class="w-5 h-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-computer"></use> </svg> <span class="ml-2">System</span> </button> </li> </ul> </div> <script>
  // Ëé∑ÂèñÊåâÈíÆ
  var themeDropdownButton = document.getElementById('theme-dropdown-button'); // Êñ∞Â¢ûÔºöËé∑Âèñ‰∏ªÂºÄÂÖ≥ÊåâÈíÆ
  var themeButtonLight = document.getElementById('theme_button_light');
  var themeButtonDark = document.getElementById('theme_button_dark');
  var themeButtonSystem = document.getElementById('theme_button_system');

  // Ëé∑ÂèñÂõæÊ†á
  var themeToggleDarkIcon = document.getElementById('theme_icon_dark');
  var themeToggleLightIcon = document.getElementById('theme_icon_light');
  var themeToggleSystemIcon = document.getElementById('theme_icon_system');

  function setTheme() {
    if (
      localStorage.getItem('color-theme') === 'dark' ||
      (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }

  function setThemeButton() {
    let theme = localStorage.getItem('color-theme');
    // ÂÖàÈöêËóèÊâÄÊúâÔºåÂÜçÊòæÁ§∫ÂØπÂ∫îÁöÑ
    themeToggleDarkIcon.classList.add('hidden');
    themeToggleLightIcon.classList.add('hidden');
    themeToggleSystemIcon.classList.add('hidden');

    if (theme === 'dark') {
      themeToggleDarkIcon.classList.remove('hidden');
    } else if (theme === 'light') {
      themeToggleLightIcon.classList.remove('hidden');
    } else {
      themeToggleSystemIcon.classList.remove('hidden');
    }
  }

  function resetTheme() {
    setTheme();
    setThemeButton();
  }

  // ÂàùÂßãÂåñ
  resetTheme();

  // ÁõëÂê¨Á≥ªÁªüÊöóÈªëÊ®°ÂºèÁöÑÂèòÂåñ
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    resetTheme();
  });

  // ÁõëÂê¨ Storage ÂèòÂåñ (Â§öÊ†áÁ≠æÈ°µÂêåÊ≠•)
  window.addEventListener('storage', function (event) {
    if (event.key === 'color-theme') {
      resetTheme();
    }
  });

  // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÁÇπÂáªÈÄâÈ°πÂêéÔºåÂêåÊó∂ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï ---

  // Dark Ê®°Âºè
  themeButtonDark.addEventListener('click', function () {
    localStorage.setItem('color-theme', 'dark');
    resetTheme();
    themeDropdownButton.click(); // Ê®°ÊãüÁÇπÂáª‰∏ªÊåâÈíÆ‰ª•ÂÖ≥Èó≠ËèúÂçï
  });

  // Light Ê®°Âºè
  themeButtonLight.addEventListener('click', function () {
    localStorage.setItem('color-theme', 'light');
    resetTheme();
    themeDropdownButton.click(); // Ê®°ÊãüÁÇπÂáª‰∏ªÊåâÈíÆ‰ª•ÂÖ≥Èó≠ËèúÂçï
  });

  // System Ê®°Âºè
  themeButtonSystem.addEventListener('click', function () {
    localStorage.removeItem('color-theme');
    resetTheme();
    themeDropdownButton.click(); // Ê®°ÊãüÁÇπÂáª‰∏ªÊåâÈíÆ‰ª•ÂÖ≥Èó≠ËèúÂçï
  });
</script> <div id="docsearch" class="group w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center cursor-pointer"> <svg class="w-5 h-5 fill-none stroke-current" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-search"></use> </svg> </div> </div> <button data-collapse-toggle="navbar-solid-bg" type="button" class="inline-flex items-center p-2 mx-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-solid-bg" aria-expanded="false" id="navbar-toggle-button"> <span class="sr-only">Open main menu</span> <svg class="w-5 h-5 text-default" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path> </svg> </button> <nav class="hidden w-full md:block md:w-auto px-4 z-40" id="navbar-solid-bg"> <ul class="flex flex-col font-bold mt-4 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent dark:bg-gray-800 md:dark:bg-transparent dark:border-gray-700"> <a href="/en/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Home </a><a href="/en/posts/" class="block py-2 px-3 md:p-0 rounded text-invert bg-secondary md:bg-transparent md:text-secondary md:dark:bg-transparent " aria-current="page"> Articles </a><a href="/en/weekly/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Weekly </a><a href="/en/snippet/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Tips </a><a href="/en/sponsorship/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> Sponsorship </a><a href="/en/about/" class="block py-2 px-3 md:p-0 rounded text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent "> About </a> </ul> </nav> </div> </div> <div id="placeholder" class="hidden" data-astro-cid-4wsjtibl></div> </div> <script>(function(){const enableSticky = true;
const enableStickyInMobile = true;

  window.onload = function () {
    checkStickyHeader();
    stickySetup();
  };

  window.addEventListener('resize', stickySetup);

  function checkStickyHeader() {
    const title = document.getElementById('blogTitle');
    const stickyHeader = document.getElementById('stickyHeader');
    const placeholder = document.getElementById('placeholder');

    if (title && stickyHeader && placeholder) {
      const offset = title.offsetTop + title.offsetHeight;

      if (shouldStick() && window.scrollY >= offset) {
        stickyHeader.classList.add('sticky');
        placeholder.style.display = 'block';
        placeholder.style.height = `${stickyHeader.offsetHeight}px`;
      } else {
        stickyHeader.classList.remove('sticky');
        placeholder.style.display = 'none';
      }
    }
  }

  function shouldStick() {
    if (!enableSticky) return false;

    let isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (isMobile && !enableStickyInMobile) return false;

    return true;
  }

  function stickySetup() {
    window.onscroll = checkStickyHeader;
  }
})();</script>  </header>  <main class="w-full mx-auto max-w-3xl p-4 md:p-6 "> <div class="container mx-auto">   <!-- 
  Ë∞ÉÊï¥ 1: ÂáèÂ∞èÂûÇÁõ¥Èó¥Ë∑ù 
  pt-16 -> pt-12, pb-10 -> pb-8 
--><header class="mx-auto max-w-3xl text-center pt-12 pb-8 px-4 sm:px-6">  <div class="flex flex-wrap justify-center items-center gap-2.5 mb-6">  <a href="/zh/posts/zipic-3-technical-details/" id="language-switcher-for-topic" class="
          inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border transition-all
          /* Light: ÁôΩÂ∫ïÈªëÂ≠ó */
          bg-white text-gray-600 border-gray-200 hover:bg-gray-900 hover:text-white hover:border-gray-900
          /* Dark: Ë∞ÉÊï¥‰∏∫ÂçäÈÄèÊòéËìùÂ∫ï (Tinted Blue)ÔºåÁúãËµ∑Êù•Êõ¥Ê∏ÖÈÄèÔºå‰∏çÂèëÁÅ∞ */
          dark:bg-blue-500/10 dark:text-blue-300 dark:border-blue-500/20 dark:hover:bg-blue-500/20 dark:hover:text-blue-200
        "> <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg> ÈòÖËØª‰∏≠ÊñáÁâà </a>  <a href="/en/tags/Dev-Diary/" class="
          inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold transition-colors
          bg-red-50 text-red-600 hover:bg-red-100
          dark:bg-blue-500/10 dark:text-blue-400 dark:hover:bg-blue-500/20
        ">
#Dev Diary </a><a href="/en/tags/Guest-Post/" class="
          inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold transition-colors
          bg-red-50 text-red-600 hover:bg-red-100
          dark:bg-blue-500/10 dark:text-blue-400 dark:hover:bg-blue-500/20
        ">
#Guest Post </a><a href="/en/tags/SwiftUI/" class="
          inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold transition-colors
          bg-red-50 text-red-600 hover:bg-red-100
          dark:bg-blue-500/10 dark:text-blue-400 dark:hover:bg-blue-500/20
        ">
#SwiftUI </a> </div>  <h1 class="
      text-2xl sm:text-3xl md:text-4xl font-extrabold text-heading leading-tight mb-6
      tracking-tight
    "> Solving SwiftUI Pain Points and Performance Bottlenecks: Zipic Development Technical Retrospective </h1>  <div class="flex flex-wrap justify-center items-center text-sm text-muted font-medium gap-x-4 gap-y-2 "> <a itemprop="author" href="https://x.com/okooo5km" target="_blank" class="flex items-center hover:text-primary transition-colors group"> <span class="border-b border-transparent group-hover:border-primary transition-colors"> Shili </span> </a> <span class="text-gray-300 dark:text-slate-700" aria-hidden="true">&bull;</span> <time datetime="2025-12-22T14:10:00.000Z"> Dec 22, 2025 </time>  <span class="text-gray-300 dark:text-slate-700" aria-hidden="true">&bull;</span> <span class="italic text-muted/80">
(Updated on  <time datetime="2025-12-24T14:10:00.000Z">Dec 24, 2025</time>)
</span>  </div> </header> <svg style="display: none;"> <symbol id="icon-clipboard" viewBox="0 0 1024 1024"> <path d="M426.666667 42.666667l170.666667 0q41.344 0 74.325333 23.850667t46.336 61.482667l50.005333 0q52.992 0 90.496 37.504t37.504 90.496l0 597.333333q0 52.992-37.504 90.496t-90.496 37.504l-512 0q-52.992 0-90.496-37.504t-37.504-90.496l0-597.333333q0-52.992 37.504-90.496t90.496-37.504l50.005333 0q13.312-37.674667 46.336-61.482667t74.325333-23.850667zM768 213.333333l-50.005333 0q-13.312 37.674667-46.336 61.482667t-74.325333 23.850667l-170.666667 0q-41.344 0-74.325333-23.850667t-46.336-61.482667l-50.005333 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333l0 597.333333q0 17.664 12.501333 30.165333t30.165333 12.501333l512 0q17.664 0 30.165333-12.501333t12.501333-30.165333l0-597.333333q0-17.664-12.501333-30.165333t-30.165333-12.501333zM597.333333 128l-170.666667 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333 12.501333 30.165333 30.165333 12.501333l170.666667 0q17.664 0 30.165333-12.501333t12.501333-30.165333-12.501333-30.165333-30.165333-12.501333z"></path> </symbol> <symbol id="icon-check" viewBox="0 0 1024 1024"> <path d="M421.858 683.366l401.796-448.518c18.66-20.828 50.668-22.586 71.498-3.928 20.828 18.66 22.586 50.67 3.928 71.498L463.638 788.494c-18.606 20.768-50.5 22.586-71.344 4.066l-263.29-233.924c-20.906-18.572-22.796-50.576-4.222-71.48 18.574-20.906 50.576-22.796 71.48-4.222L421.86 683.366z"></path> </symbol> </svg> <div class="relative" id="article-area"> <article class="prose dark:prose-invert mx-auto w-full "> <div> 
<div class="mdx-intro"><p>This is the final chapter of the Zipic indie development retrospective series. After covering <a href="/en/posts/zipic-1-from-0-to-1/" target="_blank">Product Design</a> and <a href="/en/posts/zipic-2-selling-and-distribution/" target="_blank">Independent Distribution</a>, developer <a href="https://x.com/okooo5km?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">Shili</a> takes us deep into the codebase.</p><p>This article is packed with hardcore, practical macOS development experience. From SwiftUI component adaptation to low-level Core Graphics applications, and from Raycast extension integration to PDF compression implementation, it not only solves performance bottlenecks but also pushes the native experience to the limit.</p></div>
<aside aria-label="advertisement" role="complementary"><div class="dynamic-ad-inline pt-4"></div></aside>
<p>Hi everyone, I‚Äôm <a href="https://x.com/okooo5km?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">Shili</a> üëã!</p>
<p>Welcome to the final part of the <a href="https://l.fatbobman.com/zipic" rel="noreferrer noopener">Zipic</a> retrospective series. If the first two articles were about ‚Äúwhat to build‚Äù and ‚Äúhow to sell,‚Äù then today‚Äôs article is purely about ‚Äúhow to write.‚Äù</p>
<p>Although macOS development shares many frameworks with iOS development, it faces distinctly different challenges in file systems, window management, and low-level graphics processing. Zipic strives for extreme lightness and performance, which means we can‚Äôt simply rely on high-level wrappers; often, we must dive down to Core Graphics or even kernel event levels to find answers.</p>
<p>Here are some specific technical challenges I encountered during development and the final solutions.</p>
<h2 id="technical-implementation-in-ui-details">Technical Implementation in UI Details</h2>
<h3 id="hiding-the-main-window-title-bar-in-macos-26">Hiding the Main Window Title Bar in macOS 26</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/hide-window-titlebar.jpeg" alt="Hiding Window Titlebar" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p>Zipic‚Äôs interface design strives for simplicity and doesn‚Äôt need a traditional title bar. In early versions, using <code>.windowStyle(.hiddenTitleBar)</code> perfectly hid the title bar, and everything was fine.</p>
<p>But after upgrading to macOS 26, a problem arose. The title bar was indeed ‚Äúhidden,‚Äù but a white background area remained, like a ‚Äúghost‚Äù of the title bar still occupying space, leaving an uncoordinated blank strip at the top of the window. Even more troublesome, this issue didn‚Äôt show up in Xcode preview mode‚Äîpreviews looked fine‚Äîbut appeared when running on a real device, meaning every debug session required compiling and running.</p>
<p>After researching, I found that macOS 26 introduced a new window background system. The original <code>.hiddenTitleBar</code> only hid the UI elements of the title bar but didn‚Äôt handle the underlying container background. The new solution is to use the <code>.containerBackground(.clear, for: .window)</code> modifier:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">WindowGroup</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">    ContentView</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">windowStyle</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">hiddenTitleBar</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">containerBackground</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">clear</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">for</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">window</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span></code></pre>
<p>This modifier tells the system that the window‚Äôs container background should be transparent. Combined with <code>.hiddenTitleBar</code>, this finally achieved a completely title-bar-less effect.</p>
<p>For specific adaptation details, refer to: <a href="https://5km.studio/blog/macos-26-swiftui-hidden-title-bar?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">macOS Development - Hiding the Main Window Title Bar in macOS 26</a></p>
<p><strong>Pitfalls &amp; Experience</strong>: If the app uses <a href="/en/posts/new_navigator_of_swiftui_4" target="_blank"><code>NavigationSplitView</code></a>, you also need to handle the sidebar title separately. By default, the sidebar displays an inline-style navigation title, which also needs to be hidden:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">NavigationSplitView</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">    SidebarView</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        .</span><span style="color:#998418;--shiki-dark:#97E1F1">toolbar</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">removing</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">title</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span><span style="color:#998418;--shiki-dark:#97E1F1"> detail</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">    DetailView</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p>Another detail is window dragging‚Äîhow do users drag the window after hiding the title bar? My approach is to use the <code>isMovableByWindowBackground</code> property of <code>NSWindow</code>, or add custom drag gestures in specific areas, maintaining a clean interface without affecting user operation. Additionally, <code>.containerBackground</code> is a macOS 15+ API, so conditional checks are needed if you need to support earlier system versions.</p>
<h3 id="file-size-display-consistent-with-finder">File Size Display Consistent with Finder</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/zipic-filesize.jpeg" alt="Zipic Filesize" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p>A user reported: ‚ÄúThe file size shown in Zipic is different from what I see in Finder. Is there something wrong with the compression?‚Äù</p>
<p>This confused me. The file size is obtained using the <code>fileSize</code> property from <code>FileManager</code>, so how could it be wrong? After careful comparison, I found that a difference indeed existed. For example, a file might show 1.26 MB in Finder but 1.2 MB in Zipic. Although the difference is small, for a ‚Äúprecision compression‚Äù tool, this inconsistency causes user doubt.</p>
<p>The problem lies in the concept of ‚Äúfile size‚Äù itself. There are two types of sizes in the file system:</p>
<ul>
<li><strong>Logical Size</strong>: The actual amount of data the file contains.</li>
<li><strong>Physical Size</strong>: The space the file occupies on the disk.</li>
</ul>
<p>Finder displays the logical size by default and uses the base-1000 system (1 KB = 1000 bytes), rather than the base-1024 system programmers are used to. To get a file size consistent with Finder, you need to use the <code>resourceValues</code> API of <code>URL</code>:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> resourceValues </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#1E754F;--shiki-dark:#F286C4"> try</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> url.</span><span style="color:#998418;--shiki-dark:#97E1F1">resourceValues</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">forKeys</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> [.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">fileSizeKey</span><span style="color:#393A34;--shiki-dark:#F6F6F4">]</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> fileSize </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> resourceValues.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">fileSize</span><span style="color:#AB5959;--shiki-dark:#F286C4"> ??</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 0</span></span></code></pre>
<p>When formatting for display, use <code>ByteCountFormatter</code> and specify the correct options:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> formatter </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> ByteCountFormatter</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">formatter.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">countStyle</span><span style="color:#AB5959;--shiki-dark:#F286C4"> =</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">file</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Use Finder&#39;s calculation method</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">formatter.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">allowedUnits</span><span style="color:#AB5959;--shiki-dark:#F286C4"> =</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> [.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">useBytes</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">useKB</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">useMB</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">useGB</span><span style="color:#393A34;--shiki-dark:#F6F6F4">]</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> displaySize </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> formatter.</span><span style="color:#998418;--shiki-dark:#97E1F1">string</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">fromByteCount</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic"> Int64</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">fileSize</span><span style="color:#999999;--shiki-dark:#F6F6F4">))</span></span></code></pre>
<p>The key is <code>.countStyle = .file</code>, which makes the formatter use the standard macOS file system way to display size.</p>
<p>For detailed implementation, refer to: <a href="https://5km.studio/blog/macos-dev-file-size-consistent-with-finder?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">macOS Development - Getting File Size Consistent with Finder</a></p>
<p><strong>Pitfalls &amp; Experience</strong>: There are several special cases to note:</p>
<ul>
<li><strong>Sparse Files</strong>: For some files, the logical size and physical size differ greatly. For example, a virtual machine disk file might logically be 64GB but actually occupy only a few GBs.</li>
<li><strong>APFS Transparent Compression</strong>: The APFS file system supports transparent compression. A file might be logically 10MB, but because the system automatically compresses it, it actually takes up only 3MB. In this case, calculating ‚Äúspace saved‚Äù becomes complicated.</li>
<li><strong>Symbolic Links</strong>: If the file is a symbolic link, you might get the size of the link itself rather than the target file. You need to use <code>.resolvingSymlinksInPath()</code> to resolve the real path first.</li>
</ul>
<p>My strategy is to uniformly use the logical size as the display standard, keeping it consistent with Finder. After the fix, I never received similar feedback again.</p>
<h3 id="no-design-mockups-just-code">No Design Mockups, Just Code</h3>
<p>Zipic‚Äôs UI has a ‚Äúsecret‚Äù: I never drew a design mockup.</p>
<p>Not because I‚Äôm lazy, but I found that for utility apps, having clear design principles in mind is more efficient than drawing mockups. Zipic‚Äôs UI strictly adheres to the four basic principles in ‚ÄúThe Non-Designer‚Äôs Design Book‚Äù: <strong>Proximity, Alignment, Repetition, Contrast</strong>. These four principles are simple to understand but are the easiest feasible way to take UI to the next level.</p>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/design-proximity.jpeg" alt="Design Proximity" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<ul>
<li><strong>Proximity</strong>: Related elements are placed together. in Zipic‚Äôs compression list, each file item‚Äôs thumbnail, filename, size, and compression rate are close to each other, forming a visual unit; while there is obvious spacing between different files. Users can distinguish which information belongs to the same image at a glance. The settings panel is the same, grouped by function‚Äîoutput settings together, quality settings together, not mixing ‚Äúoutput path‚Äù and ‚Äúcompression quality.‚Äù</li>
</ul>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/design-alignment.jpeg" alt="Design Alignment" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<ul>
<li><strong>Alignment</strong>: All elements must have a visual connection. In Zipic‚Äôs sidebar, list view, and details panel, all text within the same element is aligned. It looks trivial, but if alignment is messy, the whole interface looks ‚Äúamateur.‚Äù SwiftUI‚Äôs <code>alignment</code> parameter is used a lot; <code>.leading</code>, <code>.trailing</code>, and <code>.center</code> must be chosen based on content type.</li>
</ul>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/design-repetition.jpeg" alt="Design Repetition" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<ul>
<li><strong>Repetition</strong>: Unified visual elements run throughout. The corner radius in Zipic is unified, and all clickable text uses the same color. Icon styles are also unified‚Äîeither all SF Symbols or all custom icons, no mixing. This consistency makes users feel ‚Äúthis is a complete product,‚Äù not ‚Äúcobbled together.‚Äù</li>
</ul>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/design-contrast.jpeg" alt="Design Contrast" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<ul>
<li><strong>Contrast</strong>: Important things should stand out. The compression rate is the data users care about most, so it is displayed with a blue gradient tag; the filename is secondary, using a regular font; the original size is even more secondary, using light gray. Primary and secondary are distinct; users know what to click without thinking.</li>
</ul>
<p>These four principles sound simple, but using them well requires constant adjustment. My approach is: write the code, run it to see the effect, and if something feels ‚Äúoff,‚Äù check it against these four principles. Are related elements not close enough? Is there an alignment issue? Are repetitive elements not unified enough? Is what should be highlighted not standing out?</p>
<p>The benefit of no design mockups is fast iteration‚Äîchange a few lines of code to see the effect, without changing the mockup first and then the code. Of course, this method has a prerequisite: having clear design principles in mind, otherwise, it‚Äôs easy to make a mess while changing things.</p>
<h2 id="technical-implementation-of-core-features">Technical Implementation of Core Features</h2>
<p>Next, I‚Äôll share implementation details of several core features, which are interesting technical points on the macOS platform.</p>
<h3 id="directory-monitor-for-automatic-compression">Directory Monitor for Automatic Compression</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/zipic-directory-monitor.jpeg" alt="Zipic Directory Monitor" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p>Directory monitoring is a signature feature of Zipic: users specify a folder, Zipic monitors its changes in real-time, and automatically compresses any new image added. The requirement looks straightforward, but I encountered many problems during implementation: which monitoring mechanism to choose, how to handle event bursts, what about infinite loops triggered by output files‚Ä¶</p>
<p>First is the choice of monitoring mechanism. The most intuitive way is polling‚Äîscanning the directory every few seconds to see if there are new files. But this method consumes too many resources, especially when the monitored folder contains thousands of files. I ultimately chose macOS‚Äôs <code>DispatchSource.FileSystemEvent</code>, an efficient monitoring mechanism based on kernel-level kqueue, which triggers only when file system changes actually occur, keeping CPU usage extremely low.</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Open directory with O_EVTONLY flag (only listen for events, don&#39;t block unmounting)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">fileDescriptor </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#1E754F;--shiki-dark:#F286C4"> open</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">url.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">path</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, O_EVTONLY</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Create DispatchSource to monitor file system object</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">source </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> DispatchSource.</span><span style="color:#998418;--shiki-dark:#97E1F1">makeFileSystemObjectSource</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">    fileDescriptor</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> fileDescriptor,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">    eventMask</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> [.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">write</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">extend</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">delete</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">rename</span><span style="color:#393A34;--shiki-dark:#F6F6F4">],</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">    queue</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> configuration.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">queue</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span></code></pre>
<p>The next problem encountered was event bursts. If a user drags in hundreds of images at once, the system triggers hundreds of events in an instant. Processing each event immediately is inefficient and can cause interface lag. The solution is to implement a <strong>Debounce mechanism</strong>: when multiple events are received continuously, wait for a short period (default 0.5 seconds) and merge events within this period into one processing batch. This way, if a user drags in 100 images, it ultimately triggers only one compression task.</p>
<p>The trickiest problem is infinite loops. Imagine: User monitors Folder A, Zipic detects new image <code>photo.jpg</code>, compresses it to generate <code>photo_compressed.jpg</code>. But this output file is also in Folder A, so it triggers the monitoring event again‚Ä¶ and so on, creating an infinite loop.</p>
<p>For this, I designed a <strong>Predictive Ignore Mechanism</strong>. When an input file is detected, the system predicts the path of the output file and adds it to the ignore list in advance:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> predictor </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> FileTransformPredictor.</span><span style="color:#998418;--shiki-dark:#97E1F1">imageCompression</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">suffix</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">_compressed</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> predictedOutputs </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> predictor.</span><span style="color:#998418;--shiki-dark:#97E1F1">predictOutputFiles</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">for</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> inputURL</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">ignoreList.</span><span style="color:#998418;--shiki-dark:#97E1F1">addPredictiveIgnore</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">predictedOutputs</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span></code></pre>
<p>The filtering system is also important. Users may only want to compress specific types of images, or only process files larger than a certain size. I used the Predicate pattern to implement flexible condition combinations:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Only monitor image files, larger than 1KB, modified within 1 hour</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> filter </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> FileFilter.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">imageFiles</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    .</span><span style="color:#998418;--shiki-dark:#97E1F1">and</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">fileSize</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#2F798A;--shiki-dark:#BF9EEE">1024</span><span style="color:#AB5959;--shiki-dark:#F286C4">...</span><span style="color:#999999;--shiki-dark:#F6F6F4">))</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    .</span><span style="color:#998418;--shiki-dark:#97E1F1">and</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">modifiedWithin</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#2F798A;--shiki-dark:#BF9EEE">3600</span><span style="color:#999999;--shiki-dark:#F6F6F4">))</span></span></code></pre>
<p>There are also some details worth noting. Monitoring depth should be set according to actual scenarios‚Äîfor most users, monitoring one or two levels of subdirectories is enough. If set to infinite depth, encountering complex directory structures (like node_modules) will create a massive number of watchers, consuming too many system resources. Additionally, newly created subdirectories also need to be dynamically added to monitoring, which requires the system to automatically check for new subdirectories and create watchers for them when directory changes are detected.</p>
<p>After repeatedly polishing this solution, I later open-sourced the core part as the <a href="https://github.com/okooo5km/FSWatcher?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">FSWatcher</a> project, hoping to help developers with similar needs.</p>
<h3 id="pdf-compression-utilizing-native-macos-capabilities">PDF Compression: Utilizing Native macOS Capabilities</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/zipic-pdf-filter-compression.jpeg" alt="Zipic PDF Filter Compression" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p><strong>As the most common format for daily documents, PDFs are often stuffed with images. Supporting PDF compression was a highly requested feature.</strong></p>
<p>PDF compression and ordinary image compression are completely different things. Image compression is relatively simple‚Äîread pixel data, re-encode with algorithms, write to a new file. But PDF is a complex container format that may contain text, vector graphics, embedded fonts, bookmarks, forms‚Ä¶ and of course, images. The key question is: How to compress only the images within without destroying the PDF structure?</p>
<p>Initially, I considered several solutions: Ghostscript is powerful but bulky and requires handling external dependency distribution; ImageMagick doesn‚Äôt preserve PDF structure well enough; parsing PDF format manually to extract and re-compress images‚Äîthinking about this path reveals it as a bottomless pit.</p>
<p>Ultimately, I chose <strong>macOS native Quartz Filter technology</strong>. To be honest, I wish I had known about it sooner. It‚Äôs hidden in the system specifically for this purpose; the ‚ÄúReduce File Size‚Äù option when exporting PDFs in the system‚Äôs ‚ÄúPreview‚Äù app uses exactly this. The working principle is elegant: it automatically performs JPEG re-compression on bitmap images within the PDF while rendering pages, leaving text, vector graphics, and fonts untouched.</p>
<p>This is a unique advantage of the macOS platform‚Äî<strong>the Core Graphics framework has hardware acceleration support</strong>, processing is fast, and no external dependencies need to be bundled, so the app size won‚Äôt bloat.</p>
<p>The core idea is to dynamically generate a custom <code>.qfilter</code> configuration file defining compression parameters, and then apply this filter via the Core Graphics framework to render the PDF. The whole flow: Generate corresponding Quartz Filter config based on user‚Äôs selected compression level -&gt; Read source PDF -&gt; Create new PDF context and apply Filter -&gt; Render page by page (Filter handles image compression automatically at this step) -&gt; Output compressed PDF.</p>
<p>Key Code (Quartz Filter File Generation):</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">private</span><span style="color:#AB5959;--shiki-dark:#F286C4"> static</span><span style="color:#AB5959;--shiki-dark:#F286C4"> func</span><span style="color:#59873A;--shiki-dark:#62E884"> generateQFilter</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;--shiki-dark:#62E884">at</span><span style="color:#393A34;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic"> url</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: URL, </span><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">compressionQuality</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: </span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">Double</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">level</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: </span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">Int</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> xmlContent </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">    &lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;...&quot;&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">    &lt;plist version=&quot;1.0&quot;&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">    &lt;dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">        &lt;key&gt;FilterData&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">        &lt;dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">            &lt;key&gt;ColorSettings&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">            &lt;dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                &lt;key&gt;ImageSettings&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                &lt;dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                    &lt;key&gt;Compression Quality&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                    &lt;real&gt;</span><span style="color:#999999;--shiki-dark:#F286C4">\(</span><span style="color:#B56959;--shiki-dark:#E7EE98">compressionQuality</span><span style="color:#B56959;--shiki-dark:#F286C4">)</span><span style="color:#B56959;--shiki-dark:#E7EE98">&lt;/real&gt;      &lt;!-- 0.0-1.0 --&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                    &lt;key&gt;ImageCompression&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                    &lt;string&gt;ImageJPEGCompress&lt;/string&gt;       &lt;!-- JPEG Compression --&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                    &lt;key&gt;ImageScaleSettings&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                    &lt;dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                        &lt;key&gt;ImageScaleFactor&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                        &lt;real&gt;1.0&lt;/real&gt;                     &lt;!-- Keep Original Size --&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                    &lt;/dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">                &lt;/dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">            &lt;/dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">        &lt;/dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">        &lt;key&gt;FilterType&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">        &lt;integer&gt;1&lt;/integer&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">        &lt;key&gt;Name&lt;/key&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">        &lt;string&gt;Compress PDF&lt;/string&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">    &lt;/dict&gt;</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#E7EE98">    &lt;/plist&gt;</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#DEE492">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    try</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> xmlContent.</span><span style="color:#998418;--shiki-dark:#97E1F1">write</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">to</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> url, </span><span style="color:#998418;--shiki-dark:#97E1F1">atomically</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> true</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">encoding</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#998418;--shiki-dark:#BF9EEE">utf8</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p>For the design of compression levels, I defined 6 levels corresponding to different JPEG quality parameters (0.9 to 0.2). It is worth noting that at level 0.2, images show obvious compression artifacts. For documents that need to be printed or presented, higher quality levels are recommended; aggressive settings can be used for network transmission or archiving.</p>
<p>Key Code (PDF Compression Core Logic):</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">static</span><span style="color:#AB5959;--shiki-dark:#F286C4"> func</span><span style="color:#59873A;--shiki-dark:#62E884"> pdf</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;--shiki-dark:#62E884">at</span><span style="color:#393A34;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic"> sourceURL</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: URL, </span><span style="color:#59873A;--shiki-dark:#62E884">to</span><span style="color:#393A34;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic"> destinationURL</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: URL, </span><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">compressionLevel</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: </span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">Double</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#AB5959;--shiki-dark:#F286C4"> -&gt;</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CommandResult </span><span style="color:#999999;--shiki-dark:#F6F6F4">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 1. Load Quartz Filter</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> filter </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> QuartzFilterManager.</span><span style="color:#998418;--shiki-dark:#97E1F1">filterForCompressionLevel</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">compressionLevel</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        return</span><span style="color:#998418;--shiki-dark:#97E1F1"> CommandResult</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">output</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">Failed to load filter</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">error</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">exit</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">status</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> -1</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 2. Read Source PDF</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> sourcePDF </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> PDFDocument</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">url</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> sourceURL</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        return</span><span style="color:#998418;--shiki-dark:#97E1F1"> CommandResult</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">output</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">Failed to load PDF</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">error</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">exit</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">status</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> -1</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 3. Create Data Consumer and PDF Context</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> mutableData </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> NSMutableData</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> consumer </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGDataConsumer</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">data</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> mutableData</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#393A34;--shiki-dark:#F6F6F4">,</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">          let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> firstPage </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> sourcePDF.</span><span style="color:#998418;--shiki-dark:#97E1F1">page</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">at</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 0</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> return</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B"> /* error */</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    var</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> mediaBox </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> firstPage.</span><span style="color:#998418;--shiki-dark:#97E1F1">bounds</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">for</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">mediaBox</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> pdfContext </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGContext</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">consumer</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> consumer, </span><span style="color:#998418;--shiki-dark:#97E1F1">mediaBox</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#AB5959;--shiki-dark:#F286C4"> &amp;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">mediaBox, </span><span style="color:#1E754F;--shiki-dark:#BF9EEE">nil</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        return</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B"> /* error */</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 4. Apply Filter to Context (Key Step)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    guard</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> filter.</span><span style="color:#998418;--shiki-dark:#97E1F1">apply</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">to</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> pdfContext</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        return</span><span style="color:#998418;--shiki-dark:#97E1F1"> CommandResult</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">output</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">Failed to apply filter</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">error</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">exit</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">status</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> -1</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 5. Render All Pages</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    return</span><span style="color:#998418;--shiki-dark:#97E1F1"> renderPDFPages</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">sourcePDF</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> sourcePDF, </span><span style="color:#998418;--shiki-dark:#97E1F1">context</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> pdfContext, </span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">                          data</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> mutableData, </span><span style="color:#998418;--shiki-dark:#97E1F1">destinationURL</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> destinationURL</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p>Key Code (Page Rendering Implementation):</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">private</span><span style="color:#AB5959;--shiki-dark:#F286C4"> static</span><span style="color:#AB5959;--shiki-dark:#F286C4"> func</span><span style="color:#59873A;--shiki-dark:#62E884"> renderPDFPages</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span></span>
<span class="line"><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">    sourcePDF</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: PDFDocument,</span></span>
<span class="line"><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">    context</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: CGContext,</span></span>
<span class="line"><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">    data</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: NSMutableData,</span></span>
<span class="line"><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">    destinationURL</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: URL</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#AB5959;--shiki-dark:#F286C4"> -&gt;</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CommandResult </span><span style="color:#999999;--shiki-dark:#F6F6F4">{</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // Render page by page (Filter automatically handles image compression)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    for</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> pageIndex </span><span style="color:#1E754F;--shiki-dark:#F286C4">in</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 0</span><span style="color:#AB5959;--shiki-dark:#F286C4">..&lt;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">sourcePDF.pageCount </span><span style="color:#999999;--shiki-dark:#F6F6F4">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> page </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> sourcePDF.</span><span style="color:#998418;--shiki-dark:#97E1F1">page</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">at</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> pageIndex</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> continue</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        var</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> pageRect </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> page.</span><span style="color:#998418;--shiki-dark:#97E1F1">bounds</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">for</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">mediaBox</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        </span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        context.</span><span style="color:#998418;--shiki-dark:#97E1F1">beginPage</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">mediaBox</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#AB5959;--shiki-dark:#F286C4"> &amp;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">pageRect</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        page.</span><span style="color:#998418;--shiki-dark:#97E1F1">draw</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">with</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">mediaBox</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">to</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> context</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Filter applies during drawing</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        context.</span><span style="color:#998418;--shiki-dark:#97E1F1">endPage</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    context.</span><span style="color:#998418;--shiki-dark:#97E1F1">closePDF</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // Write to file</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    try</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> data.</span><span style="color:#998418;--shiki-dark:#97E1F1">write</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">to</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> destinationURL, </span><span style="color:#998418;--shiki-dark:#97E1F1">options</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">atomic</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    return</span><span style="color:#998418;--shiki-dark:#97E1F1"> CommandResult</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">output</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">Success</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">error</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">exit</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">status</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 0</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p><strong>Pitfalls &amp; Experience</strong>: The dynamically generated <code>.qfilter</code> file needs to be stored in a suitable location (I chose <code>~/Library/zipic/filters/</code>). You need to handle cases where the file doesn‚Äôt exist or is corrupted, regenerating it if necessary.</p>
<p>Also note that Quartz Filter only compresses bitmap images in the PDF. If a PDF mainly consists of text and vector graphics, the compressed size might not change much‚Äîthis needs to be explained to users at the product level to avoid confusion like ‚Äúwhy did I compress it but it didn‚Äôt get smaller.‚Äù The good news is that metadata (bookmarks, links, forms, etc.) in the PDF can be fully preserved under this scheme, which many third-party solutions cannot achieve.</p>
<h3 id="thumbnail-generation-optimization">Thumbnail Generation Optimization</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/zipic-image-thumbnail.jpeg?x=1" alt="Zipic Image Thumbnail" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p>Zipic‚Äôs list view needs to display a large number of image thumbnails. The initial implementation was naive: using <code>AsyncImage</code> to load the original image directly and letting the system scale it down automatically. It was fine for small images, but with large images, it lagged noticeably, and memory usage skyrocketed.</p>
<p><strong>First Optimization: Pre-generate Thumbnail Cache</strong></p>
<p>The idea is straightforward‚Äîsince scaling happens every time, why not pre-generate thumbnails and save them to disk, then load the small image next time? The early implementation used <code>NSImage</code>‚Äôs <code>lockFocus/unlockFocus</code> methods:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Early version (Deprecated)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">func</span><span style="color:#59873A;--shiki-dark:#62E884"> thumbnail</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;--shiki-dark:#62E884">with</span><span style="color:#393A34;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic"> width</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: CGFloat</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#AB5959;--shiki-dark:#F286C4"> -&gt;</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> NSImage </span><span style="color:#999999;--shiki-dark:#F6F6F4">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> thumbnailImage </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> NSImage</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">size</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> thumbnailSize</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    thumbnailImage.</span><span style="color:#998418;--shiki-dark:#97E1F1">lockFocus</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#A65E2B;font-style:inherit;--shiki-dark:#BF9EEE;--shiki-dark-font-style:italic">    self</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">draw</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">in</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> thumbnailRect, </span><span style="color:#998418;--shiki-dark:#97E1F1">from</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">zero</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">operation</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">sourceOver</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">fraction</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 1.0</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    thumbnailImage.</span><span style="color:#998418;--shiki-dark:#97E1F1">unlockFocus</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    return</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> thumbnailImage</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p>The problem is: this method requires <strong>fully decoding the original image into memory first</strong>, then scaling and drawing. Decoding an 8000x6000 image takes up about 192MB of memory. When batch processing, memory easily hits several GBs. Moreover, <code>lockFocus</code> has been marked as a deprecated API by Apple, and calling it on background threads may trigger priority inversion.</p>
<p><strong>Second Optimization: CGContext Manual Drawing</strong></p>
<p>To solve the <code>lockFocus</code> issue, I switched to using <code>CGContext</code> to manually create a bitmap context:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Improved version (Still problematic)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> cgImage </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#A65E2B;font-style:inherit;--shiki-dark:#BF9EEE;--shiki-dark-font-style:italic"> self</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">cgImage</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">forProposedRect</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">context</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">hints</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    return</span><span style="color:#A65E2B;font-style:inherit;--shiki-dark:#BF9EEE;--shiki-dark-font-style:italic"> self</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> context </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGContext</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#AB5959;--shiki-dark:#F286C4">...</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> return</span><span style="color:#A65E2B;font-style:inherit;--shiki-dark:#BF9EEE;--shiki-dark-font-style:italic"> self</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">context.</span><span style="color:#998418;--shiki-dark:#97E1F1">draw</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">cgImage, </span><span style="color:#998418;--shiki-dark:#97E1F1">in</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGRect</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">origin</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">zero</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">size</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> thumbnailSize</span><span style="color:#999999;--shiki-dark:#F6F6F4">))</span></span></code></pre>
<p>This solved the thread safety issue, but the <strong>essence didn‚Äôt change</strong>‚Äîthe original image still had to be fully decoded to get the <code>CGImage</code>, so the memory problem persisted.</p>
<p><strong>Final Solution: ImageIO Downsampling</strong></p>
<p>Later, I discovered that the ImageIO framework provides the <code>CGImageSourceCreateThumbnailAtIndex</code> API, which can <strong>generate thumbnails of a specified size directly from the image file using progressive downsampling internally, without needing to fully decode the original image</strong>. This is the correct answer.</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">func</span><span style="color:#59873A;--shiki-dark:#62E884"> savePNGThumbnail</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;--shiki-dark:#62E884">for</span><span style="color:#393A34;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic"> imageURL</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: URL, </span><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">maxPixelSize</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: </span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">Int</span><span style="color:#999999;--shiki-dark:#F286C4"> =</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 192</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#AB5959;--shiki-dark:#F286C4"> -&gt;</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> URL</span><span style="color:#999999;--shiki-dark:#F286C4">?</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    return</span><span style="color:#998418;--shiki-dark:#97E1F1"> autoreleasepool</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">        // Create image source (Do not cache original image)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> sourceOptions: CFDictionary </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> [kCGImageSourceShouldCache</span><span style="color:#AB5959;--shiki-dark:#F286C4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> false</span><span style="color:#393A34;--shiki-dark:#F6F6F4">] </span><span style="color:#AB5959;--shiki-dark:#F286C4">as</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CFDictionary</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> source </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGImageSourceCreateWithURL</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">imageURL </span><span style="color:#AB5959;--shiki-dark:#F286C4">as</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CFURL, sourceOptions</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">            return</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">        // Configure thumbnail options</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> thumbnailOptions: </span><span style="color:#999999;--shiki-dark:#F6F6F4">[</span><span style="color:#393A34;--shiki-dark:#F6F6F4">CFString</span><span style="color:#999999;--shiki-dark:#F286C4">:</span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic"> Any</span><span style="color:#999999;--shiki-dark:#F6F6F4">]</span><span style="color:#AB5959;--shiki-dark:#F286C4"> =</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> [</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            kCGImageSourceCreateThumbnailFromImageAlways</span><span style="color:#AB5959;--shiki-dark:#F286C4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> true</span><span style="color:#393A34;--shiki-dark:#F6F6F4">,</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            kCGImageSourceCreateThumbnailWithTransform</span><span style="color:#AB5959;--shiki-dark:#F286C4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> true</span><span style="color:#393A34;--shiki-dark:#F6F6F4">,  </span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Auto-apply EXIF orientation</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            kCGImageSourceShouldCacheImmediately</span><span style="color:#AB5959;--shiki-dark:#F286C4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> true</span><span style="color:#393A34;--shiki-dark:#F6F6F4">,        </span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Decode immediately to avoid priority inversion</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            kCGImageSourceThumbnailMaxPixelSize</span><span style="color:#AB5959;--shiki-dark:#F286C4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> maxPixelSize  </span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Max dimension 192px</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">        // Generate thumbnail directly (Internal downsampling, no full decode)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> cgImage </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGImageSourceCreateThumbnailAtIndex</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">source, </span><span style="color:#2F798A;--shiki-dark:#BF9EEE">0</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, thumbnailOptions </span><span style="color:#AB5959;--shiki-dark:#F286C4">as</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CFDictionary</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">            return</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">        // Write PNG file</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> destURL </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> thumbnailsDir.</span><span style="color:#998418;--shiki-dark:#97E1F1">appendingPathComponent</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">fileComponent</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            .</span><span style="color:#998418;--shiki-dark:#97E1F1">deletingPathExtension</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">appendingPathExtension</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">png</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> destination </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGImageDestinationCreateWithURL</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            destURL </span><span style="color:#AB5959;--shiki-dark:#F286C4">as</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CFURL, UTType.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">png</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">identifier</span><span style="color:#AB5959;--shiki-dark:#F286C4"> as</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CFString, </span><span style="color:#2F798A;--shiki-dark:#BF9EEE">1</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#1E754F;--shiki-dark:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">        )</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> return</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#998418;--shiki-dark:#97E1F1">        CGImageDestinationAddImage</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">destination, cgImage, </span><span style="color:#1E754F;--shiki-dark:#BF9EEE">nil</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        guard</span><span style="color:#998418;--shiki-dark:#97E1F1"> CGImageDestinationFinalize</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">destination</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> return</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        return</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> destURL</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p><strong>Effect Comparison</strong>: Processing the same 8000x6000 JPEG, full decoding takes about 192MB, while downsampling to generate a 192px thumbnail takes about 0.15MB‚Äî<strong>memory savings of nearly a thousand times</strong>.</p>
<p><strong>Key Parameters</strong>:</p>
<ul>
<li><code>kCGImageSourceShouldCache: false</code>: Disable caching when creating image source to avoid original image data staying in memory.</li>
<li><code>kCGImageSourceShouldCacheImmediately: true</code>: Decode immediately on the current thread to prevent being scheduled to a low-priority background thread causing priority inversion.</li>
<li><code>kCGImageSourceCreateThumbnailWithTransform: true</code>: Automatically apply EXIF orientation information so portrait photos taken with phones won‚Äôt display ‚Äúsideways.‚Äù</li>
<li><code>kCGImageSourceThumbnailMaxPixelSize</code>: Specify the maximum edge length; ImageIO will downsample as needed internally.</li>
</ul>
<p><strong>Pitfalls &amp; Experience</strong>:</p>
<ul>
<li><strong>Memory Release</strong>: Wrap the loop body with <code>autoreleasepool</code> during batch processing to ensure temporary objects are released immediately after processing each image, avoiding memory accumulation.</li>
<li><strong>Filename Conflict</strong>: Early thumbnails were stored using only filenames, so <code>photo.jpg</code> in different directories would overwrite each other. The solution is for the cache directory to preserve the relative path structure, e.g., thumbnails for <code>a/photo.jpg</code> and <code>b/photo.jpg</code> are saved to <code>thumbnails/a/photo.png</code> and <code>thumbnails/b/photo.png</code> respectively.</li>
</ul>
<p>The core principle of this optimization is: <strong>For scenarios where only thumbnails need to be displayed, never fully decode the original image</strong>. ImageIO‚Äôs downsampling is the best practice recommended by Apple.</p>
<h3 id="device-fingerprint-stability-optimization">Device Fingerprint Stability Optimization</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/zipic-fingerprint-issue.jpeg" alt="Zipic Fingerprint Issue" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p>I once received user feedback saying ‚ÄúI didn‚Äôt change my computer but I need to reactivate.‚Äù Investigation revealed that the old fingerprint algorithm included the hostname, which changes with network environment changes or system updates, causing fingerprint drift and triggering false positives.</p>
<p>The solution was to make the device fingerprint rely only on stable hardware identifiers, removing any mutable software identifiers. Ultimately, only the mainboard serial number and Ethernet MAC address are kept for calculation:</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">func</span><span style="color:#59873A;--shiki-dark:#62E884"> generateStable</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#AB5959;--shiki-dark:#F286C4"> -&gt;</span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic"> String</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    var</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> components: </span><span style="color:#999999;--shiki-dark:#F6F6F4">[</span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">String</span><span style="color:#999999;--shiki-dark:#F6F6F4">]</span><span style="color:#AB5959;--shiki-dark:#F286C4"> =</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    if</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> boardSerial </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> getBoardSerial</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        components.</span><span style="color:#998418;--shiki-dark:#97E1F1">append</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">boardSerial</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B"> // Mainboard Serial</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    if</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> macAddress </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> getMACAddress</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        components.</span><span style="color:#998418;--shiki-dark:#97E1F1">append</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">macAddress</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Ethernet MAC Address</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> joined </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> components.</span><span style="color:#998418;--shiki-dark:#97E1F1">joined</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">separator</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">|</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> data </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> Data</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">joined.</span><span style="color:#998418;--shiki-dark:#BF9EEE">utf8</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    return</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> data.</span><span style="color:#998418;--shiki-dark:#97E1F1">sha256</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">map</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic"> String</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">format</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">%02hhx</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#A65E2B;font-style:inherit;--shiki-dark:#BF9EEE;--shiki-dark-font-style:italic">$0</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">joined</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p><strong>Pitfalls &amp; Experience</strong>:</p>
<ul>
<li><strong>Silent Migration Strategy</strong>: Automatically fallback to try the old fingerprint when verification fails. If the old fingerprint is valid, silently de-register the old device and reactivate with the new fingerprint in the background, making the whole process imperceptible to the user.</li>
<li><strong>Network Error Tolerance</strong>: Revoke authorization only under specific business error codes. For anomalies like timeouts or network jitter, only log and retry without changing the local authorization status.</li>
</ul>
<h3 id="batch-compression-concurrency-optimization">Batch Compression Concurrency Optimization</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/zipic-accelerate-compression.jpeg" alt="Zipic Accelerate Compression" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p>When a user drags in hundreds of images at once, efficient processing is a technical challenge. The initial serial solution‚Äîcompressing one by one‚Äîwas obviously too slow, but simply maximizing concurrency also causes problems: system lag, memory spikes, and chaotic task scheduling.</p>
<p>The final solution is a combination of <code>OperationQueue</code> + <code>DispatchGroup</code>, cooperating with <code>QueueManager</code> to implement double-queue load balancing scheduling.</p>
<p><strong>Why Double Queues?</strong></p>
<p>The problem with a single queue is obvious: User drags in 500 large images first, filling the queue; then immediately drags in 3 small images wanting quick processing, but they have to wait behind the 500 images. The double-queue design allows new tasks to be assigned to the lighter-loaded queue, so small batch tasks won‚Äôt be blocked by large batch tasks.</p>
<p>Key Code (QueueManager Load Balancing Allocation):</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">class</span><span style="color:#2E8F82;--shiki-dark:#97E1F1"> QueueManager</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">    static</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> shared </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> QueueManager</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">num</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 2</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Double Queue</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    var</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> queues </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> [OperationQueue]</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    var</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> counts </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> [</span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">Int</span><span style="color:#393A34;--shiki-dark:#F6F6F4">]</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Record task count of each queue</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">    init</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">num</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: </span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">Int</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        for</span><span style="color:#998418;--shiki-dark:#BF9EEE"> _</span><span style="color:#1E754F;--shiki-dark:#F286C4"> in</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 1</span><span style="color:#AB5959;--shiki-dark:#F286C4">...</span><span style="color:#393A34;--shiki-dark:#F6F6F4">num </span><span style="color:#999999;--shiki-dark:#F6F6F4">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">            let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> queue </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> OperationQueue</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            queue.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">qualityOfService</span><span style="color:#AB5959;--shiki-dark:#F286C4"> =</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">userInitiated</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            queue.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">maxConcurrentOperationCount</span><span style="color:#AB5959;--shiki-dark:#F286C4"> =</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 8</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Configurable</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            queues.</span><span style="color:#998418;--shiki-dark:#97E1F1">append</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">queue</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            counts.</span><span style="color:#998418;--shiki-dark:#97E1F1">append</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#2F798A;--shiki-dark:#BF9EEE">0</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">        }</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    /// Load Balancing: Choose the queue with fewest tasks</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">    func</span><span style="color:#59873A;--shiki-dark:#62E884"> allocate</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">count</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: </span><span style="color:#998418;font-style:inherit;--shiki-dark:#97E1F1;--shiki-dark-font-style:italic">Int</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#AB5959;--shiki-dark:#F286C4"> -&gt;</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> OperationQueue </span><span style="color:#999999;--shiki-dark:#F6F6F4">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        var</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> index </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#2F798A;--shiki-dark:#BF9EEE"> 0</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        if</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> minCount </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> counts.</span><span style="color:#998418;--shiki-dark:#97E1F1">min</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#393A34;--shiki-dark:#F6F6F4">,</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">           let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> indexOfMinValue </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> counts.</span><span style="color:#998418;--shiki-dark:#97E1F1">firstIndex</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">of</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> minCount</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            index </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> indexOfMinValue</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">        }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        counts</span><span style="color:#999999;--shiki-dark:#F6F6F4">[</span><span style="color:#393A34;--shiki-dark:#F6F6F4">index</span><span style="color:#999999;--shiki-dark:#F6F6F4">]</span><span style="color:#AB5959;--shiki-dark:#F286C4"> +=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> count</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        return</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> queues</span><span style="color:#999999;--shiki-dark:#F6F6F4">[</span><span style="color:#393A34;--shiki-dark:#F6F6F4">index</span><span style="color:#999999;--shiki-dark:#F6F6F4">]</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p>Key Code (Batch Compression Flow):</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">static</span><span style="color:#AB5959;--shiki-dark:#F286C4"> func</span><span style="color:#59873A;--shiki-dark:#62E884"> compress</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;font-style:inherit;--shiki-dark:#62E884;--shiki-dark-font-style:italic">urls</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: </span><span style="color:#999999;--shiki-dark:#F6F6F4">[</span><span style="color:#393A34;--shiki-dark:#F6F6F4">URL</span><span style="color:#999999;--shiki-dark:#F6F6F4">]</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#59873A;--shiki-dark:#62E884">by</span><span style="color:#393A34;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic"> compressedImages</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: CompressedImages</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> group </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> DispatchGroup</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 1. Get the queue with lightest load</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> operationQueue </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> QueueManager.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">shared</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.</span><span style="color:#998418;--shiki-dark:#97E1F1">allocate</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">count</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> urls.</span><span style="color:#998418;--shiki-dark:#BF9EEE">count</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 2. Create Operation for each image</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    for</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> url </span><span style="color:#1E754F;--shiki-dark:#F286C4">in</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> urls </span><span style="color:#999999;--shiki-dark:#F6F6F4">{</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> operation </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> BlockOperation</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">            // Generate thumbnail, execute compression, update UI</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">        }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        </span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        operation.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">completionBlock</span><span style="color:#AB5959;--shiki-dark:#F286C4"> =</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">            group.</span><span style="color:#998418;--shiki-dark:#97E1F1">leave</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">        }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        </span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        group.</span><span style="color:#998418;--shiki-dark:#97E1F1">enter</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">        operationQueue.</span><span style="color:#998418;--shiki-dark:#97E1F1">addOperation</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#393A34;--shiki-dark:#F6F6F4">operation</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // 3. Send notification when all tasks are done</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    group.</span><span style="color:#998418;--shiki-dark:#97E1F1">notify</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">queue</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> .</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">main</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">        // Show completion notification</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p><strong>Why OperationQueue instead of GCD?</strong></p>
<p><code>OperationQueue</code> has several key advantages over native GCD: supports task cancellation (needed when user clears the list), can set maximum concurrency count, and can query task status. These features are crucial for batch processing scenarios requiring fine-grained control.</p>
<p><strong>Pitfalls &amp; Experience</strong>:</p>
<ul>
<li><strong>Thread Safety</strong>: Multiple Operations will concurrently update progress statistics, needing <code>DispatchSemaphore</code> to protect shared state and avoid data races.</li>
<li><strong>QoS Settings</strong>: Must set <code>queue.qualityOfService = .userInitiated</code>, otherwise the system will issue priority warnings and tasks might be executed with downgraded performance.</li>
<li><strong>Concurrency Count Selection</strong>: The default of 8 is an empirical value. Compression is CPU-intensive; too high concurrency leads to increased context switching overhead, while too low leaves CPU underutilized.</li>
<li><strong>UI Updates</strong>: UI updates inside Operations must be dispatched to the main thread, otherwise there will be thread safety issues and warnings.</li>
<li><strong>Multi-batch Progress Tracking</strong>: Users might drag in multiple batches of images continuously. Each batch needs to track progress independently, and total progress is a weighted average of all batches. I designed a <code>TaskStack</code> to manage this scenario.</li>
</ul>
<h3 id="building-an-open-ecosystem-url-scheme--raycast-extension">Building an Open Ecosystem: URL Scheme &amp; Raycast Extension</h3>
<figure style="margin: 2em 0; text-align: center;"><img src="https://storage.5km.host/zipic-url-scheme-extention.jpeg" alt="Zipic URL Scheme Extension" style="
max-width: 80%;     
width: 550px;         
border-radius: 16px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.06);
display: inline-block;
"/></figure>
<p>For a utility product to truly integrate into a user‚Äôs workflow, relying solely on its own interface is not enough. Users might be using Raycast, Alfred, Shortcuts, or even writing their own scripts‚Äîif Zipic can be invoked by these tools, the usage scenarios broaden significantly.</p>
<p>The most common way for cross-app communication on macOS is <strong>URL Scheme</strong>. After registering a custom scheme in <code>Info.plist</code>, any application can invoke Zipic to execute tasks via <code>open &quot;zipic://...&quot;</code>.</p>
<p>My design is: <code>zipic://compress?url=Path1&amp;url=Path2&amp;level=3&amp;format=webp</code>, supporting passing multiple file paths and compression parameters.</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">Swift</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="swift"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Handle incoming URL at App entry after registering URL Scheme</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">private</span><span style="color:#AB5959;--shiki-dark:#F286C4"> func</span><span style="color:#59873A;--shiki-dark:#62E884"> handle</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#59873A;--shiki-dark:#62E884">_</span><span style="color:#393A34;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic"> url</span><span style="color:#393A34;--shiki-dark:#F6F6F4">: URL</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    guard</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> url.scheme </span><span style="color:#AB5959;--shiki-dark:#F286C4">==</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">zipic</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, url.host </span><span style="color:#AB5959;--shiki-dark:#F286C4">==</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">compress</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#1E754F;--shiki-dark:#F286C4"> else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> return</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // Parse URL parameters</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    guard</span><span style="color:#1E754F;--shiki-dark:#F286C4"> let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> queryItems </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#998418;--shiki-dark:#97E1F1"> URLComponents</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">url</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> url, </span><span style="color:#998418;--shiki-dark:#97E1F1">resolvingAgainstBaseURL</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> true</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#AB5959;--shiki-dark:#F286C4">?</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.queryItems </span><span style="color:#1E754F;--shiki-dark:#F286C4">else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> return</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // Parse file path parameters (Support multiple url parameters)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">    let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> urls </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> queryItems.</span><span style="color:#998418;--shiki-dark:#97E1F1">compactMap</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> item </span><span style="color:#AB5959;--shiki-dark:#F286C4">-&gt;</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> URL</span><span style="color:#AB5959;--shiki-dark:#F286C4">?</span><span style="color:#1E754F;--shiki-dark:#F286C4"> in</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        guard</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> item.name </span><span style="color:#AB5959;--shiki-dark:#F286C4">==</span><span style="color:#B5695977;--shiki-dark:#DEE492"> &quot;</span><span style="color:#B56959;--shiki-dark:#E7EE98">url</span><span style="color:#B5695977;--shiki-dark:#DEE492">&quot;</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#1E754F;--shiki-dark:#F286C4">let</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> path </span><span style="color:#AB5959;--shiki-dark:#F286C4">=</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> item.</span><span style="color:#998418;--shiki-dark:#BF9EEE">value</span><span style="color:#AB5959;--shiki-dark:#F286C4">?</span><span style="color:#393A34;--shiki-dark:#F6F6F4">.removingPercentEncoding </span><span style="color:#1E754F;--shiki-dark:#F286C4">else</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span><span style="color:#1E754F;--shiki-dark:#F286C4"> return</span><span style="color:#1E754F;--shiki-dark:#BF9EEE"> nil</span><span style="color:#999999;--shiki-dark:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">        return</span><span style="color:#998418;--shiki-dark:#97E1F1"> URL</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">fileURLWithPath</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> path</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">    // Parse compression options (level, format, etc.) and execute compression</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">    Common.</span><span style="color:#998418;--shiki-dark:#97E1F1">compress</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">urls</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> urls, </span><span style="color:#998418;--shiki-dark:#97E1F1">by</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> CompressedImages.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">shared</span><span style="color:#393A34;--shiki-dark:#F6F6F4">, </span><span style="color:#998418;--shiki-dark:#97E1F1">with</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#998418;--shiki-dark:#97E1F1"> parseOptions</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#998418;--shiki-dark:#97E1F1">from</span><span style="color:#999999;--shiki-dark:#F6F6F4">:</span><span style="color:#393A34;--shiki-dark:#F6F6F4"> queryItems</span><span style="color:#999999;--shiki-dark:#F6F6F4">))</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p><strong>Raycast Extension Practice</strong></p>
<p>Based on this URL Scheme, I developed <a href="https://www.raycast.com/okooo5km/images-compression" rel="noreferrer noopener">Zipic‚Äôs Raycast Extension</a>, which currently has 2000+ installs.</p>
<p>The user‚Äôs typical workflow became: Select image in Finder -&gt; Call up Raycast with shortcut -&gt; Type <code>compress</code> and hit Enter. If a global hotkey is set for the command, it can even be ‚ÄúSelect image -&gt; Hit shortcut -&gt; Compression done,‚Äù taking less than 1 second.</p>
<div class="code-header flex justify-between items-center h-9 px-4 text-xs font-medium font-sans rounded-t-lg bg-gray-100 text-gray-600 border-t border-l border-r border-gray-200 dark:bg-[#1e293b] dark:text-slate-400 dark:border-t dark:border-l dark:border-r dark:border-slate-700/50">
  <span class="select-none">TypeScript</span>
  <button class="copy-button group relative flex items-center justify-center py-1 px-2 rounded transition-colors duration-200 text-gray-400 hover:text-red-600 dark:hover:text-blue-400" aria-label="Copy code" onclick="window.copyCode(this, event)">
    <div class="code-copy-icon" style="opacity:1;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    </div>
    <div class="code-success-icon absolute inset-0 flex items-center justify-center text-green-600 dark:text-green-400" style="opacity:0;transition:opacity 0.2s">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
  </button>
</div>
<pre class="astro-code astro-code-themes vitesse-light dracula-soft" style="background-color:#ffffff;--shiki-dark-bg:#282A36;color:#393a34;--shiki-dark:#f6f6f4;overflow-x:auto" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">// Raycast Extension Core Logic (TypeScript)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">export</span><span style="color:#1E754F;--shiki-dark:#F286C4"> default</span><span style="color:#AB5959;--shiki-dark:#F286C4"> async</span><span style="color:#AB5959;--shiki-dark:#F286C4"> function</span><span style="color:#59873A;--shiki-dark:#62E884"> Command</span><span style="color:#999999;--shiki-dark:#F6F6F4">()</span><span style="color:#999999;--shiki-dark:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">  const</span><span style="color:#B07D48;--shiki-dark:#F6F6F4"> selectedItems</span><span style="color:#999999;--shiki-dark:#F286C4"> =</span><span style="color:#1E754F;--shiki-dark:#F286C4"> await</span><span style="color:#59873A;--shiki-dark:#62E884"> getSelectedFinderItems</span><span style="color:#999999;--shiki-dark:#F6F6F4">();</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">  const</span><span style="color:#B07D48;--shiki-dark:#F6F6F4"> paths</span><span style="color:#999999;--shiki-dark:#F286C4"> =</span><span style="color:#B07D48;--shiki-dark:#F6F6F4"> selectedItems</span><span style="color:#999999;--shiki-dark:#F6F6F4">.</span><span style="color:#59873A;--shiki-dark:#62E884">map</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#B07D48;font-style:inherit;--shiki-dark:#FFB86C;--shiki-dark-font-style:italic">item</span><span style="color:#999999;--shiki-dark:#F286C4"> =&gt;</span><span style="color:#B07D48;--shiki-dark:#F6F6F4"> item</span><span style="color:#999999;--shiki-dark:#F6F6F4">.</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">path</span><span style="color:#999999;--shiki-dark:#F6F6F4">);</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">  </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Build URL Scheme Call</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">  const</span><span style="color:#B07D48;--shiki-dark:#F6F6F4"> data</span><span style="color:#999999;--shiki-dark:#F286C4"> =</span><span style="color:#B07D48;--shiki-dark:#BF9EEE"> JSON</span><span style="color:#999999;--shiki-dark:#F6F6F4">.</span><span style="color:#59873A;--shiki-dark:#62E884">stringify</span><span style="color:#999999;--shiki-dark:#F6F6F4">({ </span><span style="color:#998418;--shiki-dark:#F6F6F4">urls</span><span style="color:#999999;--shiki-dark:#F286C4">:</span><span style="color:#B07D48;--shiki-dark:#F6F6F4"> paths</span><span style="color:#999999;--shiki-dark:#F6F6F4"> });</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#F286C4">  const</span><span style="color:#B07D48;--shiki-dark:#F6F6F4"> url</span><span style="color:#999999;--shiki-dark:#F286C4"> =</span><span style="color:#B5695977;--shiki-dark:#E7EE98"> `</span><span style="color:#B56959;--shiki-dark:#E7EE98">zipic://compress?data=</span><span style="color:#1E754F;--shiki-dark:#F286C4">${</span><span style="color:#59873A;--shiki-dark:#62E884">encodeURIComponent</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#B56959;--shiki-dark:#F6F6F4">data</span><span style="color:#999999;--shiki-dark:#F6F6F4">)</span><span style="color:#1E754F;--shiki-dark:#F286C4">}</span><span style="color:#B5695977;--shiki-dark:#E7EE98">`</span><span style="color:#999999;--shiki-dark:#F6F6F4">;</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#F6F6F4">  </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#F286C4">  await</span><span style="color:#59873A;--shiki-dark:#62E884"> open</span><span style="color:#999999;--shiki-dark:#F6F6F4">(</span><span style="color:#B07D48;--shiki-dark:#F6F6F4">url</span><span style="color:#999999;--shiki-dark:#F6F6F4">);</span><span style="color:#A0ADA0;--shiki-dark:#7B7F8B">  // Call Zipic</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#F6F6F4">}</span></span></code></pre>
<p>What the extension does is simple: Get the file paths selected in Finder, assemble them into a URL conforming to Zipic‚Äôs spec, and then <code>open</code>. The Zipic app receives the request, parses paths, executes compression, and sends a system notification upon completion.</p>
<p><strong>Pitfalls &amp; Experience</strong>:</p>
<ul>
<li><strong>Path Encoding</strong>: File paths may contain spaces, Chinese, or other special characters. You must perform Percent Encoding when assembling the URL, otherwise, the App side will error during parsing (Swift‚Äôs <code>URLComponents</code> helps, but the initiator must be standard).</li>
<li><strong>Security Validation</strong>: After receiving paths, the App must verify if the files exist, if they are supported image formats, and filter out special directories like <code>.app</code> or <code>.bundle</code> to prevent malicious invocation or accidental operation.</li>
</ul>
<p>Besides URL Scheme, Zipic also supports <strong>App Intents</strong> for macOS 13+, which can be called directly in ‚ÄúShortcuts‚Äù and might even be recognized by Apple Intelligence in the future. But URL Scheme currently has the advantages of good compatibility and simple integration, making it still the best choice for productivity tools like Raycast/Alfred.</p>
<h2 id="conclusion-and-outlook">Conclusion and Outlook</h2>
<p>Looking back at Zipic‚Äôs development process, from polishing UI details to optimizing low-level performance, every ‚Äúseemingly simple‚Äù feature has unknown technical trade-offs behind it.</p>
<p>I always believe that <strong>technology serves the product</strong>. Whether choosing native Swift development or obsessing over ImageIO memory optimization, the ultimate goal is to provide users with a smooth ‚Äúopen-use-leave‚Äù tool.</p>
<p>Zipic‚Äôs creation also relies on contributions from the open-source community. Sparkle solved automatic updates, Keygen solved licensing, and libwebp provided core compression capabilities. As a give-back, I have also organized and open-sourced the core folder monitoring solution mentioned in the text as the <a href="https://github.com/okooo5km/FSWatcher?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">FSWatcher</a> project, hoping to help developers with similar needs.</p>
<p>Finally, thank you to everyone who read this series of articles. If you are interested in native macOS development, or want to experience the actual effects of these technologies mentioned, feel free to visit the <a href="https://l.fatbobman.com/zipic" rel="noreferrer noopener">Zipic Website</a> to download a trial.</p>
<p>I hope this set of articles encourages more developers to try creating their own indie products on the macOS platform.</p>
<p>See you around!</p>
<footer class="mdx-author"><p class="mdx-author__title">About Author</p><p><strong><a href="https://x.com/okooo5km?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">Shili</a></strong> is the creator of apps like <a href="https://l.fatbobman.com/zipic" rel="noreferrer noopener">Zipic</a>, <a href="https://orchard.5km.tech/?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">Orchard</a>, <a href="https://hipixel.5km.tech/?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">HiPixel</a>, and <a href="https://apps.apple.com/app/id6448658165?utm_source=Fatbobman%20Blog&utm_medium=web" rel="noreferrer noopener">TimeGo Clock</a>. He enjoys building ‚Äúsmall and beautiful‚Äù products‚Äînot greedy for features, but striving for perfection in every detail. If you are also tinkering with indie products, feel free to chat!</p></footer> </div> </article> <aside aria-label="advertisement" role="complementary" id="card-advertisement"><div class="dynamic-ad-card"></div></aside> <!-- Ê†áÁ≠æÂÆπÂô®ÔºöÂ±Ö‰∏≠ --><div class="flex flex-wrap justify-center items-center gap-2 mb-10"> <span class="text-xs font-medium text-gray-400 uppercase tracking-widest mr-2">Tags</span> <a href="/en/tags/Dev-Diary/" class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary tracking-normal"> <span class="opacity-50">#</span>Dev Diary </a><a href="/en/tags/Guest-Post/" class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary tracking-normal"> <span class="opacity-50">#</span>Guest Post </a><a href="/en/tags/SwiftUI/" class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary tracking-normal"> <span class="opacity-50">#</span>SwiftUI </a> </div> <section class="py-10" id="related-posts"><!-- Section Ê†áÈ¢òÔºö‰∏éÊ≠£ÊñáÂå∫ÂàÜÔºåÂ¢ûÂä†Â±ÇÊ¨°ÊÑü --><div class="flex items-center gap-2 mb-6 justify-center text-gray-400 dark:text-gray-500"><span class="h-px w-8 bg-gray-200 dark:bg-gray-700"></span><span class="text-xs font-bold uppercase tracking-widest">Recommended Reading</span><span class="h-px w-8 bg-gray-200 dark:bg-gray-700"></span></div><!-- ÁΩëÊ†ºÂ∏ÉÂ±ÄÔºö2Âàó (ÁßªÂä®Á´Ø 1ÂàóÂ§™ÈïøÔºåÁõ¥Êé• 2ÂàóÊõ¥Á¥ßÂáë) --><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><a href="/en/posts/pari-programming-with-ai/" class="
                group relative flex flex-col justify-center px-5 py-4 h-full
                bg-white dark:bg-gray-900/50 
                border border-gray-200 dark:border-gray-700/60 rounded-xl
                hover:border-orange-400/50 dark:hover:border-blue-500/50
                hover:shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] dark:hover:shadow-none
                transition-all duration-300
              "><!-- Ë£ÖÈ•∞ÔºöÂ∑¶‰∏äËßíÁöÑÂ∞èÁÇπÊàñÂõæÊ†áÔºåÂ¢ûÂä†Á≤æËá¥ÊÑü --><div class="absolute top-4 left-3 w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600 group-hover:bg-orange-500 dark:group-hover:bg-blue-500 transition-colors"></div><div class="flex items-start justify-between gap-3 pl-2"><!-- Ê†áÈ¢ò --><span class="text-[15px] leading-relaxed font-medium text-gray-700 dark:text-gray-200 group-hover:text-black dark:group-hover:text-white transition-colors ">Pair Programming with AI</span><!-- ÁÆ≠Â§¥ÂõæÊ†áÔºöHover Êó∂Âπ≥ÁßªÂá∫Áé∞ --><svg class="w-4 h-4 text-gray-400 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></div></a><a href="/en/posts/ai-services-i-am-currently-using/" class="
                group relative flex flex-col justify-center px-5 py-4 h-full
                bg-white dark:bg-gray-900/50 
                border border-gray-200 dark:border-gray-700/60 rounded-xl
                hover:border-orange-400/50 dark:hover:border-blue-500/50
                hover:shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] dark:hover:shadow-none
                transition-all duration-300
              "><!-- Ë£ÖÈ•∞ÔºöÂ∑¶‰∏äËßíÁöÑÂ∞èÁÇπÊàñÂõæÊ†áÔºåÂ¢ûÂä†Á≤æËá¥ÊÑü --><div class="absolute top-4 left-3 w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600 group-hover:bg-orange-500 dark:group-hover:bg-blue-500 transition-colors"></div><div class="flex items-start justify-between gap-3 pl-2"><!-- Ê†áÈ¢ò --><span class="text-[15px] leading-relaxed font-medium text-gray-700 dark:text-gray-200 group-hover:text-black dark:group-hover:text-white transition-colors ">AI Services that I am Currently Using</span><!-- ÁÆ≠Â§¥ÂõæÊ†áÔºöHover Êó∂Âπ≥ÁßªÂá∫Áé∞ --><svg class="w-4 h-4 text-gray-400 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></div></a><a href="/en/posts/healthnotes2year/" class="
                group relative flex flex-col justify-center px-5 py-4 h-full
                bg-white dark:bg-gray-900/50 
                border border-gray-200 dark:border-gray-700/60 rounded-xl
                hover:border-orange-400/50 dark:hover:border-blue-500/50
                hover:shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] dark:hover:shadow-none
                transition-all duration-300
              "><!-- Ë£ÖÈ•∞ÔºöÂ∑¶‰∏äËßíÁöÑÂ∞èÁÇπÊàñÂõæÊ†áÔºåÂ¢ûÂä†Á≤æËá¥ÊÑü --><div class="absolute top-4 left-3 w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600 group-hover:bg-orange-500 dark:group-hover:bg-blue-500 transition-colors"></div><div class="flex items-start justify-between gap-3 pl-2"><!-- Ê†áÈ¢ò --><span class="text-[15px] leading-relaxed font-medium text-gray-700 dark:text-gray-200 group-hover:text-black dark:group-hover:text-white transition-colors ">Reflecting on Two Years of Using Health Notes and My Physical Condition in Recent Years</span><!-- ÁÆ≠Â§¥ÂõæÊ†áÔºöHover Êó∂Âπ≥ÁßªÂá∫Áé∞ --><svg class="w-4 h-4 text-gray-400 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></div></a><a href="/en/posts/blogupgrade/" class="
                group relative flex flex-col justify-center px-5 py-4 h-full
                bg-white dark:bg-gray-900/50 
                border border-gray-200 dark:border-gray-700/60 rounded-xl
                hover:border-orange-400/50 dark:hover:border-blue-500/50
                hover:shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] dark:hover:shadow-none
                transition-all duration-300
              "><!-- Ë£ÖÈ•∞ÔºöÂ∑¶‰∏äËßíÁöÑÂ∞èÁÇπÊàñÂõæÊ†áÔºåÂ¢ûÂä†Á≤æËá¥ÊÑü --><div class="absolute top-4 left-3 w-1 h-1 rounded-full bg-gray-300 dark:bg-gray-600 group-hover:bg-orange-500 dark:group-hover:bg-blue-500 transition-colors"></div><div class="flex items-start justify-between gap-3 pl-2"><!-- Ê†áÈ¢ò --><span class="text-[15px] leading-relaxed font-medium text-gray-700 dark:text-gray-200 group-hover:text-black dark:group-hover:text-white transition-colors ">Blog Update Journal</span><!-- ÁÆ≠Â§¥ÂõæÊ†áÔºöHover Êó∂Âπ≥ÁßªÂá∫Áé∞ --><svg class="w-4 h-4 text-gray-400 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 shrink-0 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></div></a></div></section> <!-- <BuymeacoffeeInPost lang={lang} /> --> <!-- <WeeklySubscribe lang={lang} bottom={0} top={8} anchor='related-posts'/> --> <!-- <Author lang={lang} /> --> <!-- Êï¥ÂêàÂ∫ïÂ∫ßÂÆπÂô® --><div class="mt-16 mb-28 bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700/60 rounded-2xl p-6 sm:p-8"> <div class="flex flex-col lg:flex-row items-center justify-between gap-8 lg:gap-12"> <!-- Â∑¶‰æßÔºöËÆ¢ÈòÖÂå∫Âüü --> <!-- ÈÄÇÈÖçÈÄªËæëÔºöÁßªÂä®Á´Ø/Âπ≥ÊùøÂ±Ö‰∏≠(text-center)ÔºåÊ°åÈù¢Á´ØÂ±ÖÂ∑¶(lg:text-left) --> <div class="flex-1 w-full text-center lg:text-left flex flex-col items-center lg:items-start"> <h3 class="font-bold text-xl text-gray-900 dark:text-gray-100 mb-2"> Subscribe to Fatbobman </h3> <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 max-w-md"> Weekly Swift &amp; SwiftUI highlights. Join developers. </p> <!-- ËÆ¢ÈòÖÊåâÈíÆÔºö‰ΩøÁî®ÈîöÁÇπÈìæÊé•Ëß¶Âèë Modal --> <a href="#subscript" id="subscribe-bottom-btn" class="
          bg-black dark:bg-white text-white dark:text-black
          font-bold text-sm px-8 py-3 rounded-xl
          hover:opacity-80 hover:scale-105 active:scale-95
          transition-all duration-200 shadow-sm
          w-full sm:w-auto inline-block text-center
        "> Subscribe Now </a> </div> <!-- Âè≥‰æßÔºöÂäüËÉΩÊåâÈíÆÁªÑ --> <!-- ÈÄÇÈÖçÈÄªËæëÔºöÁßªÂä®Á´ØÂ†ÜÂè†(grid-cols-1)ÔºåÂπ≥Êùø‰ª•‰∏äÂπ∂Êéí(sm:grid-cols-2) --> <!-- w-full lg:w-auto ‰øùËØÅÁßªÂä®Á´ØÊíëÊª°ÔºåÊ°åÈù¢Á´ØÁ¥ßÂáë --> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full lg:w-auto min-w-[320px]"> <!-- ÂíñÂï°ÊåâÈíÆ --> <a href="https://www.buymeacoffee.com/fatbobman" target="_blank" rel="noopener" class="group flex items-center justify-center lg:justify-start gap-3 px-5 py-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-sm hover:shadow-md hover:border-orange-200 dark:hover:border-orange-900 transition-all"> <span class="text-2xl group-hover:scale-110 transition-transform">‚òïÔ∏è</span> <div class="text-left"> <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Support</div> <div class="text-sm font-bold text-gray-800 dark:text-gray-100">Buy me a Coffee</div> </div> </a> <!-- Discord ÊåâÈíÆ --> <a href="https://x.com/intent/follow?screen_name=fatbobman" target="_blank" rel="noopener" class="group flex items-center justify-center lg:justify-start gap-3 px-5 py-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-sm hover:shadow-md hover:border-blue-200 dark:hover:border-blue-900 transition-all"> <span class="text-2xl group-hover:scale-110 transition-transform">üí¨</span> <div class="text-left"> <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">CONNECT</div> <div class="text-sm font-bold text-gray-800 dark:text-gray-100">Follow on X</div> </div> </a> </div> </div> </div> <script>(function(){const lang = "en";

  // Track newsletter subscription button click via GTM dataLayer
  document.addEventListener('DOMContentLoaded', () => {
    const subscribeBtn = document.getElementById('subscribe-bottom-btn');
    if (!subscribeBtn) return;

    subscribeBtn.addEventListener('click', () => {
      // Initialize dataLayer if not exists
      window.dataLayer = window.dataLayer || [];

      // Push event to dataLayer for GTM
      window.dataLayer.push({
        event: 'subscribe_click',
        content_type: 'newsletter_subscribe',
        click_location: 'bottom',
        lang: lang
      });

      console.log('[Subscribe Tracking] Bottom subscribe button clicked (dataLayer)');
    }, { capture: true });  // ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµÔºåÁ°Æ‰øùÂú®ÂÖ∂‰ªñÁõëÂê¨Âô®‰πãÂâçÊâßË°å
  });
})();</script> <!-- 
  ÊèêÁ§∫Ê°ÜÂÆπÂô® (Toast Container)
  z-index: Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç
--><div id="copy-alert" class="hidden fixed bottom-10 right-5 z-50"> <div id="alert-1" class="
      flex items-center px-6 py-3 rounded-full shadow-lg border backdrop-blur-md
      transition-all duration-300 transform
      
      /* === Light Mode (Red Theme) === */
      /* ÁôΩÂ∫ï + Á∫¢Ëâ≤ÊñáÂ≠ó + Á∫¢Ëâ≤ËæπÊ°ÜÔºåÈò¥ÂΩ±Â∏¶Á∫¢ */
      bg-white/95 text-red-600 border-red-100 shadow-red-500/10
      
      /* === Dark Mode (Blue Theme) === */
      /* Ê∑±ËìùÂ∫ï + ËìùËâ≤ÊñáÂ≠ó + ËìùËâ≤ËæπÊ°ÜÔºåÈò¥ÂΩ±Â∏¶Ëìù */
      dark:bg-slate-800/90 dark:text-blue-400 dark:border-blue-500/30 dark:shadow-blue-500/20
    " role="alert"> <!-- ÂõæÊ†á (ÂèØÈÄâÔºåÂ¢ûÂä†Á≤æËá¥ÊÑü) --> <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path> <polyline points="22 4 12 14.01 9 11.01"></polyline> </svg> <div class="text-sm font-bold tracking-wide">Link copied</div> </div> </div> <style>
  /* ‰øùÊåÅÂéüÊúâÁöÑÂõæÊ†áÂÆö‰ΩçÈÄªËæë */
  .copy-icon {
    position: absolute;
    left: -30px; 
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    transition: opacity 0.3s ease;
    pointer-events: all;
    /* ÁªôÂõæÊ†áÂä†‰∏ÄÁÇπÈ¢úËâ≤ËøáÊ∏° */
    color: #9ca3af; /* gray-400 */
  }
  
  /* Hover Êó∂ÂõæÊ†áÂèòËâ≤ (JSÈáåÊ∑ªÂä†‰∫Ü hover:text-secondary Á±ªÔºåËøôÈáå‰Ωú‰∏∫ÂÖúÂ∫ï) */
  .copy-icon:hover {
    color: var(--aw-color-primary); /* ‰ΩøÁî® CSS ÂèòÈáèÂìçÂ∫î‰∏ªÈ¢ò */
  }

  article h2,
  article h3,
  article h4,
  article h5 {
    position: relative;
  }

  /* ÊèêÁ§∫Ê°ÜÂä®Áîª */
  #copy-alert {
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* ÂºπÊÄßÂä®Áîª */
    transform: translateY(100px);
    opacity: 0;
  }
  
  #copy-alert.show {
    transform: translateY(0);
    opacity: 1;
  }
</style> <script>(function(){const lang = "en";

  const isTouchDevice = () => {
    if (typeof window === 'undefined') return false;
    return (
      'ontouchstart' in window ||
      (navigator && navigator.maxTouchPoints > 0) ||
      window.matchMedia('(pointer: coarse)').matches
    );
  };

  // ‰ΩøÁî® defer Êàñ load ‰∫ã‰ª∂Á°Æ‰øù DOM Â∞±Áª™
  document.addEventListener('DOMContentLoaded', () => {
    if (isTouchDevice()) {
      // Ëß¶Êë∏ËÆæÂ§á‰∏çÂêØÁî®Â§çÂà∂ÂäüËÉΩÔºåÈÅøÂÖç‰∏éÁÇπÂáªË°å‰∏∫ÂÜ≤Á™Å
      return;
    }

    let hideTimeout;
    const alertDiv = document.getElementById('copy-alert');

    // ÁªëÂÆöÊ†áÈ¢òÂõæÊ†á
    document.querySelectorAll('article h2, article h3, article h4, article h5').forEach((header) => {
      // ÂàõÂª∫ÂõæÊ†áÂÆπÂô®
      const copyIcon = document.createElement('span');
      // ‰ΩøÁî®Êõ¥ÁÆÄÊ¥ÅÁöÑ Link ÂõæÊ†á SVG
      copyIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 hidden md:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>`;
      copyIcon.className = 'copy-icon';
      copyIcon.style.opacity = '0';
      
      header.insertBefore(copyIcon, header.firstChild);

      // ÊÇ¨ÂÅúÊòæÁ§∫ÈÄªËæë
      header.addEventListener('mouseover', () => copyIcon.style.opacity = '1');
      header.addEventListener('mouseout', () => copyIcon.style.opacity = '0');

      // ÁÇπÂáªÂ§çÂà∂ÈÄªËæë
      copyIcon.addEventListener('click', () => {
        const url = window.location.href.split('#')[0] + '#' + header.id;
        
        navigator.clipboard.writeText(url).then(() => {
          if (alertDiv) {
            // ÊòæÁ§∫Âä®Áîª
            alertDiv.classList.remove('hidden');
            // Âº∫Âà∂ÈáçÁªò‰ª•Ëß¶Âèë transition
            void alertDiv.offsetWidth; 
            alertDiv.classList.add('show');

            // Ê∏ÖÈô§ÊóßÂÆöÊó∂Âô®
            if (hideTimeout) clearTimeout(hideTimeout);

            // 3ÁßíÂêéÈöêËóè
            hideTimeout = setTimeout(() => {
              alertDiv.classList.remove('show');
              // Á≠âÂæÖÂä®ÁîªÁªìÊùüÂêéÂÜç hidden
              setTimeout(() => {
                alertDiv.classList.add('hidden');
              }, 500);
            }, 3000);
          }
        });
      });
    });
  });
})();</script> <script>
  window.copyCode = function(button, event) {
    if (event) event.preventDefault();

    // header ÊòØÊåâÈíÆÁöÑÁà∂Á∫ß div.code-header
    const header = button.closest('.code-header');
    if (!header) return;

    // ‰ª£Á†ÅÂùóÊòØ header ÁöÑ‰∏ã‰∏Ä‰∏™ÂÖÑÂºüÂÖÉÁ¥† (pre ÊàñÂåÖÂê´ pre ÁöÑÂÖÉÁ¥†)
    let nextEl = header.nextElementSibling;
    if (!nextEl) return;

    // ÊâæÂà∞ pre ÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÁõ¥Êé•ÁöÑ preÔºåÊàñËÄÖÂú® figure/div ÂÜÖÔºâ
    const pre = nextEl.tagName === 'PRE' ? nextEl : nextEl.querySelector('pre');
    const codeEl = pre?.querySelector('code') ?? pre;
    if (!codeEl) return;

    const code = codeEl.textContent ?? '';

    // ÂõæÊ†áÂàáÊç¢ÔºöÁõ¥Êé•Êìç‰Ωú style.opacity Êõ¥ÂèØÈù†
    function showSuccessFeedback() {
      const copyIcon = button.querySelector('.code-copy-icon');
      const successIcon = button.querySelector('.code-success-icon');

      if (copyIcon && successIcon) {
        // ÈöêËóèÂ§çÂà∂ÂõæÊ†áÔºåÊòæÁ§∫ÊàêÂäüÂõæÊ†á
        copyIcon.style.opacity = '0';
        successIcon.style.opacity = '1';

        // 2ÁßíÂêéÊÅ¢Â§ç
        setTimeout(() => {
          copyIcon.style.opacity = '1';
          successIcon.style.opacity = '0';
        }, 2000);
      }
    }

    const handleFailure = (err) => {
      console.error('Copy Failed', err);
      fallbackCopyTextToClipboard(code);
    };

    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(code).then(showSuccessFeedback).catch(handleFailure);
    } else {
      fallbackCopyTextToClipboard(code);
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showSuccessFeedback();
        } else {
          console.error('Fallback Copy Failed: execCommand returned false');
        }
      } catch (err) {
        console.error('Fallback Copy Failed', err);
      }
      document.body.removeChild(textArea);
    }
  }
</script> <script>(function(){const baseUrl = "https://fatbobman.com/ads/";
const langSuffix = "en";
const utmTerm = "en/zipic-3-technical-details";

  // ========================================
  // Configuration & Constants
  // ========================================

  const CACHE_DURATION = 20 * 60 * 1000; // 20 minutes
  const STALE_THRESHOLD = 24 * 60 * 60 * 1000; // 24 hours - when to force UI refresh

  // ËØªÂèñ URL ÂèÇÊï∞Áî®‰∫éÊµãËØïÂíåÈ¢ÑËßà
  const urlParams = new URLSearchParams(window.location.search);
  const adIdParam = urlParams.get('adid') || urlParams.get('adId');
  const sponsorIdParam = urlParams.get('sponsorId');
  const scheduleIdParam = urlParams.get('scheduleId');
  const forceUpdateParam = urlParams.get('adForceUpdate') === 'true';

  const isPreviewMode = !!(adIdParam || sponsorIdParam || scheduleIdParam);
  const effectiveCacheDuration = isPreviewMode ? 60 * 1000 : CACHE_DURATION;

  // Store current ad metadata for click tracking
  const currentAdMetadata = {
    version1: null,  // .dynamic-ad-card metadata
    version2: null   // .dynamic-ad-inline metadata
  };

  // ========================================
  // Cache Management Functions
  // ========================================

  /**
   * Load ad from cache with SWR metadata
   * @param {string} cacheKey - Cache key
   * @returns {Object|null} - Cached ad data with metadata or null
   */
  function loadFromCache(cacheKey) {
    try {
      const cachedData = localStorage.getItem(cacheKey);
      if (!cachedData) return null;

      const cached = JSON.parse(cachedData);

      // Backward compatibility: handle old cache format
      if (cached.content && !cached.metadata) {
        console.log(`[AdsLoader SWR] Old cache format detected for ${cacheKey}, will update`);
        return null; // Force refresh to get new format
      }

      return cached;
    } catch (e) {
      console.warn(`[AdsLoader SWR] Failed to parse cached ad: ${cacheKey}`, e);
      localStorage.removeItem(cacheKey);
      return null;
    }
  }

  /**
   * Save ad to cache with metadata
   * @param {string} cacheKey - Cache key
   * @param {string} content - Ad HTML content
   * @param {Object} metadata - Ad metadata from response headers
   */
  function saveToCache(cacheKey, content, metadata) {
    try {
      const cacheData = {
        content: content,
        metadata: {
          ...metadata,
          fetchedAt: Date.now()
        }
      };

      localStorage.setItem(cacheKey, JSON.stringify(cacheData));
      const cacheMinutes = Math.round(effectiveCacheDuration / 60000);
      console.log(`[AdsLoader SWR] Saved to cache: ${cacheKey} (${cacheMinutes} min)`, metadata);
    } catch (e) {
      console.warn(`[AdsLoader SWR] Failed to save cache: ${cacheKey}`, e);
    }
  }

  /**
   * Extract metadata from response headers
   * @param {Response} response - Fetch response object
   * @returns {Object} - Metadata object
   */
  function extractMetadata(response) {
    return {
      sponsorId: response.headers.get('X-Sponsor-Id') || 'unknown',
      adId: response.headers.get('X-Ad-Id') || 'unknown',
      version: parseInt(response.headers.get('X-Ad-Version') || '1'),
      lang: response.headers.get('X-Ad-Lang') || langSuffix,
      lastUpdated: response.headers.get('Last-Modified') || new Date().toISOString(),
      forceUpdate: response.headers.get('X-Force-Update') === 'true',
      campaign: response.headers.get('X-UTM-Campaign') || null // Optional UTM campaign
    };
  }

  // ========================================
  // Smart Refresh Logic
  // ========================================

  /**
   * Check if two timestamps are on the same UTC calendar day
   * @param {number} timestamp1 - First timestamp (milliseconds)
   * @param {number} timestamp2 - Second timestamp (milliseconds)
   * @returns {boolean} - True if same UTC day
   */
  function isSameUTCDay(timestamp1, timestamp2) {
    const d1 = new Date(timestamp1);
    const d2 = new Date(timestamp2);
    return d1.getUTCFullYear() === d2.getUTCFullYear() &&
           d1.getUTCMonth() === d2.getUTCMonth() &&
           d1.getUTCDate() === d2.getUTCDate();
  }

  /**
   * Decide if UI should be refreshed based on cache age and ad changes
   * @param {Object|null} cached - Cached ad data with metadata
   * @param {Object} newMetadata - New ad metadata from server
   * @returns {boolean} - True if UI should be refreshed
   */
  function shouldRefreshUI(cached, newMetadata) {
    // Rule 1: No cache -> always render (first load)
    if (!cached || !cached.metadata) {
      console.log('[AdsLoader SWR] No cache, will render immediately');
      return true;
    }

    // Rule 2: Force update parameter -> always refresh
    if (forceUpdateParam || newMetadata.forceUpdate) {
      console.log('[AdsLoader SWR] Force update detected, will refresh UI');
      return true;
    }

    const cachedMeta = cached.metadata;
    const cacheAge = Date.now() - cachedMeta.fetchedAt;

    // Rule 3: Sponsor changed -> always refresh (different advertiser)
    if (cachedMeta.sponsorId !== newMetadata.sponsorId) {
      console.log(`[AdsLoader SWR] Sponsor changed: ${cachedMeta.sponsorId} ‚Üí ${newMetadata.sponsorId}, will refresh UI`);
      return true;
    }

    // Rule 4: UTC date changed -> always refresh (ad schedule switches by calendar day)
    if (!isSameUTCDay(cachedMeta.fetchedAt, Date.now())) {
      const cachedDate = new Date(cachedMeta.fetchedAt).toISOString().split('T')[0];
      const currentDate = new Date().toISOString().split('T')[0];
      console.log(`[AdsLoader SWR] UTC date changed: ${cachedDate} ‚Üí ${currentDate}, will refresh UI`);
      return true;
    }

    // Rule 5: Cache older than 24 hours -> always refresh
    if (cacheAge > STALE_THRESHOLD) {
      console.log(`[AdsLoader SWR] Cache very old (${Math.round(cacheAge / 3600000)}h), will refresh UI`);
      return true;
    }

    // Rule 6: Ad ID changed (same sponsor, different version) -> refresh if old, else silent update
    if (cachedMeta.adId !== newMetadata.adId) {
      console.log(`[AdsLoader SWR] Ad changed but cache fresh (${Math.round(cacheAge / 60000)}min), will update silently`);
      return false; // Silent update
    }

    // Rule 7: Default - silent update
    console.log(`[AdsLoader SWR] Cache fresh (${Math.round(cacheAge / 60000)}min old), will update silently`);
    return false;
  }

  // ========================================
  // UTM Parameters Injection
  // ========================================

  /**
   * Inject UTM parameters to all links in ad HTML
   * Only applies to non-default ads (sponsored ads)
   * @param {string} html - Ad HTML content
   * @param {Object} metadata - Ad metadata (sponsorId, campaign, version, etc.)
   * @returns {string} - Modified HTML with UTM parameters
   */
  function injectUTMParameters(html, metadata) {
    // Skip UTM injection for default ads
    if (metadata.sponsorId === 'default') {
      return html;
    }

    // Create temporary container to parse HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;

    // Find all links
    const links = tempDiv.querySelectorAll('a[href]');

    if (links.length === 0) {
      return html; // No links found, return original HTML
    }

    // Build UTM parameters
    const utmParams = {
      utm_source: 'fatbobman',
      utm_medium: 'blog',
      utm_content: metadata.version === 2 ? 'post-header' : 'post-footer'
    };

    // Add campaign if available
    if (metadata.campaign) {
      utmParams.utm_campaign = metadata.campaign;
    }

    // Add term if available
    if (utmTerm) {
      utmParams.utm_term = utmTerm;
    }

    // Inject UTM parameters to each link
    links.forEach(link => {
      try {
        const url = new URL(link.href);

        // Add each UTM parameter
        Object.entries(utmParams).forEach(([key, value]) => {
          url.searchParams.set(key, value);
        });

        link.href = url.toString();
      } catch (e) {
        // Invalid URL, skip
        console.warn('[AdsLoader SWR] Skipping invalid URL:', link.href, e);
      }
    });

    console.log('[AdsLoader SWR] Injected UTM parameters:', utmParams, `(${links.length} link(s))`);
    return tempDiv.innerHTML;
  }

  // ========================================
  // GA4 Click Tracking
  // ========================================

  /**
   * Track ad click in Google Analytics 4 via GTM dataLayer
   * @param {string} destinationUrl - Click destination URL
   * @param {Object} metadata - Ad metadata
   */
  function trackAdClick(destinationUrl, metadata) {
    // Initialize dataLayer if not exists (works with both regular GTM and Partytown)
    window.dataLayer = window.dataLayer || [];

    // Build event data based on ad type
    const eventData = {
      event: 'ad_click',
      destination_url: destinationUrl
    };

    if (metadata.sponsorId === 'default') {
      // Default ad: simple tracking with position only
      eventData.content_type = 'default_ad';
      eventData.ad_position = metadata.version === 2 ? 'post-header' : 'post-footer';
    } else {
      // Sponsored ad: detailed tracking
      eventData.content_type = 'sponsored_ad';
      eventData.ad_position = metadata.version === 2 ? 'post-header' : 'post-footer';
      eventData.sponsor_id = metadata.sponsorId;
      eventData.ad_id = metadata.adId;
      eventData.ad_version = metadata.version;
      eventData.ad_lang = metadata.lang;
    }

    // Push event to dataLayer for GTM
    window.dataLayer.push(eventData);
    console.log('[AdsLoader SWR] Ad click tracked (dataLayer):', eventData);
  }

  /**
   * Attach click tracking to ad links (reads metadata dynamically from currentAdMetadata)
   * @param {string} containerSelector - Container selector
   * @param {string} version - 'version1' or 'version2' key in currentAdMetadata
   */
  function attachClickTracking(containerSelector, version) {
    const containers = document.querySelectorAll(containerSelector);
    if (containers.length === 0) return;

    containers.forEach(container => {
      // Use event delegation to handle dynamically loaded ads
      container.addEventListener('click', (event) => {
        // Find the clicked link (or parent link)
        const link = event.target.closest('a[href]');
        if (!link) return;

        // Get current metadata dynamically (always up-to-date)
        const metadata = currentAdMetadata[version];
        if (!metadata) {
          console.warn(`[AdsLoader SWR] No metadata available for ${version}, skipping tracking`);
          return;
        }

        // Track the click
        trackAdClick(link.href, metadata);
      }, { capture: false, passive: true });
    });

    console.log(`[AdsLoader SWR] Click tracking attached to ${containers.length} container(s): ${containerSelector}`);
  }

  // ========================================
  // Ad Loading & Rendering
  // ========================================

  /**
   * Render ad to containers
   * @param {string} html - Ad HTML content
   * @param {string} containerSelector - Container selector
   * @param {Object} metadata - Ad metadata for tracking
   * @param {string} reason - Reason for rendering (for logging)
   */
  function renderAd(html, containerSelector, metadata, reason = 'unknown') {
    const containers = document.querySelectorAll(containerSelector);
    if (containers.length === 0) {
      console.warn(`[AdsLoader SWR] No containers found: ${containerSelector}`);
      return;
    }

    containers.forEach(container => {
      container.innerHTML = html;
    });

    // Store metadata for this version
    if (containerSelector === '.dynamic-ad-card') {
      currentAdMetadata.version1 = metadata;
    } else if (containerSelector === '.dynamic-ad-inline') {
      currentAdMetadata.version2 = metadata;
    }

    console.log(`[AdsLoader SWR] Rendered ad to ${containers.length} container(s): ${containerSelector} (${reason})`);
  }

  /**
   * Fetch ad from server
   * @param {number} version - Ad version (1 or 2)
   * @param {string} cacheKey - Cache key
   * @param {string} containerSelector - Container selector
   * @param {Object|null} cached - Cached ad data (if any)
   */
  async function fetchAd(version, cacheKey, containerSelector, cached) {
    // Build URL with parameters
    const params = new URLSearchParams({
      lang: langSuffix,
      version: version.toString()
    });

    // Add test/preview parameters
    if (adIdParam) params.append('adId', adIdParam);
    if (sponsorIdParam) params.append('sponsorId', sponsorIdParam);
    if (scheduleIdParam) params.append('scheduleId', scheduleIdParam);
    if (forceUpdateParam) params.append('adForceUpdate', 'true');

    const url = `${baseUrl}?${params.toString()}`;
    const previewTag = isPreviewMode ? ' [PREVIEW MODE]' : '';
    console.log(`[AdsLoader SWR] Fetching ad: ${url}${previewTag}`);

    try {
      const response = await fetch(url, {
        headers: { 'Accept': 'text/html' },
        cache: 'no-cache'
      });

      // Validate HTTP status
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      // Validate required metadata headers
      const sponsorId = response.headers.get('X-Sponsor-Id');
      const adId = response.headers.get('X-Ad-Id');

      if (!sponsorId || !adId || sponsorId === 'null' || adId === 'null') {
        console.warn('[AdsLoader SWR] Invalid response: missing or null metadata headers');
        throw new Error('Invalid ad response: missing metadata headers');
      }

      const content = await response.text();
      const metadata = extractMetadata(response);

      // Inject UTM parameters for sponsored ads
      const processedContent = injectUTMParameters(content, metadata);

      console.log('[AdsLoader SWR] Server response metadata:', metadata);

      // Decide if UI should be refreshed
      const shouldRefresh = shouldRefreshUI(cached, metadata);

      // Always update cache (with UTM-enhanced content)
      saveToCache(cacheKey, processedContent, metadata);

      // Conditionally refresh UI (with UTM-enhanced content)
      if (shouldRefresh) {
        renderAd(processedContent, containerSelector, metadata, shouldRefresh === true && !cached ? 'initial load' : 'smart refresh');
      } else {
        console.log(`[AdsLoader SWR] UI kept as-is, updated cache for next visit`);
      }

    } catch (error) {
      console.error(`[AdsLoader SWR] Error loading ad (version ${version}):`, error);

      // Smart fallback strategy based on cached ad type
      if (cached && cached.metadata) {
        if (cached.metadata.sponsorId === 'default') {
          // Default ad: keep displaying cached content (own content, safe to show when stale)
          console.log('[AdsLoader SWR] Fetch failed, keeping default ad cache');
          // UI already shows cached content, no action needed
        } else {
          // Sponsored ad: clear display (avoid showing expired paid ads)
          console.log('[AdsLoader SWR] Fetch failed, clearing sponsored ad to avoid showing stale content');
          const emptyMetadata = { sponsorId: 'error', version: version };
          renderAd('', containerSelector, emptyMetadata, 'error-clear');
        }
      } else {
        // No cache: leave blank
        console.log('[AdsLoader SWR] Fetch failed with no cache, leaving blank');
      }
    }
  }

  /**
   * Load ad with SWR strategy
   * @param {number} version - Ad version
   * @param {string} cacheKey - Cache key
   * @param {string} containerSelector - Container selector
   */
  function loadAd(version, cacheKey, containerSelector) {
    // Check if containers exist
    const containers = document.querySelectorAll(containerSelector);
    if (containers.length === 0) {
      console.log(`[AdsLoader SWR] No containers found for ${containerSelector}, skipping version ${version}`);
      return;
    }

    // Step 1: Load from cache if available
    const cached = loadFromCache(cacheKey);
    if (cached && cached.content) {
      console.log(`[AdsLoader SWR] Displaying cached ad: ${cacheKey}`, cached.metadata);
      // Inject UTM parameters to cached content (in case it's from old cache without UTM)
      const processedCachedContent = injectUTMParameters(cached.content, cached.metadata);
      renderAd(processedCachedContent, containerSelector, cached.metadata, 'from cache');
    } else {
      console.log(`[AdsLoader SWR] No cache available for ${cacheKey}, will show blank until loaded`);
    }

    // Step 2: Fetch from server in background
    fetchAd(version, cacheKey, containerSelector, cached);
  }

  // ========================================
  // Initialization
  // ========================================

  function initAds() {
    console.log('[AdsLoader SWR] Initializing ad loading with Stale-While-Revalidate strategy...');
    console.log(`[AdsLoader SWR] Config: cacheDuration=${effectiveCacheDuration/60000}min, staleThreshold=${STALE_THRESHOLD/3600000}h`);

    if (isPreviewMode) {
      const params = [];
      if (adIdParam) params.push(`adId=${adIdParam}`);
      if (sponsorIdParam) params.push(`sponsorId=${sponsorIdParam}`);
      if (scheduleIdParam) params.push(`scheduleId=${scheduleIdParam}`);
      console.log(`[AdsLoader SWR] üîç PREVIEW MODE: ${params.join(', ')}`);
    }

    if (forceUpdateParam) {
      console.log('[AdsLoader SWR] üîÑ FORCE UPDATE MODE: UI will always refresh');
    }

    // Generate cache keys (include test params to avoid conflicts)
    const cacheKeySuffix = langSuffix + (adIdParam || sponsorIdParam || scheduleIdParam || '');
    const cacheKeyCard = 'dynamicAdCardSWR-' + cacheKeySuffix;
    const cacheKeyInline = 'dynamicAdInlineSWR-' + cacheKeySuffix;

    // Load both ad versions
    loadAd(1, cacheKeyCard, '.dynamic-ad-card');
    loadAd(2, cacheKeyInline, '.dynamic-ad-inline');

    // Attach click tracking event listeners (after ads are loaded)
    // These will dynamically read metadata from currentAdMetadata
    attachClickTracking('.dynamic-ad-card', 'version1');
    attachClickTracking('.dynamic-ad-inline', 'version2');
  }

  // Start loading when page is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAds);
  } else {
    initAds();
  }
})();</script> <script type="module">var c=document.querySelectorAll("article");c.forEach(function(r){var a=r.querySelectorAll("a");a.forEach(function(e){var t=e.getAttribute("href");t&&t.startsWith("http")&&!t.includes("fatbobman.com")&&!t.includes("fatbobman.github.com")&&!t.includes("localhost")&&e.setAttribute("target","_blank")})});</script> <!-- <LeaveFeedback lang={lang} /> --> <!-- <BottomWeeklySubscribe lang={lang} /> --> <div id="gitalk-container" data-comment-id="Zipic ‰ªé 0 Âà∞ 1 ÁöÑ‰∫ßÂìÅÂåñ‰πãË∑Ø" data-lang="en" data-repo="blogComments" data-createIssueManually="true" data-anchor="card-advertisement" class="pb-16"></div>

    <script defer>
      document.addEventListener('DOMContentLoaded', async function () {
      const container = document.getElementById('gitalk-container');
      let anchor = '';
      if (container) {
        anchor = container.getAttribute('data-anchor') || '';
      }
        // ÊèêÂâçÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂä†ËΩΩËØÑËÆ∫
        try {
          const response = await fetch('https://fatbobman.com/status/comment');
          const data = await response.text();
          console.log(data, "comment");

          if (data !== '1') {
            console.log('ËØÑËÆ∫ÂäüËÉΩÊú™ÂêØÁî®ÔºåË∑≥ËøáÁõëÊéßÂíåÂä†ËΩΩÊìç‰Ωú„ÄÇ');
            return; // ÊèêÂâçËøîÂõûÔºåË∑≥ËøáÂêéÁª≠ÈÄªËæë
          }
        } catch (error) {
          console.error('Ê£ÄÊü•ËØÑËÆ∫Áä∂ÊÄÅÊó∂Âá∫ÈîôÔºö', error);
          return; // Âá∫Áé∞ÈîôËØØÊó∂‰πüË∑≥ËøáÂêéÁª≠ÈÄªËæë
        }

        // Â¶ÇÊûúËøîÂõûÂÄº‰∏∫ "1"ÔºåÂàôÂêØÂä®ËßÇÂØüÂô®
        const observerTarget = document.getElementById(anchor);
        if (observerTarget) {
          const observer = new IntersectionObserver(async (entries, observer) => {
            const entry = entries[0];
            if (entry.isIntersecting) {
              console.log("load comment")
              // ÂÅúÊ≠¢ËßÇÂØüÔºåÈÅøÂÖçÈáçÂ§çËß¶Âèë
              observer.unobserve(observerTarget);

              // Âä®ÊÄÅÂä†ËΩΩËØÑËÆ∫Âå∫ËÑöÊú¨
              await loadGitalk();
            }
          }, {
            root: null, // Áõ∏ÂØπ‰∫éËßÜÂè£
            rootMargin: '20%', // ÊèêÂâç 20% ÁöÑ‰ΩçÁΩÆËß¶Âèë
            threshold: 0.1, // ÂÖÉÁ¥†ÊòæÁ§∫ 10% Âç≥Ëß¶Âèë
          });

          observer.observe(observerTarget);
        }

        // Âä®ÊÄÅÂä†ËΩΩ Gitalk ËÑöÊú¨Âπ∂ÂàùÂßãÂåñËØÑËÆ∫Âå∫
        async function loadGitalk() {
          const container = document.getElementById('gitalk-container');
          if (container) {
            const commentID = container.getAttribute('data-comment-id');
            const lang = container.getAttribute('data-lang');
            const repo = container.getAttribute('data-repo')
            const createIssueManually = container.getAttribute('data-createIssueManually')

            console.log(repo);
            console.log(createIssueManually)

            // Âä®ÊÄÅÂä†ËΩΩ Gitalk ËÑöÊú¨
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js';
            script.defer = true;
            script.onload = () => {
              const gitalk = new Gitalk({
                clientID: 'fcf61195c7f73253dc8b',
                clientSecret: '0ac2907be08248a1fcb5312e27480ad535c682e5',
                repo: repo,
                owner: 'fatbobman',
                admin: ['fatbobman'],
                id: commentID.split('/').pop().substring(0, 49),
                distractionFreeMode: true,
                createIssueManually: createIssueManually,
                language: lang,
              });

              gitalk.render('gitalk-container');
            };
            document.body.appendChild(script);
          }
        }
      });
    </script> <!-- 
  Â∑¶‰æßÊÇ¨ÊµÆÂÆπÂô® 
  Âª∫ËÆÆÔºöËøôÈáå top: 0px ÈÖçÂêàÂÜÖÈÉ® padding Â∫îËØ•ËÉΩÂíåÂè≥‰æßÂØπÈΩê„ÄÇ
  Â¶ÇÊûúÂè≥‰æß Sidebar È°∂ÈÉ®Êúâ paddingÔºåËøôÈáå‰πü‰øùÊåÅ‰∏ÄËá¥„ÄÇ
--><div class="hidden lg:block w-32 xl:w-44 lg:absolute" id="toc" style="left: -30px; top: 0px"> <div class="text-muted items-center justify-center opacity-0 transition-all duration-1000 delay-300 ease-out" id="toc-content"> <!-- ÊåâÈíÆÂÆπÂô® --> <!-- id="toc-float-button" ‰æõ JS ÂÆö‰Ωç‰ΩøÁî® --> <!-- Âª∫ËÆÆÔºöpb-2 ÂèØ‰ª•ÂæÆË∞ÉÔºåÁ°Æ‰øùÂíåÂè≥‰æßÈó¥Ë∑ùÊÑü‰∏ÄËá¥ --> <div class="w-full flex justify-end pb-2" id="toc-float-button"> <div id="toc-button" class="
    group relative flex items-center justify-center w-9 h-9 rounded-full 
    transition-all duration-300 cursor-pointer
    
    /* === ÈªòËÆ§Áä∂ÊÄÅ (Ghost) === */
    bg-transparent ring-0
    text-gray-500 dark:text-gray-400

    /* === Hover Áä∂ÊÄÅ (ÊÇ¨ÊµÆÂèçÈ¶à) === */
    hover:scale-110 hover:-translate-y-0.5
    hover:bg-red-50 hover:text-red-600 hover:ring-1 hover:ring-red-100
    dark:hover:bg-blue-500/10 dark:hover:text-blue-400 dark:hover:ring-blue-500/20

    /* === Active Áä∂ÊÄÅ (Â±ïÂºÄÊó∂Â∏∏È©ªÈ´ò‰∫Æ) === */
    [&.active]:bg-red-50 [&.active]:text-red-600 [&.active]:ring-1 [&.active]:ring-red-100
    dark:[&.active]:bg-blue-500/10 dark:[&.active]:text-blue-400 dark:[&.active]:ring-blue-500/20
  " aria-label="Toggle Table of Contents"> <!-- 
    Âçï‰∏ÄÂõæÊ†á
    group-[.active]:rotate-90 -> ÂΩìÁà∂ÂÆπÂô®Êúâ active Á±ªÊó∂ÔºåÂõæÊ†áÊóãËΩ¨ 90 Â∫¶
  --> <svg class="w-5 h-5 transition-transform duration-300 group-[.active]:rotate-90" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-toc"></use> </svg> </div> </div> <!-- ÂàóË°®ÂÜÖÂÆπ --> <div class="text-default text-xxs xl:text-xs hidden max-h-[70vh] overflow-y-auto" id="toc-list" data-source-type="article" aria-live="polite" style="scroll-behavior: smooth;"></div> </div> </div> <script type="module" src="/_astro/TOC.astro_astro_type_script_index_0_lang.B1ErLf9O.js"></script> <div class="hidden md:block md:absolute" id="sidebar" style="right: -50px; top: 0px"> <div class="invisible flex flex-col space-y-4 text-muted items-center justify-center opacity-0 transition-all duration-1000 delay-300 ease-out" id="sidebar-content"> <!-- <PreviousPost lang={lang} post = {post} source = {source}/> --> <!-- <NextPost lang={lang} post = {post} source = {source} /> --> <!-- <DictButton lang={lang} post = {post}/> --> <!-- <ShareWithBlueSky lang={lang} post = {post} source = {source}/> --> <!-- <ShareWithFacebook lang={lang} post = {post} source = {source}/> --> <!-- { lang === Lang.ZH &&
    <ShareWithWeibo lang={lang} post = {post} source = {source}/>
    } --> <!-- <ShareWithLinkedin lang={lang} post = {post} source = {source}/> --> <a href="#subscript" id="sidebar-subscribe-btn" class="
    group relative flex items-center justify-center w-9 h-9 rounded-full 
    transition-all duration-500
    hover:scale-110 hover:-translate-y-0.5
    
    /* === ÈªòËÆ§Áä∂ÊÄÅÔºöÊó†ËÉåÊôØÂúÜÔºåÊó†Èò¥ÂΩ±ÔºåÊ†πÊçÆÊ®°ÂºèÊòæÁ§∫ÊñáÂ≠óÈ¢úËâ≤ === */
  text-gray-500 dark:text-gray-400
    
    /* === Èó™ÁÉÅÊàñ hover Êó∂ÊòæÁ§∫ËÉåÊôØÂúÜÂíåÈò¥ÂΩ± === */
    /* Light Mode (Red Theme) */
    hover:bg-red-50 hover:text-red-600 hover:ring-1 hover:ring-red-100 hover:shadow-sm
    hover:hover:bg-red-100 hover:hover:text-red-700
    
    /* Dark Mode (Blue Theme) */
    dark:hover:bg-blue-500/10 dark:hover:text-blue-400 dark:hover:ring-blue-500/20
    dark:hover:hover:bg-blue-500/20 dark:hover:hover:text-blue-300
    
    /* === Èó™ÁÉÅÁä∂ÊÄÅÔºàÈÄöËøá data-blinking Â±ûÊÄßÊéßÂà∂Ôºâ=== */
    data-[blinking=true]:bg-red-50 data-[blinking=true]:text-red-600 data-[blinking=true]:ring-1 data-[blinking=true]:ring-red-100 data-[blinking=true]:shadow-sm
    dark:data-[blinking=true]:bg-blue-500/10 dark:data-[blinking=true]:text-blue-400 dark:data-[blinking=true]:ring-blue-500/20
  " aria-label="Subscribe to Newsletter" data-tooltip-target="tooltip-sidebar-subscribe" data-tooltip-placement="left" data-blinking="false"> <svg class="w-6 h-6 transition-transform duration-300 group-hover:rotate-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-email"></use> </svg>  <span id="ping-dot" class="absolute top-0 right-0 -mt-0.5 -mr-0.5 flex h-2.5 w-2.5 hidden"> <span id="ping-animation" class="absolute inline-flex h-full w-full rounded-full opacity-75 bg-red-400 dark:bg-blue-400"></span> <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500 dark:bg-blue-500"></span> </span> </a> <!-- Tooltip (‰øùÊåÅ‰∏çÂèòÔºåÊ∑±Ëâ≤ËÉåÊôØÈÄöÁî®) --> <div id="tooltip-sidebar-subscribe" role="tooltip" class="absolute z-50 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700 transition-opacity duration-300 whitespace-nowrap"> Subscribe to Newsletter <div class="tooltip-arrow" data-popper-arrow></div> </div> <script>(function(){const lang = "en";

  document.addEventListener('DOMContentLoaded', () => {
    const subscribeBtn = document.getElementById('sidebar-subscribe-btn');
    if (subscribeBtn) {
      subscribeBtn.addEventListener('click', () => {
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: 'subscribe_click',
          content_type: 'newsletter_subscribe',
          click_location: 'sidebar_floating',
          lang: lang
        });
      });
    }

    // ÊéßÂà∂ÂëºÂê∏ÁÇπÁöÑÈó¥Ê≠áÈó™ÁÉÅ
    const pingDot = document.getElementById('ping-dot');
    const pingAnimation = document.getElementById('ping-animation');
    
    if (pingDot && pingAnimation && subscribeBtn) {
      // ÁîüÊàê 10-20 Áßí‰πãÈó¥ÁöÑÈöèÊú∫Êó∂Èó¥ÔºàÊØ´ÁßíÔºâ
      const getRandomDelay = () => Math.random() * 10000 + 10000; // 10000-20000ms
      
      const startBlinking = () => {
        // ÊòæÁ§∫ÂëºÂê∏ÁÇπÂπ∂ÂºÄÂßãÈó™ÁÉÅÔºåÂêåÊó∂ÊòæÁ§∫ËÉåÊôØÂúÜ
        pingDot.classList.remove('hidden');
        pingAnimation.classList.add('animate-ping');
        subscribeBtn.setAttribute('data-blinking', 'true');
        
        // Èó™ÁÉÅ 10-20 ÁßíÂêéÂÅúÊ≠¢
        const blinkDuration = getRandomDelay();
        setTimeout(() => {
          // ÂÅúÊ≠¢Èó™ÁÉÅÂπ∂ÈöêËóèÔºåÂêåÊó∂ÈöêËóèËÉåÊôØÂúÜ
          pingAnimation.classList.remove('animate-ping');
          pingDot.classList.add('hidden');
          subscribeBtn.setAttribute('data-blinking', 'false');
          
          // Á≠âÂæÖ 10-20 ÁßíÂêéÂÜçÊ¨°ÂºÄÂßã
          const pauseDuration = getRandomDelay();
          setTimeout(startBlinking, pauseDuration);
        }, blinkDuration);
      };
      
      // ÂàùÂßãÁ≠âÂæÖ 10-20 ÁßíÂêéÂºÄÂßãÁ¨¨‰∏ÄÊ¨°Èó™ÁÉÅ
      const initialDelay = getRandomDelay();
      setTimeout(startBlinking, initialDelay);
    }
  });
})();</script> <!-- 
  ÂÆπÂô®Ê†∑ÂºèÔºö
  1. w-9 h-9: ‰∏éËÆ¢ÈòÖÊåâÈíÆÂ∞∫ÂØ∏‰øùÊåÅ‰∏ÄËá¥ÔºåÁ°Æ‰øùÂûÇÁõ¥ÂØπÈΩê
  2. text-gray-400: ÈªòËÆ§ÁÅ∞Ëâ≤ÔºåÈôç‰ΩéËßÜËßâÊùÉÈáç
  3. hover:text-black / dark:hover:text-white: ÊÇ¨ÊµÆÊó∂Âèò‰∏∫ X ÁöÑÂìÅÁâåËâ≤
  4. hover:bg-gray-100: ÊÇ¨ÊµÆÊó∂Â¢ûÂä†Ê∑°Ê∑°ÁöÑËÉåÊôØÔºåÂ¢ûÂä†ÁÇπÂáªÂå∫ÂüüÊÑü
--><a href="https://x.com/intent/tweet?text=Solving%20SwiftUI%20Pain%20Points%20and%20Performance%20Bottlenecks%3A%20Zipic%20Development%20Technical%20Retrospective&url=https%3A%2F%2Ffatbobman.com%2Fen%2Fposts%2Fzipic-3-technical-details%2F&hashtags=ios,swiftlang&via=fatbobman" target="_blank" id="sidebar-share-with-twitter" class="
    group relative flex items-center justify-center w-9 h-9 rounded-full 
    transition-all duration-300 
    hover:scale-110 hover:-translate-y-0.5
    
    /* === ÈªòËÆ§Áä∂ÊÄÅ (ÈöêÂΩ¢ËÉåÊôØ) === */
    bg-transparent ring-0
    text-gray-500 dark:text-gray-400
    
    /* === Light Mode Hover (Red Theme) === */
    hover:bg-red-50 hover:text-red-600 hover:ring-1 hover:ring-red-100
    
    /* === Dark Mode Hover (Blue Theme) === */
    dark:hover:bg-blue-500/10 dark:hover:text-blue-400 dark:hover:ring-blue-500/20
  " data-tooltip-target="tooltip-share-with-twitter" data-tooltip-placement="left" aria-label="Share on X"> <svg class="w-6 h-6 transition-transform duration-300 group-hover:rotate-12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-twitter"></use> </svg> </a> <!-- Tooltip: Ê†∑Âºè‰∏éËÆ¢ÈòÖÊåâÈíÆ‰øùÊåÅ‰∏ÄËá¥ --> <div id="tooltip-share-with-twitter" role="tooltip" class="absolute z-50 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700 transition-opacity duration-300 whitespace-nowrap"> <div>Share on X</div> <div class="tooltip-arrow" data-popper-arrow></div> </div> <!-- 
  ÂÆπÂô®‰øÆÊîπÔºö
  1. ÁßªÈô§ opacity-80: ‰øùÊåÅÈ¢úËâ≤Á∫ØÂáÄÔºåËΩ®ÈÅìÁöÑ gray-200/700 Â∑≤ÁªèË∂≥Â§ü‰ΩéË∞É„ÄÇ
  2. bg-gray-200 dark:bg-gray-700: ‰øùÊåÅ‰∏≠ÊÄßËΩ®ÈÅìËâ≤„ÄÇ
--><div class="relative w-[2px] h-32 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden my-4" aria-hidden="true"> <div id="sidebar-reading-progress" class="
        absolute top-0 left-0 w-full transition-all duration-100 ease-out
        
        /* === Light Mode (Red Theme) === */
        /* ‰ΩøÁî®Ê∑±Á∫¢Ëâ≤ÔºåÂëºÂ∫îÂìÅÁâåËâ≤ #c72f1c */
        bg-red-600
        
        /* === Dark Mode (Blue Theme) === */
        /* ‰ΩøÁî®‰∫ÆËìùËâ≤ÔºåÂëºÂ∫îÊöóÈªë‰∏ªËâ≤ #60a5fa */
        dark:bg-blue-400
      " style="height: 0%"></div> </div> <script>
  function initProgressBar() {
    const progressBar = document.getElementById('sidebar-reading-progress');
    // ËØ∑Á°Æ‰øù‰Ω†ÁöÑÊñáÁ´†ÂÆπÂô® ID Á°ÆÂÆûÊòØ 'article-area'ÔºåÂê¶ÂàôËøõÂ∫¶Êù°‰∏ç‰ºöÂä®
    const article = document.getElementById('article-area'); 

    if (!progressBar || !article) return;

    function updateProgress() {
      const articleRect = article.getBoundingClientRect();
      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      const scrollTop = window.scrollY;

      // ËøõÂ∫¶ËÆ°ÁÆó
      let progress = (scrollTop - articleTop + 150) / (articleHeight - windowHeight + 150);

      progress = Math.min(Math.max(progress, 0), 1);

      progressBar.style.height = `${progress * 100}%`;
    }

    // ‰ºòÂåñÔºö‰ΩøÁî® passive: true ÊèêÈ´òÊªöÂä®ÊÄßËÉΩ
    window.addEventListener('scroll', () => requestAnimationFrame(updateProgress), { passive: true });
    window.addEventListener('resize', updateProgress);
    updateProgress(); 
  }

  // ËøôÈáåÁöÑÂà§Êñ≠ÈÄªËæëÂèØ‰ª•‰øùÁïô
  if (window.innerWidth >= 768) {
    initProgressBar();
    document.addEventListener('astro:page-load', initProgressBar);
  }
</script> <!-- 
  ÂÆπÂô®Ê†∑ÂºèÔºö
  1. w-9 h-9: ‰øùÊåÅÂ∞∫ÂØ∏Áªü‰∏Ä
  2. text-gray-400: ÈªòËÆ§‰ΩéË∞É
  3. hover:text-blue-600: ÊÇ¨ÊµÆÊó∂Âèò‰∏∫ÂìÅÁâåËâ≤ (Âå∫Âà´‰∫é X ÁöÑÈªëËâ≤)
  4. hover:bg-blue-50: ÊÇ¨ÊµÆÊó∂Â¢ûÂä†Ê∑°Ê∑°ÁöÑËìùËâ≤ËÉåÊôØ
--><button id="sidebar-comment-btn" type="button" class="
  group relative flex items-center justify-center w-9 h-9 rounded-full 
  transition-all duration-300 
  hover:scale-110 hover:-translate-y-0.5
  
  /* === ÈªòËÆ§Áä∂ÊÄÅ (ÈöêÂΩ¢ËÉåÊôØ) === */
  bg-transparent ring-0
  text-gray-500 dark:text-gray-400
  
  /* === Light Mode Hover (Red Theme) === */
  hover:bg-red-50 hover:text-red-600 hover:ring-1 hover:ring-red-100
  
  /* === Dark Mode Hover (Blue Theme) === */
  dark:hover:bg-blue-500/10 dark:hover:text-blue-400 dark:hover:ring-blue-500/20
  " aria-label="Comment" data-tooltip-target="tooltip-sidebar-comment" data-tooltip-placement="left"> <svg class="w-6 h-6 transition-transform duration-300 group-hover:rotate-12" " fill="currentColor" stroke="currentColor" stroke-width="5" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-comment"></use> </svg> </button> <!-- Tooltip --> <div id="tooltip-sidebar-comment" role="tooltip" class="absolute z-50 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700 transition-opacity duration-300 whitespace-nowrap"> <div>Share Your Thoughts</div> <div class="tooltip-arrow" data-popper-arrow></div> </div> <script>
  // ‰øùÊåÅÂéüÊúâÈÄªËæëÔºå‰ΩÜÂÅö‰∫ÜÈò≤Âæ°ÊÄßÁºñÁ®ã
  // ‰ΩøÁî® IIFE Êàñ block scope ÈÅøÂÖçÂèòÈáèÊ±°ÊüìÂÖ®Â±Ä
  {
    const SCROLL_OFFSET = 80;

    // ÈÄªËæëÔºöÊâæÂà∞ËØÑËÆ∫Âå∫Âπ∂Âπ≥ÊªëÊªöÂä®
    const handleCommentScroll = () => {
      // ‰ºòÂÖàÂ∞ùËØï gitalkÔºå‰πüÂèØ‰ª•Êâ©Â±ïÊîØÊåÅ giscus ÊàñÂÖ∂‰ªñËØÑËÆ∫Á≥ªÁªü
      const commentContainer = document.getElementById('gitalk-container') || document.getElementById('giscus'); 
      
      if (commentContainer) {
        const topPosition = commentContainer.getBoundingClientRect().top + window.scrollY - SCROLL_OFFSET;
        window.scrollTo({ top: topPosition, behavior: 'smooth' });
      } else {
        // Â¶ÇÊûúÊâæ‰∏çÂà∞ËØÑËÆ∫Âå∫ÂÆπÂô®ÔºàÊØîÂ¶ÇËøòÊ≤°Âä†ËΩΩÔºâÔºåÂ∞ùËØïÁõ¥Êé•ÊªöÂà∞Â∫ïÈÉ®
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }
    };

    // ÁªëÂÆö‰∫ã‰ª∂
    // Astro View Transitions ÂÖºÂÆπÔºöÂ¶ÇÊûúÁî®‰∫Ü ViewTransitionsÔºåÈúÄË¶ÅÁõëÂê¨ 'astro:page-load'
    // ËøôÈáå‰ΩøÁî®Âü∫Á°ÄÁöÑ DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('sidebar-comment-btn');
      if (btn) {
        btn.addEventListener('click', handleCommentScroll);
      }
    });
  }
</script> <!-- 
  ÂÆπÂô®Ê†∑ÂºèÔºö
  1. w-9 h-9, rounded-full: Â∞∫ÂØ∏Áªü‰∏Ä
  2. opacity-0 invisible: ÈªòËÆ§ÈöêËóèÔºåÁî± JS ÊéßÂà∂ÊòæÈöê
  3. hover:text-blue-600: ÊÇ¨ÊµÆÈ´ò‰∫Æ
--><button id="sidebar-top-btn" type="button" class="
  group relative flex items-center justify-center w-9 h-9 rounded-full 
  transition-all duration-300 
  hover:scale-110 hover:-translate-y-0.5
  
  /* === ÈªòËÆ§Áä∂ÊÄÅ (ÈöêÂΩ¢ËÉåÊôØ) === */
  bg-transparent ring-0
  text-gray-500 dark:text-gray-400
  
  /* === Light Mode Hover (Red Theme) === */
  hover:bg-red-50 hover:text-red-600 hover:ring-1 hover:ring-red-100
  
  /* === Dark Mode Hover (Blue Theme) === */
  dark:hover:bg-blue-500/10 dark:hover:text-blue-400 dark:hover:ring-blue-500/20
  " aria-label="Back to Top" data-tooltip-target="tooltip-back-to-top" data-tooltip-placement="left"> <svg class="w-6 h-6" fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"> <use href="/_astro/iconCollection.Ch_vtVZw.svg#icon-top"></use> </svg> </button> <!-- Tooltip --> <div id="tooltip-back-to-top" role="tooltip" class="absolute z-50 invisible inline-block px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700 transition-opacity duration-300 whitespace-nowrap"> <div>Back to Top</div> <div class="tooltip-arrow" data-popper-arrow></div> </div> <script>
  document.addEventListener('DOMContentLoaded', () => {
    const topBtn = document.getElementById('sidebar-top-btn');
    const SHOW_THRESHOLD = 400; // ÊªöÂä®Ë∂ÖËøá 400px ÂêéÊòæÁ§∫

    if (topBtn) {
      // 1. ÁÇπÂáª‰∫ã‰ª∂
      topBtn.addEventListener('click', () => {
        const header = document.getElementById('wholeHeader');
        if (header) {
          const target = header.offsetTop + header.offsetHeight;
          window.scrollTo({ top: target, behavior: 'smooth' });
        } else {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      // 2. ÊªöÂä®ÁõëÂê¨
      const handleScroll = () => {
        if (window.scrollY > SHOW_THRESHOLD) {
          // ÊòæÁ§∫
          topBtn.classList.remove('opacity-0', 'invisible', 'translate-y-4');
          topBtn.classList.add('opacity-100', 'visible', 'translate-y-0');
        } else {
          // ÈöêËóè (Âä†‰∏ÄÁÇπ‰∏ãÊ≤âÊïàÊûú translate-y-4ÔºåÊòæÂæóÊòØ‰ªé‰∏ãÈù¢ÂÜíÂá∫Êù•ÁöÑ)
          topBtn.classList.remove('opacity-100', 'visible', 'translate-y-0');
          topBtn.classList.add('opacity-0', 'invisible', 'translate-y-4');
        }
      };

      // ÊÄßËÉΩ‰ºòÂåñÔºö‰ΩøÁî® RAF ËøõË°åËäÇÊµÅ
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            handleScroll();
            ticking = false;
          });
          ticking = true;
        }
      });
      
      // ÂàùÂßãÂåñÊâßË°å‰∏ÄÊ¨°ÔºåÈò≤Ê≠¢Âà∑Êñ∞È°µÈù¢ÂêéÂÅúÁïôÂú®‰∏≠Èó¥‰ΩÜÊåâÈíÆÊ≤°Âá∫Êù•
      handleScroll();
    }
  });
</script> </div> </div> <script type="module" src="/_astro/SideBar.astro_astro_type_script_index_0_lang.kcu16vqK.js"></script> </div>   </div> </main> </div> <footer> <footer class="bg-block border-t border-gray-100 dark:border-slate-800 mt-20" id="page-footer"> <div class="mx-auto w-full max-w-5xl px-6 py-12 md:py-16"> <div class="grid grid-cols-1 md:grid-cols-12 gap-8 lg:gap-12">  <div class="md:col-span-4 lg:col-span-5 space-y-4"> <div class="flex items-center space-x-2">  <span class="text-xl font-black tracking-tight text-heading">
Fatbobman's <span class="text-primary">Blog</span> </span> </div> <p class="text-sm text-muted leading-relaxed max-w-xs"> Exploring the infinite possibilities of Swift and Apple development ecosystem. </p> </div>  <div class="md:col-span-8 lg:col-span-7 grid grid-cols-2 sm:grid-cols-3 gap-8">  <div> <h3 class="text-sm font-bold text-heading uppercase tracking-wider mb-4 "> Explore </h3> <ul class="space-y-3 text-sm text-muted"> <li><a href="/en/snippet/" class="hover:text-primary transition-colors">Quick Tips</a></li> <li><a href="/en/posts/" class="hover:text-primary transition-colors">Posts</a></li> <li><a href="/en/tags/" class="hover:text-primary transition-colors">Tags</a></li> <li><a href="/en/collections/" class="hover:text-primary transition-colors">Collections</a></li> </ul> </div>  <div> <h3 class="text-sm font-bold text-heading uppercase tracking-wider mb-4 "> Subscribe </h3> <ul class="space-y-3 text-sm text-muted"> <li><a href="https://weekly.fatbobman.com/welcome" class="hover:text-primary transition-colors" target="_blank">Newsletter</a></li> <li><a href="/rss.xml" class="hover:text-primary transition-colors" target="_blank">RSS</a></li> </ul> </div>  <div> <h3 class="text-sm font-bold text-heading uppercase tracking-wider mb-4 "> Connect &amp; Support </h3> <ul class="space-y-3 text-sm text-muted"> <li><a href="/en/sponsorship/" class="hover:text-primary transition-colors" rel="sponsored">Promote on Blog</a></li> <li><a href="/en/about/#contact" class="hover:text-primary transition-colors">Contact Me</a></li> <li> <a href="https://www.buymeacoffee.com/fatbobman" class="hover:text-primary transition-colors group flex items-center" target="_blank"> <span>Buy Me a Coffee</span> <span class="ml-1 group-hover:scale-110 transition-transform inline-block">‚òïÔ∏è</span> </a> </li> </ul> </div> </div> </div>  <div class="mt-12 pt-8 border-t border-gray-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-center text-xs text-muted/60 gap-4"> <div class="text-center md:text-left"> <span>&copy; 2026 Fatbobman Digital Limited. All Rights Reserved.</span> </div> <div class="flex items-center gap-4">  <div class="opacity-70 hover:opacity-100 transition-opacity"> <div class="flex items-center justify-center w-full px-6 pt-2 text-sm pb-10"> <button type="button" onclick="
        try {
          window.open('https://beian.miit.gov.cn/#/Integrated/index', '_blank');
        } catch (e) {
          console.log('Failed to open ICP link:', e);
        }
      " class="text-xxs hover:underline text-muted tracking-wide" aria-label="ICP Registration Information">
ËæΩICPÂ§á20006550Âè∑-1
</button> </div> </div> </div> </div> </div> </footer> </footer> </div> <section> <div id="weekly-modal" data-subscribeText="Join Now" data-placeholder="Subscribe with your email" data-embed-url="https://weekly.fatbobman.com/embed" data-iframe-class="mx-auto sm:w-[320px] md:w-[480px] sm:h-[200px] md:h-[320px] dark:opacity-80 dark:rounded-lg dark:shadow-2xl dark:border-gray-600" data-iframe-style="border:0px solid #EEE; background:white; width: 100%; max-width: 480px;"> <div id="popup-modal" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full"> <!-- Modal content --> <div class="relative bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-lg shadow-2xl border-gray-200 border dark:border-gray-600"> <!-- Modal header --> <div class="flex items-center justify-between px-4 md:px-5 pt-4 pb-0 rounded-t dark:border-gray-600"> <button id="popup-modal-close-button" type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"> <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path> </svg> <span class="sr-only">Close modal</span> </button> </div> <!-- Modal body --> <div class="px-4 md:px-5 pb-4 md:w-[480px] sm:w-80 mx-auto"> <div class="sm:hidden md:block text-base text-center font-bold text-gray-900 dark:text-blue-100 pt-4 pb-2 ">Weekly Swift &amp; SwiftUI Highlights - Every Monday</div> <div id="weekly-modal-embed" class="flex flex-col items-center justify-center gap-4" data-iframe-loaded="false"> <div class="relative flex items-center justify-center"> <div class="w-8 h-8 border-2 border-gray-200 dark:border-gray-700 border-t-secondary rounded-full animate-spin" aria-hidden="true"></div> </div> <div class="text-sm text-gray-400 dark:text-gray-500 text-center" data-weekly-loader data-error-text="Failed to load subscription form. Please retry later." aria-live="polite"> Preparing subscription form... </div> </div> </div> </div> </div> </div> </section> <script type="module" src="/_astro/WeeklyModalLoader.astro_astro_type_script_index_0_lang.DMZWLG_2.js"></script>  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js" async></script> <script>
  // ‰∏∫ÊØè‰∏™ÈúÄË¶ÅÊ∏ÖÈô§ focus Áä∂ÊÄÅÁöÑÊåâÈíÆÈÉΩÊ∑ªÂä†‰∏Ä‰∏™ clear-focus Á±ª, ‰∏ãÈù¢ÁöÑ‰ª£Á†ÅÂ∞ÜÂú®ÁÇπÂáªÂêéËá™Âä®ÁßªÈô§ focus Áä∂ÊÄÅ
  document.addEventListener('DOMContentLoaded', () => {
    // Ëé∑ÂèñÊâÄÊúâÂÖ∑Êúâ 'clear-focus' Á±ªÁöÑÊåâÈíÆ
    const buttons = document.querySelectorAll('.clear-focus');

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        setTimeout(() => {
          button.blur();
        }, 0);
      });
    });
  });

  window.onpageshow = function () {
    document.documentElement.classList.add('motion-safe:scroll-smooth');
  };

  if (typeof window !== 'undefined') {
    const videos = Array.from(document.querySelectorAll('video.lazy-video[data-autoplay="lazy"]'));

    const disableTooltipsOnTouch = () => {
      const isTouch =
        'ontouchstart' in window ||
        (navigator && navigator.maxTouchPoints > 0) ||
        (window.matchMedia && window.matchMedia('(pointer: coarse)').matches);
      if (!isTouch) {
        return;
      }
      const triggers = document.querySelectorAll('[data-tooltip-target]');
      triggers.forEach((trigger) => {
        const tooltipId = trigger.getAttribute('data-tooltip-target');
        trigger.removeAttribute('data-tooltip-target');
        trigger.removeAttribute('data-tooltip-placement');
        if (tooltipId) {
          const tooltipEl = document.getElementById(tooltipId);
          if (tooltipEl && tooltipEl.parentNode) {
            tooltipEl.parentNode.removeChild(tooltipEl);
          }
        }
      });
    };

    document.addEventListener('DOMContentLoaded', disableTooltipsOnTouch);

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const video = entry.target;

            if (entry.isIntersecting) {
              // ËøõÂÖ•ËßÜÁ™ó -> Â∞ùËØïÊí≠ÊîæÔºàÊµèËßàÂô®‰ºöÊ†πÊçÆÁ≠ñÁï•ÂÜ≥ÂÆöÊòØÂê¶ÂÖÅËÆ∏Ôºâ
              video.play().catch(() => {
                // Êüê‰∫õÊÉÖÂÜµ‰∏ãÔºàÊµèËßàÂô®Á≠ñÁï•ÔºâÂèØËÉΩ‰ºöÂ§±Ë¥•ÔºåÈùôÈªòÂç≥ÂèØ
              });
            } else {
              // Á¶ªÂºÄËßÜÁ™ó -> ÊöÇÂÅúÔºåËäÇÁúÅ CPU & Â∏¶ÂÆΩ
              video.pause();
            }
          });
        },
        {
          threshold: 0.1, // Ëá≥Â∞ëÊúâ 10% Âá∫Áé∞Âú®ËßÜÁ™óÈáåÊó∂Ëß¶Âèë
        }
      );

      videos.forEach((video) => observer.observe(video));

      // Ê∏ÖÁêÜÈÄªËæëÔºöÈ°µÈù¢Âç∏ËΩΩÊó∂ÂèñÊ∂àÊâÄÊúâËßÇÂØü
      window.addEventListener('beforeunload', () => {
        videos.forEach((video) => observer.unobserve(video));
        observer.disconnect();
      });

      // Â§ÑÁêÜ bfcache ÊÉÖÂÜµ
      window.addEventListener('pageshow', (event) => {
        // Â¶ÇÊûúÊòØ‰ªé bfcache ÊÅ¢Â§çÔºåÈáçÊñ∞ÂàùÂßãÂåñ
        if (event.persisted) {
          const newVideos = Array.from(document.querySelectorAll('video.lazy-video[data-autoplay="lazy"]'));
          newVideos.forEach((video) => {
            if (!videos.includes(video)) {
              observer.observe(video);
            }
          });
        }
      });
    } else {
      // ËÄÅÊµèËßàÂô®ÁöÑÈôçÁ∫ßÁ≠ñÁï•Ôºö‰ªÄ‰πàÈÉΩ‰∏çÂÅöÔºåÁî®Êà∑ÊâãÂä®Êí≠Êîæ
    }
  }
</script> <script>(function(){const lang = "en";
const searchText = "Search...";
const runSearchModuleUrl = "/_astro/runsearch.Cf7wkMmH.js";

  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('docsearch');
    if (!button) {
      return;
    }

    let docsearchScriptPromise = null;
    let initialized = false;

    const loadDocsearchLibrary = () => {
      if (typeof window !== 'undefined' && typeof window.docsearch === 'function') {
        return Promise.resolve();
      }
      if (!docsearchScriptPromise) {
        docsearchScriptPromise = new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@docsearch/js@3.8.3';
          script.defer = true;
          script.onload = () => resolve();
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      return docsearchScriptPromise;
    };

    const handleFirstClick = async (event) => {
      event.preventDefault();
      event.stopPropagation();

      try {
        // Load DocSearch library
        await loadDocsearchLibrary();

        // Import and execute search module
        const module = await import(runSearchModuleUrl);

        // openSearch will call initSearch internally, so we don't need to call both
        await module.openSearch(lang, searchText);

        // Remove the first-click listener after successful initialization
        button.removeEventListener('click', handleFirstClick, true);
        initialized = true;
      } catch (error) {
        console.error('Failed to initialize DocSearch:', error);
      }
    };

    button.addEventListener('click', handleFirstClick, true);
  });
})();</script> <!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5C7N4MF5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!-- End Google Tag Manager (noscript) --> <!--Magic Fix Ëß£ÂÜ≥Âú® Safari ‰∏ãÊêúÁ¥¢Ê°ÜÂèñÊ∂àÂêé‰ºöÊªöÂä®Âà∞È°µÈù¢Â∫ïÈÉ®--> <div class="fixed"> <input type="text"> </div> </body></html>