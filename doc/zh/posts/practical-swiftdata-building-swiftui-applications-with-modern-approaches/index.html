<!DOCTYPE html><html lang="zh"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="sitemap" href="/sitemap-index.xml"><!-- <link rel="shortcut icon" href={iconSVG.src} /> --><link rel="icon" type="image/png" sizes="16x16" href="/_astro/favicon-16x16.2312221518-2.4YWPtmqG.png"><link rel="icon" type="image/png" sizes="32x32" href="/_astro/favicon-32x32.2312221518-2.W1M1HUWf.png"><link rel="mask-icon" href="/_astro/faviconSVG-32x32.2312221518-2.JZf4E4CU.svg"><link rel="apple-touch-icon" sizes="180x180" href="/_astro/apple-touch-icon.2312227635.RNVrzb6f.png"><style is:global>
  :root {
    --aw-font-sans: 'Inter Variable';
    --aw-font-serif: var(--aw-font-sans);
    --aw-font-heading: var(--aw-font-sans);
    --aw-font-mono: 'Roboto Mono Variable';

    --aw-color-primary: #c72f1c;
    /* --aw-color-secondary: #d97706; */
    --aw-color-secondary: #E65C00;
    --aw-color-accent: #00ac57;

    --aw-color-text-heading: rgb(45 45 45);
    --aw-color-text-default: rgb(71 85 95);
    --aw-color-text-muted: rgb(100 116 139);
    --aw-color-bg-page: rgb(255 255 255);
    --aw-color-bg-block: #f9fafb;

    --aw-color-bg-page-dark: rgb(15 23 42);

    --aw-color-text-invert: rgb(255 255 255);

    --comment-blue: var(--aw-color-secondary);

    --subscribe-input-background: #f3f4f6;
    --subscribe-input-text: #000000;
    --subscribe-button-background: #EA580C;
    --subscribe-button-text: #ffffff;
    --subscribe-widget-border: 0.05px solid var(--subscribe-button-background);

    ::selection {
      background-color: lavender;
    }
  }

  /* @media (prefers-color-scheme: dark) {
    :root {
      --aw-font-sans: 'Inter Variable';
      --aw-font-serif: var(--aw-font-sans);
      --aw-font-heading: var(--aw-font-sans);
      --aw-font-mono: 'Roboto Mono Variable';

      --aw-color-primary: rgb(200 30 30);
      --aw-color-secondary: #6b9ff9;
      --aw-color-accent: rgb(109 40 217);

      --aw-color-text-heading: rgb(226 232 240);
      --aw-color-text-default: rgb(148 163 184);
      --aw-color-text-muted: rgb(100 116 139);
      --aw-color-bg-page: var(--aw-color-bg-page-dark);
      --aw-color-bg-block: #1f2937;

      ::selection {
        background-color: black;
        color: snow;
      }
    }
  } */

  .dark {
    --aw-font-sans: 'Inter Variable';
    --aw-font-serif: var(--aw-font-sans);
    --aw-font-heading: var(--aw-font-sans);
    --aw-font-mono: 'Roboto Mono Variable';

    --aw-color-primary: rgb(200 30 30);
    --aw-color-secondary: #3B82F6;
    /* --aw-color-secondary: #6b9ff9; */
    --aw-color-accent: rgb(109 40 217);

    --aw-color-text-heading: rgb(198 198 198);
    --aw-color-text-default: rgb(148 163 184);
    --aw-color-text-muted: rgb(100 116 139);
    --aw-color-bg-page: var(--aw-color-bg-page-dark);
    --aw-color-bg-block: #1f2937;
    --aw-color-text-invert: #e2e2e2;
    --comment-blue: var(--aw-color-secondary);

    --subscribe-input-background: #f3f4f6;
    --subscribe-input-text: #000000;
    --subscribe-button-background: #3B82F6;
    --subscribe-button-text: #ffffff;

    ::selection {
      background-color: black;
      color: snow;
    }
  }

  /* inter-latin-wght-normal */
  @font-face {
    font-family: 'Inter Variable';
    font-style: oblique 0deg 10deg;
    font-display: swap;
    font-weight: 100 900;
    src: url(https://cdn.jsdelivr.net/fontsource/fonts/inter:vf@latest/latin-slnt-normal.woff2)
      format('woff2-variations');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0300-0301, U+0303-0304,
      U+0308-0309, U+0323, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

  /* roboto-mono-latin-wght-normal */
  @font-face {
    font-family: 'Roboto Mono Variable';
    font-style: normal;
    font-display: swap;
    font-weight: 100 700;
    src: url(https://cdn.jsdelivr.net/fontsource/fonts/roboto-mono:vf@latest/latin-wght-normal.woff2)
      format('woff2-variations');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0300-0301, U+0303-0304,
      U+0308-0309, U+0323, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }
</style><title>SwiftData 实战：用现代方法构建 SwiftUI 应用 | 肘子的 Swift 记事本</title>
<meta name="description" content="探索SwiftData与现代SwiftUI编程的结合，学习如何模块化数据管理、进行单元测试和处理并发。解决SwiftData的挑战，构建稳定应用。">
<meta name="robots" content="index,follow">
<link rel="canonical" href="https://fatbobman.com/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/">
<meta property="og:title" content="SwiftData 实战：用现代方法构建 SwiftUI 应用 | 肘子的 Swift 记事本">
<meta property="og:description" content="探索SwiftData与现代SwiftUI编程的结合，学习如何模块化数据管理、进行单元测试和处理并发。解决SwiftData的挑战，构建稳定应用。">
<meta property="og:url" content="https://fatbobman.com/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/">
<meta property="og:type" content="article">
<meta property="og:image" content="https://cdn.fatbobman.com/card/practical-swiftdata-building-swiftui-applications-with-modern-approaches-zh.png">

<meta property="og:locale" content="zh">
<meta property="og:site_name" content="fatbobman.com">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@fatbobman">
<meta name="twitter:creator" content="@fatbobman"><link rel="alternate" type="application/rss+xml" title="RSS Feed for My Website" href="https://fatbobman.com/zh/rss.xml"><link rel="sitemap" href="/sitemap-index.xml"><meta name="keywords" content="Swift 编程,Swift Programming,SwiftUI 教程,SwiftUI Tutorials,Core Data 实践,Core Data Practices,SwiftData 应用,SwiftData Applications,iOS 开发,iOS Development,Swift UI 设计,Swift UI Design,Swift 性能优化,Swift Performance Optimization,Swift 编码技巧,Swift Coding Techniques,iOS 应用开发,iOS App Development,Swift 数据管理,Swift Data Management,SwiftUI 布局,SwiftUI Layout,SwiftUI 动画,SwiftUI Animation"><meta name="apple-mobile-web-app-title" content="肘子的博客"><link rel="alternate" hreflang="zh" href="https://fatbobman.com/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/"><link rel="alternate" hreflang="en" href="https://fatbobman.com/en/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/"><!-- <BasicScripts /> --><script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?14e5d60a3ea6276655f9d14c58b1fcd0";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script> <!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5C7N4MF5');</script> <!-- End Google Tag Manager --><link rel="stylesheet" href="/_astro/about.W-24wY6J.css" />
<link rel="stylesheet" href="/_astro/about.g78UfH4M.css" />
<link rel="stylesheet" href="/_astro/_slug_.KE54EPLE.css" />
<style>.sticky[data-astro-cid-4wsjtibl]{position:fixed;top:0;left:50%;transform:translate(-50%);width:100%;max-width:100%}
@keyframes rotate360{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rotate[data-astro-cid-qwm5cfxr]{animation:rotate360 1s linear}
</style><script type="module" src="/_astro/hoisted.BZCfwh3i.js"></script></head> <body class="antialiased text-default tracking-tight bg-page">  <div class="flex flex-col min-h-screen justify-between "> <div> <header> <div class="bg-block" id="wholeHeader" data-astro-cid-4wsjtibl> <div id="blogTitle"> <a href="/zh/"> <div class="flex space-x-4 mx-auto text-center pt-16 sm:pt-12 font-black w-[240px] sm:w-[300px] pb-6 sm:pb-1"> <svg class="text-heading" width="337" height="63" viewBox="0 0 337 63" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M57.768 7.944C58.9627 8.11466 59.7733 8.47733 60.2 9.032C60.6693 9.58666 60.904 10.312 60.904 11.208C60.904 14.152 59.3253 15.5173 56.168 15.304L53.928 15.112C51.4107 14.8987 48.8933 14.728 46.376 14.6C43.9013 14.472 41.2987 14.408 38.568 14.408H35.688C35.176 20.7227 34.6427 26.4827 34.088 31.688L45.096 31.496C46.6747 31.496 47.72 31.7733 48.232 32.328C48.7867 32.8827 49.064 33.6293 49.064 34.568C49.064 36.0187 48.6373 37.1707 47.784 38.024C46.9307 38.8347 45.7147 39.24 44.136 39.24H33.192L32.808 41.992C31.912 49.032 29.992 54.0453 27.048 57.032C24.1467 60.0187 20.136 61.512 15.016 61.512C12.1147 61.512 9.448 60.8933 7.016 59.656C4.584 58.376 2.792 56.84 1.64 55.048C1.17067 54.3227 0.936 53.448 0.936 52.424C0.936 51.4 1.17067 50.504 1.64 49.736C2.152 48.968 2.77067 48.584 3.496 48.584C4.008 48.584 4.49867 48.7547 4.968 49.096C5.48 49.4373 6.12 50.0987 6.888 51.08C8.936 53.768 11.4747 55.112 14.504 55.112C16.936 55.112 18.9627 54.1307 20.584 52.168C22.248 50.1627 23.3147 47.0267 23.784 42.76L24.168 39.24H21.096C20.1147 39.24 19.2613 38.9627 18.536 38.408C17.8533 37.8533 17.512 37.064 17.512 36.04C17.512 34.7173 17.8533 33.7147 18.536 33.032C19.2187 32.3067 20.2213 31.944 21.544 31.944C22.7387 31.944 23.912 31.9227 25.064 31.88C25.576 27.1867 26.1307 21.4907 26.728 14.792C22.12 15.2187 18.8773 15.9653 17 17.032C15.1227 18.0987 14.184 19.6773 14.184 21.768C14.184 23.2187 14.6107 24.6053 15.464 25.928C15.72 26.312 15.848 26.696 15.848 27.08C15.848 27.848 15.4213 28.5307 14.568 29.128C13.7147 29.6827 12.7547 29.96 11.688 29.96C10.536 29.96 9.55467 29.6187 8.744 28.936C8.232 28.5093 7.74133 27.6347 7.272 26.312C6.80267 24.9893 6.568 23.5173 6.568 21.896C6.568 16.6053 9.27733 12.7653 14.696 10.376C20.1573 7.98666 28.1147 6.792 38.568 6.792C45.8213 6.792 52.2213 7.176 57.768 7.944ZM55.2565 61.32C52.6112 61.32 50.4992 60.36 48.9205 58.44C47.3418 56.52 46.5525 54.0027 46.5525 50.888C46.5525 47.4747 47.3418 44.2533 48.9205 41.224C50.4992 38.152 52.5898 35.6987 55.1925 33.864C57.8378 31.9867 60.6325 31.048 63.5765 31.048C64.5152 31.048 65.1338 31.24 65.4325 31.624C65.7738 31.9653 66.0512 32.6053 66.2645 33.544C67.1605 33.3733 68.0992 33.288 69.0805 33.288C71.1712 33.288 72.2165 34.0347 72.2165 35.528C72.2165 36.424 71.8965 38.5573 71.2565 41.928C70.2752 46.8347 69.7845 50.248 69.7845 52.168C69.7845 52.808 69.9338 53.32 70.2325 53.704C70.5738 54.088 71.0005 54.28 71.5125 54.28C72.3232 54.28 73.3045 53.768 74.4565 52.744C75.6085 51.6773 77.1658 49.9707 79.1285 47.624C79.6405 47.0267 80.2165 46.728 80.8565 46.728C81.4112 46.728 81.8378 46.984 82.1365 47.496C82.4778 48.008 82.6485 48.712 82.6485 49.608C82.6485 51.3147 82.2432 52.6373 81.4325 53.576C79.6832 55.752 77.8272 57.5867 75.8645 59.08C73.9018 60.5733 72.0032 61.32 70.1685 61.32C68.7605 61.32 67.4592 60.8507 66.2645 59.912C65.1125 58.9307 64.2378 57.608 63.6405 55.944C61.4218 59.528 58.6272 61.32 55.2565 61.32ZM57.5605 54.856C58.4992 54.856 59.3952 54.3013 60.2485 53.192C61.1018 52.0827 61.7205 50.6107 62.1045 48.776L64.4725 37C62.6805 37.0427 61.0165 37.7253 59.4805 39.048C57.9872 40.328 56.7925 42.0347 55.8965 44.168C55.0005 46.3013 54.5525 48.5627 54.5525 50.952C54.5525 52.2747 54.8085 53.256 55.3205 53.896C55.8752 54.536 56.6218 54.856 57.5605 54.856ZM105.991 46.728C106.546 46.728 106.972 46.984 107.271 47.496C107.612 48.008 107.783 48.712 107.783 49.608C107.783 51.3147 107.378 52.6373 106.567 53.576C104.732 55.8373 102.727 57.6933 100.551 59.144C98.375 60.5947 95.879 61.32 93.063 61.32C84.359 61.32 80.007 55.1973 80.007 42.952C80.007 41.0747 80.071 39.176 80.199 37.256H77.703C76.423 37.256 75.5483 37.0213 75.079 36.552C74.6523 36.0827 74.439 35.336 74.439 34.312C74.439 31.9227 75.399 30.728 77.319 30.728H80.967C81.6923 26.0347 82.8017 21.7467 84.295 17.864C85.7883 13.9813 87.5803 10.888 89.671 8.584C91.8043 6.28 94.087 5.128 96.519 5.128C98.311 5.128 99.719 5.91733 100.743 7.496C101.767 9.07467 102.279 11.0587 102.279 13.448C102.279 20.0613 99.5057 25.8213 93.959 30.728H101.127C101.81 30.728 102.3 30.8773 102.599 31.176C102.898 31.4747 103.047 32.0293 103.047 32.84C103.047 35.784 100.636 37.256 95.815 37.256H88.007C87.9217 39.3893 87.879 41.0533 87.879 42.248C87.879 46.6853 88.391 49.8 89.415 51.592C90.4817 53.384 92.1457 54.28 94.407 54.28C96.2417 54.28 97.863 53.7253 99.271 52.616C100.679 51.5067 102.343 49.8427 104.263 47.624C104.775 47.0267 105.351 46.728 105.991 46.728ZM94.791 11.272C94.151 11.272 93.4257 12.0827 92.615 13.704C91.847 15.2827 91.1003 17.5013 90.375 20.36C89.6923 23.176 89.1163 26.312 88.647 29.768C91.1643 27.592 93.0417 25.16 94.279 22.472C95.559 19.7413 96.199 17.2667 96.199 15.048C96.199 12.5307 95.7297 11.272 94.791 11.272ZM136.62 41.352C137.175 41.352 137.601 41.6293 137.9 42.184C138.199 42.7387 138.348 43.4427 138.348 44.296C138.348 45.3627 138.199 46.1947 137.9 46.792C137.601 47.3467 137.132 47.7307 136.492 47.944C133.932 48.84 131.116 49.352 128.044 49.48C127.191 53.0213 125.569 55.88 123.18 58.056C120.833 60.232 118.231 61.32 115.372 61.32C111.063 61.32 107.927 59.6773 105.964 56.392C104.001 53.1067 103.02 48.3493 103.02 42.12C103.02 36.616 103.703 30.6427 105.068 24.2C106.433 17.7147 108.417 12.2107 111.02 7.688C113.665 3.12266 116.801 0.839996 120.428 0.839996C122.391 0.839996 123.969 1.69333 125.164 3.4C126.359 5.064 126.956 7.24 126.956 9.928C126.956 13.4267 126.295 16.904 124.972 20.36C123.649 23.816 121.452 27.4427 118.38 31.24C121.239 31.4533 123.564 32.648 125.356 34.824C127.148 36.9573 128.215 39.6027 128.556 42.76C130.561 42.632 132.951 42.2053 135.724 41.48C135.98 41.3947 136.279 41.352 136.62 41.352ZM118.956 7.176C118.103 7.176 117.164 8.456 116.14 11.016C115.159 13.5333 114.241 16.968 113.388 21.32C112.535 25.672 111.895 30.4293 111.468 35.592C114.284 30.4293 116.524 25.8853 118.188 21.96C119.895 17.992 120.748 14.472 120.748 11.4C120.748 10.0347 120.577 8.98933 120.236 8.264C119.937 7.53866 119.511 7.176 118.956 7.176ZM115.628 54.536C116.951 54.536 118.124 53.9813 119.148 52.872C120.172 51.7627 120.855 50.1627 121.196 48.072C119.873 47.176 118.849 46.0027 118.124 44.552C117.441 43.1013 117.1 41.5653 117.1 39.944C117.1 39.3467 117.185 38.536 117.356 37.512H117.164C115.415 37.512 113.943 38.3867 112.748 40.136C111.596 41.8427 111.02 44.1467 111.02 47.048C111.02 49.48 111.468 51.336 112.364 52.616C113.303 53.896 114.391 54.536 115.628 54.536ZM165.462 41.352C166.017 41.352 166.443 41.6293 166.742 42.184C167.041 42.7387 167.19 43.4427 167.19 44.296C167.19 46.344 166.571 47.56 165.334 47.944C162.774 48.84 159.958 49.352 156.886 49.48C156.075 53.064 154.475 55.944 152.086 58.12C149.697 60.2533 146.987 61.32 143.958 61.32C141.398 61.32 139.201 60.7013 137.366 59.464C135.574 58.2267 134.209 56.584 133.27 54.536C132.331 52.488 131.862 50.2693 131.862 47.88C131.862 44.6373 132.481 41.7573 133.718 39.24C134.955 36.68 136.662 34.696 138.838 33.288C141.014 31.8373 143.425 31.112 146.07 31.112C149.313 31.112 151.915 32.2427 153.878 34.504C155.883 36.7227 157.057 39.4747 157.398 42.76C159.403 42.632 161.793 42.2053 164.566 41.48C164.907 41.3947 165.206 41.352 165.462 41.352ZM144.47 54.536C145.835 54.536 147.009 53.9813 147.99 52.872C149.014 51.7627 149.697 50.1627 150.038 48.072C148.715 47.176 147.691 46.0027 146.966 44.552C146.283 43.1013 145.942 41.5653 145.942 39.944C145.942 39.2613 146.006 38.5787 146.134 37.896H145.814C144.107 37.896 142.678 38.728 141.526 40.392C140.417 42.0133 139.862 44.3173 139.862 47.304C139.862 49.6507 140.31 51.4427 141.206 52.68C142.145 53.9173 143.233 54.536 144.47 54.536ZM195.745 41.352C196.3 41.352 196.726 41.6293 197.025 42.184C197.324 42.7387 197.473 43.4427 197.473 44.296C197.473 45.3627 197.324 46.1947 197.025 46.792C196.726 47.3467 196.257 47.7307 195.617 47.944C193.057 48.84 190.241 49.352 187.169 49.48C186.316 53.0213 184.694 55.88 182.305 58.056C179.958 60.232 177.356 61.32 174.497 61.32C170.188 61.32 167.052 59.6773 165.089 56.392C163.126 53.1067 162.145 48.3493 162.145 42.12C162.145 36.616 162.828 30.6427 164.193 24.2C165.558 17.7147 167.542 12.2107 170.145 7.688C172.79 3.12266 175.926 0.839996 179.553 0.839996C181.516 0.839996 183.094 1.69333 184.289 3.4C185.484 5.064 186.081 7.24 186.081 9.928C186.081 13.4267 185.42 16.904 184.097 20.36C182.774 23.816 180.577 27.4427 177.505 31.24C180.364 31.4533 182.689 32.648 184.481 34.824C186.273 36.9573 187.34 39.6027 187.681 42.76C189.686 42.632 192.076 42.2053 194.849 41.48C195.105 41.3947 195.404 41.352 195.745 41.352ZM178.081 7.176C177.228 7.176 176.289 8.456 175.265 11.016C174.284 13.5333 173.366 16.968 172.513 21.32C171.66 25.672 171.02 30.4293 170.593 35.592C173.409 30.4293 175.649 25.8853 177.313 21.96C179.02 17.992 179.873 14.472 179.873 11.4C179.873 10.0347 179.702 8.98933 179.361 8.264C179.062 7.53866 178.636 7.176 178.081 7.176ZM174.753 54.536C176.076 54.536 177.249 53.9813 178.273 52.872C179.297 51.7627 179.98 50.1627 180.321 48.072C178.998 47.176 177.974 46.0027 177.249 44.552C176.566 43.1013 176.225 41.5653 176.225 39.944C176.225 39.3467 176.31 38.536 176.481 37.512H176.289C174.54 37.512 173.068 38.3867 171.873 40.136C170.721 41.8427 170.145 44.1467 170.145 47.048C170.145 49.48 170.593 51.336 171.489 52.616C172.428 53.896 173.516 54.536 174.753 54.536ZM196.491 61.32C194.87 61.32 193.718 60.4667 193.035 58.76C192.395 57.0533 192.075 54.3227 192.075 50.568C192.075 45.0213 192.864 39.752 194.443 34.76C194.827 33.5227 195.446 32.6267 196.299 32.072C197.195 31.4747 198.432 31.176 200.011 31.176C200.864 31.176 201.462 31.2827 201.803 31.496C202.144 31.7093 202.315 32.1147 202.315 32.712C202.315 33.3947 201.995 34.9307 201.355 37.32C200.928 39.0267 200.587 40.52 200.331 41.8C200.075 43.0373 199.862 44.5947 199.691 46.472C200.843 43.144 202.208 40.328 203.787 38.024C205.408 35.72 207.051 34.0133 208.715 32.904C210.422 31.752 212.022 31.176 213.515 31.176C215.008 31.176 216.054 31.5173 216.651 32.2C217.291 32.8827 217.611 33.928 217.611 35.336C217.611 36.7013 217.206 39.176 216.395 42.76C216.054 44.296 215.819 45.448 215.691 46.216C217.824 40.968 220.192 37.1493 222.795 34.76C225.398 32.3707 227.83 31.176 230.091 31.176C232.864 31.176 234.251 32.5627 234.251 35.336C234.251 37 233.782 40.008 232.843 44.36C232.032 48.072 231.627 50.5253 231.627 51.72C231.627 53.4267 232.246 54.28 233.483 54.28C234.336 54.28 235.339 53.768 236.491 52.744C237.686 51.6773 239.264 49.9707 241.227 47.624C241.739 47.0267 242.315 46.728 242.955 46.728C243.51 46.728 243.936 46.984 244.235 47.496C244.576 48.008 244.747 48.712 244.747 49.608C244.747 51.3147 244.342 52.6373 243.531 53.576C241.696 55.8373 239.712 57.6933 237.579 59.144C235.488 60.5947 233.099 61.32 230.411 61.32C228.235 61.32 226.592 60.7013 225.483 59.464C224.374 58.184 223.819 56.3493 223.819 53.96C223.819 52.7653 224.118 50.632 224.715 47.56C225.27 44.872 225.547 43.016 225.547 41.992C225.547 41.3093 225.312 40.968 224.843 40.968C224.288 40.968 223.499 41.6933 222.475 43.144C221.451 44.552 220.427 46.4293 219.403 48.776C218.379 51.1227 217.547 53.5973 216.907 56.2C216.438 58.248 215.883 59.6133 215.243 60.296C214.646 60.9787 213.664 61.32 212.299 61.32C210.891 61.32 209.824 60.6587 209.099 59.336C208.416 57.9707 208.075 56.328 208.075 54.408C208.075 52.7867 208.288 50.44 208.715 47.368C209.056 44.6373 209.227 42.8453 209.227 41.992C209.227 41.3093 208.992 40.968 208.523 40.968C207.883 40.968 207.072 41.736 206.091 43.272C205.11 44.808 204.15 46.7707 203.211 49.16C202.315 51.5493 201.59 53.896 201.035 56.2C200.566 58.2053 200.011 59.5707 199.371 60.296C198.774 60.9787 197.814 61.32 196.491 61.32ZM247.444 61.32C244.799 61.32 242.687 60.36 241.108 58.44C239.529 56.52 238.74 54.0027 238.74 50.888C238.74 47.4747 239.529 44.2533 241.108 41.224C242.687 38.152 244.777 35.6987 247.38 33.864C250.025 31.9867 252.82 31.048 255.764 31.048C256.703 31.048 257.321 31.24 257.62 31.624C257.961 31.9653 258.239 32.6053 258.452 33.544C259.348 33.3733 260.287 33.288 261.268 33.288C263.359 33.288 264.404 34.0347 264.404 35.528C264.404 36.424 264.084 38.5573 263.444 41.928C262.463 46.8347 261.972 50.248 261.972 52.168C261.972 52.808 262.121 53.32 262.42 53.704C262.761 54.088 263.188 54.28 263.7 54.28C264.511 54.28 265.492 53.768 266.644 52.744C267.796 51.6773 269.353 49.9707 271.316 47.624C271.828 47.0267 272.404 46.728 273.044 46.728C273.599 46.728 274.025 46.984 274.324 47.496C274.665 48.008 274.836 48.712 274.836 49.608C274.836 51.3147 274.431 52.6373 273.62 53.576C271.871 55.752 270.015 57.5867 268.052 59.08C266.089 60.5733 264.191 61.32 262.356 61.32C260.948 61.32 259.647 60.8507 258.452 59.912C257.3 58.9307 256.425 57.608 255.828 55.944C253.609 59.528 250.815 61.32 247.444 61.32ZM249.748 54.856C250.687 54.856 251.583 54.3013 252.436 53.192C253.289 52.0827 253.908 50.6107 254.292 48.776L256.66 37C254.868 37.0427 253.204 37.7253 251.668 39.048C250.175 40.328 248.98 42.0347 248.084 44.168C247.188 46.3013 246.74 48.5627 246.74 50.952C246.74 52.2747 246.996 53.256 247.508 53.896C248.063 54.536 248.809 54.856 249.748 54.856ZM274.179 61.32C272.557 61.32 271.405 60.4667 270.723 58.76C270.083 57.0533 269.763 54.3227 269.763 50.568C269.763 45.0213 270.552 39.752 272.131 34.76C272.515 33.5227 273.133 32.6267 273.987 32.072C274.883 31.4747 276.12 31.176 277.699 31.176C278.552 31.176 279.149 31.2827 279.491 31.496C279.832 31.7093 280.003 32.1147 280.003 32.712C280.003 33.3947 279.683 34.9307 279.043 37.32C278.616 39.0267 278.275 40.52 278.019 41.8C277.763 43.08 277.549 44.6587 277.379 46.536C278.787 42.8667 280.365 39.88 282.115 37.576C283.864 35.272 285.571 33.6293 287.235 32.648C288.941 31.6667 290.499 31.176 291.907 31.176C293.272 31.176 294.296 31.5387 294.979 32.264C295.704 32.9467 296.067 33.9707 296.067 35.336C296.067 36.4453 295.832 38.536 295.363 41.608C294.936 44.2107 294.595 46.6853 294.339 49.032C294.083 51.336 293.955 53.9173 293.955 56.776C293.955 58.3973 293.613 59.5707 292.931 60.296C292.291 60.9787 291.224 61.32 289.731 61.32C288.323 61.32 287.299 60.9573 286.659 60.232C286.019 59.5067 285.699 58.4187 285.699 56.968C285.699 55.2613 285.997 52.4453 286.595 48.52C287.107 45.1067 287.363 42.9307 287.363 41.992C287.363 41.3093 287.128 40.968 286.659 40.968C286.104 40.968 285.315 41.6933 284.291 43.144C283.309 44.552 282.285 46.4293 281.219 48.776C280.195 51.1227 279.363 53.5973 278.723 56.2C278.253 58.2053 277.699 59.5707 277.059 60.296C276.461 60.9787 275.501 61.32 274.179 61.32ZM307.242 22.92C306.303 22.92 305.556 22.7067 305.002 22.28C304.447 21.8533 304.17 21.1707 304.17 20.232C304.17 19.848 304.234 19.4 304.362 18.888C304.831 16.9253 305.172 15.112 305.385 13.448C305.642 11.784 305.77 9.928 305.77 7.88C305.77 5.74666 306.26 4.104 307.242 2.952C308.266 1.8 309.567 1.224 311.146 1.224C312.682 1.224 313.834 1.65067 314.602 2.504C315.412 3.31466 315.818 4.424 315.818 5.832C315.818 7.32533 315.37 9.30933 314.474 11.784C313.578 14.2587 312.49 16.6693 311.21 19.016C310.356 20.5947 309.674 21.64 309.162 22.152C308.692 22.664 308.052 22.92 307.242 22.92ZM327.039 62.728C324.82 62.728 323.113 62.216 321.919 61.192C320.767 60.168 320.191 59.016 320.191 57.736C320.191 56.6267 320.596 55.6667 321.407 54.856C322.217 54.0453 323.412 53.64 324.991 53.64C325.545 53.64 326.185 53.704 326.911 53.832C327.679 53.9173 328.255 53.9813 328.639 54.024C328.596 52.9147 328.34 51.8693 327.871 50.888C327.444 49.9067 326.889 48.968 326.207 48.072C325.524 47.1333 324.884 46.3227 324.287 45.64C322.964 48.1573 321.641 50.248 320.319 51.912C319.039 53.576 317.631 55.1547 316.095 56.648C315.327 57.416 314.516 57.8 313.663 57.8C312.98 57.8 312.425 57.5653 311.998 57.096C311.572 56.584 311.358 55.9653 311.358 55.24C311.358 54.3867 311.657 53.5973 312.255 52.872L313.087 51.848C315.433 48.9467 317.204 46.5573 318.399 44.68C319.167 43.4427 319.935 41.9707 320.703 40.264C321.513 38.5573 322.559 36.232 323.839 33.288C324.649 31.4107 326.335 30.472 328.895 30.472C330.089 30.472 330.921 30.5787 331.391 30.792C331.86 31.0053 332.095 31.3467 332.095 31.816C332.095 32.072 332.009 32.4773 331.839 33.032C331.668 33.5867 331.433 34.1413 331.135 34.696C330.367 36.232 329.983 37.5333 329.983 38.6C329.983 39.24 330.196 39.944 330.623 40.712C331.092 41.48 331.796 42.44 332.735 43.592C334.1 45.384 335.124 46.92 335.807 48.2C336.532 49.4373 336.895 50.8027 336.895 52.296C336.895 54.088 336.468 55.7947 335.615 57.416C334.804 58.9947 333.652 60.2747 332.159 61.256C330.665 62.2373 328.959 62.728 327.039 62.728Z" fill="currentColor"></path> </svg> <svg class="text-primary mt-[-6px] sm:mt-[-5px]" width="130" height="91" viewBox="0 0 130 91" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M54.552 20.04C54.552 23.6667 53.272 26.8027 50.712 29.448C48.152 32.0507 44.4187 33.928 39.512 35.08C42.1573 35.8053 44.1627 37 45.528 38.664C46.8933 40.2853 47.576 42.1627 47.576 44.296C47.576 47.6667 46.5093 50.5893 44.376 53.064C42.2853 55.5387 39.2133 57.4587 35.16 58.824C31.1067 60.1467 26.2213 60.808 20.504 60.808C18.3707 60.808 16.664 60.744 15.384 60.616C15.3413 61.8107 14.8293 62.7067 13.848 63.304C12.8667 63.9013 11.608 64.2 10.072 64.2C8.536 64.2 7.46933 63.8587 6.872 63.176C6.31733 62.4933 6.08267 61.4907 6.168 60.168C6.552 54.1947 7.29867 47.944 8.408 41.416C9.51733 34.8453 10.9253 28.5093 12.632 22.408C12.9307 21.3413 13.528 20.5947 14.424 20.168C15.32 19.7413 16.4933 19.528 17.944 19.528C20.5467 19.528 21.848 20.2533 21.848 21.704C21.848 22.3013 21.72 22.984 21.464 23.752C20.3547 27.08 19.2453 31.6027 18.136 37.32C17.0267 42.9947 16.2373 48.4133 15.768 53.576C17.816 53.7467 19.48 53.832 20.76 53.832C26.7333 53.832 31.1067 52.9787 33.88 51.272C36.696 49.5227 38.104 47.304 38.104 44.616C38.104 42.7387 37.2933 41.16 35.672 39.88C34.0933 38.6 31.4267 37.896 27.672 37.768C26.8187 37.7253 26.2213 37.512 25.88 37.128C25.5387 36.744 25.368 36.1253 25.368 35.272C25.368 34.0347 25.624 33.032 26.136 32.264C26.648 31.496 27.5867 31.0907 28.952 31.048C31.9813 30.9627 34.712 30.5147 37.144 29.704C39.6187 28.8933 41.56 27.7627 42.968 26.312C44.376 24.8187 45.08 23.0907 45.08 21.128C45.08 18.6533 43.864 16.712 41.432 15.304C39 13.8533 35.2667 13.128 30.232 13.128C25.6667 13.128 21.2507 13.7253 16.984 14.92C12.7173 16.072 9.09067 17.544 6.104 19.336C4.73867 20.1467 3.58667 20.552 2.648 20.552C1.88 20.552 1.28267 20.296 0.856 19.784C0.472 19.2293 0.28 18.5467 0.28 17.736C0.28 16.6693 0.493333 15.752 0.92 14.984C1.38933 14.216 2.47733 13.3413 4.184 12.36C7.768 10.312 11.9707 8.712 16.792 7.56C21.6133 6.408 26.5413 5.832 31.576 5.832C39.2987 5.832 45.0587 7.13333 48.856 9.736C52.6533 12.3387 54.552 15.7733 54.552 20.04ZM79.2655 46.728C79.8202 46.728 80.2468 46.984 80.5455 47.496C80.8868 48.008 81.0575 48.712 81.0575 49.608C81.0575 51.3147 80.6522 52.6373 79.8415 53.576C78.0068 55.8373 76.0015 57.6933 73.8255 59.144C71.6922 60.5947 69.2602 61.32 66.5295 61.32C62.7748 61.32 59.9802 59.6133 58.1455 56.2C56.3535 52.7867 55.4575 48.3707 55.4575 42.952C55.4575 37.7467 56.1188 31.816 57.4415 25.16C58.8068 18.504 60.7908 12.7867 63.3935 8.008C66.0388 3.22933 69.1748 0.839996 72.8015 0.839996C74.8495 0.839996 76.4495 1.8 77.6015 3.72C78.7962 5.59733 79.3935 8.30667 79.3935 11.848C79.3935 16.9253 77.9855 22.8133 75.1695 29.512C72.3535 36.2107 68.5348 42.8453 63.7135 49.416C64.0122 51.1653 64.5028 52.424 65.1855 53.192C65.8682 53.9173 66.7642 54.28 67.8735 54.28C69.6228 54.28 71.1588 53.7893 72.4815 52.808C73.8042 51.784 75.4895 50.056 77.5375 47.624C78.0495 47.0267 78.6255 46.728 79.2655 46.728ZM71.3935 7.176C70.4122 7.176 69.3028 8.94667 68.0655 12.488C66.8282 16.0293 65.7402 20.424 64.8015 25.672C63.8628 30.92 63.3508 35.9547 63.2655 40.776C66.2948 35.784 68.7055 30.792 70.4975 25.8C72.2895 20.7653 73.1855 16.1787 73.1855 12.04C73.1855 8.79733 72.5882 7.176 71.3935 7.176ZM108.525 41.352C109.079 41.352 109.506 41.6293 109.805 42.184C110.103 42.7387 110.253 43.4427 110.253 44.296C110.253 46.344 109.634 47.56 108.397 47.944C105.837 48.84 103.021 49.352 99.9485 49.48C99.1378 53.064 97.5378 55.944 95.1485 58.12C92.7592 60.2533 90.0498 61.32 87.0205 61.32C84.4605 61.32 82.2632 60.7013 80.4285 59.464C78.6365 58.2267 77.2712 56.584 76.3325 54.536C75.3938 52.488 74.9245 50.2693 74.9245 47.88C74.9245 44.6373 75.5432 41.7573 76.7805 39.24C78.0178 36.68 79.7245 34.696 81.9005 33.288C84.0765 31.8373 86.4872 31.112 89.1325 31.112C92.3752 31.112 94.9778 32.2427 96.9405 34.504C98.9458 36.7227 100.119 39.4747 100.461 42.76C102.466 42.632 104.855 42.2053 107.629 41.48C107.97 41.3947 108.269 41.352 108.525 41.352ZM87.5325 54.536C88.8978 54.536 90.0712 53.9813 91.0525 52.872C92.0765 51.7627 92.7592 50.1627 93.1005 48.072C91.7778 47.176 90.7538 46.0027 90.0285 44.552C89.3458 43.1013 89.0045 41.5653 89.0045 39.944C89.0045 39.2613 89.0685 38.5787 89.1965 37.896H88.8765C87.1698 37.896 85.7405 38.728 84.5885 40.392C83.4792 42.0133 82.9245 44.3173 82.9245 47.304C82.9245 49.6507 83.3725 51.4427 84.2685 52.68C85.2072 53.9173 86.2952 54.536 87.5325 54.536ZM126.456 33.288C127.522 33.288 128.269 33.4587 128.696 33.8C129.165 34.0987 129.4 34.7173 129.4 35.656C129.4 36.168 129.378 36.5733 129.336 36.872C129.165 38.1947 128.632 41.608 127.736 47.112C127.096 50.824 126.69 53.2773 126.52 54.472C124.898 65.48 122.701 74.1627 119.928 80.52C117.197 86.92 113.528 90.12 108.92 90.12C106.744 90.12 104.973 89.4373 103.608 88.072C102.242 86.7493 101.559 85 101.559 82.824C101.559 79.7947 102.754 76.5307 105.144 73.032C107.533 69.576 112.013 65.3093 118.583 60.232L118.968 57.736C118.242 58.888 117.282 59.784 116.088 60.424C114.936 61.0213 113.784 61.32 112.632 61.32C109.986 61.32 107.874 60.36 106.296 58.44C104.717 56.52 103.928 54.0027 103.928 50.888C103.928 47.4747 104.717 44.2533 106.296 41.224C107.874 38.152 109.965 35.6987 112.568 33.864C115.213 31.9867 118.008 31.048 120.952 31.048C121.89 31.048 122.509 31.24 122.808 31.624C123.149 31.9653 123.426 32.6053 123.64 33.544C124.45 33.3733 125.389 33.288 126.456 33.288ZM114.936 54.856C115.917 54.856 116.856 54.2587 117.752 53.064C118.648 51.8693 119.288 50.1627 119.672 47.944L121.72 37C119.97 37.0427 118.349 37.7253 116.856 39.048C115.362 40.328 114.168 42.0347 113.272 44.168C112.376 46.3013 111.928 48.5627 111.928 50.952C111.928 52.2747 112.184 53.256 112.696 53.896C113.25 54.536 113.997 54.856 114.936 54.856ZM109.624 83.912C110.69 83.912 111.885 82.632 113.208 80.072C114.573 77.512 115.874 73.4373 117.112 67.848C113.826 70.664 111.458 73.2027 110.008 75.464C108.557 77.7253 107.832 79.7093 107.832 81.416C107.832 82.1413 107.96 82.7387 108.216 83.208C108.514 83.6773 108.984 83.912 109.624 83.912Z" fill="currentColor"></path> </svg> </div></a></div> <div class="bg-block z-50 shadow-custom-light dark:shadow-custom-dark" id="stickyHeader" data-astro-cid-4wsjtibl> <div class="max-w-5xl flex flex-wrap items-center justify-between mx-auto p-2 sm:p-0" data-astro-cid-4wsjtibl> <div class="flex space-x-2" data-astro-cid-4wsjtibl> <div id="lang-data" data-lang="zh" style="display: none;"></div> <button id="language-dropdown-button" data-dropdown-toggle="language-dropdown-menu" type="button" class="p-2 w-10 h-10 font-medium text-default hover:text-secondary hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg"> ZH </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-page divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="language-dropdown-menu"> <ul class="py-2 font-medium text-sm" role="none"> <li> <a href="/en/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
English
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="EN-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <a href="" class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem"> <div class="inline-flex items-center">
中文
<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 ml-2 hidden text-primary" id="ZH-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path></svg> </div> </a> </li> <li> <div class="border-t border-gray-200 dark:border-gray-800 w-4/5 mx-auto my-2"></div> <button class="block px-4 py-2 text-default hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" role="menuitem" id="set-default-lang"> <div class="inline-flex items-center"> 将中文设置为默认 </div> </button> </li> </ul> </div>  <button id="theme-dropdown-button" data-dropdown-toggle="theme-dropdown-menu" type="button" class="group p-2 w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"> <svg viewBox="0 0 24 24" id="theme_icon_system" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <svg viewBox="0 0 24 24" id="theme_icon_dark" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <svg viewBox="0 0 24 24" id="theme_icon_light" class="w-5 h-5 text-default fill-current group-hover:text-secondary hidden" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> </button> <!-- Dropdown --> <div class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700" id="theme-dropdown-menu"> <ul class="py-2 font-medium" role="none"> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_light"> <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current" astro-icon="tabler:sun"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><circle cx="12" cy="12" r="4"/><path d="M3 12h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></g></svg> <span class="ml-2 dark:hover:text-white">Light</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_dark"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:moon"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3h.393a7.5 7.5 0 0 0 7.92 12.446A9 9 0 1 1 12 2.992z"/></svg> <span class="ml-2 text-default dark:hover:text-white">Dark</span> </button> </li> <li class="hover:bg-gray-100 dark:hover:bg-gray-600"> <button class="flex px-4 py-2 text-sm align-text-center dark:hover:text-white text-default" id="theme_button_system"> <svg viewBox="0 0 24 24" class="w-5 h-5" astro-icon="tabler:device-laptop"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon-tabler"><path d="M3 19h18"/><rect width="14" height="10" x="5" y="6" rx="1"/></g></svg> <span class="ml-2 dark:hover:text-white">System</span> </button> </li> </ul> </div> <script>
  (async () => {
    const { setTheme } = await import('/js/theme.js');
    // Use setTheme here
    // Change the icons inside the button based on previous settings
    // 如果 localStorage 里面有设置过 color-theme 的值, 则 themeToggleSystemIcon.classList.remove('hidden')
    function setThemeButton() {
      let theme = localStorage.getItem('color-theme');
      if (theme === 'dark') {
        themeToggleDarkIcon.classList.remove('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else if (theme === 'light') {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.remove('hidden');
        themeToggleSystemIcon.classList.add('hidden');
      } else {
        themeToggleDarkIcon.classList.add('hidden');
        themeToggleLightIcon.classList.add('hidden');
        themeToggleSystemIcon.classList.remove('hidden');
      }
    }

    // 监听暗黑模式的变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
      setThemeButton();
    });

    // 保证其他的页面也能够监听到 localStorage 的变化
    window.addEventListener('storage', function (event) {
      if (event.key === 'color-theme') {
        setThemeButton();
      }
    });

    function resetTheme() {
      setTheme();
      setThemeButton();
    }

    // 获取按钮
    var themeButtonLight = document.getElementById('theme_button_light');
    var themeButtonDark = document.getElementById('theme_button_dark');
    var themeButtonSystem = document.getElementById('theme_button_system');
    // 获取图标
    var themeToggleDarkIcon = document.getElementById('theme_icon_dark');
    var themeToggleLightIcon = document.getElementById('theme_icon_light');
    var themeToggleSystemIcon = document.getElementById('theme_icon_system');

    // Listen for clicks on the button themeToggleDarkIcon
    themeButtonDark.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'dark');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleLightIcon
    themeButtonLight.addEventListener('click', function () {
      localStorage.setItem('color-theme', 'light');
      resetTheme();
    });

    // // Listen for clicks on the button themeToggleSystemIcon
    themeButtonSystem.addEventListener('click', function () {
      localStorage.removeItem('color-theme');
      resetTheme();
    });

    resetTheme();
  })();
</script> <link rel="stylesheet" href="/style/docsearch.css"><div id="docsearch" class="group w-10 h-10 text-default hover:bg-gray-100 dark:hover:bg-page focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600 rounded-lg flex items-center justify-center"></div> </div> <button data-collapse-toggle="navbar-solid-bg" type="button" class="inline-flex items-center p-2 mx-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-solid-bg" aria-expanded="false" id="navbar-toggle-button"> <span class="sr-only">Open main menu</span> <svg class="w-5 h-5 text-default" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path> </svg> </button> <nav class="hidden w-full md:block md:w-auto px-4 z-40" id="navbar-solid-bg"> <ul class="flex flex-col font-bold mt-4 rounded-lg bg-gray-50 md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0 md:bg-transparent dark:bg-gray-800 md:dark:bg-transparent dark:border-gray-700"> <a href="/zh/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 首页 </a><a href="/zh/posts/" class="block py-2 px-3 md:p-0 rounded text-invert bg-secondary md:bg-transparent md:text-secondary md:dark:bg-transparent" aria-current="page"> 文章 </a><a href="/zh/weekly/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 周报 </a><a href="/zh/snippet/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 小贴士 </a><a href="/zh/about/" class="block py-2 px-3 md:p-0 rounded  text-heading md:hover:text-secondary hover:bg-gray-100 dark:hover:bg-gray-700 md:hover:bg-transparent md:dark:hover:bg-transparent"> 关于 </a> </ul> </nav>  </div> </div> <div id="placeholder" class="hidden" data-astro-cid-4wsjtibl></div> </div> <script>(function(){const enableSticky = true;
const enableStickyInMobile = true;

  window.onload = function () {
    checkStickyHeader();
    stickySetup();
  };

  window.addEventListener('resize', stickySetup);

  function checkStickyHeader() {
    const title = document.getElementById('blogTitle');
    const stickyHeader = document.getElementById('stickyHeader');
    const placeholder = document.getElementById('placeholder');

    if (title && stickyHeader && placeholder) {
      const offset = title.offsetTop + title.offsetHeight;

      if (shouldStick() && window.scrollY >= offset) {
        stickyHeader.classList.add('sticky');
        placeholder.style.display = 'block';
        placeholder.style.height = `${stickyHeader.offsetHeight}px`;
      } else {
        stickyHeader.classList.remove('sticky');
        placeholder.style.display = 'none';
      }
    }
  }

  function shouldStick() {
    if (!enableSticky) return false;

    let isMobile = window.matchMedia('(max-width: 640px)').matches;
    if (isMobile && !enableStickyInMobile) return false;

    return true;
  }

  function stickySetup() {
    window.onscroll = checkStickyHeader;
  }
})();</script>  </header> <main class="w-full mx-auto max-w-3xl p-4 md:p-6 "> <div class="container mx-auto space-y-6 sm:space-y-12">   <div class="mx-auto space-y-4 text-center py-10" style="width:80%"> <div class="flex mx-auto justify-center"> <div class="flex mx-auto justify-center"> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/zh/tags/SwiftData/">
#SwiftData </a><a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/zh/tags/SwiftUI/">
#SwiftUI </a> <a class="text-xs font-medium sm:font-semibold mx-2 text-muted hover:text-secondary" href="/en/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/" id="language-switcher-for-topic"> #English </a> </div> </div> <h1 class="text-2xl font-bold leadi md:text-3xl text-heading">SwiftData 实战：用现代方法构建 SwiftUI 应用</h1> <p class="text-sm text-default"> <a itemprop="author" href="https://twitter.com/fatbobman" class="hover:text-secondary font-medium">东坡肘子</a> <!-- <time datetime={`${post.data.publishDate.toISOString()}`}>{date}</time> --> </p> <p class="text-xs text-muted"> 发表于 <time datetime="2024-03-21T00:20:00.000Z">2024 年 3 月 21 日</time>  </p> </div> <div class="w-full mx-auto text-center pb-0 sm:pb-6 pt-0"> <div id="custom-substack-embed"></div> <div class="text-xs font-medium text-heading p-4">为您每周带来有关 Swift 和 SwiftUI 的精选资讯！</div> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };

    // 创建一个新的 MutationObserver 实例
    const observer = new MutationObserver((mutationsList, observer) => {
      // 遍历所有的 mutations
      for (let mutation of mutationsList) {
        // 如果这个 mutation 是一个子节点的添加或删除
        if (mutation.type === 'childList') {
          // 查找订阅框
          const widget = document.querySelector('.custom-substack-widget');
          if (widget) {
            // 查找 input 元素
            const input = widget.querySelector('input');
            const button = widget.querySelector('button');
            // 根据当前的颜色方案修改订阅框的样式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              // 暗黑模式
              widget.style.padding = '0.5rem';
              widget.style.borderRadius = '1.2rem 1.2rem 1.2rem 1.2rem';
              widget.style.border = '0.1px solid var(--aw-color-text-muted)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--aw-background-color)';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.borderRadius = '0.8rem 0.8rem 0.8rem 0.8rem';
              button.style.maxWidth = '100px';
              button.style.fontWeight = 'bold';
            } else {
              // 正常模式
              widget.style.padding = '0.5rem';
              widget.style.borderRadius = '1.2rem 1.2rem 1.2rem 1.2rem';
              widget.style.border = '0.1px solid var(--aw-color-text-muted)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--aw-background-color)';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.borderRadius = '0.8rem 0.8rem 0.8rem 0.8rem';
              button.style.maxWidth = '100px';
              button.style.fontWeight = 'bold';
            }

            if (window.matchMedia('(max-width: 640px)').matches) {
              // 屏幕尺寸小于 640px
              widget.style.maxWidth = '325px';
            } else {
              // 屏幕尺寸大于或等于 640px
              widget.style.maxWidth = '400px';
            }
            // 停止观察
            observer.disconnect();
          }
        }
      }
    });

    // 开始观察 #custom-substack-embed 元素的子节点的变化
    observer.observe(document.getElementById('custom-substack-embed'), { childList: true });
  })();</script> <script src="https://substackapi.com/widget.js" async></script> </div> <svg style="display: none;"> <symbol id="icon-clipboard" viewBox="0 0 1024 1024"> <path d="M426.666667 42.666667l170.666667 0q41.344 0 74.325333 23.850667t46.336 61.482667l50.005333 0q52.992 0 90.496 37.504t37.504 90.496l0 597.333333q0 52.992-37.504 90.496t-90.496 37.504l-512 0q-52.992 0-90.496-37.504t-37.504-90.496l0-597.333333q0-52.992 37.504-90.496t90.496-37.504l50.005333 0q13.312-37.674667 46.336-61.482667t74.325333-23.850667zM768 213.333333l-50.005333 0q-13.312 37.674667-46.336 61.482667t-74.325333 23.850667l-170.666667 0q-41.344 0-74.325333-23.850667t-46.336-61.482667l-50.005333 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333l0 597.333333q0 17.664 12.501333 30.165333t30.165333 12.501333l512 0q17.664 0 30.165333-12.501333t12.501333-30.165333l0-597.333333q0-17.664-12.501333-30.165333t-30.165333-12.501333zM597.333333 128l-170.666667 0q-17.664 0-30.165333 12.501333t-12.501333 30.165333 12.501333 30.165333 30.165333 12.501333l170.666667 0q17.664 0 30.165333-12.501333t12.501333-30.165333-12.501333-30.165333-30.165333-12.501333z"></path> </symbol> <symbol id="icon-check" viewBox="0 0 1024 1024"> <path d="M421.858 683.366l401.796-448.518c18.66-20.828 50.668-22.586 71.498-3.928 20.828 18.66 22.586 50.67 3.928 71.498L463.638 788.494c-18.606 20.768-50.5 22.586-71.344 4.066l-263.29-233.924c-20.906-18.572-22.796-50.576-4.222-71.48 18.574-20.906 50.576-22.796 71.48-4.222L421.86 683.366z"></path> </symbol> </svg> <div class="relative" id="article-area"> <article class="prose dark:prose-invert mx-auto w-full"> <div> <!-- <AdsBannerTest /> --> 
<p>在之前的文章 <a href="/zh/posts/concurret-programming-in-swiftdata/" target="_blank">SwiftData 中的并发编程</a> 中，我们深入探讨了 SwiftData 提出的创新并发编程模式，包括它的原理、核心操作及相关的注意事项。这种优雅的编程解决方案赢得了不少赞誉。然而，随着更多开发者在实际的 SwiftUI 应用中尝试使用 SwiftData，他们遇到了一些挑战：尤其在启用 Swift 的严格并发检查后，发现 SwiftData 基于 Actor 的并发模型与传统的应用构建方法很难融合。本文将采用类似教程的方式阐述如何将 SwiftData 与现代编程理念相结合，顺畅地融入 SwiftUI 应用之中，同时提供策略来应对目前开发者面临的挑战。</p>
<div class="dynamic-ad-container pt-4"></div>
<h2 id="什么是所谓的现代方法">什么是所谓的现代方法？</h2>
<p>在探讨现代编程方法时，虽然不同的开发者可能会有不同的见解，但有些核心原则是广泛认同的。在使用 SwiftData 构建 SwiftUI 应用的上下文中，我认为现代编程方法至少应满足以下几个关键标准：</p>
<ul>
<li><strong>模块化</strong>：通过将数据定义和操作逻辑封装在独立的模块中，我们不仅能增强代码的可读性和可维护性，还能促进功能的重用。模块化是确保项目结构清晰、灵活应对未来变化的基石。</li>
<li><strong>全面可测试</strong>：确保每一个数据操作都通过彻底的单元测试是至关重要的。这种做法保证了代码的可靠性和稳定性，同时也使得持续集成和部署过程更加顺畅。</li>
<li><strong>线程安全</strong>：在并发编程中保持数据的完整性和一致性是极其重要的。有效的线程安全措施不仅防止了数据冲突和竞态条件，而且符合 Swift 的严格并发标准，确保应用的高性能和稳定运行。</li>
<li><strong>与架构无关</strong>：一个强大的数据管理模块应当灵活适应不同的架构设计，无论是 SwiftUI 自身的数据注入机制还是整合其他第三方框架，都应无缝对接，展现出高度的适应性。</li>
<li><strong>支持预览</strong>：SwiftUI 的预览功能是其开发体验中的一大亮点，允许开发者即时看到界面变化。因此，确保数据层支持这一功能，对于加快开发流程和提高效率至关重要。</li>
<li><strong>数据展示与操作分离</strong>：在遵循 SwiftUI 的响应式设计原则的同时，有效地分离数据展示与操作逻辑。通过 <code>@Query</code> 直观地展示数据并响应变化，而将创建、更新、删除等操作交由 SwiftData 的新并发模式处理，这样既提升了效率，又充分利用了 SwiftUI 响应式框架的优势。</li>
</ul>
<p>为了更好地理解本文所讨论的概念，并实际看到这些现代编程方法在实践中的应用，我准备了一个演示项目。你可以通过访问以下 GitHub 仓库来获取完整的项目代码：</p>
<p><a href="https://github.com/fatbobman/SwiftDataConcurrencyDemo?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">访问演示项目代码</a></p>
<p>该项目包含了使用 SwiftData 在 SwiftUI 应用中实现的示例，展示了如何按照文章中介绍的现代编程标准来构建应用。</p>
<h2 id="创建数据管理模块">创建数据管理模块</h2>
<p>长久以来，将数据管理逻辑抽离出主项目，封装到一个独立的模块中，一直是一个广受推崇的做法。许多开发者在使用 Core Data 的项目中也采纳了这种模式。然而，与 SwiftData 相比，Core Data 在模块化方面给开发者带来了额外的挑战。这主要是由于 Core Data 在构建数据模型时使用图形化的模型编辑器，而数据模型本身则存储为独立的文件，它们会在应用的不同生命周期阶段以不同的文件扩展名被加载。这种对外部模型文件的依赖，在很大程度上减弱了开发者将数据管理代码模块化的意愿。</p>
<p>而 SwiftData，它的纯代码声明方式极大地简化了这一过程，实际上已经没有借口不将数据管理逻辑独立化了。这种方法不仅简化了代码的维护，而且还增加了代码的可移植性和可重用性。</p>
<p>考虑到数据管理模块通常与特定项目高度相关，在展示项目中我在项目的当前目录下创建一个新的 Swift Package，而不是为它建立一个单独的仓库。</p>
<p>首先创建一个名为 <code>DataProvider</code> 的包。在其 <code>Package.swift</code> 文件中，我们启用了 Swift 的严格并发检查功能，确保并发代码的安全性：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">.</span><span style="color:#8BE9FD">target</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#8BE9FD">  name</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">DataProvider</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#8BE9FD">  swiftSettings</span><span style="color:#F8F8F2">: [</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">enableExperimentalFeature</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">StrictConcurrency</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">  ]</span></span>
<span class="line"><span style="color:#F8F8F2">),</span></span></code></pre></div>
<p><picture>
                    <source media="(max-width: 479px)" srcset="https://cdn.fatbobman.com/image-20240316210229483-zipic.png?imageView2/0/w/500"/>
                    <img src="https://cdn.fatbobman.com/image-20240316210229483-zipic.png" alt="image-20240316210229483" loading="lazy"/>
                  </picture></p>
<p>在这个独立的模块中，我们将完成数据模型的定义、数据操作逻辑的实现以及相关的测试工作。这样的结构不仅清晰地划分了应用的不同关注点，还使得维护和测试工作变得更加高效。</p>
<h2 id="构建数据模型">构建数据模型</h2>
<p>在 SwiftData 中，构建数据模型的方法与定义 Swift 的基础类型极为相似，仅需通过纯代码即可完成。在我们的演示项目中，我们定义了一个简洁的模型 <code>Item</code>：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@Model</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> timestamp: Date</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createTimestamp: Date</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">timestamp</span><span style="color:#F8F8F2">: Date) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    self</span><span style="color:#F8F8F2">.timestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> timestamp</span></span>
<span class="line"><span style="color:#F8F8F2">    createTimestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> .now</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>需要注意的是，采用 SwiftData 的纯代码建模方式意味着，一旦应用部署后需要修改数据模型或进行数据迁移，我们必须手动管理所有版本的数据模型。因此，尽管目前我们的模型版本只有一个，最好从一开始就规划好数据迁移的策略。</p>
<p>为此，我们首先定义一个用于表示模型版本的枚举，并通过 <code>CurrentScheme</code> 类型别名将其标记为当前使用的版本：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> typealias</span><span style="color:#8BE9FD;font-style:italic"> CurrentScheme</span><span style="color:#FF79C6"> =</span><span style="color:#F8F8F2"> SchemaV1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> enum</span><span style="color:#8BE9FD;font-style:italic"> SchemaV1</span><span style="color:#F8F8F2">: VersionedSchema {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> static</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> versionIdentifier: Schema.Version {</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#FF79C6">init</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> static</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> models: [</span><span style="color:#FF79C6">any</span><span style="color:#F8F8F2"> PersistentModel.</span><span style="color:#FF79C6">Type</span><span style="color:#F8F8F2">] {</span></span>
<span class="line"><span style="color:#F8F8F2">    [Item.</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>接下来，我们将 <code>Item</code> 类的声明嵌入到 <code>SchemaV1</code> 中，并通过类型别名保持名称的连贯性：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> typealias</span><span style="color:#8BE9FD;font-style:italic"> Item</span><span style="color:#FF79C6"> =</span><span style="color:#F8F8F2"> SchemaV1.Item</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> SchemaV1</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  @Model</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> timestamp: Date</span></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createTimestamp: Date</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">timestamp</span><span style="color:#F8F8F2">: Date) {</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">      self</span><span style="color:#F8F8F2">.timestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> timestamp</span></span>
<span class="line"><span style="color:#F8F8F2">      createTimestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> .now</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>在我们的演示项目中，为了简化学习过程，我们没有进一步扩展数据模型。但在实际应用中，开发者可以通过扩展来为数据模型增加预设的谓词、排序规则或 FetchDescriptor 等信息，详见<a href="https://gist.github.com/fatbobman/6dc873ae18bb28cd1ccc521b3f56cefb?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">此示例代码</a>。</p>
<p>现在，无论是在模块内还是外部，我们都可以使用 <code>Item</code> 来引用这个版本的数据模型。若未来模型有变更，我们可以轻松地引入新的 Schema 版本，比如 <code>SchemaV2</code>，并相应地调整类型别名，以适应新的模型结构。</p>
<blockquote>
<p>要深入了解 SwiftData 数据模型的构建原理，请参阅 <a href="/zh/posts/unveiling-the-data-modeling-principles-of-swiftdata/" target="_blank">揭秘 SwiftData 的数据建模原理</a>。此外，若对 SwiftData 的数据模型迁移方法感兴趣，可阅读 <a href="/zh/posts/what-s-new-in-core-data-in-wwdc23/#%E9%98%B6%E6%AE%B5%E5%BC%8F%E8%BF%81%E7%A7%BB-staged-migration" target="_blank">这篇文章</a> ，其中介绍了迁移策略和实施步骤。</p>
</blockquote>
<h2 id="swiftdata-同样需要-stack">SwiftData 同样需要 Stack</h2>
<p>在 Core Data 项目中，开发者习惯于构建一个类似于 Stack 的结构，用以集中管理持久化容器的声明和数据操作逻辑。SwiftData 显著简化了这一过程，允许开发者通过直接调用例如 <code>.modelContainer(for: Item.self)</code> 的简洁方式来快速构建容器并进行数据注入。那么，在使用 SwiftData 的场景下，是否还需要维护一个类似于 Stack 的结构呢？</p>
<p>尽管接下来我们将采用 <code>@ModelActor</code> 宏来封装数据操作逻辑，但构建一个类似于 Stack 的结构依然十分重要。这样的结构不仅为应用的不同部分统一提供容器和 <code>@ModelActor</code> 实现，而且在尝试结合 SwiftData 和 Core Data 双框架模式的项目中尤为关键，因为它可以在同一位置处理两种框架的容器构建。</p>
<p>在我们的演示项目里，我们定义了一个 <code>DataProvider</code> 类。这个类在功能上类似于 Core Data 项目中常用的 <code>CoreDataStack</code>：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> DataProvider</span><span style="color:#F8F8F2">: Sendable {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> static</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> shared </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DataProvider</span><span style="color:#F8F8F2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> sharedModelContainer: ModelContainer </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> schema </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Schema</span><span style="color:#F8F8F2">(CurrentScheme.models)</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> modelConfiguration </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> ModelConfiguration</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">schema</span><span style="color:#F8F8F2">: schema, </span><span style="color:#8BE9FD">isStoredInMemoryOnly</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">false</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    do</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">      return</span><span style="color:#FF79C6"> try</span><span style="color:#8BE9FD"> ModelContainer</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: schema, </span><span style="color:#8BE9FD">configurations</span><span style="color:#F8F8F2">: [modelConfiguration])</span></span>
<span class="line"><span style="color:#F8F8F2">    } </span><span style="color:#FF79C6">catch</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">      fatalError</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Could not create ModelContainer: </span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">error</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">() {}</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>在这里，构建 schema 时直接利用了 <code>CurrentScheme.models</code> 提供的类型信息。此外，若数据模型需要迁移，相应的迁移逻辑也将在 <code>sharedModelContainer</code> 的初始化闭包中实现。</p>
<blockquote>
<p>请阅读 <a href="/zh/posts/masteringofcoredatastack/" target="_blank">掌握 Core Data Stack</a> ，了解更多 Core Data Stack 的构建技巧。</p>
</blockquote>
<h2 id="用-modelactor-封装数据操作逻辑">用 @ModelActor 封装数据操作逻辑</h2>
<p>SwiftData 提供了 <code>@ModelActor</code> 宏，鼓励开发者利用这一功能来创建一个 Actor 类型，进而在其中封装数据操作逻辑。对于我们的 <code>Item</code> 类型，我们定义了创建、更新和删除数据项的相关逻辑：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@ModelActor</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> actor</span><span style="color:#8BE9FD;font-style:italic"> DataHandler</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  @discardableResult</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> newItem</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">date</span><span style="color:#F8F8F2">: Date) </span><span style="color:#FF79C6">throws</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> PersistentIdentifier {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> item </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Item</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">timestamp</span><span style="color:#F8F8F2">: date)</span></span>
<span class="line"><span style="color:#F8F8F2">    modelContext.</span><span style="color:#8BE9FD">insert</span><span style="color:#F8F8F2">(item)</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#F8F8F2"> modelContext.</span><span style="color:#8BE9FD">save</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> item.persistentModelID</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> updateItem</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">id</span><span style="color:#F8F8F2">: PersistentIdentifier, </span><span style="color:#50FA7B;font-style:italic">timestamp</span><span style="color:#F8F8F2">: Date) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> item </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9;font-style:italic"> self</span><span style="color:#F8F8F2">[id, </span><span style="color:#8BE9FD">as</span><span style="color:#F8F8F2">: Item.</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">return</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#F8F8F2">    item.timestamp </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> timestamp</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#F8F8F2"> modelContext.</span><span style="color:#8BE9FD">save</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> deleteItem</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">id</span><span style="color:#F8F8F2">: PersistentIdentifier) </span><span style="color:#FF79C6">throws</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    guard</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> item </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9;font-style:italic"> self</span><span style="color:#F8F8F2">[id, </span><span style="color:#8BE9FD">as</span><span style="color:#F8F8F2">: Item.</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> { </span><span style="color:#FF79C6">return</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#F8F8F2">    modelContext.</span><span style="color:#8BE9FD">delete</span><span style="color:#F8F8F2">(item)</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#F8F8F2"> modelContext.</span><span style="color:#8BE9FD">save</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>在实现这些功能时，有几点需要特别注意：</p>
<ul>
<li>更新和删除操作仅接受 <code>PersistentIdentifier</code> 作为参数。</li>
<li>创建新的 Item 实例后，该方法会返回新创建对象的 <code>PersistentIdentifier</code>。虽然在许多实际应用场景中这个返回值可能不常用，但它在进行单元测试时非常有用，提供了一种有效的方式来引用和测试新创建的数据实体。</li>
</ul>
<blockquote>
<p>为深入理解 <code>@ModelActor</code> 的用法及其在 SwiftData 中的角色，请参考文章 <a href="/zh/posts/concurret-programming-in-swiftdata/" target="_blank">SwiftData 中的并发编程</a>。</p>
</blockquote>
<h2 id="编写测试">编写测试</h2>
<p>尽管基于测试驱动开发（TDD）的逻辑通常推荐先编写测试再实现功能，但在我们的演示项目中，我们会在完成数据操作逻辑后才构建测试单元。</p>
<p>首先，我们设置一个专用于测试的辅助函数，确保每个测试用例都能使用一个干净的数据库环境：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">enum</span><span style="color:#8BE9FD;font-style:italic"> ContainerForTest</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  static</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> temp</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B">_</span><span style="color:#FFB86C;font-style:italic"> name</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">String</span><span style="color:#F8F8F2">, </span><span style="color:#50FA7B;font-style:italic">delete</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> true</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">throws</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> ModelContainer {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> url </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> URL.temporaryDirectory.</span><span style="color:#8BE9FD">appending</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">component</span><span style="color:#F8F8F2">: name)</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> delete, FileManager.default.</span><span style="color:#8BE9FD">fileExists</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">atPath</span><span style="color:#F8F8F2">: url.path) {</span></span>
<span class="line"><span style="color:#FF79C6">      try</span><span style="color:#F8F8F2"> FileManager.default.</span><span style="color:#8BE9FD">removeItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">at</span><span style="color:#F8F8F2">: url)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> schema </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Schema</span><span style="color:#F8F8F2">(CurrentScheme.models)</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> configuration </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> ModelConfiguration</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">url</span><span style="color:#F8F8F2">: url)</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try!</span><span style="color:#8BE9FD"> ModelContainer</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: schema, </span><span style="color:#8BE9FD">configurations</span><span style="color:#F8F8F2">: configuration)</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> container</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>该辅助函数为每个测试用例创建独立的数据库，数据库名称基于测试函数的名称。默认情况下，它会在每次测试前删除旧的数据文件。</p>
<p>下面是一个测试用例，用于验证创建新的 <code>Item</code> 实例的功能：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">final</span><span style="color:#FF79C6"> class</span><span style="color:#8BE9FD"> DataProviderTests</span><span style="color:#F8F8F2">: XCTestCase {</span></span>
<span class="line"><span style="color:#FF79C6">  @MainActor</span></span>
<span class="line"><span style="color:#FF79C6">  func</span><span style="color:#50FA7B"> testNewItem</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> throws</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">    // Arrange</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try</span><span style="color:#F8F8F2"> ContainerForTest.</span><span style="color:#8BE9FD">temp</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">#function</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> hander </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DataHandler</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">modelContainer</span><span style="color:#F8F8F2">: container)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // ACT</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> date </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Date</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">timeIntervalSince1970</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">    try</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> hander.</span><span style="color:#8BE9FD">newItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">date</span><span style="color:#F8F8F2">: date)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // Assert</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> fetchDescriptor </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> FetchDescriptor</span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2">Item</span><span style="color:#FF79C6">&gt;</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> items </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> try</span><span style="color:#F8F8F2"> container.mainContext.</span><span style="color:#8BE9FD">fetch</span><span style="color:#F8F8F2">(fetchDescriptor)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8BE9FD">    XCTAssertNotNil</span><span style="color:#F8F8F2">(items.</span><span style="color:#BD93F9">first</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">The item should be created and fetched successfully.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#8BE9FD">    XCTAssertEqual</span><span style="color:#F8F8F2">(items.</span><span style="color:#BD93F9">count</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">There should be exactly one item in the store.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> firstItem </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> items.</span><span style="color:#8BE9FD">first</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">      XCTAssertEqual</span><span style="color:#F8F8F2">(firstItem.timestamp, date, </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">The item&#39;s timestamp should match the initially provided date.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    } </span><span style="color:#FF79C6">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">      XCTFail</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Expected to find an item but none was found.</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>测试流程概述：</p>
<ul>
<li>初始化一个新的、干净的数据库实例。</li>
<li>利用 <code>DataHandler</code> 添加新的数据项。</li>
<li>通过容器的 <code>mainContext</code> 从数据库中检索 <code>Item</code> 数据。</li>
<li>断言检索到的数据是否符合预期。</li>
</ul>
<p>需要特别注意的是：</p>
<ul>
<li>测试用例用 <code>@MainActor</code> 标注，以允许直接使用容器的 <code>mainContext</code>。</li>
<li>创建和检索数据在不同的上下文中进行，以确保逻辑的准确性并模拟实际应用中的使用场景。</li>
<li>删除测试功能时，可以利用新创建数据项的返回值 <code>PersistentIdentifier</code> 来简化流程，避免重复从数据库检索数据。</li>
<li>返回的 <code>PersistentIdentifier</code> 应在相同的上下文中使用，特别是在它仍然是临时状态的情况下。对于跨上下文的操作，可能需要重新检索数据以获取持久化的标识符。</li>
</ul>
<p>关于测试效率的顾虑：根据实际经验，即使是创建新数据库文件的测试方法也能在短时间内顺利完成大量测试，开发者无需担心其对测试性能的影响。</p>
<video src="https://cdn.fatbobman.com/unitTests-demo_2024-03-01.mp4" autoplay="true" loop="true" loading="lazy" muted="true" playsInline="true" controls="true"></video>
<h2 id="为注入做好准备">为注入做好准备</h2>
<p>在完成了演示项目中对数据操作的全面测试后，下一步是考虑如何将 <code>DataHandler</code> 以安全且符合现代编程模式的方式，让项目中的其他代码轻松访问或进行注入。</p>
<p>为此，在 <code>DataProvider</code> 类中，我们定义了以下方法：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> dataHandlerCreator</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">-&gt;</span><span style="color:#FF79C6"> @Sendable</span><span style="color:#F8F8F2"> () </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> DataHandler {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> sharedModelContainer</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#F8F8F2"> { </span><span style="color:#8BE9FD">DataHandler</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">modelContainer</span><span style="color:#F8F8F2">: container) }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>此辅助函数提供了一种安全的方法来创建 <code>DataHandler</code> 实例，这在启用 Swift 的严格并发检查功能时尤其关键。</p>
<p>在演示项目中，我们使用了将 <code>DataHandler</code> 创建函数注入到视图环境的做法。这种思路不仅限于通过环境值注入的方式，也适用于其他各种架构设计。例如，在使用 The Composable Architecture (TCA) 时，可以采用相似的策略来定义 <code>DependencyKey</code>，以便实现依赖注入的目的。此外，鉴于 <code>DataProvider</code> 本身符合 <code>Sendable</code> 协议，它也可以直接用作依赖注入的源，在某些场景下这种做法同样有效。这种灵活性允许开发者根据具体的应用架构需求，选择最合适的注入和依赖管理策略。</p>
<p>通过扩展 SwiftUI 的 <code>EnvironmentValues</code>，我们能够将 <code>DataHandler</code> 的生成逻辑无缝集成到 SwiftUI 的环境中，从而为视图层提供强大的数据操作功能：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> struct</span><span style="color:#8BE9FD;font-style:italic"> DataHandlerKey</span><span style="color:#F8F8F2">: EnvironmentKey {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> static</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> defaultValue: </span><span style="color:#FF79C6">@Sendable</span><span style="color:#F8F8F2"> () </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> DataHandler</span><span style="color:#FF79C6">?</span><span style="color:#FF79C6"> =</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9">nil</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> EnvironmentValues</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createDataHandler: </span><span style="color:#FF79C6">@Sendable</span><span style="color:#F8F8F2"> () </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> DataHandler</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    get</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">[DataHandlerKey.</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">] }</span></span>
<span class="line"><span style="color:#FF79C6">    set</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">[DataHandlerKey.</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> newValue }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>至此，我们已经完成了数据管理模块的所有准备工作，现在可以将其集成到项目中，并开始利用这一模块了。</p>
<h2 id="始终使用一个实例还是每次创建新的实例">始终使用一个实例还是每次创建新的实例</h2>
<p>在使用 SwiftData 进行开发时，我建议避免在 <code>DataProvider</code> 中持有一个长期共享的 <code>DataHandler</code> 实例。相反，在每个业务逻辑场景中独立创建新的实例或许是更好的选择。这种方法有几个优点：</p>
<p>首先，考虑到现代设备的性能已经非常出色，动态创建一个新的 <code>DataHandler</code> 实例的开销通常是可以接受的，不会对应用的响应速度或效率产生负面影响。</p>
<p>其次，由于 SwiftData 在某些方面如错误处理和合并策略等配置上的缺失，为每次数据操作创建一个新的独立实例可以简化异常处理的复杂度。这样，每个实例都是自包含的，操作互不干扰，从而降低了出错的风险，并使得代码更加清晰、易于维护。</p>
<blockquote>
<p>需要注意的是，在 iOS 18 中，每次创建新实例的策略可能会引发一些问题，特别是 <code>context.reset</code> 错误。如果你在 iOS 18 上遇到了此类问题，可以尝试将生成的 Actor 实例通过 <code>@State</code> 持有在视图中，或者使用生命周期比当前视图更长的实例来解决这些问题。有关此问题的详细讨论，可以参考 <a href="https://forums.developer.apple.com/forums/thread/757521?answerId=795665022#795665022?&#38;utm_source=Fatbobman%20Blog&#38;utm_medium=web&#38;utm_campaign=Fatbobman%20Blog" rel="noreferrer noopener">这篇帖子</a>。</p>
</blockquote>
<h2 id="将数据模块集成到项目中">将数据模块集成到项目中</h2>
<p>在项目中引入 Package 后，我们可以开始在应用中使用它，为视图提供 <code>container</code> 和 <code>DataHandler</code> 生成方法。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">import</span><span style="color:#8BE9FD;font-style:italic"> DataProvider</span></span>
<span class="line"><span style="color:#FF79C6">import</span><span style="color:#8BE9FD;font-style:italic"> SwiftData</span></span>
<span class="line"><span style="color:#FF79C6">import</span><span style="color:#8BE9FD;font-style:italic"> SwiftUI</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">@main</span></span>
<span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> SwiftDataConcurrencyDemoApp</span><span style="color:#F8F8F2">: App {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> dataProvider </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> DataProvider.shared</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> body: </span><span style="color:#FF79C6">some</span><span style="color:#F8F8F2"> Scene {</span></span>
<span class="line"><span style="color:#F8F8F2">    WindowGroup {</span></span>
<span class="line"><span style="color:#8BE9FD">      ContentView</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">        .</span><span style="color:#8BE9FD">environment</span><span style="color:#F8F8F2">(\.createDataHandler, dataProvider.</span><span style="color:#8BE9FD">dataHandlerCreator</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">modelContainer</span><span style="color:#F8F8F2">(dataProvider.sharedModelContainer)</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>此代码段将 <code>DataProvider</code> 的实例集成到了 SwiftUI 应用的主入口。我们通过 <code>.environment</code> 修饰器注入 <code>createDataHandler</code> 方法，使其在 <code>ContentView</code> 及其子视图中可用。</p>
<p>在 <code>ContentView</code> 中，我们实现了添加新数据项的功能，如下所示：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> ContentView</span><span style="color:#F8F8F2">: View {</span></span>
<span class="line"><span style="color:#FF79C6">  @Environment</span><span style="color:#F8F8F2">(\.modelContext) </span><span style="color:#FF79C6">private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> modelContext</span></span>
<span class="line"><span style="color:#FF79C6">  @Environment</span><span style="color:#F8F8F2">(\.createDataHandler) </span><span style="color:#FF79C6">private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#FF79C6">  @Query</span><span style="color:#F8F8F2">(sort</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> \Item.createTimestamp, animation</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> .smooth) </span><span style="color:#FF79C6">private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> items: [Item]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> body: </span><span style="color:#FF79C6">some</span><span style="color:#F8F8F2"> View {</span></span>
<span class="line"><span style="color:#F8F8F2">    NavigationSplitView {</span></span>
<span class="line"><span style="color:#F8F8F2">      List {</span></span>
<span class="line"><span style="color:#8BE9FD">        ForEach</span><span style="color:#F8F8F2">(items) { item </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#8BE9FD">          ItemView</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">item</span><span style="color:#F8F8F2">: item)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">      .toolbar {</span></span>
<span class="line"><span style="color:#F8F8F2">        ToolbarItem {</span></span>
<span class="line"><span style="color:#8BE9FD">          Button</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">action</span><span style="color:#F8F8F2">: addItem) {</span></span>
<span class="line"><span style="color:#8BE9FD">            Label</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Add Item</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">, </span><span style="color:#8BE9FD">systemImage</span><span style="color:#F8F8F2">: </span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">plus</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">          }</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">    } detail</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">      Text</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Select an item</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  @MainActor</span></span>
<span class="line"><span style="color:#FF79C6">  private</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> addItem</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> createDataHandler </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#F8F8F2">    Task.detached {</span></span>
<span class="line"><span style="color:#FF79C6">      if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> dataHandler </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> await</span><span style="color:#8BE9FD"> createDataHandler</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">        try</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> dataHandler.</span><span style="color:#8BE9FD">newItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">date</span><span style="color:#F8F8F2">: .now)</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>关键点概述：</p>
<ul>
<li>使用 <code>@Environment(\.createDataHandler)</code> 将创建 <code>DataHandler</code> 的方法引入视图。</li>
<li>为了符合 Swift 的严格并发检查，我们需用 <code>@MainActor</code> 标注 <code>addItem</code> 函数。</li>
<li>利用 <code>Task.detached</code> 创建一个分离的任务，确保在非主线程上创建 <code>DataHandler</code> 实例，并进行数据操作，从而避免阻塞 UI。</li>
</ul>
<p>通过这种方式，数据管理逻辑与视图逻辑分离，保持了代码的清晰性和可维护性，同时也利于异步数据处理和更新界面。</p>
<h2 id="构建独立视图来展示数据">构建独立视图来展示数据</h2>
<p>继列表视图之后，我们接下来将构建用于展示 <code>Item</code> 数据详细信息的独立视图。在 <code>ItemView</code> 中，我们利用 <code>createDataHandler</code> 环境变量来创建 <code>DataHandler</code> 实例，分别处理数据的删除和更新操作。所有 <code>DataHandler</code> 实例的操作都在非主线程上进行，以确保界面的流畅性不受数据处理过程的影响。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> ItemView</span><span style="color:#F8F8F2">: View {</span></span>
<span class="line"><span style="color:#FF79C6">  @Environment</span><span style="color:#F8F8F2">(\.createDataHandler) </span><span style="color:#FF79C6">private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> item: Item</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> body: </span><span style="color:#FF79C6">some</span><span style="color:#F8F8F2"> View {</span></span>
<span class="line"><span style="color:#F8F8F2">    VStack {</span></span>
<span class="line"><span style="color:#8BE9FD">      Text</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">item.</span><span style="color:#F8F8F2">timestamp</span><span style="color:#F1FA8C">.</span><span style="color:#F8F8F2">timeIntervalSince1970</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">      HStack {</span></span>
<span class="line"><span style="color:#8BE9FD">        Button</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Update Timestamp</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">          let</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> item.id</span></span>
<span class="line"><span style="color:#FF79C6">          let</span><span style="color:#F8F8F2"> date </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Date.now</span></span>
<span class="line"><span style="color:#FF79C6">          let</span><span style="color:#F8F8F2"> createDataHandler </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#F8F8F2">          Task.detached {</span></span>
<span class="line"><span style="color:#FF79C6">            if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> dataHandler </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> await</span><span style="color:#8BE9FD"> createDataHandler</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">              try?</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> dataHandler.</span><span style="color:#8BE9FD">updateItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">id</span><span style="color:#F8F8F2">: id, </span><span style="color:#8BE9FD">timestamp</span><span style="color:#F8F8F2">: date)</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">          }</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#8BE9FD">        Button</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Delete</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">          let</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> item.id</span></span>
<span class="line"><span style="color:#FF79C6">          let</span><span style="color:#F8F8F2"> createDataHandler </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#F8F8F2">          Task.detached {</span></span>
<span class="line"><span style="color:#FF79C6">            if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> dataHandler </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> await</span><span style="color:#8BE9FD"> createDataHandler</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">              try?</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> dataHandler.</span><span style="color:#8BE9FD">deleteItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">id</span><span style="color:#F8F8F2">: id)</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"><span style="color:#F8F8F2">          }</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">buttonStyle</span><span style="color:#F8F8F2">(.bordered)</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>现在，我们就可以在模拟器中完整的运行项目并实现数据的添加与删除了。</p>
<video src="https://cdn.fatbobman.com/swiftdata-concurrency-sim-demo-2024-03-16.mp4" autoplay="true" loop="true" muted="true" loading="lazy" playsInline="true" controls="true"></video>
<h2 id="是否还需要数据转换层">是否还需要数据转换层？</h2>
<p>在传统的 Core Data 项目中，通常会创建一个值类型的数据转换层，这一层主要作用是将托管对象（引用类型）转换为更适合视图使用的值类型，这有助于提高数据处理的安全性和简化视图的数据绑定。</p>
<p>在 SwiftData 中，模型本身就是用纯 Swift 类型构建的，加上 SwiftData 的 <code>PersistentModel</code> 采用 <code>Observation</code> 框架提供的观察机制，这一机制为每个属性提供了观察能力，确保了视图能精准响应数据变化。如果在视图中对这些数据进行转换，会破坏此观察机制，增加不必要的视图更新，因此，建议在视图中直接使用 SwiftData 中定义的数据模型。</p>
<p>然而，这并不意味着在所有场景下都不需要数据转换层。实际上，在创建或更新数据时，使用基于值类型的数据模型可以更加安全和高效，尤其在涉及数据比对和测试时。</p>
<p>虽然在演示项目中我们没有提供转换层的数据类型，但在实际应用的开发过程中，开发者应根据具体需求考虑是否引入这一层。这种设计决策应基于项目的具体需求，考虑到数据安全、开发效率以及是否能够提升整体的代码质量和可维护性。</p>
<h2 id="为预览做准备">为预览做准备</h2>
<p>在 SwiftUI 开发中，预览是一个不可或缺的功能，它可以大大提高开发效率。因此，为预览配置适当的环境是至关重要的。我们通常推荐使用基于内存的数据库用于预览场景，这就要求我们需要对 <code>DataProvider</code> 进行适当的调整。</p>
<p>首先，我们在 <code>DataProvider</code> 中添加以下代码，以初始化一个非持久化的 <code>ModelContainer</code>，专门用于预览环境：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> previewContainer: ModelContainer </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> schema </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> Schema</span><span style="color:#F8F8F2">(CurrentScheme.models)</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> modelConfiguration </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> ModelConfiguration</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">schema</span><span style="color:#F8F8F2">: schema, </span><span style="color:#8BE9FD">isStoredInMemoryOnly</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">  do</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#FF79C6"> try</span><span style="color:#8BE9FD"> ModelContainer</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">for</span><span style="color:#F8F8F2">: schema, </span><span style="color:#8BE9FD">configurations</span><span style="color:#F8F8F2">: [modelConfiguration])</span></span>
<span class="line"><span style="color:#F8F8F2">  } </span><span style="color:#FF79C6">catch</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">    fatalError</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Could not create ModelContainer: </span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">error</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}()</span></span></code></pre></div>
<p>接着，我们修改 <code>dataHandlerCreator</code> 函数，使其能够根据需求选择使用持久化或非持久化的容器：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> dataHandlerCreator</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">preview</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> false</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#FF79C6"> @Sendable</span><span style="color:#F8F8F2"> () </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> DataHandler {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> preview </span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> previewContainer </span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> sharedModelContainer</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#F8F8F2"> { </span><span style="color:#8BE9FD">DataHandler</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">modelContainer</span><span style="color:#F8F8F2">: container) }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>为了在预览中有效利用这些配置，我们通常会创建一个专用的预览包装视图，它不仅准备预览环境，还可以构建演示数据。以下是一个示例，展示了如何为 <code>ItemView</code> 构建一个预览容器：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">#</span><span style="color:#FF79C6">if</span><span style="color:#F8F8F2"> DEBUG</span></span>
<span class="line"><span style="color:#FF79C6">  struct</span><span style="color:#8BE9FD;font-style:italic"> ItemViewPreviewContainer</span><span style="color:#F8F8F2">: View {</span></span>
<span class="line"><span style="color:#FF79C6">    @Environment</span><span style="color:#F8F8F2">(\.createDataHandler) </span><span style="color:#FF79C6">var</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#FF79C6">    @Query</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> items: [Item]</span></span>
<span class="line"><span style="color:#FF79C6">    var</span><span style="color:#F8F8F2"> body: </span><span style="color:#FF79C6">some</span><span style="color:#F8F8F2"> View {</span></span>
<span class="line"><span style="color:#F8F8F2">      VStack {</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> item </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> items.</span><span style="color:#8BE9FD">first</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#8BE9FD">          ItemView</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">item</span><span style="color:#F8F8F2">: item)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">      .task {</span></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> dataHander </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> await</span><span style="color:#8BE9FD"> createDataHandler</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">          let</span><span style="color:#BD93F9"> _</span><span style="color:#FF79C6"> =</span><span style="color:#FF79C6"> try?</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> dataHander.</span><span style="color:#8BE9FD">newItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">date</span><span style="color:#F8F8F2">: .now)</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">#</span><span style="color:#FF79C6">endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">#Preview {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> dataProvider </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DataProvider</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#8BE9FD"> ItemViewPreviewContainer</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">environment</span><span style="color:#F8F8F2">(\.createDataHandler, dataProvider.</span><span style="color:#8BE9FD">dataHandlerCreator</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">preview</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">modelContainer</span><span style="color:#F8F8F2">(dataProvider.previewContainer)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>当配置 <code>ItemViewPreviewContainer</code> 的预览环境时，确保使用专门为预览准备的 <code>container</code> 和 <code>DataHandler</code> 创建函数。这样可以保证预览环境是隔离的，不会影响到实际的应用数据，同时提供了一种快速高效的方式来演示和测试视图。</p>
<h2 id="新的问题数据更新后视图没有刷新">新的问题：数据更新后视图没有刷新</h2>
<p>如果你跟随本文构建自己的代码，可能会遇到一个问题：在 <code>ItemView</code> 中点击更新数据的按钮时，界面上的数据并没有相应地更新。考虑到我们的单元测试能够正常通过，且数据更新逻辑本身没有问题，那么这个问题是怎么引起的呢？</p>
<p>这实际上是由当前 SwiftData 的一个已知 Bug 导致的，当满足以下两个条件时，会出现数据更新后视图未刷新的情况：</p>
<ul>
<li>数据更新逻辑被封装在 <code>ModelActor</code> 中。</li>
<li>使用独立的视图来展示和响应数据的变化（例如，当我们将展示代码做如下调整，通过直接使用 <code>Text</code> 显示数据时，可以明显看到更新后的区别）：</li>
</ul>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">List {</span></span>
<span class="line"><span style="color:#8BE9FD">  ForEach</span><span style="color:#F8F8F2">(items) { item </span><span style="color:#FF79C6">in</span></span>
<span class="line"><span style="color:#F8F8F2">    VStack {</span></span>
<span class="line"><span style="color:#8BE9FD">      Text</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">item.</span><span style="color:#F8F8F2">timestamp</span><span style="color:#F1FA8C">.</span><span style="color:#F8F8F2">timeIntervalSince1970</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#8BE9FD">      ItemView</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">item</span><span style="color:#F8F8F2">: item) </span><span style="color:#6272A4">// don&#39;t change after update</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<video src="https://cdn.fatbobman.com/swiftdata-modelactor-update-issue-2024-03-17.mp4" autoplay="true" loop="true" muted="true" loading="lazy" playsInline="true" controls="true"></video>
<p>这个问题已有多位使用 <code>ModelActor</code> 的开发者向我提出，我当时给出的解决方案并不理想，主要是通过为数据展示视图增加额外的参数来实现更新感知。这种方法局限性较大，且可能会丢失首次更新的变化。本文将探讨其他可能的解决方案。</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> ItemView</span><span style="color:#F8F8F2">: View {</span></span>
<span class="line"><span style="color:#FF79C6">  @Environment</span><span style="color:#F8F8F2">(\.createDataHandler) </span><span style="color:#FF79C6">private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> item: Item</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> date: Date</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> body: </span><span style="color:#FF79C6">some</span><span style="color:#F8F8F2"> View {</span></span>
<span class="line"><span style="color:#FF79C6">     ....</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8BE9FD">ItemView</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">item</span><span style="color:#F8F8F2">: item, </span><span style="color:#8BE9FD">date</span><span style="color:#F8F8F2">: item.timestamp)</span></span></code></pre></div>
<blockquote>
<p>我已经向苹果提交了反馈（<code>FB13689240</code>），希望问题能够尽早得到修复。</p>
</blockquote>
<h2 id="解决思路">解决思路</h2>
<p>为了解决数据更新后视图不刷新的问题，我们首先会考虑以下两种方法：</p>
<ol>
<li>避免使用独立视图来展示和响应数据。</li>
<li>将数据更新逻辑从 <code>DataHandler</code> 中剥离，并直接在 <code>mainContext</code> 中修改数据。</li>
</ol>
<p>显然，出于维护现有架构模式和测试流程的考虑，这两种方法都不是我们所希望的。但是，如果在 <code>mainContext</code> 中执行数据更新操作可以避免视图不刷新的问题，那么我们是否可以考虑创建一个专门用于数据更新操作的 <code>DataHandler</code> 实例，它直接使用 <code>mainContext</code> 呢？</p>
<blockquote>
<p><code>mainContext</code> 是由 <code>ModelContainer</code> 实例提供的，它被标注了 <code>@MainActor</code> 只能在主线程中使用。我们在视图中通过 <code>@Qurey</code> 检索数据时便是通过这个上下文。</p>
</blockquote>
<p>Swift 的宏（Macro）功能为这种思路提供了实现的可能性。通过探索由 <code>@ModelActor</code> 宏生成的代码，我们可以洞察其背后的实现机制，并据此进行必要的调整。</p>
<p>观察 <code>@ModelActor</code> 宏生成的 <code>DataHandler</code> 初始化方法：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">modelContainer</span><span style="color:#F8F8F2">: SwiftData.ModelContainer) {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> modelContext </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> ModelContext</span><span style="color:#F8F8F2">(modelContainer)</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    self</span><span style="color:#F8F8F2">.modelExecutor </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DefaultSerialModelExecutor</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">modelContext</span><span style="color:#F8F8F2">: modelContext)</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">    self</span><span style="color:#F8F8F2">.modelContainer </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> modelContainer</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>这个初始化方法通过 <code>ModelContext(modelContainer)</code> 创建了一个新的 <code>ModelContext</code> 实例，并设定 Actor 的执行环境与此上下文相关联（ 使用相同的线程 ）。因此，我们可以考虑为 <code>DataHandler</code> 添加一个新的构造方法，这样就可以在不大幅度调整当前开发模式的前提下，提供一个解决方案。</p>
<h2 id="临时解决方案">临时解决方案</h2>
<p>我们的这个临时方案涉及对 <code>DataHandler</code> 类的扩展和对 <code>DataProvider</code> 的调整，以确保在主线程上的 <code>mainContext</code> 进行数据更新操作。</p>
<p>首先，我们为 <code>DataHandler</code> 添加一个新的构造方法：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">@MainActor</span></span>
<span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> init</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">modelContainer</span><span style="color:#F8F8F2">: ModelContainer, </span><span style="color:#50FA7B">mainActor</span><span style="color:#FFB86C;font-style:italic"> _</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> modelContext </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> modelContainer.mainContext</span></span>
<span class="line"><span style="color:#F8F8F2">  modelExecutor </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DefaultSerialModelExecutor</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">modelContext</span><span style="color:#F8F8F2">: modelContext)</span></span>
<span class="line"><span style="color:#BD93F9;font-style:italic">  self</span><span style="color:#F8F8F2">.modelContainer </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> modelContainer</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>此构造函数通过 <code>@MainActor</code> 标注确保能够将 <code>modelContainer.mainContext</code> 与 Actor 的执行器直接绑定。我们引入了一个未使用的参数来避免与现有构造函数签名冲突。</p>
<p>然后，在 <code>DataProvider</code> 中添加一个新的辅助方法，用于生成绑定到 <code>mainContext</code> 的 <code>DataHandler</code> 实例：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> dataHandlerWithMainContextCreator</span><span style="color:#F8F8F2">(</span><span style="color:#50FA7B;font-style:italic">preview</span><span style="color:#F8F8F2">: </span><span style="color:#8BE9FD;font-style:italic">Bool</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> false</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">-&gt;</span><span style="color:#FF79C6"> @Sendable</span><span style="color:#FF79C6"> @MainActor</span><span style="color:#F8F8F2"> () </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> DataHandler {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> container </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> preview </span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> previewContainer </span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> sharedModelContainer</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#F8F8F2"> { </span><span style="color:#8BE9FD">DataHandler</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">modelContainer</span><span style="color:#F8F8F2">: container, </span><span style="color:#8BE9FD">mainActor</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">) }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>接下来，我们定义一个新的环境键，并扩展 <code>EnvironmentValues</code> 以注入新的辅助方法：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">public</span><span style="color:#FF79C6"> struct</span><span style="color:#8BE9FD;font-style:italic"> MainActorDataHandlerKey</span><span style="color:#F8F8F2">: EnvironmentKey {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> static</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> defaultValue: </span><span style="color:#FF79C6">@Sendable</span><span style="color:#FF79C6"> @MainActor</span><span style="color:#F8F8F2"> () </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> DataHandler</span><span style="color:#FF79C6">?</span><span style="color:#FF79C6"> =</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9">nil</span><span style="color:#F8F8F2"> }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">extension</span><span style="color:#8BE9FD;font-style:italic"> EnvironmentValues</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">  public</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createDataHandlerWithMainContext: </span><span style="color:#FF79C6">@Sendable</span><span style="color:#FF79C6"> @MainActor</span><span style="color:#F8F8F2"> () </span><span style="color:#FF79C6">async</span><span style="color:#FF79C6"> -&gt;</span><span style="color:#F8F8F2"> DataHandler</span><span style="color:#FF79C6">?</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">    get</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">[MainActorDataHandlerKey.</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">] }</span></span>
<span class="line"><span style="color:#FF79C6">    set</span><span style="color:#F8F8F2"> { </span><span style="color:#BD93F9;font-style:italic">self</span><span style="color:#F8F8F2">[MainActorDataHandlerKey.</span><span style="color:#FF79C6">self</span><span style="color:#F8F8F2">] </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> newValue }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>在应用的根视图中，我们注入这个新的环境值：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">WindowGroup {</span></span>
<span class="line"><span style="color:#8BE9FD">  ContentView</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">environment</span><span style="color:#F8F8F2">(\.createDataHandler, dataProvider.</span><span style="color:#8BE9FD">dataHandlerCreator</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#6272A4">    // new</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">environment</span><span style="color:#F8F8F2">(\.createDataHandlerWithMainContext, dataProvider.</span><span style="color:#8BE9FD">dataHandlerWithMainContextCreator</span><span style="color:#F8F8F2">())</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>在 <code>ItemView</code> 中，我们引入并使用这个新环境值来执行数据更新操作：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#FF79C6">struct</span><span style="color:#8BE9FD;font-style:italic"> ItemView</span><span style="color:#F8F8F2">: View {</span></span>
<span class="line"><span style="color:#FF79C6">  @Environment</span><span style="color:#F8F8F2">(\.createDataHandler) </span><span style="color:#FF79C6">private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createDataHandler</span></span>
<span class="line"><span style="color:#FF79C6">  @Environment</span><span style="color:#F8F8F2">(\.createDataHandlerWithMainContext) </span><span style="color:#FF79C6">private</span><span style="color:#FF79C6"> var</span><span style="color:#F8F8F2"> createDataHandlerWithMainContext</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> item: Item</span></span>
<span class="line"><span style="color:#FF79C6">  var</span><span style="color:#F8F8F2"> body: </span><span style="color:#FF79C6">some</span><span style="color:#F8F8F2"> View {</span></span>
<span class="line"><span style="color:#F8F8F2">    VStack {</span></span>
<span class="line"><span style="color:#8BE9FD">      Text</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#FF79C6">\(</span><span style="color:#F1FA8C">item.</span><span style="color:#F8F8F2">timestamp</span><span style="color:#F1FA8C">.</span><span style="color:#F8F8F2">timeIntervalSince1970</span><span style="color:#FF79C6">)</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">      HStack {</span></span>
<span class="line"><span style="color:#8BE9FD">        Button</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">&quot;</span><span style="color:#F1FA8C">Update Timestamp</span><span style="color:#E9F284">&quot;</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#8BE9FD">          updateItemTimestamp</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#FF79C6">				....</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">buttonStyle</span><span style="color:#F8F8F2">(.bordered)</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">  @MainActor</span></span>
<span class="line"><span style="color:#FF79C6">  private</span><span style="color:#FF79C6"> func</span><span style="color:#50FA7B"> updateItemTimestamp</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> item.id</span></span>
<span class="line"><span style="color:#FF79C6">    let</span><span style="color:#F8F8F2"> date </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> Date.now</span></span>
<span class="line"><span style="color:#F8F8F2">    Task { </span><span style="color:#FF79C6">@MainActor</span><span style="color:#FF79C6"> in</span></span>
<span class="line"><span style="color:#FF79C6">      if</span><span style="color:#FF79C6"> let</span><span style="color:#F8F8F2"> dataHandler </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> await</span><span style="color:#8BE9FD"> createDataHandlerWithMainContext</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#FF79C6">        try?</span><span style="color:#FF79C6"> await</span><span style="color:#F8F8F2"> dataHandler.</span><span style="color:#8BE9FD">updateItem</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">id</span><span style="color:#F8F8F2">: id, </span><span style="color:#8BE9FD">timestamp</span><span style="color:#F8F8F2">: date)</span></span>
<span class="line"><span style="color:#F8F8F2">      }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>确保预览环境也注入了相应的环境值：</p>
<div>
        <div class="flex justify-between items-center h-8 font-medium bg-[#96744d] dark:bg-[#002565] text-gray-200 text-xs rounded-tl-md rounded-tr-md">
          <span class="px-4 py-1">Swift</span>
          <button class="copy-button py-1 px-4" onclick="copyCode(this, event)">
          <div class="copy-text">
            <span class="flex items-center justify-center sm:hover:text-white sm:hover:font-bold">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                <use xlink:href="#icon-clipboard"></use>
              </svg>
            Copy code
            </span>
          </div>
          <div class="copied-text hidden">
            <span class="flex items-center justify-center">
              <svg class="w-3 h-3 mr-1" fill="currentColor" stroke="currentColor">
                  <use xlink:href="#icon-check"></use>
             </svg>
              Copied!
            </span>
          </div>
        </button>
        </div>
      <pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">#Preview {</span></span>
<span class="line"><span style="color:#FF79C6">  let</span><span style="color:#F8F8F2"> dataProvider </span><span style="color:#FF79C6">=</span><span style="color:#8BE9FD"> DataProvider</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">  return</span><span style="color:#8BE9FD"> ItemViewPreviewContainer</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">environment</span><span style="color:#F8F8F2">(\.createDataHandler, dataProvider.</span><span style="color:#8BE9FD">dataHandlerCreator</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">preview</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">environment</span><span style="color:#F8F8F2">(\.createDataHandlerWithMainContext, dataProvider.</span><span style="color:#8BE9FD">dataHandlerWithMainContextCreator</span><span style="color:#F8F8F2">(</span><span style="color:#8BE9FD">preview</span><span style="color:#F8F8F2">: </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">))</span></span>
<span class="line"><span style="color:#F8F8F2">    .</span><span style="color:#8BE9FD">modelContainer</span><span style="color:#F8F8F2">(dataProvider.previewContainer)</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre></div>
<p>通过这种方式，我们可以保证数据更新操作会在一个绑定到主线程 <code>mainContext</code> 的 <code>DataHandler</code> 实例中进行，而其他操作仍在非主线程执行。虽然这需要我们为更新操作进行特别的处理，但这是在不改变原有架构的前提下的一个可行的妥协方案。我希望这个问题可以尽快被官方修复。</p>
<blockquote>
<p><span style="color:red"><strong>特别提醒</strong></span>：自首个版本（iOS 17.0）起，SwiftData 几乎在每个版本中都对一些已知问题进行了修复，同时也可能引入了新的问题。因此，当你运行文章中提供的 Demo 项目，而项目运行在不同的系统版本或使用不同版本的 Xcode 编译时，可能会遇到与预期不一致的结果（比如，点击添加按钮后无法看到新数据，或应用被推到后台时崩溃等）。我们还需等待苹果对这些问题进行进一步的修复。尽管如此，我相信文章中介绍的数据操作逻辑本身是正确的。为了确保在当前项目中以稳定、可靠的方式使用本文介绍的方法，请通过 <code>createDataHandlerWithMainContext</code> 创建所有的 <code>DataHandler</code>（即使用主上下文来构建 <code>DataHandler</code>）。</p>
</blockquote>
<div class="dynamic-ad-container pt-4"></div>
<h2 id="总结">总结</h2>
<p>在这篇文章中，我们探讨了如何采用新思维来构建使用 SwiftData 的 SwiftUI 应用。当我们开始使用新框架时，特别是那些在旧有框架基础上发展起来的框架，我们不能仅仅将旧有的经验和习惯直接移植过来。我们需要深入思考如何利用新框架的优势，同时融入最新的编程理念，以打造更加高效、现代化的应用。</p>
<p>框架的每次更新不仅是一项挑战，也是一个机遇。它要求开发者离开舒适区，重新审视和学习新工具的潜力和最佳实践。通过这样做，我们不仅能够提升个人技能，还能够为用户提供更好的产品。SwiftData 作为一个现代化的数据管理框架，给予了开发者更大的灵活性和更强大的功能，使得数据处理更加直观和高效。</p>
<p>随着 Swift 和 SwiftUI 的不断进化，结合像 SwiftData 这样的框架，开发者被赋予了创造出更加安全、更加响应式、更加丰富和更具互动性应用的能力。因此，紧跟最新的开发趋势，并学会利用这些新工具的强大功能，将是每一个致力于提升自身技能和产品质量的开发者的必经之路。</p> </div> </article>  <!-- Modal toggle --><button data-modal-target="default-modal" data-modal-toggle="default-modal" class="hidden text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
Toggle modal
</button> <!-- Main modal --> <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"> <div id="default-modal" tabindex="-1" aria-hidden="true" class="hidden w-full h-full justify-center items-center"> <div class="relative p-4 w-full max-w-2xl"> <!-- Modal content --> <div class="relative bg-white rounded-lg shadow-2xl dark:bg-gray-800 border-gray-200 border dark:border-gray-600"> <!-- Modal header --> <div class="flex items-center justify-between px-4 md:px-5 pt-4 pb-0 rounded-t dark:border-gray-600"> <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="default-modal"> <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"> <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path> </svg> <span class="sr-only">Close modal</span> </button> </div> <!-- Modal body --> <div class="px-4 md:px-5 pb-4"> <div class="w-full mx-auto text-center px-6 pb-6"> <div class="text-lg font-semibold text-gray-900 dark:text-blue-100 pt-4 pb-8">每周一，与您分享精心筛选的 Swift 与 SwiftUI 开发精华</div> <div id="custom-substack-embed1"></div> <!-- <div class="text-gray-700 dark:text-blue-200 text-xs font-medium pt-4">{bottomTip}</div> --> <script>(function(){const subscribeText = "立刻订阅";
const placeholder = "输入邮箱订阅周报";

    window.CustomSubstackWidget = {
      substackUrl: 'weekly.fatbobman.com',
      placeholder: placeholder,
      buttonText: subscribeText,
      theme: 'custom',
      colors: {
        primary: '#F50000',
        input: '#000000',
        email: '#777777',
        text: '#000000',
      },
    };

    // 创建一个新的 MutationObserver 实例
    const observer = new MutationObserver((mutationsList, observer) => {
      // 遍历所有的 mutations
      for (let mutation of mutationsList) {
        // 如果这个 mutation 是一个子节点的添加或删除
        if (mutation.type === 'childList') {
          // 查找订阅框
          const widget = document.querySelector('.custom-substack-widget1');
          if (widget) {
            // 查找 input 元素
            const input = widget.querySelector('input');
            const button = widget.querySelector('button');
            // 根据当前的颜色方案修改订阅框的样式
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              // 暗黑模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            } else {
              // 正常模式
              widget.style.border = 'var(--subscribe-widget-border)';
              widget.style.padding = '0.3rem';
              widget.style.borderRadius = '0.7rem 0.7rem 0.7rem 0.7rem';
              widget.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.border = '0px solid #000';
              input.style.backgroundColor = 'var(--subscribe-input-background)';
              input.style.padding = '0.5rem';
              // input.style.border = '1px solid #E2E8F0';
              input.style.outline = 'none';
              button.style.backgroundColor = 'var(--subscribe-button-background)';
              button.style.color = 'var(--subscribe-button-text)';
              button.style.fontWeight = 'bold';
              button.style.padding = '0.5rem 1rem';
              button.style.borderRadius = '0.5rem 0.5rem 0.5rem 0.5rem';
              button.style.maxWidth = '100px';
            }

            if (window.matchMedia('(max-width: 640px)').matches) {
              // 屏幕尺寸小于 640px
              widget.style.maxWidth = '325px';
            } else {
              // 屏幕尺寸大于或等于 640px
              widget.style.maxWidth = '600px';
            }
            // 停止观察
            observer.disconnect();
          }
        }
      }
    });

    // 开始观察 #custom-substack-embed 元素的子节点的变化
    observer.observe(document.getElementById('custom-substack-embed1'), { childList: true });
  })();</script> <script src="/js/subscriber.js" async></script> </div> <div class="flex justify-center pb-6"> <button data-modal-hide="default-modal" type="button" class="text-gray-600 dark:text-gray-400 bg-transparent hover:text-gray-800 dark:hover:text-gray-200 font-medium rounded-lg text-sm px-8 py-2.5 text-center transition-colors">继续阅读</button> </div> </div> </div> </div> </div> </div> <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "author": {
    "@type": "Person",
    "name": "Fatbobman",
    "url": "https://twitter.com/fatbobman"
  },
  "dateModified": "2024-03-21T00:20:00.000Z",
  "datePublished": "2024-03-21T00:20:00.000Z",
  "description": "探索SwiftData与现代SwiftUI编程的结合，学习如何模块化数据管理、进行单元测试和处理并发。解决SwiftData的挑战，构建稳定应用。",
  "headline": "SwiftData 实战：用现代方法构建 SwiftUI 应用",
  "image": {
    "@type": "ImageObject",
    "url": [
      {
        "url": "https://cdn.fatbobman.com/card/practical-swiftdata-building-swiftui-applications-with-modern-approaches-zh.png"
      }
    ]
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fatbobman.com/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/"
  },
  "url": "https://fatbobman.com/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/",
  "publisher": {
    "@type": "Organization",
    "name": "Fatbobman's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fatbobman.com/images/blog-card.png"
    }
  }
}</script> <div class="pt-6 pb-6  dark:border-gray-700"> <!-- <p class="flex justify-center align-center text-sm font-medium text-heading">
    { lang === Lang.ZH && <SupportMeTextZH /> }
    { lang === Lang.EN && <SupportMeTextEN /> }
  </p> --> <div class="flex flex-col sm:flex-row justify-center items-center mx-auto sm:space-x-8 align-center pt-2"> <button type="button" class="text-gray-900 bg-yellow-200 hover:bg-yellow-300 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://www.buymeacoffee.com/fatbobman')"> <img src="/images/buymeacoffee.svg" alt="Buy me a coffee" class="w-5 h-5 me-2 -ms-1"> <span class="text-black font-medium">Buy me a coffee</span> </button> <div class="pt-4 sm:pt-0"> <button type="button" class="text-red-500 bg-[#3270e1] hover:bg-blue-700 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-8 py-4 text-center inline-flex items-center dark:focus:ring-gray-600 dark:border-gray-700 me-2 mb-2" onclick="window.open('https://afdian.com/a/fatbobman')"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round" class="mr-2">  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037 .033l.034 -.03a6 6 0 0 1 4.733 -1.44l.246 .036a6 6 0 0 1 3.364 10.008l-.18 .185l-.048 .041l-7.45 7.379a1 1 0 0 1 -1.313 .082l-.094 -.082l-7.493 -7.422a6 6 0 0 1 3.176 -10.215z" stroke-width="0" fill="currentColor"></path>  </svg> <span class="text-white font-medium">爱发电(微信/支付宝)</span> </button>  </div> </div> </div> <!-- <WeeklySubscribe1 lang={lang} top={0} bottom={4}/> --> <div id="copy-alert" class="hidden fixed bottom-28 right-5"> <div id="alert-1" class="flex items-center p-4 mb-4 text-blue-800 rounded-lg bg-blue-50/90 dark:bg-gray-800/90 dark:text-blue-400" role="alert"> <div class="text-sm font-medium">链接已复制</div> </div> </div> <style>
  .copy-icon {
    position: absolute;
    left: -30px; /* 根据您的布局调整位置 */
    top: 50%; /* 将图标定位到标题的中间高度 */
    transform: translateY(-50%); /* 垂直居中对齐图标 */
    cursor: pointer;
    transition: opacity 0.6s ease;
    pointer-events: all; /* 始终响应鼠标事件 */
  }

  article h2,
  article h3,
  article h4,
  article h5 {
    position: relative;
  }

  #copy-alert {
    position: fixed;
    bottom: -100px; /* 初始在视窗下方 */
    right: 20px;
    transition: bottom 0.5s ease-in-out;
  }

  /* 进入动画 */
  @keyframes slideIn {
    from {
      bottom: -100px;
    }
    to {
      bottom: 0px;
    }
  }

  /* 消失动画 */
  @keyframes slideOut {
    from {
      bottom: 20px;
    }
    to {
      bottom: -100px;
    }
  }
</style> <script>
  var hideTimeout; // 用于保存自动隐藏定时器的引用
  document.querySelectorAll('article h2, article h3, article h4, article h5').forEach(function (header) {
    var copyIcon = document.createElement('span');
    copyIcon.innerHTML =
      '<svg fill="currentColor" aria-hidden="true" stroke="currentColor" class="w-5 h-5 hidden md:block hover:text-secondary" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M861.866667 164.266667c-87.466667-87.466667-230.4-89.6-320-2.133334l-68.266667 68.266667c-12.8 12.8-12.8 32 0 44.8s32 12.8 44.8 0l68.266667-68.266667c64-61.866667 166.4-61.866667 230.4 2.133334 64 64 64 168.533333 2.133333 232.533333l-117.333333 119.466667c-34.133333 34.133333-81.066667 51.2-128 49.066666-46.933333-4.266667-91.733333-27.733333-119.466667-66.133333-10.666667-14.933333-29.866667-17.066667-44.8-6.4-14.933333 10.666667-17.066667 29.866667-6.4 44.8 40.533333 53.333333 100.266667 87.466667 166.4 91.733333h17.066667c59.733333 0 119.466667-23.466667 162.133333-68.266666l117.333333-119.466667c83.2-89.6 83.2-234.666667-4.266666-322.133333z"></path><path d="M505.6 750.933333l-66.133333 68.266667c-64 61.866667-166.4 61.866667-230.4-2.133333-64-64-64-168.533333-2.133334-232.533334l117.333334-119.466666c34.133333-34.133333 81.066667-51.2 128-49.066667 46.933333 4.266667 91.733333 27.733333 119.466666 66.133333 10.666667 14.933333 29.866667 17.066667 44.8 6.4 14.933333-10.666667 17.066667-29.866667 6.4-44.8-40.533333-53.333333-100.266667-87.466667-166.4-91.733333-66.133333-4.266667-130.133333 19.2-177.066666 66.133333l-117.333334 119.466667c-85.333333 89.6-85.333333 234.666667 2.133334 322.133333 44.8 44.8 102.4 66.133333 162.133333 66.133334 57.6 0 115.2-21.333333 160-64l66.133333-68.266667c12.8-12.8 12.8-32 0-44.8-14.933333-10.666667-34.133333-10.666667-46.933333 2.133333z"></path></svg>'; // 使用您选择的图标
    copyIcon.className = 'copy-icon';
    copyIcon.style.opacity = '0'; // 默认透明
    header.insertBefore(copyIcon, header.firstChild);

    header.addEventListener('mouseover', function () {
      copyIcon.style.opacity = '1';
    });
    header.addEventListener('mouseout', function () {
      copyIcon.style.opacity = '0';
    });

    copyIcon.addEventListener('click', function () {
        var url = window.location.href.split('#')[0] + '#' + header.id;
        navigator.clipboard.writeText(url).then(function () {
            var alertDiv = document.getElementById('copy-alert');
            if (alertDiv) {
                alertDiv.classList.remove('hidden'); // 确保提示框是可见的
                alertDiv.style.display = 'block'; // 显示提示框
                clearTimeout(hideTimeout); // 清除之前的定时器
                alertDiv.style.animation = 'none'; // 先清除之前的动画
                setTimeout(function () {
                    alertDiv.style.animation = 'slideIn 0.5s forwards'; // 应用新动画
                }, 10);

                // 设置自动隐藏定时器
                hideTimeout = setTimeout(function () {
                    alertDiv.style.animation = 'slideOut 0.5s forwards'; // 应用消失动画
                    setTimeout(function () {
                        alertDiv.style.display = 'none';
                    }, 500);
                }, 3000);
            }
        });
    });
  });
</script> <script>
function copyCode(button, event) {
  event.preventDefault();
  const codeBlock = button.parentNode.nextElementSibling.textContent; // 获取代码内容
  navigator.clipboard.writeText(codeBlock).then(() => {
    // 显示 "Copied"
    button.querySelector('.copy-text').style.display = 'none';
    button.querySelector('.copied-text').style.display = 'inline';

    // 3秒后恢复
    setTimeout(() => {
      button.querySelector('.copy-text').style.display = 'inline';
      button.querySelector('.copied-text').style.display = 'none';
    }, 3000);
  });
}
</script> <script>(function(){const url = "https://fatbobman.com/ads/zh";

  fetch(url)
    .then(response => response.text())
    .then(html => {
      // 获取所有的广告位元素
      const adSlots = document.querySelectorAll('.dynamic-ad-container');
      // 将广告内容填充到每一个广告位中
      adSlots.forEach(slot => {
        slot.innerHTML = html;
      });
    })
    .catch(error => console.error('Error loading the ad:', error));
})();</script>  <!-- <LeaveFeedback lang={lang} /> --> <section class="pt-10"><div class="max-w-5xl sm:px-4 py-2 mx-auto"><div class="grid gap-4 sm:gap-2 sm:mx-4 sm:grid-cols-12"><div class="col-span-12 sm:col-span-3 hidden sm:block"><div class="text-center sm:text-left mt-3 mb-14 before:block before:w-24 before:h-1 before:mb-3 before:rounded before:mx-auto sm:before:mx-0 before:bg-secondary"><h3 class="text-lg font-medium text-default">相关文章</h3></div></div><div class="sm:hidden text-lg font-medium text-heading col-span-12 text-left">相关文章</div><div class="relative col-span-12 sm:px-4 space-y-6 sm:col-span-9"><div class="col-span-12 space-y-2 relative sm:px-4 sm:col-span-8 sm:space-y-4 sm:before:absolute sm:before:top-2 sm:before:bottom-0 sm:before:w-0.5 sm:before:-left-3 before:bg-block"><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/concurret-programming-in-swiftdata/" id="relatedPosts-SwiftData 中的并发编程"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData 中的并发编程</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/unveiling-the-data-modeling-principles-of-swiftdata/" id="relatedPosts-揭秘 SwiftData 的数据建模原理"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">揭秘 SwiftData 的数据建模原理</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/relationships-in-swiftdata-changes-and-considerations/" id="relatedPosts-SwiftData 中的关系：变化与注意事项"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftData 中的关系：变化与注意事项</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/modern-core-data-problem/" id="relatedPosts-SwiftUI 与 Core Data —— 问题"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftUI 与 Core Data —— 问题</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/weekly/issue-054" id="relatedPosts-Weekly #54 - 安全、便利与隐私"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">Weekly #54 - 安全、便利与隐私</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/modern-core-data-data-definition/" id="relatedPosts-SwiftUI 与 Core Data —— 数据定义"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftUI 与 Core Data —— 数据定义</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/modern-core-data-respond-data-safely/" id="relatedPosts-SwiftUI 与 Core Data —— 安全地响应数据"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">SwiftUI 与 Core Data —— 安全地响应数据</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/masteringofcoredatastack/" id="relatedPosts-掌握 Core Data Stack"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">掌握 Core Data Stack</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/nsubiquitouskeyvaluestore/" id="relatedPosts-在 SwiftUI 下使用 NSUbiquitousKeyValueStore 同步数据"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">在 SwiftUI 下使用 NSUbiquitousKeyValueStore 同步数据</h3></div></a><a class="flex flex-col sm:relative sm:before:absolute sm:before:top-2 sm:before:w-2 sm:before:h-2 sm:before:rounded-full sm:before:left-[-31px] sm:before:z-[1] before:bg-secondary group cursor-pointer" href="/zh/posts/coredatawithcloudkit-2/" id="relatedPosts-Core Data with CloudKit（二） —— 同步本地数据库到 iCloud 私有数据库"><div class="flex items-start"><div class="w-[7px] h-[7px] bg-secondary ml-4 mr-2 flex-shrink-0 mt-2 sm:hidden" style="border-radius: 50%;"></div><h3 class="text-default group-hover:text-secondary">Core Data with CloudKit（二） —— 同步本地数据库到 iCloud 私有数据库</h3></div></a></div></div></div></div></section> <!-- <BottomWeeklySubscribe lang={lang} /> --> <div><div id="gitalk-container" data-comment-id="SwiftData 实战用现代方法构建 SwiftUI 应用" data-lang="zh"></div><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script></div><script>
  document.addEventListener('DOMContentLoaded', async function () {
    console.log('fetching comment is enable');
    const response = await fetch('https://fatbobman.com/status/comment');
    const data = await response.text();
    console.log(data);
    if (data === '1') {
      var container = document.getElementById('gitalk-container');
      if (container) {
        var commentID = container.getAttribute('data-comment-id');
        var lang = container.getAttribute('data-lang');

        var gitalk = new Gitalk({
          clientID: 'fcf61195c7f73253dc8b',
          clientSecret: '0ac2907be08248a1fcb5312e27480ad535c682e5',
          repo: 'blogComments',
          owner: 'fatbobman',
          admin: ['fatbobman'],
          id: commentID.split('/').pop().substring(0, 49),
          distractionFreeMode: true,
          createIssueManually: true,
          language: lang,
        });

        gitalk.render('gitalk-container');
      }
    }
  });
</script> <div class="hidden xl:block w-44 lg:absolute" id="toc" style="left: -30px; top: 0px"> <div class="text-muted items-center justify-center overflow-x-clip"> <div class="w-full flex justify-start pb-2" id="toc-button"> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" id="toc-list-switcher"> <path d="M170.666667 277.333333a85.333333 85.333333 0 1 0 0-170.666666 85.333333 85.333333 0 0 0 0 170.666666zM405.333333 128a64 64 0 1 0 0 128h469.333334a64 64 0 0 0 0-128h-469.333334zM341.333333 490.666667A64 64 0 0 1 405.333333 426.666667h469.333334a64 64 0 0 1 0 128h-469.333334A64 64 0 0 1 341.333333 490.666667z m0 298.666666A64 64 0 0 1 405.333333 725.333333h469.333334a64 64 0 0 1 0 128h-469.333334A64 64 0 0 1 341.333333 789.333333z m-85.333333-298.666666a85.333333 85.333333 0 1 1-170.666667 0 85.333333 85.333333 0 0 1 170.666667 0z m-85.333333 384a85.333333 85.333333 0 1 0 0-170.666667 85.333333 85.333333 0 0 0 0 170.666667z"></path> </svg>  </div> </div> <div class="text-default text-xs hidden" id="toc-list"> <ul> <li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#什么是所谓的现代方法？" class=""> 什么是所谓的现代方法？ </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#创建数据管理模块" class=""> 创建数据管理模块 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#构建数据模型" class=""> 构建数据模型 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#swiftdata-同样需要-stack" class=""> SwiftData 同样需要 Stack </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#用-modelactor-封装数据操作逻辑" class=""> 用 @ModelActor 封装数据操作逻辑 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#编写测试" class=""> 编写测试 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#为注入做好准备" class=""> 为注入做好准备 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#始终使用一个实例还是每次创建新的实例" class=""> 始终使用一个实例还是每次创建新的实例 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#将数据模块集成到项目中" class=""> 将数据模块集成到项目中 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#构建独立视图来展示数据" class=""> 构建独立视图来展示数据 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#是否还需要数据转换层？" class=""> 是否还需要数据转换层？ </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#为预览做准备" class=""> 为预览做准备 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#新的问题数据更新后视图没有刷新" class=""> 新的问题：数据更新后视图没有刷新 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#解决思路" class=""> 解决思路 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#临时解决方案" class=""> 临时解决方案 </a> </div> </li><li class=" pb-1"> <div class="text-muted hover:text-secondary items-center justify-start"> <a href="#总结" class=""> 总结 </a> </div> </li> </ul> </div> </div> </div> <style>
  #toc-list {
    transition: all 0.9s ease-in-out;
  }

  #toc-button {
    transition: all 0.9s ease-in-out;
  }
</style> <script>
  function getOffsetTop(element) {
    var offsetTop = 0;
    while (element) {
      offsetTop += element.offsetTop;
      element = element.offsetParent;
    }
    return offsetTop;
  }

  var toc = document.querySelector('#toc');
  // 获取 sidebar 在浏览器中的初始 top 值
  var initialTop = getOffsetTop(toc);
  var positioningElement = document.querySelector('#article-area'); // 定位视图的选择器
  var stickyPoint = 150;
  var tocPadding = 30;
  var tocTopOffset = 4;
  var sidebarWidth = toc.offsetWidth;

  function adjustTocPosition() {
    var sidebarOffsetTop = toc.getBoundingClientRect().top;
    console.log(sidebarOffsetTop, window.scrollY, initialTop - stickyPoint);
    if (sidebarOffsetTop <= stickyPoint) {
      // 获取 positioningElement 的左侧侧与浏览器左侧之间的距离
      var positioningElementRight = (window.innerWidth - positioningElement.getBoundingClientRect().width) / 2;
      toc.style.position = 'fixed';
      toc.style.top = stickyPoint + 'px';
      toc.style.left = positioningElementRight - toc.getBoundingClientRect().width - tocPadding + 'px';
    }

    if (window.scrollY <= initialTop - stickyPoint) {
      toc.style.position = 'absolute';
      toc.style.top = tocTopOffset + 'px';
      toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';
    }
  }

  document.addEventListener('scroll', adjustTocPosition);
  window.addEventListener('resize', adjustTocPosition);
  // doc 加载完成后，调整 toc 的位置
  toc.style.left = -(tocPadding + toc.getBoundingClientRect().width) + 'px';

  document.addEventListener('DOMContentLoaded', function () {
    const tocList = document.getElementById('toc-list');
    const tocButton = document.getElementById('toc-button');

    // 更新toc-list和toc-button的显示状态
    function updateDisplay() {
      const showToc = localStorage.getItem('showToc') === 'true';
      if (showToc) {
        tocList.classList.remove('hidden');
        tocButton.classList.add('justify-start');
        tocButton.classList.remove('justify-end');
      } else {
        tocList.classList.add('hidden');
        tocButton.classList.remove('justify-start');
        tocButton.classList.add('justify-end');
      }
    }

    // 初始状态检查
    updateDisplay();

    // 点击事件监听器，用于切换toc-list的显示状态并更新按钮位置
    tocButton.addEventListener('click', function () {
      const isHidden = tocList.classList.contains('hidden');
      localStorage.setItem('showToc', isHidden);
      updateDisplay();
    });
  });
</script> <div class="hidden md:block md:absolute" id="sidebar" style="right: -50px; top: 0px"> <div class="flex flex-col space-y-4 text-muted items-center justify-center"> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="/zh/posts/swiftui-views-and-mainactor/" data-tooltip-target="tooltip-previous-post" data-tooltip-placement="left" id="sidebar-previous-post"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12.089 3.634a2 2 0 0 0 -1.089 1.78l-.001 2.586h-6.999a2 2 0 0 0 -2 2v4l.005 .15a2 2 0 0 0 1.995 1.85l6.999 -.001l.001 2.587a2 2 0 0 0 3.414 1.414l6.586 -6.586a2 2 0 0 0 0 -2.828l-6.586 -6.586a2 2 0 0 0 -2.18 -.434l-.145 .068z" stroke-width="0" fill="currentColor"></path></svg> </a>  </div> <div id="tooltip-previous-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> SwiftUI 视图与 @MainActor <div class="tooltip-arrow" data-popper-arrow></div> </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="/zh/posts/tips-and-considerations-for-using-lazy-containers-in-swiftui/" data-tooltip-target="tooltip-next-post" data-tooltip-placement="left" id="sidebar-next-post"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9.586 4l-6.586 6.586a2 2 0 0 0 0 2.828l6.586 6.586a2 2 0 0 0 2.18 .434l.145 -.068a2 2 0 0 0 1.089 -1.78v-2.586h7a2 2 0 0 0 2 -2v-4l-.005 -.15a2 2 0 0 0 -1.995 -1.85l-7 -.001v-2.585a2 2 0 0 0 -3.414 -1.414z" stroke-width="0" fill="currentColor"></path></svg> </a>  </div> <div id="tooltip-next-post" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 w-44 text-sm font-medium text-gray-200 bg-gray-600/90 rounded-lg shadow-sm transition-opacity duration-300 tooltip dark:bg-gray-700/90"> 几个在 SwiftUI 中使用惰性容器的技巧和注意事项 <div class="tooltip-arrow" data-popper-arrow></div> </div> <div class="hidden" id="dict-randomURLS" data-randomurls="[&#34;/zh/posts/concurret-programming-in-swiftdata/&#34;,&#34;/zh/posts/unveiling-the-data-modeling-principles-of-swiftdata/&#34;,&#34;/zh/posts/relationships-in-swiftdata-changes-and-considerations/&#34;,&#34;/zh/posts/modern-core-data-problem/&#34;,&#34;/zh/posts/modern-core-data-data-definition/&#34;,&#34;/zh/posts/modern-core-data-respond-data-safely/&#34;,&#34;/zh/posts/masteringofcoredatastack/&#34;,&#34;/zh/posts/nsubiquitouskeyvaluestore/&#34;,&#34;/zh/posts/coredatawithcloudkit-2/&#34;]" data-astro-cid-qwm5cfxr></div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:18px; height:18px;">  <svg fill="currentColor" stroke="currentColor" onclick="openRandomUrl()" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" id="sidebar-random-post" data-astro-cid-qwm5cfxr> <path d="M956.222464 226.56a28.8256 28.8256 0 0 0 18.5344-17.5104 26.368 26.368 0 0 0-3.5328-24.4224 46.9504 46.9504 0 0 0-20.1216-14.08A18601.6256 18601.6256 0 0 0 712.152064 74.5472L524.555264 0h-25.6l-17.0496 7.0144C359.384064 55.3472 237.528064 103.0144 115.672064 152.6272l-46.7456 18.8928a29.3888 29.3888 0 0 0-21.1456 27.1872 28.6208 28.6208 0 0 0 20.48 27.8528c1.6896 0 5.12 1.8944 6.8096 2.8672C214.027264 288 353.240064 346.2144 492.145664 405.0944a44.8 44.8 0 0 0 40.6016 0L887.972864 256c23.8592-9.9328 45.7216-20.1728 68.2496-29.44zM341.976064 224a121.4464 121.4464 0 0 1-126.2592 0 31.6928 31.6928 0 0 1-16.9984-27.648c0-11.4688 6.4512-22.016 16.9984-27.6992a98.9696 98.9696 0 0 1 54.272-17.6128c25.3952-1.9456 50.7904 4.2496 71.9872 17.6128a31.6928 31.6928 0 0 1 16.9984 27.648 31.6928 31.6928 0 0 1-16.9984 27.648z m233.0624 0c-38.4 24.2176-88.576 24.2176-126.976 0a31.6416 31.6416 0 0 1-16.384-27.392c0-11.1616 6.2464-21.504 16.384-27.3408 19.968-12.9024 44.032-19.0976 68.3008-17.6128 19.9168 0.1024 39.3216 5.9392 55.6032 16.64 11.0592 5.12 18.2272 15.4624 18.8928 27.0336a31.488 31.488 0 0 1-15.8208 28.672z m234.4448 0a121.4464 121.4464 0 0 1-126.2592 0 31.6928 31.6928 0 0 1-16.9984-27.648c0-11.4688 6.4512-22.016 16.9984-27.6992 17.8688-12.8 39.936-19.3024 62.464-18.2784 22.3232-1.024 44.3392 5.2224 62.464 17.6128a31.8464 31.8464 0 0 1 18.2784 27.648 31.6416 31.6416 0 0 1-16.9472 28.3648zM468.235264 437.0944c-30.72-12.4928-61.44-25.2928-92.4672-39.0144-109.568-46.08-217.088-90.2656-325.2224-135.68a36.096 36.096 0 0 0-31.3856-1.9456 33.6896 33.6896 0 0 0-18.432 33.9456v495.9744c-2.048 27.0848 14.9504 52.2752 41.984 62.0544 133.12 55.3472 265.1136 110.7456 397.2096 167.0656 28.672 11.776 49.4592 0 49.4592-30.1056V475.4944c4.096-16.1792-5.6832-32.5632-22.528-37.7344l1.3824-0.6656z m-197.5808 243.2a34.4064 34.4064 0 0 1-28.16 16.64 34.9184 34.9184 0 0 1-29.8496-13.7728 91.8016 91.8016 0 0 1-22.528-75.2128c2.5088-15.0016 7.68-29.4912 15.36-42.8544a34.304 34.304 0 0 1 27.648-17.0496 35.072 35.072 0 0 1 30.0032 12.9024c15.3088 16.5376 23.7568 37.632 23.9104 59.4944 1.28 21.0432-4.4544 41.984-16.384 59.8528z m704.3072-417.8944l-416.256 175.0016a36.4544 36.4544 0 0 0-24.9344 36.5056v514.8672a28.416 28.416 0 0 0 13.4144 29.184 32.768 32.768 0 0 0 33.9968 0.256L983.512064 848.896c25.0368-8.8576 41.4208-31.5392 40.96-56.6272V293.7344c0-28.7744-21.8624-42.5472-49.5104-31.3344z m-257.6384 578.2016a34.8672 34.8672 0 0 1-30.208 14.2848 34.304 34.304 0 0 1-28.4672-17.152 103.5264 103.5264 0 0 1 7.5264-118.0672 34.9696 34.9696 0 0 1 30.6176-13.7216c12.032 0.8704 22.7328 7.68 28.0576 17.8688 10.24 16.8448 15.1552 35.9936 14.336 55.3472a92.16 92.16 0 0 1-21.8624 61.44z m181.9136-293.12a34.816 34.816 0 0 1-31.3344 15.4112 34.1504 34.1504 0 0 1-29.0816-18.944 104.0384 104.0384 0 0 1 5.7856-115.5072 34.6624 34.6624 0 0 1 32.9216-16.8448 33.792 33.792 0 0 1 29.5424 21.6576c9.216 14.592 13.824 31.3856 13.312 48.3328 0.6144 23.7568-7.4752 47.0016-22.8864 65.8944h1.7408z" p-id="9271" data-astro-cid-qwm5cfxr></path> </svg>  </div>  <script>
  function openRandomUrl() {
    const dataElement = document.getElementById('dict-randomURLS');
    const urls = JSON.parse(dataElement.getAttribute('data-randomurls'));

    if (urls && urls.length > 0) {
      const randomUrl = urls[Math.floor(Math.random() * urls.length)];
      window.open(randomUrl, '_self');
    }
  }

  const svgElement = document.getElementById('sidebar-random-post');

  setInterval(() => {
    svgElement.classList.add('rotate');

    // Remove the class after the animation completes (1 second)
    setTimeout(() => {
      svgElement.classList.remove('rotate');
    }, 1000);
  }, 15000); // 20 seconds interval
</script> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://x.com/intent/tweet?text=SwiftData 实战：用现代方法构建 SwiftUI 应用&#38;url=https://fatbobman.com/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/&#38;hashtags=ios,swiftlang&#38;via=fatbobman" target="_blank" id="sidebar-share-with-twitter"> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 4l11.733 16h4.267l-11.733 -16z"></path><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"></path></svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://bsky.app/intent/compose?text=SwiftData 实战：用现代方法构建 SwiftUI 应用%0A by %40fatbobman.bsky.social %0Ahttps://fatbobman.com/zh/posts/practical-swiftdata-building-swiftui-applications-with-modern-approaches/%0A #ios #swift" target="_blank" id="sidebar-share-with-bluesky"> <svg xmlns="http://www.w3.org/2000/svg" class="text-default hover:text-secondary" width="20" height="20" viewBox="0 0 24 24" stroke-width="0.7" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round"> <path d="M4.9 3.02725C5.6 3.12725 6.4 3.52725 7.5 4.22725C9.3 5.62725 10.8 7.32725 12 9.22726C13.2 7.42725 14.7 5.62725 16.5 4.32725C17.5 3.62725 18.4 3.22725 19.1 3.12725C19.9 3.02725 20.4 3.22725 20.7 3.32725C21.7 3.72725 22 4.92725 22 5.92725C22 6.12725 21.9 7.22725 21.8 8.32725C21.7 8.82725 21.7 9.42726 21.6 9.92726C21.5 10.3273 21.5 10.8273 21.4 11.0273C21.1 12.2273 20.3 13.0273 19.4 13.5273C20.3 14.2273 20.7 15.4273 20.3 16.5273C19.7 18.4273 17.6 20.9273 15.5 21.1273C13.7 21.3273 12.6 19.8273 11.9 18.3273C11.2 19.7273 10.1 21.2273 8.3 21.1273C6.2 20.9273 4.1 18.4273 3.5 16.5273C3.2 15.4273 3.5 14.2273 4.4 13.5273C3.5 13.0273 2.8 12.1273 2.4 11.0273C2.3 10.7273 2.3 10.3273 2.2 9.92726C2.1 9.42726 2.1 8.92725 2 8.32725C2.1 7.12725 2 6.02725 2 5.82725C2 4.82725 2.3 3.62725 3.3 3.22725C3.6 3.12725 4.1 2.92725 4.9 3.02725ZM4 6.52725C4.1 7.32725 4.2 8.62725 4.3 9.52725C4.3 9.82725 4.4 10.0273 4.4 10.3273C4.8 11.6273 6.3 12.4273 8.1 12.2273C8.6 12.1273 9.1 12.5273 9.2 13.1273C9.3 13.6273 8.9 14.1273 8.4 14.2273C7.6 14.3273 5.1 14.6273 5.5 15.8273C5.9 17.0273 7.3 18.9273 8.6 19.0273C9.5 19.1273 10.1 17.6273 10.4 17.0273C10.7 16.3273 10.9 15.6273 11.1 15.0273C11.2 14.6273 11.6 14.3273 12.1 14.3273C12.6 14.3273 12.9 14.6273 13.1 15.0273C13.3 15.6273 13.5 16.3273 13.8 17.0273C14.1 17.7273 14.6 19.1273 15.6 19.0273C16.9 18.9273 18.4 16.9273 18.7 15.8273C19.1 14.5273 16.5 14.3273 15.8 14.2273C15.3 14.1273 14.9 13.6273 15 13.1273C15.1 12.6273 15.6 12.2273 16.1 12.2273C17.9 12.4273 19.4 11.7273 19.8 10.3273C19.9 10.0273 19.9 9.82725 19.9 9.52725C20 8.62725 20.1 7.32725 20.2 6.52725C20.2 6.02725 20.4 4.92725 19.7 5.02725C19.4 5.02725 18.9 5.22725 18 5.92725C15.7 7.32725 14 9.42725 12.9 11.6273C12.7 11.9273 12.4 12.1273 12 12.1273C11.6 12.1273 11.3 11.9273 11.1 11.6273C10 9.42725 8.3 7.32725 6.3 5.92725C5.4 5.32725 4.9 5.12725 4.6 5.02725C3.8 4.92725 4 6.02725 4 6.52725Z" fill="currentColo"></path> </svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpractical-swiftdata-building-swiftui-applications-with-modern-approaches%2F" target="_blank" id="sidebar-share-with-facebook"> <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M767.428571 6.857143v150.857143h-89.714285q-49.142857 0-66.285715 20.571428t-17.142857 61.714286v108h167.428572l-22.285715 169.142857h-145.142857v433.714286H419.428571V517.142857H273.714286V348h145.714285V223.428571q0-106.285714 59.428572-164.857142T637.142857 0q84 0 130.285714 6.857143z" p-id="4213"></path></svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpractical-swiftdata-building-swiftui-applications-with-modern-approaches%2F&#38;title=SwiftData%20%E5%AE%9E%E6%88%98%EF%BC%9A%E7%94%A8%E7%8E%B0%E4%BB%A3%E6%96%B9%E6%B3%95%E6%9E%84%E5%BB%BA%20SwiftUI%20%E5%BA%94%E7%94%A8%0A%20%23ios%20%23swift%0A%20by%20%40fatbobman%0A" target="_blank" id="sidebar-share-with-weibo"> <svg fill="currentColor" stroke="currentColor" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M457.3 543c-68.1-17.7-145 16.2-174.6 76.2-30.1 61.2-1 129.1 67.8 151.3 71.2 23 155.2-12.2 184.4-78.3 28.7-64.6-7.2-131-77.6-149.2z m-52 156.2c-13.8 22.1-43.5 31.7-65.8 21.6-22-10-28.5-35.7-14.6-57.2 13.7-21.4 42.3-31 64.4-21.7 22.4 9.5 29.6 35 16 57.3z m45.5-58.5c-5 8.6-16.1 12.7-24.7 9.1-8.5-3.5-11.2-13.1-6.4-21.5 5-8.4 15.6-12.4 24.1-9.1 8.7 3.2 11.8 12.9 7 21.5zM785.3 443.5c15 4.8 31-3.4 35.9-18.3 11.8-36.6 4.4-78.4-23.2-109-27.6-30.6-68.4-42.3-106-34.3-15.4 3.3-25.2 18.4-21.9 33.8 3.3 15.3 18.4 25.2 33.8 21.8 18.4-3.9 38.3 1.8 51.9 16.7 13.5 15 17.2 35.4 11.3 53.3-4.9 15.1 3.2 31.1 18.2 36z"></path><path d="M885.1 237.5c-56.7-62.9-140.4-86.9-217.7-70.5-17.9 3.8-29.3 21.4-25.4 39.3 3.8 17.9 21.4 29.3 39.3 25.5 55-11.7 114.4 5.4 154.8 50.1 40.3 44.7 51.2 105.7 34 159.1-5.6 17.4 3.9 36 21.3 41.7 17.4 5.6 36-3.9 41.6-21.2v-0.1c24.1-75.4 8.9-161.1-47.9-223.9zM729 499c-12.2-3.6-20.5-6.1-14.1-22.1 13.8-34.7 15.2-64.7 0.3-86-28-40.1-104.8-37.9-192.8-1.1 0 0-27.6 12.1-20.6-9.8 13.5-43.5 11.5-79.9-9.6-101-47.7-47.8-174.6 1.8-283.5 110.6C127.3 471.1 80 557.5 80 632.2 80 775.1 263.2 862 442.5 862c235 0 391.3-136.5 391.3-245 0-65.5-55.2-102.6-104.8-118zM443 810.8c-143 14.1-266.5-50.5-275.8-144.5-9.3-93.9 99.2-181.5 242.2-195.6 143-14.2 266.5 50.5 275.8 144.4C694.4 709 586 796.6 443 810.8z"></path></svg> </a>  </div> <div class="hidden opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:16px; height:16px;">  <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpractical-swiftdata-building-swiftui-applications-with-modern-approaches%2F" target="_blank" id="sidebar-share-with-linkedin"> <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 15 15"> <path fill-rule="evenodd" d="M7.979 5v1.586a3.5 3.5 0 0 1 3.082-1.574C14.3 5.012 15 7.03 15 9.655V15h-3v-4.738c0-1.13-.229-2.584-1.995-2.584-1.713 0-2.005 1.23-2.005 2.5V15H5.009V5h2.97ZM3 2.487a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" clip-rule="evenodd"></path> <path d="M3 5.012H0V15h3V5.012Z"></path> </svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <a href="mailto:?subject=%E6%8E%A8%E8%8D%90%3A%20SwiftData%20%E5%AE%9E%E6%88%98%EF%BC%9A%E7%94%A8%E7%8E%B0%E4%BB%A3%E6%96%B9%E6%B3%95%E6%9E%84%E5%BB%BA%20SwiftUI%20%E5%BA%94%E7%94%A8&#38;body=%E6%88%91%E5%8F%91%E7%8E%B0%E4%BA%86%E8%BF%99%E7%AF%87%E6%9C%89%E8%B6%A3%E7%9A%84%E6%96%87%E7%AB%A0%EF%BC%8C%E6%83%B3%E5%88%86%E4%BA%AB%E7%BB%99%E4%BD%A0%EF%BC%9A%0A%0ASwiftData%20%E5%AE%9E%E6%88%98%EF%BC%9A%E7%94%A8%E7%8E%B0%E4%BB%A3%E6%96%B9%E6%B3%95%E6%9E%84%E5%BB%BA%20SwiftUI%20%E5%BA%94%E7%94%A8%0A%0A%E5%8E%9F%E6%96%87%E5%9C%B0%E5%9D%80%3A%20https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fpractical-swiftdata-building-swiftui-applications-with-modern-approaches%2F" target="_blank" id="sidebar-share-with-email"> <svg fill="currentColor" stroke="currentColor" stroke-width="4" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M874.666667 181.333333H149.333333c-40.533333 0-74.666667 34.133333-74.666666 74.666667v512c0 40.533333 34.133333 74.666667 74.666666 74.666667h725.333334c40.533333 0 74.666667-34.133333 74.666666-74.666667V256c0-40.533333-34.133333-74.666667-74.666666-74.666667z m-725.333334 64h725.333334c6.4 0 10.666667 4.266667 10.666666 10.666667v25.6L512 516.266667l-373.333333-234.666667V256c0-6.4 4.266667-10.666667 10.666666-10.666667z m725.333334 533.333334H149.333333c-6.4 0-10.666667-4.266667-10.666666-10.666667V356.266667l356.266666 224c4.266667 4.266667 10.666667 4.266667 17.066667 4.266666s12.8-2.133333 17.066667-4.266666l356.266666-224V768c0 6.4-4.266667 10.666667-10.666666 10.666667z"></path></svg> </a>  </div> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" onclick="scrollToElement()" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M573 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40zM293 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40z" p-id="13138"></path><path d="M894 345c-48.1-66-115.3-110.1-189-130v0.1c-17.1-19-36.4-36.5-58-52.1-163.7-119-393.5-82.7-513 81-96.3 133-92.2 311.9 6 439l0.8 132.6c0 3.2 0.5 6.4 1.5 9.4 5.3 16.9 23.3 26.2 40.1 20.9L309 806c33.5 11.9 68.1 18.7 102.5 20.6l-0.5 0.4c89.1 64.9 205.9 84.4 313 49l127.1 41.4c3.2 1 6.5 1.6 9.9 1.6 17.7 0 32-14.3 32-32V753c88.1-119.6 90.4-284.9 1-408zM323 735l-12-5-99 31-1-104-8-9c-84.6-103.2-90.2-251.9-11-361 96.4-132.2 281.2-161.4 413-66 132.2 96.1 161.5 280.6 66 412-80.1 109.9-223.5 150.5-348 102z m505-17l-8 10 1 104-98-33-12 5c-56 20.8-115.7 22.5-171 7l-0.2-0.1C613.7 788.2 680.7 742.2 729 676c76.4-105.3 88.8-237.6 44.4-350.4l0.6 0.4c23 16.5 44.1 37.1 62 62 72.6 99.6 68.5 235.2-8 330z" p-id="13139"></path><path d="M433 421c-23.1 0-41 17.9-41 40s17.9 40 41 40c21.1 0 39-17.9 39-40s-17.9-40-39-40z" p-id="13140"></path></svg>  </div> <script>
  var offset = 80
  function scrollToElement() {
    var gitalkContainer = document.getElementById('gitalk-container');
    if (gitalkContainer) {
      var topPosition = gitalkContainer.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: topPosition, behavior: 'smooth' });
    }
  }
</script> <div class=" opacity-50 hover:opacity-100 text-heading hover:text-secondary" style="width:20px; height:20px;">  <svg fill="currentColor" stroke="currentColor" onclick="window.scrollTo({top:0,behavior:'smooth'})" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M862.464 161.536l-700.928 0c-30.976 0-56.096-25.12-56.096-56.096l0-28.064c0-30.944 25.12-56.064 56.096-56.064l700.896 0c30.976 0 56.096 25.12 56.096 56.064l0 28.032c0 31.008-25.12 56.096-56.096 56.096l0 0 0 0zM138.528 531.68c0 0 306.816-245.792 309.888-248.864 14.304-13.888 31.904-22.368 49.952-25.312 1.76-0.32 3.488-0.608 5.248-0.8 2.816-0.32 5.6-0.352 8.384-0.352 2.816-0.032 5.568 0.032 8.352 0.352 1.792 0.192 3.552 0.48 5.28 0.8 18.048 2.976 35.616 11.424 49.92 25.312 3.104 3.008 309.856 248.864 309.856 248.864 33.152 32.224 30.304 65.44-2.784 97.696s-77.376 3.04-110.496-29.216l-190.08-150.432 0 496.864c0 31.008-25.088 56.096-56.096 56.096l-28 0c-30.976 0-56.096-25.12-56.096-56.096l0-496.864-190.048 150.432c-33.088 32.288-77.408 61.536-110.496 29.216-33.056-32.256-35.872-65.44-2.816-97.696l0 0 0 0z"></path></svg>  </div> </div> </div> <script>
  function getOffsetTop(element) {
    var offsetTop = 0;
    while (element) {
      offsetTop += element.offsetTop;
      element = element.offsetParent;
    }
    return offsetTop;
  }

  var sidebar = document.querySelector('#sidebar');
  // 获取 sidebar 在浏览器中的初始 top 值
  var initialTop = getOffsetTop(sidebar);
  var positioningElement = document.querySelector('#article-area'); // 定位视图的选择器
  var stickyPoint = 150;
  var padding = 50;
  var topOffset = 0;
  var sidebarWidth = sidebar.offsetWidth;

  function adjustSidebarPosition() {
    var sidebarOffsetTop = sidebar.getBoundingClientRect().top;
    if (sidebarOffsetTop <= stickyPoint) {
      // 获取 positioningElement 的右侧与浏览器右侧之间的距离
      var positioningElementRight = (window.innerWidth - positioningElement.getBoundingClientRect().width) / 2;
      sidebar.style.position = 'fixed';
      sidebar.style.top = stickyPoint + 'px';
      sidebar.style.right = positioningElementRight - padding + 'px';
    }

    if (window.scrollY <= initialTop - stickyPoint) {
      sidebar.style.position = 'absolute';
      sidebar.style.top =  topOffset + 'px';
      sidebar.style.right = '-' + padding + 'px';
    }
  }

  document.addEventListener('scroll', adjustSidebarPosition);
  window.addEventListener('resize', adjustSidebarPosition);
</script> </div>   </div> </main> </div> <footer> <footer class="bg-block"> <div class="mx-auto w-full max-w-3xl px-4 md:px-6"> <div class="container flex flex-col items-center pt-10"> <div class="flex flex-row justify-around w-full space-x-3"> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">网站</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://apps.apple.com/us/app/id1534513553" class="hover:text-secondary" target="_blank">健康笔记</a> <a href="https://discord.gg/zhou-zi-de-swiftji-shi-ben-967978112509935657" class="hover:text-secondary" target="_blank">Discord</a> <a href="/zh/posts/" class="hover:text-secondary">文章</a> <a href="/zh/tags/" class="hover:text-secondary">标签</a> <a href="/zh/collections/" class="hover:text-secondary">合集</a> <a href="/zh/snippet/" class="hover:text-secondary">小贴士</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">关注</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="https://weekly.fatbobman.com" class="hover:text-secondary">周报</a> <a href="https://x.com/fatbobman" class="hover:text-secondary" target="_blank">Twitter</a> <a href="https://mastodon.social/@fatbobman" class="hover:text-secondary" target="_blank">Mastodon</a> <a href="https://www.linkedin.com/in/fatbobman/" class="hover:text-secondary" target="_blank">Linkedin</a> <a href="https://bsky.app/profile/fatbobman.bsky.social" class="hover:text-secondary" target="_blank">Blue Sky</a> <a href="https://web.okjike.com/u/e32947ef-7751-4363-9456-b340eef2efd3" class="hover:text-secondary" target="_blank">
即刻
</a> <a href="https://github.com/fatbobman" class="hover:text-secondary" target="_blank">GitHub</a> <a href="/zh/rss.xml" class="hover:text-secondary hover:font-medium" target="_blank">RSS</a> </div> </div> <div class="flex flex-col space-y-4"> <h2 class="font-bold text-heading">信息</h2> <div class="flex flex-col space-y-2 text-sm text-default font-medium"> <a href="/zh/about/" class="hover:text-secondary">关于</a>  </div> </div> </div> <div class="pb-0"> <div class="flex items-center justify-center w-full px-6 pt-12 text-sm"> <span class="text-muted text-xs">Copyright © <span>2020-</span> 2025 <a href="https://x.com/fatbobman" class="border-b-secondary border-b-[1px]">Fatbobman Digital Limited</a>. All Rights
            Reserved.</span> </div> <div class="flex items-center justify-center w-full px-6 pt-2 text-sm pb-10"> <span> <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank" class="block text-xs text-muted">
辽ICP备20006550号-1
</a> </span> </div> </div> </div> </div> </footer> </footer> </div>   <!-- <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.8.0/flowbite.min.js"></script> --><script type="module" src="/js/theme.js" defer></script> <script>(function(){const currentLang = "zh";

  function attachEvent(selector, event, fn) {
    const matches = typeof selector === 'string' ? document.querySelectorAll(selector) : selector;
    if (matches && matches.length) {
      matches.forEach((elem) => {
        elem.addEventListener(event, (e) => fn(e, elem), false);
      });
    }
  }

  // 为每个需要清除 focus 状态的按钮都添加一个 clear-focus 类, 下面的代码将在点击后自动移除 focus 状态
  document.addEventListener('DOMContentLoaded', (event) => {
    // 获取所有具有 'clear-focus' 类的按钮
    const buttons = document.querySelectorAll('.clear-focus');

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        setTimeout(() => {
          button.blur();
        }, 0);
      });
    });
  });

  window.onpageshow = function () {
    document.documentElement.classList.add('motion-safe:scroll-smooth');
  };
})();</script> <div id="docsearch-container-data" data-lang="zh" data-searchtext="搜索..."></div> <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script> <script src="/js/runsearch.js"></script> <!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5C7N4MF5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!-- End Google Tag Manager (noscript) --> </body></html>