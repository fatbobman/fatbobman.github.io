const discordAd = `
      <div class="tracking-wide">
        <a href="https://t.ly/gzxeh" target="_blank" rel="sponsored">
          <div
             class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 hover:scale-105 transition-all duration-200"
          >
          <div class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl">马上加入</div>
            <img
              src="https://cdn.fatbobman.com/ads/apple-100.svg"
              alt="Join Discord Logo"
              width="96"
              height="96" 
              class="mr-0 sm:mr-2 mb-4 sm:mb-0 hidden sm:block"
              loading="lazy"
              decoding="async"
            />
            <div class="space-y-2 sm:pr-1">
              <div class="mb-6">
                <span class="text-xl font-bold text-orange-700 dark:text-blue-200 leading-tight dark:group-hover:text-white group-hover:text-amber-900">代码相连，创意无限 - 加入我们的开发者社区!</span>
              </div>
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal">
                加入我们活跃的 Discord 苹果开发者社区! 与 2000 多名中文开发者一起深入探讨 Swift、SwiftUI 和 SwiftData 的最新进展。分享经验，解决难题，共同成长!
              </div>
            </div>
          </div>
        </a>
           <div class="flex justify-center pt-6">
            <div
              class="text-secondary transition-all duration-200 text-xs font-semibold dark:hover:text-blue-200 hover:text-red-600 hover:scale-105 hover:font-bold cursor-pointer"
              onclick="window.location.href='https://t.ly/gzxeh';"
            >
            🚀 马上加入，享受交流的快乐 → 
            </div>
          </div>
      </div>
      `

const visionOS2025Ad = `
      <div class="tracking-wide">
        <a href="https://www.huodongxing.com/event/8788490895500?coupon=GsiOBQF" target="_blank" rel="sponsored">
          <div
             class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 hover:scale-105 transition-all duration-200"
          >
          <div class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl">立即报名</div>
            <img
              src="https://cdn.fatbobman.com/ads/wwdc2024.playground.svg"
              alt="let's vision 2025"
              width="96"
              height="96" 
              class="mr-0 sm:mr-2 mb-4 sm:mb-0 hidden sm:block"
              loading="lazy"
              decoding="async"
            />
            <div>
              <div class="mb-6 font-bold text-orange-700 dark:text-blue-200 dark:group-hover:text-white group-hover:text-amber-900">
              <span class="text-xl ">Let's Vision 2025</span> 
              </div>
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal">
                与全球的开发者一起参加于

                <strong class="text-orange-700 dark:text-blue-200 leading-tight">2025.03.01 - 2025.03.02 在上海</strong> 举办的 <strong class="text-orange-700 dark:text-blue-400 leading-tight">Let's Vision 2025</strong>。
              </div>
              <!-- <div class="text-sm text-gray-600 dark:text-gray-400 italic leading-loose font-medium">赶快报名，不要错过这场技术盛宴！</div> -->
            </div>
          </div>
        </a>
           <div class="flex justify-center pt-6">
            <div
              class="text-secondary transition-all duration-200 text-xs font-semibold dark:hover:text-blue-200 hover:text-red-600 hover:scale-105 hover:font-bold cursor-pointer"
              onclick="window.location.href='https://www.huodongxing.com/event/8788490895500?coupon=GsiOBQF';"
            >
            🚀 九折购买门票通道 → 
            </div>
          </div>
      </div>
`

const midstAd = `
  <div>
        <a href="https://t.ly/hym2p" target="_blank" rel="sponsored">
          <div
            class="p-4 bg-orange-100/70 dark:bg-blue-900 border border-orange-300 dark:border-blue-700 rounded-lg shadow-md mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-800 space-y-0"
          >
            <div class="absolute top-0 right-0 text-secondary text-xs font-bold rounded mt-2 mr-4">SPONSOR</div>
            <img
              src="https://cdn.fatbobman.com/ads/midst-light.webp"
              alt="Midst"
              style="width: 6rem; height: 6rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden sm:block dark:hidden"
              loading="lazy"
              decoding="async"
            />
            <img
              src="https://cdn.fatbobman.com/ads/midst-dark.webp"
              alt="Midst"
              style="width: 6rem; height: 6rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden dark:hidden sm:dark:block"
              loading="lazy"
              decoding="async"
            />
            <div class="space-y-2">
              <style>
                .align-infinity {
                  vertical-align: 0.1em; /* 调整垂直位置 */
                }
              </style>
              <span class="text-xl font-bold text-orange-700 dark:text-blue-400 align-infinity"
                >The Midst: 本地分享，全球连接</span
              >
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal pb-2">
                The Midst 是一个专注地理位置的即时信息网络。帖子与当前位置绑定，其他用户需身处或移动地图到你区域才能看到。24小时后自动消失，保证信息新鲜。探索各地热点，分享周边新鲜事和灵感。
              </div>
              <!-- <div class="text-sm text-gray-600 dark:text-gray-400 italic leading-loose font-medium">赶快报名，不要错过这场技术盛宴！</div> -->
              <p class="mt-2 text-sm text-orange-700 dark:text-blue-400 italic font-medium">
                ✨ 立即加入，探索并分享你的精彩瞬间！🚀
              </p>
            </div>
          </div>
        </a>
      </div>
`

const pasteNowAd = `
    <div>
        <a href="https://t.ly/0JuSz" target="_blank" rel="sponsored">
          <div
            class="p-4 bg-orange-100/70 dark:bg-blue-900 border border-orange-300 dark:border-blue-700 rounded-lg shadow-md mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-800 space-y-0"
          >
            <div class="absolute top-0 right-0 text-secondary text-xs font-bold rounded mt-2 mr-4">Mac App</div>
            <img
              src="https://pastenow.app/static/pastenow/images/pastenow-logo@2x.529aa5dfe235.png"
              alt="PasteNow"
              style="width: 5rem; height: 5rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden sm:block"
              loading="lazy"
              decoding="async"
            />
            <div class="space-y-2">
              <style>
                .align-infinity {
                  vertical-align: 0.1em; /* 调整垂直位置 */
                }
              </style>
              <span class="text-xl font-bold text-orange-700 dark:text-blue-400 align-infinity"
                >PasteNow - Mac 剪贴板管理工具</span
              >
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal pb-2">
                PasteNow 是一款全新的剪贴板管理工具，可重复使用剪贴板历史数据。通过规则将历史内容分类，多种列表样式可供选择，同时支持多台设备间同步数据。
              </div>
              <!-- <div class="text-sm text-gray-600 dark:text-gray-400 italic leading-loose font-medium">赶快报名，不要错过这场技术盛宴！</div> -->
            </div>
          </div>
        </a>
      </div>
`

const zipicAd = `
    <div>
        <a href="https://t.ly/_4Leh" target="_blank" rel="sponsored">
          <div
            class="p-4 bg-orange-100/70 dark:bg-blue-900 border border-orange-300 dark:border-blue-700 rounded-lg shadow-md mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-800 space-y-0"
          >
            <div class="absolute top-0 right-0 text-secondary text-xs font-bold rounded mt-2 mr-4">Mac App</div>
            <img
              src="https://zipic.app/_astro/icon.55c1be86.png"
              alt="Zipic"
              style="width: 5rem; height: 5rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden sm:block"
              loading="lazy"
              decoding="async"
            />
            <div class="space-y-2">
              <style>
                .align-infinity {
                  vertical-align: 0.1em; /* 调整垂直位置 */
                }
              </style>
              <span class="text-xl font-bold text-orange-700 dark:text-blue-400 align-infinity"
                >Zipic - 极致简单的 Mac 图片压缩工具</span
              >
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal pb-2">
                让图片压缩变得前所未有的简单！只需拖拽即可完成，无需繁琐设置。支持主流图片格式，具备高效压缩、格式转换、尺寸修改等多种功能。
              </div>
              <!-- <div class="text-sm text-gray-600 dark:text-gray-400 italic leading-loose font-medium">赶快报名，不要错过这场技术盛宴！</div> -->
            </div>
          </div>
        </a>
      </div>
`

const getRandomContent = () => {
  const randomIndex = Math.floor(Math.random() * ads.length);
  return ads[randomIndex];
};

const ads = [
  discordAd,
  // visionOS2025Ad,
  // midstAd,
  // pasteNowAd,
  // zipicAd,
  // currentAd,
]

const currentAd = `
    <div class="relative rounded-lg overflow-visible shadow-lg mt-8 sm:mt-0">
    <!-- 上半部分（赞助展示区域） -->
    <a href="https://l.fatbobman.com/sb-boltai" target="_blank" rel="sponsored">
      <div
      class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 transition-all duration-200"
    >
        <!-- 右上角按钮：Sponsored Example -->
        <div
        class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl"
      >
        立即试用 BoltAI！
        </div>

        <img
          src="https://cdn.fatbobman.com/sb-boltai-White512@2x.png"
          alt="BoltAI Logo"
          width="80"
          height="80"
          class="mr-0 sm:mr-3 mb-4 sm:mb-0 hidden sm:block rounded-lg
opacity-90
dark:opacity-80 dark:saturate-75 dark:brightness-90 dark:contrast-90"
          loading="lazy"
          decoding="async"
        />

        <div class="space-y-2 pr-1">


          <div class="mb-6">
            <span
              class="text-xl font-bold text-orange-700 dark:text-blue-200 leading-tight group-hover:text-amber-900 dark:group-hover:text-white"
            >
            Mac 专属 AI 聊天工具<br>原生开发 · 极速体验 · 100+ 强大功能
          </div>
          <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal">
            体验 <span class="font-semibold">BoltAI！</span>专为 macOS 打造的最佳 AI 助手：在统一的原生界面中，让 AI 帮你搞定代码、写作和资料搜集。
          </div>
          <div class="px-3 py-1.5 mb-2 text-sm font-bold text-red-700 dark:text-orange-400 bg-orange-100 dark:bg-orange-950/40 rounded-md border-l-4 border-red-600 dark:border-orange-500">
            🎉 黑五特惠：使用优惠码 BFCM25 立享 51% 折扣
          </div>
        </div>
      </div>
    </a>

    <!-- 下半部分（Become a sponsor CTA） -->
    <a href="https://discord.com/invite/7FedN5E2QQ" target="_blank" rel="sponsored" class="block not-prose">
      <div
      class="bg-orange-100/40 dark:bg-blue-950/30 backdrop-blur-sm px-4 sm:px-8 py-3 sm:py-2.5 cursor-pointer hover:bg-orange-100/60 dark:hover:bg-blue-950/40 transition-all group rounded-b-lg relative z-10"
    >
        <div
          class="flex flex-col sm:flex-row items-center sm:items-center justify-center sm:justify-between gap-2 sm:gap-0"
        >
          <span class="text-orange-700/70 dark:text-blue-200/60 text-xs sm:text-sm font-normal text-center sm:text-left group-hover:text-orange-900 dark:group-hover:text-blue-100">
            与 2000+ 开发者一起讨论 iOS 开发
          </span>
          <span
            class="text-orange-700/70 dark:text-blue-200/60 text-xs sm:text-sm font-medium flex items-center gap-2 transition-all group-hover:text-orange-900 dark:group-hover:text-blue-100"
          >
            加入 Discord 社区
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"
              ></path>
            </svg>
          </span>
        </div>
      </div>
    </a>
  </div>
</div>
`

const startTime = new Date('2025-12-01T05:00:00Z');
const endTime = new Date('2025-12-08T10:00:00Z');

export async function onRequest(context) {
  const allowedOrigins = [
    'http://localhost:4321',
    'https://fatbobman.com',
    'https://fatbobman.github.io',
    'blogsource-8wyy6rcw.edgeone.site'
  ];

  const request = context.request;
  const origin = request.headers.get('Origin');
  const now = new Date();
  const headers = new Headers({
    'content-type': 'text/html; charset=UTF-8',
  });

  // 动态设置 CORS
  if (allowedOrigins.includes(origin)) {
    headers.append('Access-Control-Allow-Origin', '*'); // origin 为请求的源地址
    headers.append('Vary', 'Origin');
  }

  // 判断返回固定广告还是随机广告
  let ad = currentAd;
  let cacheDuration = 1200;
  // headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=3600`);
  if (now >= startTime && now <= endTime) {
    ad = currentAd; // 固定广告
    cacheDuration = 30; // 20 分钟 1200
    headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=3600`);
  } else {
    ad = getRandomContent(); // 随机广告
    cacheDuration = 30; // 5分钟 300
    headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=60`);
  }


  // 生成 ETag
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(ad));
  const etag = `"${btoa(String.fromCharCode(...new Uint8Array(hash)))}"`;

  if (request.headers.get('If-None-Match') === etag) {
    return new Response(null, { status: 304, headers });
  }

  headers.append('ETag', etag);

  // 返回广告内容
  return new Response(ad, { headers });
}

