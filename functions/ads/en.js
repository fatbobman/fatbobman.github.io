const visionOS2025Ad = `
      <div>
        <a href="https://t.ly/4j2kO" target="_blank" rel="sponsored">
          <div
            class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 hover:scale-105 transition-all duration-200"
          >
          <div class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl">Join Now</div>
            <img
              src="https://cdn.fatbobman.com/ads/wwdc2024.playground.svg"
              alt="let's visionOS 2025"
              width="96"
              height="96" 
              class="mr-0 sm:mr-2 mb-4 sm:mb-0 hidden sm:block"
              loading="lazy"
              decoding="async"
            />
            <div>
              <div class="mb-6 font-bold text-orange-700 dark:text-blue-200 dark:group-hover:text-white group-hover:text-amber-900">
              <span class="text-xl align-infinity"
                >Spatial Computing + AI + iOS = </span
              ><span class="text-3xl">∞</span>
              </div>
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal pb-2">
                Join developers from around the world at the
              
                <strong class="text-orange-700 dark:text-blue-200 leading-tight">Let's Vision 2025</strong>, 
                held in <strong class="text-orange-700 dark:text-blue-200 leading-tight">Shanghai, China, from March 1 to March 2, 2025</strong>.
              </div>
            </div>
          </div>
          <div class="flex justify-center pt-6">
            <div
              class="text-secondary transition-all duration-200 text-xs font-semibold dark:hover:text-blue-200 hover:text-red-600 hover:scale-105 hover:font-bold cursor-pointer"
              onclick="window.location.href='/en/sponsorship/';"
            >
            🚀 Start Promoting Today → 
            </div>
          </div>
        </a>
      </div>
`

const midstAd = `
      <div>
        <a href="https://t.ly/hym2p" target="_blank" rel="sponsored">
          <div
            class="p-4 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0"
          >
            <div class="absolute top-0 right-0 text-secondary text-xs font-bold rounded mt-2 mr-4">SPONSOR</div>
            <img
              src="https://cdn.fatbobman.com/ads/midst-light.webp"
              alt="Midst"
              style="width: 6rem; height: 6rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden sm:block dark:hidden"
            />
            <img
              src="https://cdn.fatbobman.com/ads/midst-dark.webp"
              alt="Midst"
              style="width: 6rem; height: 6rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden dark:hidden sm:dark:block"
              loading="lazy"
              decoding="async"
            />
            <div class="space-y-2">
              <style>
                .align-infinity {
                  vertical-align: 0.1em; /* 调整垂直位置 */
                }
              </style>
              <span class="text-xl font-bold text-orange-700 dark:text-blue-400 align-infinity"
                >The Midst: A location first information network.</span
              >
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal pb-2">
                Join a platform that allows you to pan across the map to discover what people are sharing across cities,
                countries, and the world.
              </div>
              <!-- <div class="text-sm text-gray-600 dark:text-gray-400 italic leading-loose font-medium">赶快报名，不要错过这场技术盛宴！</div> -->
              <p class="mt-2 text-sm text-orange-700 dark:text-blue-400 italic font-medium">
                Download on the App Store
              </p>
            </div>
          </div>
          <div class="flex justify-center py-6">
            <div
              class="text-secondary transition-all duration-200 text-xs font-semibold hover:text-buttonBg hover:scale-105 hover:font-bold cursor-pointer"
              onclick="window.location.href='/en/sponsorship/';"
            >
              Advertise on Blog & Newsletter &rarr;
            </div>
          </div>
        </a>
      </div>
`

const healthNotesAd = `
<div>
        <a href="https://t.ly/7Qg6u" target="_blank" rel="sponsored">
          <div 
          class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 hover:scale-105 transition-all duration-200"
          >
            <div class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl">Start Tracking</div>
            <img
                    src="https://cdn.fatbobman.com/healthnotes-logo.svg"
                    alt="Heath Notes Logo"
                    width="80"
                    height="80" 
                    class="mr-0 sm:mr-3 mb-4 sm:mb-0 hidden sm:block rounded-lg"
                    loading="lazy"
                    decoding="async"
            />
            <div class="space-y-2 pr-1">
              <div class="mb-6">
              <span class="text-xl font-bold text-orange-700 dark:text-blue-200 leading-tight dark:group-hover:text-white group-hover:text-amber-900">Your Health, Your Data, Your Control</span>
              </div>
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal">
                Health Notes: Custom health tracking for iOS, iPad, and macOS—tailored to your unique wellness journey.
              </div>
            </div>
          </div>
        </a>
        <div class="flex justify-center pt-6">
           <div 
               class="text-secondary transition-all duration-200 text-xs font-semibold dark:hover:text-blue-200 hover:text-red-600 hover:scale-105 hover:font-bold cursor-pointer"
               onclick="window.location.href='/en/sponsorship/';"
           >
           🚀 Start Promoting Today → 
           </div>
        </div>
      </div>
`;

const getRandomContent = () => {
  const randomIndex = Math.floor(Math.random() * ads.length);
  return ads[randomIndex];
};

const ads = [
  healthNotesAd,
  // visionOS2025Ad,
  // midstAd,
]


const currentAd = `
<div>
        <a href="https://l.fatbobman.com/sb-proxyman" target="_blank" rel="sponsored">
          <div
            class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 hover:scale-105 transition-all duration-200"
          >
            <div
              class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl"
            >
              Try it, love it!
            </div>
            <img
              src="https://cdn.fatbobman.com/ads/proxyman-icon-red-trim.webp"
              alt="Proxyman Logo"
              width="80"
              height="80"
              class="mr-0 sm:mr-6 mb-4 sm:mb-0 hidden rounded-lg dark:sm:block"
              loading="lazy"
              decoding="async"
            />
            <img
              src="https://cdn.fatbobman.com/ads/proxyman-icon-blue-trim.webp"
              alt="Proxyman Logo"
              width="80"
              height="80"
              class="mr-0 sm:mr-6 mb-4 sm:mb-0 hidden sm:block rounded-lg dark:hidden"
              loading="lazy"
              decoding="async"
            />
            <div class="space-y-2 pr-1">
              <div class="mb-6">
                <span
                  class="text-xl font-bold text-orange-700 dark:text-blue-200 leading-tight dark:group-hover:text-white group-hover:text-amber-900"
                >
                  Need to debug HTTPS on your iPhone?
                </span>
              </div>
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal">
                Try <span class="font-semibold">Proxyman!</span> The best-in-class macOS that helps you capture/debug HTTP(s) with a few clicks. Support
                iOS devices and Simulator.
              </div>
            </div>
          </div>
        </a>
        <div class="flex justify-center pt-6">
          <a
            href="https://l.fatbobman.com/sb-proxyman"
            class="text-secondary transition-all duration-200 text-xs font-semibold dark:hover:text-blue-200 hover:text-red-600 hover:scale-105 hover:font-bold cursor-pointer"
            rel="sponsored"
            target="_blank"
          >
            🚀 Get Started Now →
          </a>
        </div>
      </div>
`

const startTime = new Date('2025-04-14T00:00:00Z');
const endTime = new Date('2025-04-21T14:00:00Z');

export async function onRequest(context) {
  const allowedOrigins = [
    'http://localhost:4321',
    'https://fatbobman.com',
    'https://fatbobman.github.io',
    'https://blogsource.edgeone.site'
  ];

  const request = context.request;
  const origin = request.headers.get('Origin');
  const now = new Date();
  const headers = new Headers({
    'content-type': 'text/html; charset=UTF-8',
  });

  // 动态设置 CORS
  if (allowedOrigins.includes(origin)) {
    headers.append('Access-Control-Allow-Origin', origin);
    headers.append('Vary', 'Origin');
  }

  // 判断返回固定广告还是随机广告
  let ad;
  let cacheDuration;
  if (now >= startTime && now <= endTime) {
    ad = currentAd; // 固定广告
    cacheDuration = 1200; // 20 分钟
    headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=3600`);
  } else {
    ad = getRandomContent(); // 随机广告
    cacheDuration = 300; // 5分钟
    headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=60`);
  }

  // 生成 ETag
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(ad));
  const etag = `"${btoa(String.fromCharCode(...new Uint8Array(hash)))}"`;

  if (request.headers.get('If-None-Match') === etag) {
    return new Response(null, { status: 304, headers });
  }

  headers.append('ETag', etag);

  // 返回广告内容
  return new Response(ad, { headers });
}
