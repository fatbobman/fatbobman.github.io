const visionOS2025Ad = `
      <div>
        <a href="https://t.ly/4j2kO" target="_blank" rel="sponsored">
          <div
            class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 hover:scale-105 transition-all duration-200"
          >
          <div class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl">Join Now</div>
            <img
              src="https://cdn.fatbobman.com/ads/wwdc2024.playground.svg"
              alt="let's visionOS 2025"
              width="96"
              height="96" 
              class="mr-0 sm:mr-2 mb-4 sm:mb-0 hidden sm:block"
              loading="lazy"
              decoding="async"
            />
            <div>
              <div class="mb-6 font-bold text-orange-700 dark:text-blue-200 dark:group-hover:text-white group-hover:text-amber-900">
              <span class="text-xl align-infinity"
                >Spatial Computing + AI + iOS = </span
              ><span class="text-3xl">‚àû</span>
              </div>
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal pb-2">
                Join developers from around the world at the
              
                <strong class="text-orange-700 dark:text-blue-200 leading-tight">Let's Vision 2025</strong>, 
                held in <strong class="text-orange-700 dark:text-blue-200 leading-tight">Shanghai, China, from March 1 to March 2, 2025</strong>.
              </div>
            </div>
          </div>
          <div class="flex justify-center pt-6">
            <div
              class="text-secondary transition-all duration-200 text-xs font-semibold dark:hover:text-blue-200 hover:text-red-600 hover:scale-105 hover:font-bold cursor-pointer"
              onclick="window.location.href='/en/sponsorship/';"
            >
            Want to sponsor? We'd love to chat ‚Üí 
            </div>
          </div>
        </a>
      </div>
`

const midstAd = `
      <div>
        <a href="https://t.ly/hym2p" target="_blank" rel="sponsored">
          <div
            class="p-4 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-lg shadow-lg mt-0 flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0"
          >
            <div class="absolute top-0 right-0 text-secondary text-xs font-bold rounded mt-2 mr-4">SPONSOR</div>
            <img
              src="https://cdn.fatbobman.com/ads/midst-light.webp"
              alt="Midst"
              style="width: 6rem; height: 6rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden sm:block dark:hidden"
            />
            <img
              src="https://cdn.fatbobman.com/ads/midst-dark.webp"
              alt="Midst"
              style="width: 6rem; height: 6rem;"
              class="mr-0 sm:mr-4 mb-4 sm:mb-0 hidden dark:hidden sm:dark:block"
              loading="lazy"
              decoding="async"
            />
            <div class="space-y-2">
              <style>
                .align-infinity {
                  vertical-align: 0.1em; /* Ë∞ÉÊï¥ÂûÇÁõ¥‰ΩçÁΩÆ */
                }
              </style>
              <span class="text-xl font-bold text-orange-700 dark:text-blue-400 align-infinity"
                >The Midst: A location first information network.</span
              >
              <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal pb-2">
                Join a platform that allows you to pan across the map to discover what people are sharing across cities,
                countries, and the world.
              </div>
              <!-- <div class="text-sm text-gray-600 dark:text-gray-400 italic leading-loose font-medium">Ëµ∂Âø´Êä•ÂêçÔºå‰∏çË¶ÅÈîôËøáËøôÂú∫ÊäÄÊúØÁõõÂÆ¥ÔºÅ</div> -->
              <p class="mt-2 text-sm text-orange-700 dark:text-blue-400 italic font-medium">
                Download on the App Store
              </p>
            </div>
          </div>
          <div class="flex justify-center py-6">
            <div
              class="text-secondary transition-all duration-200 text-xs font-semibold hover:text-buttonBg hover:scale-105 hover:font-bold cursor-pointer"
              onclick="window.location.href='/en/sponsorship/';"
            >
              Advertise on Blog & Newsletter &rarr;
            </div>
          </div>
        </a>
      </div>
`

const healthNotesAd = `
      <div>
        <!-- ÂπøÂëäÂç°ÁâáÂÆπÂô® - Êîπ‰∏∫ overflow-visible ÂÖÅËÆ∏ÊåâÈíÆÊ∫¢Âá∫ -->
        <div class="relative rounded-lg overflow-visible shadow-lg mt-8 sm:mt-0">
          <!-- ÂπøÂëäÂÜÖÂÆπ -->
          <a href="https://apps.apple.com/us/app/id1534513553" target="_blank" rel="sponsored">
            <div
              class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-t-lg flex flex-col sm:flex-row items-center relative hover:bg-orange-200 dark:hover:bg-blue-700 space-y-0 transition-all duration-200"
            >
              <!-- Start Tracking ÊåâÈíÆ - Ê∑ªÂä† z-20 Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç -->
              <div
                class="absolute top-[-30px] sm:top-0 right-0 dark:text-blue-200 text-secondary text-xs font-black rounded mt-4 mr-4 dark:bg-gray-800 bg-white sm:dark:bg-black/40 sm:bg-white/80 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl z-20"
              >
                Start Tracking
              </div>

              <img
                src="https://cdn.fatbobman.com/healthnotes-logo.svg"
                alt="Heath Notes Logo"
                width="80"
                height="80"
                class="mr-0 sm:mr-3 mb-4 sm:mb-0 hidden sm:block rounded-lg"
                loading="lazy"
                decoding="async"
              />
              <div class="space-y-2 pr-1">
                <div class="mb-6">
                  <span
                    class="text-xl font-bold text-orange-700 dark:text-blue-200 leading-tight dark:group-hover:text-white group-hover:text-amber-900"
                  >
                    Your Health, Your Data, Your Control
                  </span>
                </div>
                <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal">
                  Health Notes: Custom health tracking for iOS, iPad, and macOS‚Äîtailored to your unique wellness
                  journey.
                </div>
              </div>
            </div>
          </a>

          <!-- ÂπøÂëäÂç°ÁâáÊåâÈíÆ -->
          <div
            class="bg-orange-200/60 dark:bg-blue-900/50 backdrop-blur-sm px-4 sm:px-8 py-4 sm:py-3 cursor-pointer hover:bg-orange-300/70 dark:hover:bg-blue-900/70 transition-all group border-[1.5px] border-t-0 border-orange-500/60 dark:border-blue-500/70 rounded-b-lg relative z-10"
            onclick="window.location.href='/en/sponsorship/';"
          >
            <div
              class="flex flex-col sm:flex-row items-center sm:items-center justify-center sm:justify-between gap-2 sm:gap-0"
            >
              <span class="text-orange-800 dark:text-blue-100 text-sm font-medium text-center sm:text-left">
                Reach 50,000+ Swift developers weekly
              </span>
              <span
                class="text-orange-800 dark:text-blue-100 text-sm font-semibold flex items-center gap-2 group-hover:gap-3 transition-all"
              >
                Become a sponsor
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"
                  ></path>
                </svg>
              </span>
            </div>
          </div>
          
        </div>
      </div>
`;

const placeholder = `<div>
        <div class="relative rounded-lg overflow-visible shadow-lg mt-8 sm:mt-0">
          <!-- ‰∏äÂçäÈÉ®ÂàÜÔºàËµûÂä©Â±ïÁ§∫Âå∫ÂüüÔºâ -->
          <a href="/en/sponsorship/" rel="nofollow">
            <div
              class="group p-4 sm:py-6 sm:px-8 bg-orange-100/70 dark:bg-blue-800 border-[1.5px] border-orange-500/60 dark:border-blue-500/70 rounded-t-lg flex flex-col sm:flex-row items-center hover:bg-orange-200 dark:hover:bg-blue-700 transition-all duration-200"
            >
              <!-- Âè≥‰∏äËßíÊåâÈíÆÔºöSponsored Example -->
              <div
                class="absolute top-[-30px] sm:top-0 right-0 text-secondary text-xs font-black rounded mt-4 mr-4 bg-white/90 dark:bg-gray-800/70 py-1 px-2 border-orange-500 dark:border-blue-600 border-[1px] group-hover:shadow-xl z-20"
              >
                Example Sponsor
              </div>

              <img
                src="https://cdn.fatbobman.com/placeholder-tools.svg"
                alt="Sponsor Placeholder Logo"
                width="80"
                height="80"
                class="mr-0 sm:mr-3 mb-4 sm:mb-0 hidden sm:block rounded-lg
    opacity-90
    dark:opacity-80 dark:saturate-75 dark:brightness-90 dark:contrast-90"
                loading="lazy"
                decoding="async"
              />

              <div class="space-y-2 pr-1">
                <div class="mb-6">
                  <span
                    class="text-xl font-bold text-orange-700 dark:text-blue-200 leading-tight group-hover:text-amber-900 dark:group-hover:text-white"
                  >
                    Reach Swift Developers. Share Your Product.
                  </span>
                </div>
                <div class="text-gray-700 dark:text-gray-300 leading-normal font-normal">
                  Promote your framework, tool, service, or app to a highly targeted iOS & Swift developer audience
                  across blog and newsletter placements.
                </div>
              </div>
            </div>
          </a>

          <!-- ‰∏ãÂçäÈÉ®ÂàÜÔºàBecome a sponsor CTAÔºâ -->
          <div
            class="bg-orange-200/60 dark:bg-blue-900/50 backdrop-blur-sm px-4 sm:px-8 py-4 sm:py-3 cursor-pointer hover:bg-orange-300/70 dark:hover:bg-blue-900/70 transition-all group border-[1.5px] border-t-0 border-orange-500/60 dark:border-blue-500/70 rounded-b-lg relative z-10"
            onclick="window.location.href='/en/sponsorship/';"
          >
            <div
              class="flex flex-col sm:flex-row items-center sm:items-center justify-center sm:justify-between gap-2 sm:gap-0"
            >
              <span class="text-orange-800 dark:text-blue-100 text-sm font-medium text-center sm:text-left">
                Reaching 50,000+ Swift developers monthly
              </span>
              <span
                class="text-orange-800 dark:text-blue-100 text-sm font-semibold flex items-center gap-2 group-hover:gap-3 transition-all"
              >
                Become a sponsor
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"
                  ></path>
                </svg>
              </span>
            </div>
          </div>
        </div>
      </div>
`;

const getRandomContent = () => {
  const randomIndex = Math.floor(Math.random() * ads.length);
  return ads[randomIndex];
};

const ads = [
  placeholder
  // healthNotesAd,
  // visionOS2025Ad,
  // midstAd,
  // currentAd
]



const currentAd = `
<div class="relative my-12 not-prose font-sans">

        <!-- group ÁßªÂà∞Âç°ÁâáÂÜÖÈÉ®ÔºÅ -->
        <a href="https://l.fatbobman.com/sb-boltai?utm_source=en_blog" target="_blank" rel="sponsored" class="block not-prose">
          <div class="group
            relative overflow-hidden rounded-xl
            border border-gray-200/80 dark:border-gray-700/70
            bg-white/95 dark:bg-slate-900/40
            p-4 sm:p-5
            shadow-sm
            transition-colors duration-200
          ">
            
            <div class="flex items-start gap-4">
      
              <!-- Logo -->
              <div class="shrink-0">
                <img 
                  src="https://cdn.fatbobman.com/sb-boltai-White512@2x.png" 
                  alt="BoltAI Logo" 
                  class="w-12 h-12 sm:w-16 sm:h-16 rounded-xl shadow-sm bg-gray-50 dark:bg-transparent object-cover"
                  loading="lazy"
                />
              </div>
      
              <!-- Content -->
              <div class="flex-1 min-w-0 pt-0.5">
      
                <div class="flex items-start justify-between gap-3 mb-1.5">
                  <h4 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100 leading-snug">
                    Native macOS AI Client: GPT, Claude, Gemini & Local Models
                  </h4>
      
                  <span class="
                    shrink-0 text-[10px] font-semibold tracking-wide uppercase
                    text-gray-400 dark:text-gray-500
                    border border-gray-200/60 dark:border-gray-700/60
                    bg-white/60 dark:bg-slate-900/50
                    rounded px-1.5 py-0.5 select-none
                  ">
                    Sponsor
                  </span>
                </div>
      
                <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed sm:line-clamp-none">
                  BoltAI integrates GPT, Claude, Gemini, and Ollama local models directly into your workflow. Features screen context awareness and code refactoring ‚Äî built for developers.
                </p>
      
                <div class="mt-3 flex flex-wrap items-center gap-3 text-xs sm:text-sm">
      
                  <!-- Discount -->
                  <div class="
                    inline-flex items-center gap-2 px-2.5 py-1 rounded-md
                    bg-orange-50/85 dark:bg-blue-500/10 
                    text-orange-700 dark:text-blue-300
                    border border-orange-100/70 dark:border-blue-500/20
                    font-medium
                  ">
                    <span>üéâ Code:</span>
                    <span class="font-bold font-mono">BFCM25</span>
                    <span class="opacity-80">(51% OFF)</span>
                  </div>
      
                  <!-- CTAÔºà‰ªÖÂç°ÁâáÊÇ¨ÂÅúËß¶ÂèëÔºå‰∏ç‰ºöË¢´ sponsor link Ëß¶ÂèëÔºâ -->
                  <div
                    class="
                      ml-auto flex items-center gap-1
                      text-gray-500 dark:text-gray-500
                      transition-all duration-200 font-medium
                      group-hover:text-secondary dark:group-hover:text-secondary
                    "
                  >
                    Try it now
                    <svg
                      class="w-3.5 h-3.5 transition-transform duration-200 group-hover:translate-x-0.5"
                      fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                  </div>
      
                </div>
      
              </div>
            </div>
          </div>
        </a>
      
        <!-- Sponsor link ‰∏çÂ±û‰∫é groupÔºåHover ‰∏ç‰ºöÂΩ±Âìç CTA -->
        <div class="flex justify-end mt-2 mr-1">
          <a href="/en/sponsorship/" target="_blank" class="
            group/link flex items-center gap-1 
            text-[11px] text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 
            transition-colors not-prose
          ">
            Become a sponsor
            <svg class="w-3 h-3 opacity-0 -ml-1 group-hover/link:opacity-100 group-hover/link:ml-0 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      
      </div>
`

const startTime = new Date('2025-12-01T05:00:00Z');
const endTime = new Date('2025-12-08T10:00:00Z');

export async function onRequest(context) {
  const allowedOrigins = [
    'http://localhost:4321',
    'https://fatbobman.com',
    'https://fatbobman.github.io',
    'blogsource-8wyy6rcw.edgeone.site'
  ];

  const request = context.request;
  const origin = request.headers.get('Origin');
  const now = new Date();
  const headers = new Headers({
    'content-type': 'text/html; charset=UTF-8',
  });

  // Âä®ÊÄÅËÆæÁΩÆ CORS
  if (allowedOrigins.includes(origin)) {
    headers.append('Access-Control-Allow-Origin', '*'); // origin ‰∏∫ËØ∑Ê±ÇÁöÑÊ∫êÂú∞ÂùÄ
    headers.append('Vary', 'Origin');
  }

  // Âà§Êñ≠ËøîÂõûÂõ∫ÂÆöÂπøÂëäËøòÊòØÈöèÊú∫ÂπøÂëä
  let ad = currentAd;
  let cacheDuration = 30; // 1200Áßí 20ÂàÜÈíü
  // headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=3600`);
  // if (now >= startTime && now <= endTime) {
  //   ad = currentAd; // Âõ∫ÂÆöÂπøÂëä
  //   cacheDuration = 30; // 20 ÂàÜÈíü 1200
  //   headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=3600`);
  // } else {
  //   ad = getRandomContent(); // ÈöèÊú∫ÂπøÂëä
  //   cacheDuration = 30; // 5ÂàÜÈíü 300
  //   headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=60`);
  // }
  ad = currentAd;
  cacheDuration = 30; // 20 ÂàÜÈíü 1200
  headers.append('Cache-Control', `public, max-age=${cacheDuration}, stale-while-revalidate=3600`);

  // ÁîüÊàê ETag
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(ad));
  const etag = `"${btoa(String.fromCharCode(...new Uint8Array(hash)))}"`;

  if (request.headers.get('If-None-Match') === etag) {
    return new Response(null, { status: 304, headers });
  }

  headers.append('ETag', etag);

  // ËøîÂõûÂπøÂëäÂÜÖÂÆπ
  return new Response(ad, { headers });
}
